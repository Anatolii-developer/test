<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–î–µ—Ç–∞–ª—ñ –∫—É—Ä—Å—É</title>
    <link rel="stylesheet" href="admin-styles.css" />
    <style>
      .course-detail {
        width: 890px;
        margin: 40px auto;
        padding: 60px 100px;
        border-radius: 24px;
        background: #fffef9;
        font-family: "Poppins", sans-serif;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .editable-block {
        position: relative;
        display: flex;
        flex-direction: column;
      }

      .editable-block label {
        font-weight: 600;
        margin-bottom: 6px;
      }

      .editable-block textarea {
        resize: vertical;
        padding: 12px;
        font-size: 16px;
        border: 2px solid #e37009;
        border-radius: 8px;
        background-color: #fffef9;
        color: #333;
        min-height: 48px;
      }

      .editable-block textarea[disabled] {
        background-color: #f0f0f0;
        color: #888;
        border: 1px solid #ccc;
        cursor: not-allowed;
      }

      .editable-block input[type="text"],
      .editable-block input[disabled] {
        padding: 12px;
        font-size: 16px;
        border: 2px solid #e37009;
        border-radius: 8px;
        background-color: #fffef9;
        color: #333;
        min-height: 48px;
      }

      .editable-block input[disabled] {
        background-color: #f0f0f0;
        color: #888;
        border: 1px solid #ccc;
        cursor: not-allowed;
      }

      .edit-btn {
        position: absolute;
        right: 10px;
        top: 38px;
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
      }

      .edit-btn img {
        width: 20px;
        height: 20px;
      }

      .submit-btn {
        align-self: flex-end;
        margin-top: 20px;
        background-color: #e37009;
        color: white;
        border: none;
        padding: 14px 24px;
        font-size: 16px;
        font-weight: 500;
        border-radius: 8px;
        cursor: pointer;
      }
      .submit-btn.danger {
        background: #a31d1d;
      }
      /* Date range single-input UI */
      .date-range { position: relative; }
      #dateRangeInput {
        padding: 12px;
        font-size: 16px;
        border: 2px solid #e37009;
        border-radius: 8px;
        background-color: #fffef9;
        color: #333;
        min-height: 48px;
        width: 100%;
        cursor: pointer;
      }
      .date-popover {
        position: absolute;
        z-index: 20;
        top: 100%;
        left: 0;
        margin-top: 6px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,.1);
        padding: 12px;
        display: none;
        min-width: 340px;
      }
      .date-popover.open { display: block; }
      .date-popover .row { display:flex; gap:12px; align-items:flex-end; }
      .date-popover label { font-weight:600; font-size:12px; display:block; margin:0 0 4px; }
      .date-popover input[type="date"] { padding:8px 10px; border:1px solid #ddd; border-radius:8px; }
      .date-popover .actions { display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }
    </style>
  </head>
  <body class="with-sidebar">
    <aside class="sidebar" id="sidebar"></aside>

    <div class="course-detail">
      <h1>–î–µ—Ç–∞–ª—ñ –∫—É—Ä—Å—É</h1>
      <div style="display: flex; gap: 24px; flex-wrap: wrap">
        <div class="editable-block" style="min-width: 260px; flex: 1">
          <label>–°—Ç–≤–æ—Ä–∏–≤</label>
          <input id="creatorName" type="text" disabled />
        </div>
        <div class="editable-block" style="min-width: 220px; flex: 1">
          <label>–†–æ–ª—å</label>
          <input id="creatorRole" type="text" disabled />
        </div>
      </div>
      <div class="editable-block">
        <label>–ù–∞–∑–≤–∞ –∫—É—Ä—Å—É</label>
        <textarea id="title" disabled></textarea>
        <button class="edit-btn" onclick="enableEdit('title')">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>

      <div class="editable-block">
        <label>–¢–∏–ø (—ñ–Ω—Ñ–æ)</label>
        <textarea id="eventType" disabled></textarea>
      </div>

      <div class="editable-block">
        <label>–ü—ñ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫</label>
        <textarea id="subtitle" disabled></textarea>
        <button class="edit-btn" onclick="enableEdit('subtitle')">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>

      <div class="editable-block">
        <label>–û–ø–∏—Å</label>
        <textarea id="description" disabled></textarea>
        <button class="edit-btn" onclick="enableEdit('description')">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>

      <div class="editable-block">
        <label>–î–∞—Ç–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—è –∫—É—Ä—Å—É</label>
        <div class="date-range">
          <!-- –≤–∏–¥–∏–º–∏–π —ñ–Ω–ø—É—Ç –∑–∞ –¥–∏–∑–∞–π–Ω–æ–º -->
          <input id="dateRangeInput" type="text" readonly placeholder="–î–î.–ú–ú.–†–†–†–† ‚Äì –î–î.–ú–ú.–†–†–†–†" />
          <button class="edit-btn" id="dateEditBtn" type="button" onclick="openDateEditor()" aria-label="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –¥–∞—Ç–∏">
            <img src="../assets/edit-icon.svg" alt="Edit" />
          </button>
          <!-- –ø—Ä–∏—Ö–æ–≤–∞–Ω—ñ —Ä–µ–∞–ª—å–Ω—ñ –¥–∞—Ç–∏ -->
          <input id="startDate" type="date" hidden />
          <input id="endDate" type="date" hidden />

          <!-- popover –∑ –Ω–∞—Ç–∏–≤–Ω–∏–º–∏ date-–ø—ñ–∫–µ—Ä–∞–º–∏ -->
          <div class="date-popover" id="datePopover">
            <div class="row">
              <div style="flex:1">
                <label for="pickerStart">–ü–æ—á–∞—Ç–æ–∫</label>
                <input id="pickerStart" type="date" />
              </div>
              <div style="flex:1">
                <label for="pickerEnd">–ö—ñ–Ω–µ—Ü—å</label>
                <input id="pickerEnd" type="date" />
              </div>
            </div>
            <div class="actions">
              <button type="button" class="btn" id="cancelDates">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
              <button type="button" class="btn primary" id="applyDates">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
            </div>
          </div>
        </div>
      </div>

      <div class="editable-block">
        <label>–¢–∏–ø –≥—Ä—É–ø–∏</label>
        <input id="groupType" type="text" disabled />
        <button class="edit-btn" onclick="enableEdit('groupType')">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>

      <div class="editable-block">
        <label>–¢–∏–ø –¥–æ—Å—Ç—É–ø—É</label>
        <textarea id="access" disabled></textarea>
        <button class="edit-btn" onclick="enableEdit('access')">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>

      <div class="editable-block">
        <label>–£—á–∞—Å–Ω–∏–∫–∏</label>
        <input id="participantsText" type="text" disabled />
        <button class="edit-btn" onclick="openParticipantsModal()">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>

      <div class="editable-block">
        <label>–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å</label>
        <textarea id="duration" disabled></textarea>
        <button class="edit-btn" onclick="enableEdit('duration')">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>

      <div class="editable-block">
        <label>–¶—ñ–Ω–∞</label>
        <textarea id="price" disabled></textarea>
        <button class="edit-btn" onclick="enableEdit('price')">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>

      <div class="editable-block">
        <label>–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—è –∫—É—Ä—Å—É</label>
        <textarea id="zoom" disabled></textarea>
        <button class="edit-btn" onclick="enableEdit('zoom')">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>
      <div class="editable-block">
        <label>–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É –∫—É—Ä—Å—É (–Ω–∞ —Å–∞–π—Ç—ñ)</label>
        <input id="siteLink" type="text" disabled placeholder="https://‚Ä¶" />
        <button class="edit-btn" onclick="enableEdit('siteLink')">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>

      <div class="editable-block">
        <label>–í–∏–¥ –∫—É—Ä—Å—É</label>
        <select
          id="eventTypeSel"
          style="
            padding: 12px;
            border: 2px solid #e37009;
            border-radius: 8px;
            background: #fffef9;
            min-height: 48px;
          "
        >
          <option value="–ö—É—Ä—Å">–ö—É—Ä—Å</option>
          <option value="–ì—Ä—É–ø–∞">–ì—Ä—É–ø–∞</option>
          <option value="–°—É–ø–µ—Ä–≤—ñ–∑—ñ—è">–°—É–ø–µ—Ä–≤—ñ–∑—ñ—è</option>
          <option value="–õ–µ–∫—Ü—ñ—è">–õ–µ–∫—Ü—ñ—è</option>
          <option value="–°–µ–º—ñ–Ω–∞—Ä">–°–µ–º—ñ–Ω–∞—Ä</option>
        </select>
      </div>

      <div class="editable-block" id="moderationBlock">
        <label>–ú–æ–¥–µ—Ä–∞—Ü—ñ—è</label>
        <div style="display: flex; gap: 10px; flex-wrap: wrap">
          <button
            type="button"
            class="submit-btn"
            id="approveBtn"
            onclick="approveCourse()"
          >
            ‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏
          </button>
          <button
            type="button"
            class="submit-btn"
            id="rejectBtn"
            onclick="rejectCourse()"
            style="background: #a31d1d"
          >
            ‚ùå –í—ñ–¥—Ö–∏–ª–∏—Ç–∏
          </button>
          <span
            id="statusHint"
            style="align-self: center; color: #8f8f8f; font-weight: 500"
          ></span>
        </div>
      </div>

      <button class="submit-btn" onclick="saveChanges()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
      <button class="submit-btn danger" id="deleteBtn" onclick="deleteCourse()">
        üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ –∫—É—Ä—Å
      </button>
    </div>
    <script src="admin-auth.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        if (typeof renderAdminSidebar === "function") {
          renderAdminSidebar("admin-career-requests.html");
        }
        if (typeof requireAdminPage === "function") {
          requireAdminPage();
        }
        loadCourseDetails();
      });

      let courseId;
      let allUsers = [];
      let selectedParticipantIds = [];

      function pad(n) {
        return String(n).padStart(2, "0");
      }
      function fmtDate(d) {
        if (!d) return "";
        const x = new Date(d);
        if (isNaN(x)) return "";
        return `${pad(x.getDate())}.${pad(
          x.getMonth() + 1
        )}.${x.getFullYear()}`;
      }

      function getFullName(user) {
        return [user.firstName, user.lastName].filter(Boolean).join(" ");
      }

      // --- date helpers for single-range control ---
      const pad2 = (n) => String(n).padStart(2, "0");
      function toYMD(iso){
        if (!iso) return "";
        if (/^\d{4}-\d{2}-\d{2}$/.test(iso)) return iso; // already Y-M-D
        const d = new Date(iso);
        if (isNaN(d)) return "";
        return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
      }
      function toDMY(iso){
        if (!iso) return "";
        const d = /^\d{4}-\d{2}-\d{2}$/.test(iso) ? new Date(iso+"T12:00:00") : new Date(iso);
        if (isNaN(d)) return "";
        return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${d.getFullYear()}`;
      }
      function normalizeISO(val){
        if (!val) return "";
        if (/^\d{4}-\d{2}-\d{2}$/.test(val)) return new Date(val+"T12:00:00").toISOString();
        const d = new Date(val);
        return isNaN(d) ? "" : d.toISOString();
      }
      function setDateRangeDisplay(startVal, endVal){
        const sIso = normalizeISO(startVal);
        const eIso = normalizeISO(endVal);
        const input = document.getElementById("dateRangeInput");
        if (input) input.value = (sIso || eIso) ? `${toDMY(sIso)} ‚Äì ${toDMY(eIso)}` : "";
      }

      async function deleteCourse() {
  if (!courseId) { alert("–ù–µ –≤–∫–∞–∑–∞–Ω–æ ID –∫—É—Ä—Å—É"); return; }
  if (!confirm("–¢–æ—á–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∫—É—Ä—Å? –î—ñ—é –Ω–µ–º–æ–∂–ª–∏–≤–æ —Å–∫–∞—Å—É–≤–∞—Ç–∏.")) return;

  const btn = document.getElementById('deleteBtn');
  btn && (btn.disabled = true);

  try {
    const r = await fetch(`http://157.230.121.24:5050/api/courses/${courseId}`, {
      method: "DELETE",
      credentials: "include",
      headers: getAuthHeaders(),
    });

    if (r.status === 404) {
      alert("–ö—É—Ä—Å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ (–º–æ–∂–ª–∏–≤–æ, —É–∂–µ –≤–∏–¥–∞–ª–µ–Ω–æ –∞–±–æ –Ω–µ–≤—ñ—Ä–Ω–∏–π ID).");
      return;
    }

    const data = await r.json().catch(() => ({}));
    if (!r.ok) throw new Error(data.message || `HTTP ${r.status}`);

    alert("–ö—É—Ä—Å –≤–∏–¥–∞–ª–µ–Ω–æ");
    location.href = "admin-all-courses.html";
  } catch (e) {
    console.error(e);
    alert(e.message || "–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è");
  } finally {
    btn && (btn.disabled = false);
  }
}
      function computeDurationText(startIso, endIso) {
        if (!startIso || !endIso) return "";
        const s = new Date(startIso);
        const e = new Date(endIso);
        if (isNaN(s) || isNaN(e)) return "";
        // normalize to noon to avoid DST issues
        s.setHours(12, 0, 0, 0);
        e.setHours(12, 0, 0, 0);
        const msPerDay = 24 * 60 * 60 * 1000;
        const days = Math.max(0, Math.round((e - s) / msPerDay) + 1); // inclusive range
        const weeks = Math.floor(days / 7);
        const remDays = days % 7;
        const weekPart = weeks ? `${weeks} —Ç–∏–∂–Ω.` : "";
        const dayPart = remDays ? `${remDays} –¥–Ω.` : weeks ? "" : `${days} –¥–Ω.`;
        const joiner = weekPart && dayPart ? " " : "";
        return `${days} –¥–Ω—ñ–≤ (${weekPart}${joiner}${dayPart})`;
      }

    async function loadCourseDetails() {
  const params = new URLSearchParams(window.location.search);
  courseId = params.get("id");
  if (!courseId) {
    alert("–ù–µ –≤–∫–∞–∑–∞–Ω–æ ID –∫—É—Ä—Å—É");
    return;
  }
  console.log('[admin-course-details] courseId =', courseId);

  // –≤—Å–ø–æ–º–æ–≥–∞–ª–∫–∞: –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –∫–Ω–æ–ø–∫–∏, —á—Ç–æ–±—ã –Ω–µ –∂–∞–ª–∏ –∑—Ä—è
  const setBusy = (on) => {
    ["deleteBtn"].forEach(id => {
      const b = document.getElementById(id);
      if (b) b.disabled = !!on;
    });
  };

  setBusy(true);
  try {
    // 1) –ø—Ä–æ–±—É–µ–º –ø—Ä—è–º–æ–π GET –ø–æ id
    let res = await fetch(`http://157.230.121.24:5050/api/courses/${courseId}`);
    if (res.status === 404) {
      // 2) fallback: —Ç—è–Ω–µ–º —Å–ø–∏—Å–æ–∫ –∏ –∏—â–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–π –∫—É—Ä—Å
      const listRes = await fetch(`http://157.230.121.24:5050/api/courses`);
      const all = await listRes.json();
      // –ø–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ —Ç–æ—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é _id
      let found = all.find(c => String(c._id) === String(courseId));

      // –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–∏—à—ë–ª —É–∫–æ—Ä–æ—á–µ–Ω–Ω—ã–π/–±–∏—Ç—ã–π id –∏–∑ —Å–ø–∏—Å–∫–∞: 
      // –ø–æ–∏—â–µ–º –ø–æ –Ω–∞—á–∞–ª—É/–∫–æ–Ω—Ü—É —Å—Ç—Ä–æ–∫–∏ (–∏–Ω–æ–≥–¥–∞ –æ–±—Ä–µ–∑–∞—é—Ç)
      if (!found) {
        found = all.find(c =>
          String(c._id).startsWith(String(courseId)) ||
          String(c._id).endsWith(String(courseId))
        );
      }

      if (!found) {
        alert("–ö—É—Ä—Å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ (ID –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π –∞–±–æ –∑–∞–ø–∏—Å –≤—ñ–¥—Å—É—Ç–Ω—ñ–π). –ü–æ–≤–µ—Ä—Ç–∞—é –Ω–∞–∑–∞–¥.");
        // –±–µ–∑–æ–ø–∞—Å–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏–º –Ω–∞ —Å–ø–∏—Å–æ–∫
        location.href = "admin-all-courses.html";
        return;
      }

      // –Ω–∞—à—ë–ª—Å—è –¥—Ä—É–≥–æ–π —Ä–µ–∞–ª—å–Ω—ã–π id ‚Äî –ø–æ—á–∏–Ω–∏–º URL –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º
      if (String(found._id) !== String(courseId)) {
        const u = new URL(location.href);
        u.searchParams.set("id", found._id);
        location.replace(u.toString());
        return;
      }

      // –µ—Å–ª–∏ –≤—Å—ë-—Ç–∞–∫–∏ —Ç–µ–∫—É—â–∏–π == found._id, –ø—Ä–æ—Å—Ç–æ –ø–∞–¥–∞–µ–º –Ω–∏–∂–µ –∏ –ø–æ–≤—Ç–æ—Ä—è–µ–º —Ä–∞–∑–±–æ—Ä
      res = await fetch(`http://157.230.121.24:5050/api/courses/${found._id}`);
    }

    if (!res.ok) {
      const data = await res.json().catch(()=> ({}));
      throw new Error(data.message || `HTTP ${res.status}`);
    }

    const course = await res.json();
    // === –¥–∞–ª—å—à–µ –æ—Å—Ç–∞–≤–ª—è–π —Ç–≤–æ—é —Ç–µ–∫—É—â—É—é –ª–æ–≥–∏–∫—É –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª–µ–π ===
    // ... (—Ç–≤–æ–π –∫–æ–¥ –ø—Ä–∏—Å–≤–æ–µ–Ω–∏–π –≤ –∏–Ω–ø—É—Ç—ã)
  } catch (err) {
    console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –∫—É—Ä—Å—É:", err);
    alert(err.message || "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫—É—Ä—Å—É");
  } finally {
    setBusy(false);
  }
}

      function updateParticipantsUI() {
        const input = document.getElementById("participantsText");
        if (!input) return;
        const names = allUsers
          .filter((u) => selectedParticipantIds.includes(u._id))
          .map((u) => getFullName(u) || u.email);
        input.value = names.join(", ");
      }

      function enableEdit(id) {
        const textarea = document.getElementById(id);
        textarea.disabled = false;
        textarea.focus();
      }


      function getAuthHeaders() {
  let token = null;
  try {
    const u = JSON.parse(localStorage.getItem('user') || 'null');
    token = u?.token || u?.accessToken || null;
  } catch(_) {}
  const h = { 'Content-Type': 'application/json' };
  if (token) h.Authorization = `Bearer ${token}`;
  return h;
}

      async function saveChanges() {
        const startIso = document.getElementById("startDate")?.value || "";
        const endIso = document.getElementById("endDate")?.value || "";

        const rawSite = document.getElementById('siteLink')?.value?.trim() || '';
        const siteLink = rawSite && !/^https?:\/\//i.test(rawSite) ? 'https://' + rawSite : rawSite;

        const updated = {
          courseTitle: document.getElementById("title").value,
          eventType: document.getElementById("eventTypeSel")
            ? document.getElementById("eventTypeSel").value
            : document.getElementById("eventType").value,
          courseSubtitle: document.getElementById("subtitle").value,
          courseDescription: document.getElementById("description").value,
          accessType: document.getElementById("access").value,
          courseDuration: document.getElementById("duration").value,
          coursePrice: document.getElementById("price").value,
          zoomLink: document.getElementById("zoom").value,
          // —É—Å—ñ –º–æ–∂–ª–∏–≤—ñ –∫–ª—é—á—ñ –¥–ª—è –±–µ–∫–µ–Ω–¥—É
          siteLink,
          publicUrl: siteLink,
          pageUrl: siteLink,
          website: siteLink,
          websiteUrl: siteLink,
          participants: selectedParticipantIds,
          courseDates: {
            start: startIso ? new Date(startIso + (/-/.test(startIso) && startIso.length===10 ? 'T12:00:00' : '')).toISOString() : null,
            end:   endIso   ? new Date(endIso   + (/-/.test(endIso)   && endIso.length===10   ? 'T12:00:00' : '')).toISOString()   : null,
          },
        };

        // –∑–±–µ—Ä–µ–∂–µ–º–æ –ª–æ–∫–∞–ª—å–Ω–æ —è–∫ —Ñ–æ–ª–±–µ–∫ (–Ω–∞ –≤–∏–ø–∞–¥–æ–∫, —è–∫—â–æ –±–µ–∫ –ø–æ–∫–∏ –Ω–µ –≤—ñ–¥–¥–∞—î —Ü–µ –ø–æ–ª–µ)
        try {
          const map = JSON.parse(localStorage.getItem("course.siteLinks") || "{}");
          map[courseId] = siteLink;
          localStorage.setItem("course.siteLinks", JSON.stringify(map));
        } catch(_) {}

        try {
          const res = await fetch(
            `http://157.230.121.24:5050/api/courses/${courseId}`,
            {
              method: "PUT",
              credentials: "include",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(updated),
            }
          );

          if (res.ok) {
            alert("–î–∞–Ω—ñ –æ–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ");
            document
              .querySelectorAll("textarea")
              .forEach((t) => (t.disabled = true));
            document
              .querySelectorAll("input[type='text']")
              .forEach((i) => (i.disabled = true));
            try {
              loadCourseDetails();
            } catch (_) {}
          } else {
            const data = await res.json().catch(() => ({}));
            alert(data?.message || "–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ");
          }
        } catch (err) {
          console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ:", err);
          alert(err.message || "–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ");
        }
      }
      // Bind popover behaviour for single date-range control
      (function bindDateRangeUI(){
        const input = document.getElementById("dateRangeInput");
        const pop = document.getElementById("datePopover");
        const pStart = document.getElementById("pickerStart");
        const pEnd = document.getElementById("pickerEnd");
        const btnApply = document.getElementById("applyDates");
        const btnCancel = document.getElementById("cancelDates");
        const editBtn = document.getElementById('dateEditBtn');
        if (!input || !pop) return;

        const hiddenStart = () => document.getElementById("startDate");
        const hiddenEnd = () => document.getElementById("endDate");

        function open(){
          if (pStart) pStart.value = hiddenStart()?.value || "";
          if (pEnd)   pEnd.value   = hiddenEnd()?.value   || "";
          pop.classList.add("open");
        }
        function close(){ pop.classList.remove("open"); }

        input.addEventListener("click", open);
        btnCancel && btnCancel.addEventListener("click", close);
        btnApply && btnApply.addEventListener("click", () => {
          if (pStart && hiddenStart()) hiddenStart().value = pStart.value || "";
          if (pEnd && hiddenEnd())     hiddenEnd().value   = pEnd.value   || "";
          setDateRangeDisplay(pStart?.value || "", pEnd?.value || "");
          close();
        });
        // Modified click handler to ignore clicks on editBtn as well
        document.addEventListener('click', (e) => {
          const t = e.target;
          if (pop.contains(t) || t === input || t === editBtn) return; // –Ω–µ –∑–∞–∫—Ä–∏–≤–∞—Ç–∏ –ø—Ä–∏ –∫–ª—ñ–∫—É –Ω–∞ —ñ–Ω–ø—É—Ç/–∫–Ω–æ–ø–∫—É/–≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ø–æ–ø–æ–≤–µ—Ä–∞
          close();
        });
        // —â–æ–± –∫–ª—ñ–∫–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ø–æ–ø–æ–≤–µ—Ä–∞ –Ω–µ –±—É–ª—å–±–∞—à–∏–ª–∏—Å—è –¥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        pop.addEventListener('click', (e)=> e.stopPropagation());
        // Click handler for edit button
        if (editBtn) editBtn.addEventListener('click', (e)=> { e.stopPropagation(); openDateEditor(e); });
      })();

      // Function to open date popover and stop event propagation
      function openDateEditor(event){
        try { if (event) event.stopPropagation(); } catch(_){}
        const pop = document.getElementById('datePopover');
        const pStart = document.getElementById('pickerStart');
        const pEnd = document.getElementById('pickerEnd');
        const hStart = document.getElementById('startDate');
        const hEnd = document.getElementById('endDate');
        if (!pop) return;
        if (pStart && hStart) pStart.value = hStart.value || '';
        if (pEnd && hEnd) pEnd.value = hEnd.value || '';
        pop.classList.add('open');
        // —Ñ–æ–∫—É—Å –Ω–∞ –ø–µ—Ä—à–∏–π –ø—ñ–∫–µ—Ä
        setTimeout(()=>{ try { pStart && pStart.focus(); } catch(_){} }, 0);
      }

      async function approveCourse() {
        if (!courseId) return;
        try {
          const r = await fetch(
            `http://157.230.121.24:5050/api/courses/${courseId}/approve`,
            { method: "PUT" }
          );
          const   data = await r.json().catch(() => ({}));
          if (!r.ok)
            throw new Error(data.message || "–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∫—É—Ä—Å");
          alert("–ö—É—Ä—Å –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ");
          loadCourseDetails();
        } catch (e) {
          console.error(e);
          alert(e.message || "–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è");
        }
      }

      async function rejectCourse() {
        if (!courseId) return;
        // –æ–ø—Ü—ñ–π–Ω–æ: –ø–æ–ø—Ä–æ—Å–∏—Ç–∏ –ø—Ä–∏—á–∏–Ω—É
        const reason = prompt("–ü—Ä–∏—á–∏–Ω–∞ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è (–Ω–µ–æ–±–æ–≤ º—è–∑–∫–æ–≤–æ):", "");
        try {
          const r = await fetch(
            `http://157.230.121.24:5050/api/courses/${courseId}/reject`,
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ reason }),
            }
          );
          const data = await r.json().catch(() => ({}));
          if (!r.ok)
            throw new Error(data.message || "–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥—Ö–∏–ª–∏—Ç–∏ –∫—É—Ä—Å");
          alert("–ö—É—Ä—Å –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ");
          loadCourseDetails();
        } catch (e) {
          console.error(e);
          alert(e.message || "–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è");
        }
      }

      window.addEventListener("DOMContentLoaded", loadCourseDetails);

      async function openParticipantsModal() {
        try {
          const res = await fetch("http://157.230.121.24:5050/api/users");
          allUsers = await res.json();
          renderUserList(allUsers);
          document.getElementById("participantsModal").style.display = "flex";
        } catch (err) {
          console.error("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤:", err);
        }
      }

      function renderUserList(users) {
        const container = document.getElementById("userList");
        container.innerHTML = "";
        users.forEach((user) => {
          const div = document.createElement("div");
          const fullName = getFullName(user);
          div.innerHTML = `
      <label>
        <input type="checkbox" value="${user._id}" ${
            selectedParticipantIds.includes(user._id) ? "checked" : ""
          } />
        ${fullName || user.email}
      </label>
    `;
          container.appendChild(div);
        });
      }

      function applySelectedParticipants() {
        const checkboxes = document.querySelectorAll(
          '#userList input[type="checkbox"]'
        );
        selectedParticipantIds = Array.from(checkboxes)
          .filter((cb) => cb.checked)
          .map((cb) => cb.value);
        updateParticipantsUI();
        closeParticipantsModal();
      }

      function closeParticipantsModal() {
        document.getElementById("participantsModal").style.display = "none";
      }

      function filterParticipants(e) {
        const query = e.target.value.toLowerCase();
        const filtered = allUsers.filter((u) =>
          getFullName(u).toLowerCase().includes(query)
        );
        renderUserList(filtered);
      }
      function logoutUser() {
        try {
          // —á–∏—Å—Ç–∏–º–æ –ª–æ–∫–∞–ª—å–Ω–µ
          localStorage.removeItem("user");
          ["token", "authToken", "jwt", "accessToken", "bearer"].forEach((k) =>
            localStorage.removeItem(k)
          );
        } catch (_) {}

        // –ø—Ä–æ–±—É—î–º–æ –≤–∏–π—Ç–∏ —ñ –Ω–∞ –±–µ–∫–µ–Ω–¥—ñ (—ñ–≥–Ω–æ—Ä—É—î–º–æ –ø–æ–º–∏–ª–∫–∏ –º–µ—Ä–µ–∂—ñ)
        const API = ""; // —è–∫—â–æ –±–µ–∫ —ñ —Ñ—Ä–æ–Ω—Ç –Ω–∞ –æ–¥–Ω–æ–º—É –¥–æ–º–µ–Ω—ñ ‚Äî –∑–∞–ª–∏—à –ø–æ—Ä–æ–∂–Ω—ñ–º
        fetch(`${API}/api/users/logout`, {
          method: "POST",
          credentials: "include",
        }).catch(() => {});

        // —Ä–µ–¥—ñ—Ä–µ–∫—Ç –Ω–∞ –ª–æ–≥—ñ–Ω –∑ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è–º
        const back = encodeURIComponent(location.pathname + location.search);
        location.href = `admin-login.html?returnUrl=${back}`;
      }

      // –ø—Ä–∏–≤‚Äô—è–∑—É—î–º–æ –¥–æ –∫–Ω–æ–ø–∫–∏
      document.addEventListener("DOMContentLoaded", () => {
        const btn = document.getElementById("btnLogout");
        if (btn) btn.addEventListener("click", logoutUser);
      });

      document.addEventListener("DOMContentLoaded", () => {
        const here = location.pathname.split("/").pop();
        document.querySelectorAll(".sidebar nav a").forEach((a) => {
          if (a.getAttribute("href") === here) a.classList.add("active");
        });
      });
    </script>

    <div id="participantsModal" class="modal" style="display: none">
      <div class="modal-content" style="max-height: 70vh; overflow-y: auto">
        <h3>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —É—á–∞—Å–Ω–∏–∫—ñ–≤</h3>
        <input
          type="text"
          placeholder="–ü–æ—à—É–∫..."
          oninput="filterParticipants(event)"
        />
        <div id="userList" style="margin: 10px 0"></div>
        <button onclick="applySelectedParticipants()">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
        <button onclick="closeParticipantsModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      </div>
    </div>
  </body>
</html>
