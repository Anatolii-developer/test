<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–î–µ—Ç–∞–ª—ñ –∫—É—Ä—Å—É</title>
    <link rel="stylesheet" href="admin-styles.css" />
    <style>
      .course-detail {
        width: 890px;
        margin: 40px auto;
        padding: 60px 100px;
        border-radius: 24px;
        background: #fffef9;
        font-family: "Poppins", sans-serif;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .editable-block {
        position: relative;
        display: flex;
        flex-direction: column;
      }

      .editable-block label {
        font-weight: 600;
        margin-bottom: 6px;
      }

      .editable-block textarea {
        resize: vertical;
        padding: 12px;
        font-size: 16px;
        border: 2px solid #e37009;
        border-radius: 8px;
        background-color: #fffef9;
        color: #333;
        min-height: 48px;
      }

      .editable-block textarea[disabled] {
        background-color: #f0f0f0;
        color: #888;
        border: 1px solid #ccc;
        cursor: not-allowed;
      }

      .editable-block input[type="text"],
      .editable-block input[disabled] {
        padding: 12px;
        font-size: 16px;
        border: 2px solid #e37009;
        border-radius: 8px;
        background-color: #fffef9;
        color: #333;
        min-height: 48px;
      }

      .editable-block input[disabled] {
        background-color: #f0f0f0;
        color: #888;
        border: 1px solid #ccc;
        cursor: not-allowed;
      }

      .edit-btn {
        position: absolute;
        right: 10px;
        top: 38px;
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
      }

      .edit-btn img {
        width: 20px;
        height: 20px;
      }

      .submit-btn {
        align-self: flex-end;
        margin-top: 20px;
        background-color: #e37009;
        color: white;
        border: none;
        padding: 14px 24px;
        font-size: 16px;
        font-weight: 500;
        border-radius: 8px;
        cursor: pointer;
      }
      .submit-btn.danger {
        background: #a31d1d;
      }
      /* Date range single-input UI */
      .date-range { position: relative; }
      #dateRangeInput {
        padding: 12px;
        font-size: 16px;
        border: 2px solid #e37009;
        border-radius: 8px;
        background-color: #fffef9;
        color: #333;
        min-height: 48px;
        width: 100%;
        cursor: pointer;
      }
      .date-popover {
        position: absolute;
        z-index: 20;
        top: 100%;
        left: 0;
        margin-top: 6px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,.1);
        padding: 12px;
        display: none;
        min-width: 340px;
      }
      .date-popover.open { display: block; }
      .date-popover .row { display:flex; gap:12px; align-items:flex-end; }
      .date-popover label { font-weight:600; font-size:12px; display:block; margin:0 0 4px; }
      .date-popover input[type="date"] { padding:8px 10px; border:1px solid #ddd; border-radius:8px; }
      .date-popover .actions { display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }

      .units-toolbar {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 12px;
      }
      .units-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .units-empty {
        color: #777;
        font-size: 14px;
      }
      .unit-card {
        border: 1px solid #f0c08b;
        border-radius: 14px;
        padding: 14px;
        background: #fff;
      }
      .unit-card.unit-card-error {
        border-color: #a31d1d;
      }
      .unit-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
      }
      .unit-grid label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 12px;
        font-weight: 600;
        color: #444;
      }
      .unit-grid input,
      .unit-grid select {
        padding: 10px 12px;
        font-size: 14px;
        border: 2px solid #e37009;
        border-radius: 8px;
        background-color: #fffef9;
        color: #333;
      }
      .unit-meta-row {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      .unit-members-summary {
        font-size: 12px;
        color: #666;
      }
      .unit-action-btn {
        border: none;
        border-radius: 6px;
        padding: 6px 10px;
        font-size: 12px;
        cursor: pointer;
        background: #e37009;
        color: #fff;
      }
      .unit-action-btn.secondary {
        background: #888;
      }
      .unit-action-btn.danger {
        background: #a31d1d;
      }
      .unit-members-row {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 6px;
      }
      .unit-member-row {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 6px 0;
      }
      .unit-member-row select {
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
      }
    </style>
  </head>
  <body class="with-sidebar">
    <aside class="sidebar" id="sidebar"></aside>

    <div class="course-detail">
      <h1>–î–µ—Ç–∞–ª—ñ –∫—É—Ä—Å—É</h1>
      <div style="display: flex; gap: 24px; flex-wrap: wrap">
        <div class="editable-block" style="min-width: 260px; flex: 1">
          <label>–°—Ç–≤–æ—Ä–∏–≤</label>
          <input id="creatorName" type="text" disabled />
        </div>
        <div class="editable-block" style="min-width: 220px; flex: 1">
          <label>–†–æ–ª—å</label>
          <input id="creatorRole" type="text" disabled />
        </div>
      </div>
      <div class="editable-block">
        <label>–ù–∞–∑–≤–∞ –∫—É—Ä—Å—É</label>
        <textarea id="title" disabled></textarea>
        <button class="edit-btn" onclick="enableEdit('title')">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>

      <div class="editable-block">
        <label>–¢–∏–ø (—ñ–Ω—Ñ–æ)</label>
        <textarea id="eventType" disabled></textarea>
      </div>

      <div class="editable-block">
        <label>–ü—ñ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫</label>
        <textarea id="subtitle" disabled></textarea>
        <button class="edit-btn" onclick="enableEdit('subtitle')">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>

      <div class="editable-block">
        <label>–û–ø–∏—Å</label>
        <textarea id="description" disabled></textarea>
        <button class="edit-btn" onclick="enableEdit('description')">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>

      <div class="editable-block">
        <label>–î–∞—Ç–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—è –∫—É—Ä—Å—É</label>
        <div class="date-range">
          <!-- –≤–∏–¥–∏–º–∏–π —ñ–Ω–ø—É—Ç –∑–∞ –¥–∏–∑–∞–π–Ω–æ–º -->
          <input id="dateRangeInput" type="text" readonly placeholder="–î–î.–ú–ú.–†–†–†–† ‚Äì –î–î.–ú–ú.–†–†–†–†" />
          <button class="edit-btn" id="dateEditBtn" type="button" onclick="openDateEditor()" aria-label="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –¥–∞—Ç–∏">
            <img src="../assets/edit-icon.svg" alt="Edit" />
          </button>
          <!-- –ø—Ä–∏—Ö–æ–≤–∞–Ω—ñ —Ä–µ–∞–ª—å–Ω—ñ –¥–∞—Ç–∏ -->
          <input id="startDate" type="date" hidden />
          <input id="endDate" type="date" hidden />

          <!-- popover –∑ –Ω–∞—Ç–∏–≤–Ω–∏–º–∏ date-–ø—ñ–∫–µ—Ä–∞–º–∏ -->
          <div class="date-popover" id="datePopover">
            <div class="row">
              <div style="flex:1">
                <label for="pickerStart">–ü–æ—á–∞—Ç–æ–∫</label>
                <input id="pickerStart" type="date" />
              </div>
              <div style="flex:1">
                <label for="pickerEnd">–ö—ñ–Ω–µ—Ü—å</label>
                <input id="pickerEnd" type="date" />
              </div>
            </div>
            <div class="actions">
              <button type="button" class="btn" id="cancelDates">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
              <button type="button" class="btn primary" id="applyDates">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
            </div>
          </div>
        </div>
      </div>

      <div class="editable-block">
        <label>–¢–∏–ø –≥—Ä—É–ø–∏</label>
        <input id="groupType" type="text" disabled />
        <button class="edit-btn" onclick="enableEdit('groupType')">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>

      <div class="editable-block">
        <label>–¢–∏–ø –¥–æ—Å—Ç—É–ø—É</label>
        <textarea id="access" disabled></textarea>
        <button class="edit-btn" onclick="enableEdit('access')">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>

      <div class="editable-block">
        <label>–£—á–∞—Å–Ω–∏–∫–∏</label>
        <input id="participantsText" type="text" disabled />
        <button class="edit-btn" onclick="openParticipantsModal()">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>

      <div class="editable-block" id="unitsBlock">
        <label>–Æ–Ω—ñ—Ç–∏ (–∑–∞–Ω—è—Ç—Ç—è)</label>
        <div class="units-toolbar">
          <button type="button" class="unit-action-btn" onclick="addUnitCard()">+ –î–æ–¥–∞—Ç–∏ —é–Ω—ñ—Ç</button>
        </div>
        <div id="unitsContainer" class="units-list"></div>
      </div>

      <div class="editable-block">
        <label>–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å</label>
        <textarea id="duration" disabled></textarea>
        <button class="edit-btn" onclick="enableEdit('duration')">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>

      <div class="editable-block">
        <label>–¶—ñ–Ω–∞</label>
        <textarea id="price" disabled></textarea>
        <button class="edit-btn" onclick="enableEdit('price')">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>

      <div class="editable-block">
        <label>–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—è –∫—É—Ä—Å—É</label>
        <textarea id="zoom" disabled></textarea>
        <button class="edit-btn" onclick="enableEdit('zoom')">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>
      <div class="editable-block">
        <label>–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É –∫—É—Ä—Å—É (–Ω–∞ —Å–∞–π—Ç—ñ)</label>
        <input id="siteLink" type="text" disabled placeholder="https://‚Ä¶" />
        <button class="edit-btn" onclick="enableEdit('siteLink')">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>

      <div class="editable-block">
        <label>–í–∏–¥ –∫—É—Ä—Å—É</label>
        <select
          id="eventTypeSel"
          style="
            padding: 12px;
            border: 2px solid #e37009;
            border-radius: 8px;
            background: #fffef9;
            min-height: 48px;
          "
        >
          <option value="–ö—É—Ä—Å">–ö—É—Ä—Å</option>
          <option value="–ì—Ä—É–ø–∞">–ì—Ä—É–ø–∞</option>
          <option value="–°—É–ø–µ—Ä–≤—ñ–∑—ñ—è">–°—É–ø–µ—Ä–≤—ñ–∑—ñ—è</option>
          <option value="–õ–µ–∫—Ü—ñ—è">–õ–µ–∫—Ü—ñ—è</option>
          <option value="–°–µ–º—ñ–Ω–∞—Ä">–°–µ–º—ñ–Ω–∞—Ä</option>
        </select>
      </div>

      <div class="editable-block" id="moderationBlock">
        <label>–ú–æ–¥–µ—Ä–∞—Ü—ñ—è</label>
        <div style="display: flex; gap: 10px; flex-wrap: wrap">
          <button
            type="button"
            class="submit-btn"
            id="approveBtn"
            onclick="approveCourse()"
          >
            ‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏
          </button>
          <button
            type="button"
            class="submit-btn"
            id="rejectBtn"
            onclick="rejectCourse()"
            style="background: #a31d1d"
          >
            ‚ùå –í—ñ–¥—Ö–∏–ª–∏—Ç–∏
          </button>
          <span
            id="statusHint"
            style="align-self: center; color: #8f8f8f; font-weight: 500"
          ></span>
        </div>
      </div>

      <button class="submit-btn" onclick="saveChanges()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
      <button class="submit-btn danger" id="deleteBtn" onclick="deleteCourse()">
        üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ –∫—É—Ä—Å
      </button>
    </div>
    <script src="admin-auth.js"></script>
    <script>

      const API = "https://cabinet.mamko-prof-supervision.com";

      
    function isApproved(user) {
    const s = String(user.status || "").toUpperCase().trim();
    // —Å–µ—Ä–≤–µ—Ä –æ—Ç–¥–∞—ë—Ç approved, –Ω–æ –ø–æ–¥—Å—Ç—Ä–∞—Ö—É–µ–º—Å—è –ø–æ–¥ –≤–∞—Ä–∏–∞–Ω—Ç—ã
    return ["APPROVED"].includes(s);
  }


  function logoutUser() {
    try {
      localStorage.removeItem("user");
      ["token", "authToken", "jwt", "accessToken", "bearer"].forEach((k) =>
        localStorage.removeItem(k)
      );
    } catch (_) {}

    // Attempt backend logout (ignore network errors)
    fetch(`/api/users/logout`, {
      method: "POST",
      credentials: "include",
    }).catch(() => {});

    // Redirect to admin login with return URL
    const back = encodeURIComponent(location.pathname + location.search);
    location.href = `admin-login.html?returnUrl=${back}`;
  }
  // expose to window in case admin-auth.js references it directly
  window.logoutUser = logoutUser;
  // --- Page bootstrap ---
  document.addEventListener("DOMContentLoaded", () => {
    if (typeof renderAdminSidebar === "function") {
      renderAdminSidebar("admin-course-details.html");
    }
    if (typeof requireAdminPage === "function") {
      requireAdminPage();
    }
    loadCourseDetails();
    bindDateRangeUI();
    highlightActiveSidebar();
  });

  // --- State ---
  let courseId;
  let allUsers = [];
  let selectedParticipantIds = [];
  let courseParticipants = [];
  let unitMembersTargetCard = null;
  let unitMembersAvailable = [];
  let unitMembersCurrent = [];

  const UNIT_DAY_OPTIONS = [
    "–ü–æ–Ω–µ–¥—ñ–ª–æ–∫",
    "–í—ñ–≤—Ç–æ—Ä–æ–∫",
    "–°–µ—Ä–µ–¥–∞",
    "–ß–µ—Ç–≤–µ—Ä",
    "–ü‚Äô—è—Ç–Ω–∏—Ü—è",
    "–°—É–±–æ—Ç–∞",
    "–ù–µ–¥—ñ–ª—è",
  ];
  const UNIT_TYPE_OPTIONS = [
    "–û—Å–æ–±–∏—Å—Ç–∏–π –∞–Ω–∞–ª—ñ–∑",
    "–Ü–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–∞ —Å—É–ø–µ—Ä–≤—ñ–∑—ñ—è",
    "–ì—Ä—É–ø–æ–≤–∞ —Å—É–ø–µ—Ä–≤—ñ–∑—ñ—è",
    "–ú–µ–Ω—Ç–æ—Ä—Å—å–∫–µ –∑–∞–Ω—è—Ç—Ç—è",
    "–õ–µ–∫—Ü—ñ—è",
    "–°–µ–º—ñ–Ω–∞—Ä",
    "–¢–µ—Ä–∞–ø–µ–≤—Ç–∏—á–Ω–∞ –≥—Ä—É–ø–∞",
    "–°—É–ø–µ—Ä–≤—ñ–∑—ñ–π–Ω–æ-—Å–µ–º—ñ–Ω–∞—Ä—Å—å–∫–µ –∑–∞–Ω—è—Ç—Ç—è",
    "–ü–∞—Ä–Ω–∞ —Ç–µ—Ä–∞–ø—ñ—è",
    "–õ–µ–∫—Ç–æ—Ä—ñ–π",
  ];

  // --- Utils ---
  function $(id) { return document.getElementById(id); }

  function getAuthHeaders() {
    let token = null;
    try {
      const u = JSON.parse(localStorage.getItem("user") || "null");
      token = u?.token || u?.accessToken || null;
    } catch (_) {}
    const h = { "Content-Type": "application/json" };
    if (token) h.Authorization = `Bearer ${token}`;
    return h;
  }

  function enableEdit(id) {
    const el = $(id);
    if (!el) return;
    el.disabled = false;
    el.focus();
  }

  function normalizeUserId(value) {
    if (!value) return "";
    if (typeof value === "string") return value;
    if (typeof value === "object") return value._id || value.id || "";
    return "";
  }

  function getUserLabelById(userId) {
    const id = normalizeUserId(userId);
    if (!id) return "";
    const fromAll = Array.isArray(allUsers)
      ? allUsers.find((u) => normalizeUserId(u) === id)
      : null;
    const fromCourse = Array.isArray(courseParticipants)
      ? courseParticipants.find((u) => normalizeUserId(u) === id)
      : null;
    const user = fromAll || fromCourse;
    if (!user) return id;
    return (
      user.fullName ||
      [user.firstName, user.lastName].filter(Boolean).join(" ").trim() ||
      user.email ||
      id
    );
  }

  function getUserLabel(user) {
    if (!user) return "";
    return (
      user.fullName ||
      [user.firstName, user.lastName].filter(Boolean).join(" ").trim() ||
      user.email ||
      normalizeUserId(user)
    );
  }

  // --- Date helpers for single-input range control ---
  const pad2 = (n) => String(n).padStart(2, "0");
  function toYMD(val) {
    if (!val) return "";
    if (/^\d{4}-\d{2}-\d{2}$/.test(val)) return val;
    const d = new Date(val);
    if (isNaN(d)) return "";
    return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
  }
  function toDMY(val) {
    if (!val) return "";
    const d = /^\d{4}-\d{2}-\d{2}$/.test(val) ? new Date(val + "T12:00:00") : new Date(val);
    if (isNaN(d)) return "";
    return `${pad2(d.getDate())}.${pad2(d.getMonth() + 1)}.${d.getFullYear()}`;
  }
  function normalizeISO(val) {
    if (!val) return "";
    if (/^\d{4}-\d{2}-\d{2}$/.test(val)) return new Date(val + "T12:00:00").toISOString();
    const d = new Date(val);
    return isNaN(d) ? "" : d.toISOString();
  }
  function setDateRangeDisplay(startVal, endVal) {
    const sIso = normalizeISO(startVal);
    const eIso = normalizeISO(endVal);
    const input = $("dateRangeInput");
    if (input) input.value = (sIso || eIso) ? `${toDMY(sIso)} ‚Äì ${toDMY(eIso)}` : "";
  }

  function parseUnitMembersData(value) {
    if (!value) return [];
    try {
      const parsed = JSON.parse(value);
      return Array.isArray(parsed) ? parsed : [];
    } catch (_) {
      return [];
    }
  }

  function normalizeUnitMember(member) {
    const userId = normalizeUserId(member?.user || member);
    if (!userId) return null;
    const mode = member?.mode === "–ø—Ä–æ–≤–æ–¥–∏–≤" ? "–ø—Ä–æ–≤–æ–¥–∏–≤" : "–ø—Ä–æ—Ö–æ–¥–∏–≤";
    return { user: userId, mode };
  }

  function normalizeUnitMembers(members) {
    if (!Array.isArray(members)) return [];
    return members.map(normalizeUnitMember).filter(Boolean);
  }

  function formatUnitMembersSummary(members) {
    if (!members.length) return "–ù–µ–º–∞—î —É—á–∞—Å–Ω–∏–∫—ñ–≤";
    const names = members.map((m) => getUserLabelById(m.user)).filter(Boolean);
    const limit = 4;
    if (names.length <= limit) return names.join(", ");
    return `${names.slice(0, limit).join(", ")} +${names.length - limit}`;
  }

  function updateUnitMembersSummary(card) {
    if (!card) return;
    const summary = card.querySelector(".unit-members-summary");
    if (!summary) return;
    const members = parseUnitMembersData(card.dataset.members);
    summary.textContent = formatUnitMembersSummary(members);
  }

  function updateAllUnitMemberSummaries() {
    document.querySelectorAll(".unit-card").forEach((card) => updateUnitMembersSummary(card));
  }

  function createSelectOptions(select, options, value, allowEmpty) {
    if (!select) return;
    const emptyOpt = allowEmpty ? '<option value="">‚Äî</option>' : "";
    select.innerHTML =
      emptyOpt +
      options
        .map((opt) => `<option value="${opt}">${opt}</option>`)
        .join("");
    if (value) select.value = value;
  }

  function getDayNameFromDate(value) {
    if (!value) return "";
    const date = new Date(`${value}T12:00:00`);
    if (isNaN(date.getTime())) return "";
    const map = ["–ù–µ–¥—ñ–ª—è", "–ü–æ–Ω–µ–¥—ñ–ª–æ–∫", "–í—ñ–≤—Ç–æ—Ä–æ–∫", "–°–µ—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä", "–ü‚Äô—è—Ç–Ω–∏—Ü—è", "–°—É–±–æ—Ç–∞"];
    return map[date.getDay()] || "";
  }

  function createUnitCard(unit = {}) {
    const card = document.createElement("div");
    card.className = "unit-card";
    if (unit._id) card.dataset.unitId = unit._id;

    const members = normalizeUnitMembers(unit.members);
    card.dataset.members = JSON.stringify(members);

    card.innerHTML = `
      <div class="unit-grid">
        <label>–î–µ–Ω—å —Ç–∏–∂–Ω—è
          <select class="unit-day"></select>
        </label>
        <label>–î–∞—Ç–∞
          <input class="unit-date" type="date" />
        </label>
        <label>–ü–æ—á–∞—Ç–æ–∫
          <input class="unit-start" type="time" />
        </label>
        <label>–ö—ñ–Ω–µ—Ü—å
          <input class="unit-end" type="time" />
        </label>
        <label>–¢–∏–ø
          <select class="unit-type"></select>
        </label>
        <label>–ù–∞–∑–≤–∞
          <input class="unit-title" type="text" />
        </label>
        <label>–ì–æ–¥–∏–Ω–∏
          <input class="unit-hours" type="number" step="0.25" min="0" />
        </label>
      </div>
      <div class="unit-meta-row">
        <div class="unit-members-row">
          <span class="unit-members-summary"></span>
          <button type="button" class="unit-action-btn secondary" onclick="openUnitMembersModal(this)">–£—á–∞—Å–Ω–∏–∫–∏</button>
        </div>
        <button type="button" class="unit-action-btn danger" onclick="removeUnitCard(this)">–í–∏–¥–∞–ª–∏—Ç–∏</button>
      </div>
    `;

    const daySelect = card.querySelector(".unit-day");
    const typeSelect = card.querySelector(".unit-type");
    const dayValue = unit.dayName === "–ü'—è—Ç–Ω–∏—Ü—è" ? "–ü‚Äô—è—Ç–Ω–∏—Ü—è" : (unit.dayName || "");
    createSelectOptions(daySelect, UNIT_DAY_OPTIONS, dayValue, true);
    createSelectOptions(typeSelect, UNIT_TYPE_OPTIONS, unit.unitType || "", true);

    const dateInput = card.querySelector(".unit-date");
    const startInput = card.querySelector(".unit-start");
    const endInput = card.querySelector(".unit-end");
    const titleInput = card.querySelector(".unit-title");
    const hoursInput = card.querySelector(".unit-hours");

    dateInput.value = toYMD(unit.date);
    startInput.value = unit.startTime || "";
    endInput.value = unit.endTime || "";
    titleInput.value = unit.title || "";
    hoursInput.value = Number.isFinite(Number(unit.hours)) ? Number(unit.hours) : "";

    updateUnitMembersSummary(card);
    return card;
  }

  function renderUnits(units) {
    const container = $("unitsContainer");
    if (!container) return;
    container.innerHTML = "";
    if (!Array.isArray(units) || !units.length) {
      container.innerHTML = '<div class="units-empty">–ù–µ–º–∞—î —é–Ω—ñ—Ç—ñ–≤</div>';
      return;
    }
    units.forEach((unit) => {
      container.appendChild(createUnitCard(unit));
    });
  }

  function addUnitCard() {
    const container = $("unitsContainer");
    if (!container) return;
    if (container.querySelector(".units-empty")) container.innerHTML = "";
    container.appendChild(createUnitCard({}));
  }

  function removeUnitCard(btn) {
    const card = btn?.closest(".unit-card");
    if (!card) return;
    const container = $("unitsContainer");
    card.remove();
    if (container && !container.querySelector(".unit-card")) {
      container.innerHTML = '<div class="units-empty">–ù–µ–º–∞—î —é–Ω—ñ—Ç—ñ–≤</div>';
    }
  }

  function buildUnitsPayload() {
    const cards = document.querySelectorAll(".unit-card");
    const units = [];
    let hasInvalid = false;

    cards.forEach((card) => {
      const unitType = card.querySelector(".unit-type")?.value?.trim() || "";
      const dayNameRaw = card.querySelector(".unit-day")?.value?.trim() || "";
      const dateVal = card.querySelector(".unit-date")?.value || "";
      const startTime = card.querySelector(".unit-start")?.value || "";
      const endTime = card.querySelector(".unit-end")?.value || "";
      const title = card.querySelector(".unit-title")?.value?.trim() || "";
      const hoursValue = card.querySelector(".unit-hours")?.value || "";

      if (!unitType) {
        card.classList.remove("unit-card-error");
        return;
      }

      const dayName = dayNameRaw || (dateVal ? getDayNameFromDate(dateVal) : "");
      if (!dayName) {
        hasInvalid = true;
        card.classList.add("unit-card-error");
        return;
      }

      card.classList.remove("unit-card-error");

      const hoursNumber = Number(hoursValue);
      const hours = Number.isFinite(hoursNumber) && hoursNumber > 0 ? hoursNumber : null;
      const members = parseUnitMembersData(card.dataset.members)
        .map(normalizeUnitMember)
        .filter(Boolean);

      const payload = {
        dayName,
        date: dateVal ? new Date(`${dateVal}T12:00:00`).toISOString() : null,
        startTime,
        endTime,
        unitType,
        title,
        hours,
        members,
      };

      const unitId = card.dataset.unitId;
      if (unitId) payload._id = unitId;

      units.push(payload);
    });

    if (hasInvalid) {
      return { error: "–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –¥–µ–Ω—å —Ç–∏–∂–Ω—è –∞–±–æ –¥–∞—Ç—É –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —é–Ω—ñ—Ç–∞ –∑ —Ç–∏–ø–æ–º." };
    }

    return { units };
  }

  // --- Load course (with fallback if :id returns 404) ---
  async function loadCourseDetails() {
    const params = new URLSearchParams(window.location.search);
    courseId = params.get("id");
    if (!courseId) {
      alert("–ù–µ –≤–∫–∞–∑–∞–Ω–æ ID –∫—É—Ä—Å—É");
      location.href = "admin-all-courses.html";
      return;
    }

    try {
      // 1) –ü—Ä—è–º–∞ —Å–ø—Ä–æ–±–∞ –æ—Ç—Ä–∏–º–∞—Ç–∏ –∫—É—Ä—Å –∑–∞ id
      let res = await fetch(`${API}/api/courses/${courseId}`, { credentials: "include" });

      if (res.status === 404) {
        // 2) –§–æ–ª–±–µ–∫: —à—É–∫–∞—î–º–æ –∫–æ—Ä–µ–∫—Ç–Ω–∏–π _id —É —Å–ø–∏—Å–∫—É –∫—É—Ä—Å—ñ–≤
        const listRes = await fetch(`${API}/api/courses`, { credentials: "include" });
        if (!listRes.ok) {
          const errJ = await listRes.json().catch(() => ({}));
          throw new Error(errJ.message || `HTTP ${listRes.status}`);
        }
        const all = await listRes.json();

        // –ü–æ—à—É–∫ —Ç–æ—á–Ω–æ–≥–æ –∑–±—ñ–≥—É, –ø–æ—Ç—ñ–º –∑–∞ –ø—Ä–µ—Ñ—ñ–∫—Å–æ–º/—Å—É—Ñ—ñ–∫—Å–æ–º
        let found = all.find(c => String(c._id) === String(courseId));
        if (!found) {
          found = all.find(c =>
            String(c._id).startsWith(String(courseId)) ||
            String(c._id).endsWith(String(courseId))
          );
        }

        if (!found) {
          // –ü–æ–∫–∞–∑—É—î–º–æ –∑—Ä–æ–∑—É–º—ñ–ª–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —ñ –Ω–µ –ª–∞–º–∞—î–º–æ —Å—Ç–æ—Ä—ñ–Ω–∫—É
          const box = document.createElement('div');
          box.style.cssText = 'padding:12px;border:1px solid #f1c40f;background:#fff8e1;border-radius:8px;margin-bottom:12px;color:#8a6d3b';
          box.textContent = "–ö—É—Ä—Å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ (ID –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π –∞–±–æ –∑–∞–ø–∏—Å –≤—ñ–¥—Å—É—Ç–Ω—ñ–π).";
          const container = document.querySelector('.course-detail');
          if (container) container.prepend(box);
          console.warn('[admin-course-details] 404 and not found in list, leaving page in place.');
          return;
        }

        // –Ø–∫—â–æ –∑–Ω–∞–π—à–ª–∏ —ñ–Ω—à–∏–π —Å–ø—Ä–∞–≤–∂–Ω—ñ–π _id ‚Äî –æ–Ω–æ–≤–ª—é—î–º–æ URL —ñ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ
        if (String(found._id) !== String(courseId)) {
          const u = new URL(location.href);
          u.searchParams.set("id", found._id);
          console.log('[admin-course-details] Redirecting to resolved id:', found._id);
          location.replace(u.toString());
          return;
        }

        // –Ø–∫—â–æ –∑–Ω–∞–π–¥–µ–Ω–∏–π id —Å–ø—ñ–≤–ø–∞–¥–∞—î ‚Äî –ø—Ä–æ–±—É—î–º–æ —â–µ —Ä–∞–∑ –ø—Ä—è–º–∏–π GET
        res = await fetch(`${API}/api/courses/${found._id}`, { credentials: "include" });
      }

      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        throw new Error(data.message || `HTTP ${res.status}`);
      }

      const course = await res.json();
      console.log("[admin-course-details] loaded course:", course);

      // ====== –ó–∞–ø–æ–≤–Ω—é—î–º–æ –ø–æ–ª—è ======
      $("title").value       = course.courseTitle || "";
      $("eventType").value   = course.eventType || "";
      $("subtitle").value    = course.courseSubtitle || "";
      $("description").value = course.courseDescription || "";
      $("access").value      = course.accessType || "";
      $("duration").value    = course.courseDuration || "";
      $("price").value       = course.coursePrice || "";
      $("zoom").value        = course.zoomLink || "";

      $("creatorName").value =
        course.creatorName ||
        (course.creatorId ? ([course.creatorId.firstName, course.creatorId.lastName].filter(Boolean).join(" ") || course.creatorId.email || "") : "");
      $("creatorRole").value =
        course.creatorRole ||
        (course.creatorId ? (course.creatorId.role || (Array.isArray(course.creatorId.roles) ? course.creatorId.roles.join(", ") : "")) : "");

      // –¢–∏–ø –≥—Ä—É–ø–∏: –æ–∫—Ä–µ–º–µ –ø–æ–ª–µ –∞–±–æ fallback –Ω–∞ accessType
      $("groupType").value = (course.groupType || course.accessType || "");

      // –î–∞—Ç–∏
      const start = course.courseDates && course.courseDates.start;
      const end   = course.courseDates && course.courseDates.end;
      $("startDate").value = toYMD(start);
      $("endDate").value   = toYMD(end);
      setDateRangeDisplay(start, end);

      // –°–µ–ª–µ–∫—Ç –≤–∏–¥—É –∫—É—Ä—Å—É
      if ($("eventTypeSel") && course.eventType) $("eventTypeSel").value = course.eventType;

      // –°—Ç–∞—Ç—É—Å
      if ($("statusHint")) $("statusHint").textContent = course.status ? `–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞—Ç—É—Å: ${course.status}` : "";

      // –ü—É–±–ª—ñ—á–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è (—è–∫—â–æ –±–µ–∫ –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—î ‚Äî –º–æ–∂–µ –±—É—Ç–∏ –ø–æ—Ä–æ–∂–Ω—î)
      $("siteLink").value = course.siteLink || course.publicUrl || course.pageUrl || course.website || course.websiteUrl || "";

      // –£—á–∞—Å–Ω–∏–∫–∏
      selectedParticipantIds = (course.participants || []).map(p => typeof p === "string" ? p : (p && p._id ? p._id : p));
      courseParticipants = Array.isArray(course.participants) ? course.participants : [];
      renderUnits(Array.isArray(course.units) ? course.units : []);
      try {
        const usersRes = await fetch(`${API}/api/users`, { credentials: "include" });
        if (usersRes.ok) {
          allUsers = await usersRes.json();
          updateParticipantsUI();
          updateAllUnitMemberSummaries();
        }
      } catch (_) {}
    } catch (err) {
      console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –∫—É—Ä—Å—É:", err);
      const box = document.createElement('div');
      box.style.cssText = 'padding:12px;border:1px solid #e74c3c;background:#fdecea;border-radius:8px;margin-bottom:12px;color:#b0413e';
      box.textContent = err.message || "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫—É—Ä—Å—É";
      const container = document.querySelector('.course-detail');
      if (container) container.prepend(box);
    }
  }

  // --- Save ---
  async function saveChanges() {
    const startVal = $("startDate")?.value || "";
    const endVal   = $("endDate")?.value || "";
    const rawSite  = $("siteLink")?.value?.trim() || "";
    const siteLink = rawSite && !/^https?:\/\//i.test(rawSite) ? "https://" + rawSite : rawSite;

    const body = {
      eventType:        $("eventTypeSel") ? $("eventTypeSel").value : $("eventType").value,
      courseTitle:      $("title").value,
      courseSubtitle:   $("subtitle").value,
      courseDescription:$("description").value,
      accessType:       $("access").value,
      courseDuration:   $("duration").value,
      coursePrice:      $("price").value,
      zoomLink:         $("zoom").value,
      siteLink, publicUrl: siteLink, pageUrl: siteLink, website: siteLink, websiteUrl: siteLink,
      participants:     selectedParticipantIds,
      courseDates: {
        start: startVal ? new Date(startVal + (startVal.length === 10 ? "T12:00:00" : "")).toISOString() : null,
        end:   endVal   ? new Date(endVal   + (endVal.length   === 10 ? "T12:00:00" : "")).toISOString()   : null,
      },
    };

    const unitsResult = buildUnitsPayload();
    if (unitsResult.error) {
      alert(unitsResult.error);
      return;
    }
    body.units = unitsResult.units;

    try {
      const res = await fetch(`${API}/api/courses/${courseId}`, {
        method: "PUT",
        credentials: "include",
        headers: getAuthHeaders(),
        body: JSON.stringify(body),
      });
      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        throw new Error(data.message || `HTTP ${res.status}`);
      }
      alert("–î–∞–Ω—ñ –æ–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ");
      document.querySelectorAll("textarea, input[type='text']").forEach(el => el.disabled = true);
      loadCourseDetails();
    } catch (err) {
      console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ:", err);
      alert(err.message || "–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ");
    }
  }

  // --- Delete (–ø—Ä–æ—Å—Ç–∞—è –≤–µ—Ä—Å–∏—è) ---
  async function deleteCourse() {
    if (!courseId) { alert("–ù–µ –≤–∫–∞–∑–∞–Ω–æ ID –∫—É—Ä—Å—É"); return; }
    if (!confirm("–¢–æ—á–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∫—É—Ä—Å? –î—ñ—é –Ω–µ–º–æ–∂–ª–∏–≤–æ —Å–∫–∞—Å—É–≤–∞—Ç–∏.")) return;
    try {
      const r = await fetch(`${API}/api/courses/${courseId}`, {
        method: "DELETE",
        credentials: "include",
        headers: getAuthHeaders(),
      });
      if (!r.ok) {
        const d = await r.json().catch(() => ({}));
        throw new Error(d.message || `HTTP ${r.status}`);
      }
      alert("–ö—É—Ä—Å –≤–∏–¥–∞–ª–µ–Ω–æ");
      location.href = "admin-all-courses.html";
    } catch (e) {
      console.error(e);
      alert(e.message || "–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è");
    }
  }

  // --- Approve / Reject ---
  async function approveCourse() {
    if (!courseId) return;
    try {
      const r = await fetch(`${API}/api/courses/${courseId}/approve`, { method: "PUT", credentials: "include" });
      if (!r.ok) {
        const d = await r.json().catch(() => ({}));
        throw new Error(d.message || `HTTP ${r.status}`);
      }
      alert("–ö—É—Ä—Å –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ");
      loadCourseDetails();
    } catch (e) {
      console.error(e);
      alert(e.message || "–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è");
    }
  }

  async function rejectCourse() {
    if (!courseId) return;
    const reason = prompt("–ü—Ä–∏—á–∏–Ω–∞ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è (–Ω–µ–æ–±–æ–≤ º—è–∑–∫–æ–≤–æ):", "");
    try {
      const r = await fetch(`${API}/api/courses/${courseId}/reject`, {
        method: "PUT",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ reason }),
      });
      if (!r.ok) {
        const d = await r.json().catch(() => ({}));
        throw new Error(d.message || `HTTP ${r.status}`);
      }
      alert("–ö—É—Ä—Å –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ");
      loadCourseDetails();
    } catch (e) {
      console.error(e);
      alert(e.message || "–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è");
    }
  }

  // --- Date popover (UI) ---
  function bindDateRangeUI() {
    const input   = $("dateRangeInput");
    const pop     = $("datePopover");
    const pStart  = $("pickerStart");
    const pEnd    = $("pickerEnd");
    const applyBt = $("applyDates");
    const cancelBt= $("cancelDates");
    const editBtn = $("dateEditBtn");
    if (!input || !pop) return;

    const hiddenStart = () => $("startDate");
    const hiddenEnd   = () => $("endDate");

    function open() {
      if (pStart) pStart.value = hiddenStart()?.value || "";
      if (pEnd)   pEnd.value   = hiddenEnd()?.value   || "";
      pop.classList.add("open");
      setTimeout(() => { try { pStart && pStart.focus(); } catch(_){} }, 0);
    }
    function close() { pop.classList.remove("open"); }

    input.addEventListener("click", open);
    editBtn && editBtn.addEventListener("click", (e) => { e.stopPropagation(); open(); });
    cancelBt && cancelBt.addEventListener("click", close);
    applyBt && applyBt.addEventListener("click", () => {
      if (pStart && hiddenStart()) hiddenStart().value = pStart.value || "";
      if (pEnd && hiddenEnd())     hiddenEnd().value   = pEnd.value   || "";
      setDateRangeDisplay(pStart?.value || "", pEnd?.value || "");
      close();
    });

    document.addEventListener("click", (e) => {
      const t = e.target;
      if (pop.contains(t) || t === input || t === editBtn) return;
      close();
    });
    pop.addEventListener("click", (e) => e.stopPropagation());
  }

  // --- Participants modal ---
  async function openParticipantsModal() {
    try {
      // —Ç—è–Ω–µ–º —Ç–æ–ª—å–∫–æ approved —Å –±—ç–∫–∞; –µ—Å–ª–∏ 404/–Ω–µ—Ç —Ä–æ—É—Ç–∞ ‚Äî –±–µ—Ä—ë–º –≤—Å–µ—Ö –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
      let users = [];
      let res = await fetch(`${API}/api/users/approved`, { credentials: "include" });
      if (res.ok) {
        users = await res.json();
      } else {
        // fallback
        res = await fetch(`${API}/api/users`, { credentials: "include" });
        users = res.ok ? await res.json() : [];
        users = users.filter(isApproved);
      }

      // –û—Ç—Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –§–ò–û
      users.sort((a,b)=>{
        const an = `${a.firstName||""} ${a.lastName||""}`.trim().toLowerCase();
        const bn = `${b.firstName||""} ${b.lastName||""}`.trim().toLowerCase();
        return an.localeCompare(bn);
      });

      allUsers = users;                 // —Ç–æ–ª—å–∫–æ approved
      renderUserList(allUsers);         // –æ—Ç—Ä–∏—Å–æ–≤–∞–ª–∏ —Å–ø–∏—Å–æ–∫
      $("participantsModal").style.display = "flex";
    } catch (err) {
      console.error("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤:", err);
      alert("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤");
    }
  }


 function renderUserList(users) {
    const container = $("userList");
    container.innerHTML = "";

    // –ü–∞–Ω–µ–ª—å –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
    const bar = document.createElement("div");
    bar.style.cssText = "display:flex;gap:8px;align-items:center;position:sticky;top:0;background:#fffef9;padding:6px 0;";
    bar.innerHTML = `
      <label style="display:flex;align-items:center;gap:6px;">
        <input type="checkbox" id="checkAllBox" />
        –í–∏–¥—ñ–ª–∏—Ç–∏ –≤—Å—ñ—Ö (–≤–∏–¥–∏–º–∏—Ö)
      </label>
      <button type="button" id="clearAllBtn" class="submit-btn" style="padding:6px 10px;background:#888;">–û—á–∏—Å—Ç–∏—Ç–∏</button>
    `;
    container.appendChild(bar);

    const list = document.createElement("div");
    list.id = "userListInner";
    container.appendChild(list);

    // –°–∞–º–∏ —á–µ–∫–±–æ–∫—Å—ã
    users.forEach((user) => {
      const fullName = [user.firstName, user.lastName].filter(Boolean).join(" ").trim();
      const label = fullName || user.email || "(–±–µ–∑ —ñ–º–µ–Ω—ñ)";
      const id = user._id || user.id;

      const row = document.createElement("label");
      row.style.display = "block";
      row.style.padding = "6px 0";
      row.innerHTML = `
        <input type="checkbox" value="${id}" ${selectedParticipantIds.includes(id) ? "checked" : ""}/>
        ${label}
      `;
      list.appendChild(row);
    });

    // ‚Äú–í–∏–¥—ñ–ª–∏—Ç–∏ –≤—Å—ñ—Ö (–≤–∏–¥–∏–º–∏—Ö)‚Äù
    const checkAll = $("checkAllBox");
    checkAll.onchange = () => {
      const boxes = list.querySelectorAll('input[type="checkbox"]');
      boxes.forEach(cb => { cb.checked = checkAll.checked; });
    };

    // ‚Äú–û—á–∏—Å—Ç–∏—Ç–∏‚Äù
    $("clearAllBtn").onclick = () => {
      const boxes = list.querySelectorAll('input[type="checkbox"]');
      boxes.forEach(cb => { cb.checked = false; });
      if (checkAll) checkAll.checked = false;
    };
  }

   function applySelectedParticipants() {
    const boxes = document.querySelectorAll('#userListInner input[type="checkbox"]');
    selectedParticipantIds = Array.from(boxes).filter(cb => cb.checked).map(cb => cb.value);
    updateParticipantsUI();
    closeParticipantsModal();
  }

  function closeParticipantsModal() {
    $("participantsModal").style.display = "none";
  }

  function filterParticipants(e) {
    const q = (e.target.value || "").toLowerCase().trim();
    const filtered = allUsers.filter(u => {
      const name = [u.firstName, u.lastName].filter(Boolean).join(" ").toLowerCase();
      const email = String(u.email || "").toLowerCase();
      return name.includes(q) || email.includes(q);
    });
    renderUserList(filtered);
  }

  function updateParticipantsUI() {
    const input = $("participantsText");
    if (!input) return;
    const names = selectedParticipantIds.map((id) => getUserLabelById(id)).filter(Boolean);
    input.value = names.join(", ");
  }

  function getAvailableUnitUsers() {
    const map = new Map();
    if (Array.isArray(allUsers)) {
      allUsers.forEach((u) => {
        const id = normalizeUserId(u);
        if (id) map.set(id, u);
      });
    }
    if (Array.isArray(courseParticipants)) {
      courseParticipants.forEach((u) => {
        const id = normalizeUserId(u);
        if (id && !map.has(id)) map.set(id, u);
      });
    }
    let users = Array.from(map.values());
    if (Array.isArray(selectedParticipantIds) && selectedParticipantIds.length) {
      const set = new Set(selectedParticipantIds.map((id) => String(id)));
      users = users.filter((u) => set.has(String(normalizeUserId(u))));
    }
    users.sort((a, b) => getUserLabel(a).localeCompare(getUserLabel(b), "uk"));
    return users;
  }

  function openUnitMembersModal(btn) {
    const card = btn?.closest(".unit-card");
    if (!card) return;
    unitMembersTargetCard = card;
    unitMembersAvailable = getAvailableUnitUsers();
    unitMembersCurrent = parseUnitMembersData(card.dataset.members).map(normalizeUnitMember).filter(Boolean);
    const search = $("unitMembersSearch");
    if (search) search.value = "";
    renderUnitMembersList("");
    $("unitMembersModal").style.display = "flex";
  }

  function closeUnitMembersModal() {
    $("unitMembersModal").style.display = "none";
    unitMembersTargetCard = null;
    unitMembersAvailable = [];
    unitMembersCurrent = [];
  }

  function renderUnitMembersList(query) {
    const container = $("unitMembersList");
    if (!container) return;
    const q = (query || "").toLowerCase().trim();
    container.innerHTML = "";

    if (!unitMembersAvailable.length) {
      container.textContent = "–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö —É—á–∞—Å–Ω–∏–∫—ñ–≤";
      return;
    }

    const membersMap = new Map(
      unitMembersCurrent.map((m) => [normalizeUserId(m.user), m.mode])
    );

    unitMembersAvailable
      .filter((u) => {
        const label = getUserLabel(u).toLowerCase();
        return !q || label.includes(q);
      })
      .forEach((user) => {
        const id = normalizeUserId(user);
        const label = getUserLabel(user) || id;
        const mode = membersMap.get(id) || "–ø—Ä–æ—Ö–æ–¥–∏–≤";
        const checked = membersMap.has(id);

        const row = document.createElement("label");
        row.className = "unit-member-row";
        row.innerHTML = `
          <input type="checkbox" value="${id}" ${checked ? "checked" : ""} />
          <span>${label}</span>
          <select ${checked ? "" : "disabled"}>
            <option value="–ø—Ä–æ—Ö–æ–¥–∏–≤">–£—á–∞—Å–Ω–∏–∫</option>
            <option value="–ø—Ä–æ–≤–æ–¥–∏–≤">–õ–µ–∫—Ç–æ—Ä</option>
          </select>
        `;
        const select = row.querySelector("select");
        select.value = mode;
        const checkbox = row.querySelector('input[type="checkbox"]');
        checkbox.onchange = () => {
          select.disabled = !checkbox.checked;
        };
        container.appendChild(row);
      });
  }

  function syncUnitMembersDraft() {
    const rows = document.querySelectorAll("#unitMembersList .unit-member-row");
    const draft = [];
    rows.forEach((row) => {
      const checkbox = row.querySelector('input[type="checkbox"]');
      const select = row.querySelector("select");
      if (!checkbox || !select || !checkbox.checked) return;
      draft.push({
        user: checkbox.value,
        mode: select.value === "–ø—Ä–æ–≤–æ–¥–∏–≤" ? "–ø—Ä–æ–≤–æ–¥–∏–≤" : "–ø—Ä–æ—Ö–æ–¥–∏–≤",
      });
    });
    unitMembersCurrent = draft;
  }

  function filterUnitMembers(e) {
    syncUnitMembersDraft();
    renderUnitMembersList(e?.target?.value || "");
  }

  function applyUnitMembers() {
    if (!unitMembersTargetCard) return;
    const rows = document.querySelectorAll("#unitMembersList .unit-member-row");
    const updated = [];
    rows.forEach((row) => {
      const checkbox = row.querySelector('input[type="checkbox"]');
      const select = row.querySelector("select");
      if (!checkbox || !select || !checkbox.checked) return;
      updated.push({
        user: checkbox.value,
        mode: select.value === "–ø—Ä–æ–≤–æ–¥–∏–≤" ? "–ø—Ä–æ–≤–æ–¥–∏–≤" : "–ø—Ä–æ—Ö–æ–¥–∏–≤",
      });
    });
    unitMembersTargetCard.dataset.members = JSON.stringify(updated);
    updateUnitMembersSummary(unitMembersTargetCard);
    closeUnitMembersModal();
  }

  // --- Sidebar active highlight (tiny helper) ---
  function highlightActiveSidebar() {
    const here = location.pathname.split("/").pop();
    document.querySelectorAll(".sidebar nav a").forEach((a) => {
      if (a.getAttribute("href") === here) a.classList.add("active");
    });
  }
</script>

    <div id="participantsModal" class="modal" style="display: none">
      <div class="modal-content" style="max-height: 70vh; overflow-y: auto">
        <h3>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —É—á–∞—Å–Ω–∏–∫—ñ–≤</h3>
        <input
          type="text"
          placeholder="–ü–æ—à—É–∫..."
          oninput="filterParticipants(event)"
        />
        <div id="userList" style="margin: 10px 0"></div>
        <button onclick="applySelectedParticipants()">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
        <button onclick="closeParticipantsModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      </div>
    </div>

    <div id="unitMembersModal" class="modal" style="display: none">
      <div class="modal-content" style="max-height: 70vh; overflow-y: auto">
        <h3>–£—á–∞—Å–Ω–∏–∫–∏ —é–Ω—ñ—Ç–∞</h3>
        <input
          id="unitMembersSearch"
          type="text"
          placeholder="–ü–æ—à—É–∫..."
          oninput="filterUnitMembers(event)"
        />
        <div id="unitMembersList" style="margin: 10px 0"></div>
        <button onclick="applyUnitMembers()">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
        <button onclick="closeUnitMembersModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      </div>
    </div>
  </body>
</html>
