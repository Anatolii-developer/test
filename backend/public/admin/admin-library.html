<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ –∫—É—Ä—Å—ñ–≤</title>
  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-overlay {
  position: absolute;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
}

.modal-content {
  position: relative;
  background: #fff;
  border-radius: 16px;
  max-width: 480px;
  width: 90%;
  padding: 32px;
  z-index: 10;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
  font-family: 'Poppins', sans-serif;
}

.modal-content h2 {
  margin-top: 0;
  font-size: 22px;
  margin-bottom: 20px;
  text-align: center;
}

.close-btn {
  position: absolute;
  top: 16px;
  right: 20px;
  font-size: 24px;
  cursor: pointer;
  color: #888;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-bottom: 18px;
}

.form-group label {
  font-weight: 500;
  font-size: 14px;
}

.form-group input,
.form-group textarea,
.form-group select {
  padding: 10px 12px;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 14px;
  font-family: 'Poppins', sans-serif;
}

.form-group textarea {
  resize: vertical;
  min-height: 80px;
}

.submit-btn {
  width: 100%;
  background-color: #48a868;
  color: white;
  font-weight: 600;
  font-size: 16px;
  padding: 14px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.3s ease;
}

.submit-btn:hover {
  background-color: #3c9359;
}

  </style>
</head>
<body class="with-sidebar">
  <aside class="sidebar" id="sidebar"></aside>

    <div class="main-content">
      <div class="materials-header">
        <button class="btn-green">–î–æ–¥–∞—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏ –¥–æ –∫—É—Ä—Å—ñ–≤</button>
        <button class="btn-light-green">–î–æ–¥–∞—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏ –≥—Ä—É–ø–∏</button>
      </div>

     <div class="filters">
  <input type="text" id="searchInput" placeholder="–ü–æ—à—É–∫ –∑–∞ —ñ–º'—è–º" />

  <select id="roleFilter">
    <option value="">–£—Å—ñ —Ä–æ–ª—ñ</option>
  </select>

  <label for="courseSelect">–û–±–µ—Ä—ñ—Ç—å –∫—É—Ä—Å</label>
<select id="courseSelect">
  <option value="">-- –û–±–µ—Ä—ñ—Ç—å –∫—É—Ä—Å --</option>
</select>


  <button id="selectAllBtn" class="btn-light-green">–í–∏–¥—ñ–ª–∏—Ç–∏ –≤—Å—ñ—Ö</button>
</div>

      <table class="participants-table">
        <thead>
          <tr>
            <th>#</th>
            <th>–Ü–º‚Äô—è —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–µ</th>
            <th>Email</th>
            <th>–†–æ–ª—å</th>
            <th>–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è</th>
            <th>–û–±—Ä–∞—Ç–∏</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="date-time">
        <label>–û–±–µ—Ä—ñ—Ç—å –¥–∞—Ç—É —Ç–∞ —á–∞—Å –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó</label>
        <input type="date" />
        <input type="time" />
      </div>

      <div class="action-buttons">
        <button class="btn-green-add">–î–æ–¥–∞—Ç–∏ –≤—ñ–¥–µ–æ</button>
        <button class="btn-dark-green">–î–æ–¥–∞—Ç–∏ –∫–Ω–∏–≥—É</button>
      </div>

      <button class="submit-button">Submit</button>
    </div>
  </div>
  <script src="admin-auth.js"></script>
  
  <script>
  const API_BASE = "http://157.230.121.24:5050";
  let selectAllClicked = false;
  let allUsers = [];
  const rolesById = new Map();     // _id -> name
  const rolesByName = new Map();   // name -> _id

  async function loadRoles() {
    const res = await fetch(`${API_BASE}/api/roles`);
    if (!res.ok) throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ —Ä–æ–ª—ñ');
    const roles = await res.json(); // [{ _id, name }]
    const sel = document.getElementById("roleFilter");
    sel.innerHTML = `<option value="">–£—Å—ñ —Ä–æ–ª—ñ</option>`;
    roles.forEach(r => {
      rolesById.set(String(r._id), r.name);
      rolesByName.set(r.name, String(r._id));
      const opt = document.createElement("option");
      opt.value = String(r._id);
      opt.textContent = r.name;
      sel.appendChild(opt);
    });
  }

  function normalizeUserRoleIds(user){
    if (Array.isArray(user.roleIds)) return user.roleIds.map(String);
    if (Array.isArray(user.roles))   return user.roles.map(r => String(rolesByName.get(r) || r));
    if (user.roleId)                 return [String(user.roleId)];
    if (user.role)                   return [String(rolesByName.get(user.role) || user.role)];
    return [];
  }

  function renderTable(users) {
    const tbody = document.querySelector(".participants-table tbody");
    tbody.innerHTML = "";

    users.forEach((user, index) => {
      const fullName = `${user.firstName || ""} ${user.lastName || ""}`.trim();
      const roleIds = normalizeUserRoleIds(user);
      const roleNames = roleIds.map(id => rolesById.get(id) || id);
      const roleText = roleNames.length ? roleNames.join(", ") : "-";

      const dob = user.dateOfBirth ? new Date(user.dateOfBirth).toLocaleDateString("uk-UA") : "-";

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${index + 1}</td>
        <td>${fullName}</td>
        <td>${user.email || ""}</td>
        <td>${roleText}</td>
        <td>${dob}</td>
        <td>
          <img 
            src="images/checkbox-empty.png" 
            alt="checkbox" 
            class="custom-checkbox" 
            data-role-ids='${JSON.stringify(roleIds)}'
            data-checked="false"
            style="width: 24px; height: 24px; cursor: pointer;" />
        </td>
      `;
      tbody.appendChild(row);
    });
  }

  function applyFilters() {
    const searchValue = document.getElementById("searchInput").value.toLowerCase();
    const selectedRoleId = document.getElementById("roleFilter").value;

    const filtered = allUsers.filter(user => {
      const name = `${user.firstName || ""} ${user.lastName || ""}`.toLowerCase();
      const matchName = name.includes(searchValue);

      if (!selectedRoleId) return matchName;

      const roleIds = normalizeUserRoleIds(user);
      const matchRole = roleIds.includes(String(selectedRoleId));
      return matchName && matchRole;
    });

    renderTable(filtered);
  }

  document.addEventListener("DOMContentLoaded", async () => {
    if (typeof renderAdminSidebar === "function") {
      renderAdminSidebar("admin-career-requests.html");
    }
    if (typeof requireAdminPage === "function") {
      requireAdminPage();
    }
    if (typeof load === "function") {
      load();
    }

    // 1) –°–Ω–∞—á–∞–ª–∞ —Ä–æ–ª–∏
    try {
      await loadRoles();
    } catch (e) {
      console.error("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ä–æ–ª—ñ:", e);
    }

    // 2) –ö—É—Ä—Å–∏
    async function loadCurrentCourses() {
      const res = await fetch(`${API_BASE}/api/courses`);
      const allCourses = await res.json();
      const currentCourses = allCourses.filter(c => c.status === "–ü–æ—Ç–æ—á–Ω–∏–π");

      const courseSelect = document.getElementById("courseSelect");
      courseSelect.innerHTML = `<option value="">-- –û–±–µ—Ä—ñ—Ç—å –∫—É—Ä—Å --</option>`;
      currentCourses.forEach(course => {
        const opt = document.createElement("option");
        opt.value = course._id;
        opt.textContent = course.courseTitle;
        courseSelect.appendChild(opt);
      });
    }
    await loadCurrentCourses();

    // 3) –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ
    try {
      const response = await fetch(`${API_BASE}/api/users/approved`);
      allUsers = await response.json();
      renderTable(allUsers);
    } catch (err) {
      console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤:", err);
    }

    // –û–±—Ä–æ–±–Ω–∏–∫–∏
    document.getElementById("courseSelect").addEventListener("change", async (e) => {
      const courseId = e.target.value;
      if (!courseId) return;
      try {
        const res = await fetch(`${API_BASE}/api/courses/${courseId}/participants`);
        const users = await res.json();
        allUsers = users;
        applyFilters();
      } catch (err) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ —É—á–∞—Å–Ω–∏–∫—ñ–≤ –∫—É—Ä—Å—É:", err);
      }
    });

    document.getElementById("searchInput").addEventListener("input", applyFilters);
    document.getElementById("roleFilter").addEventListener("change", applyFilters);

    document.getElementById("selectAllBtn").addEventListener("click", () => {
      selectAllClicked = true;
      const selectedRoleId = document.getElementById("roleFilter").value;

      document.querySelectorAll(".custom-checkbox").forEach(cb => {
        if (!selectedRoleId) {
          cb.src = "images/checkbox.png";
          cb.dataset.checked = "true";
          return;
        }
        const roleIds = JSON.parse(cb.dataset.roleIds || "[]");
        const match = roleIds.includes(String(selectedRoleId));
        cb.src = match ? "images/checkbox.png" : "images/checkbox-empty.png";
        cb.dataset.checked = match.toString();
      });
    });

    document.addEventListener("click", (e) => {
      if (e.target.classList.contains("custom-checkbox")) {
        const checkbox = e.target;
        const isChecked = checkbox.dataset.checked === "true";
        checkbox.src = isChecked ? "images/checkbox-empty.png" : "images/checkbox.png";
        checkbox.dataset.checked = (!isChecked).toString();
      }
    });

    document.querySelector(".btn-green-add").addEventListener("click", () => {
      openModal("video");
    });
    document.querySelector(".btn-dark-green").addEventListener("click", () => {
      openModal("book");
    });
  });

function openModal(type) {
  document.getElementById("addMaterialModal").style.display = "block";
  document.getElementById("materialType").value = type;
  toggleInputs(type);
}
function closeModal() {
  document.getElementById("addMaterialModal").style.display = "none";
}

document.getElementById("materialType").addEventListener("change", e => {
  toggleInputs(e.target.value);
});



async function submitMaterial() {
  const type = document.getElementById("materialType").value;
  const title = document.getElementById("materialTitle").value;
  const description = document.getElementById("materialDescription").value;
  const selectedCourseId = document.getElementById("courseSelect").value;
  const selectedRoleId = document.getElementById("roleFilter").value;

  const formData = new FormData();
  formData.append("type", type);
  formData.append("title", title);
  formData.append("description", description);

  if (type === "video") {
    const link = document.getElementById("videoLink").value;
    formData.append("videoLink", link);
  } else {
    const file = document.getElementById("bookFile").files[0];
    if (!file) return alert("–û–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª");
    formData.append("bookFile", file);
  }

  // üëâ –û—Ç–º–µ—á–µ–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏
  const checkedUsers = [...document.querySelectorAll(".custom-checkbox")]
    .filter(cb => cb.dataset.checked === "true");
if (selectedRoleId) {
  formData.append("destination", "addons");
  formData.append("roleId", selectedRoleId);
  const roleName = rolesById.get(String(selectedRoleId));
  if (roleName) formData.append("role", roleName); // –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –±—ç–∫—É –Ω—É–∂–Ω–æ –∏–º—è
} else if (selectedCourseId) {
  formData.append("destination", "courses");
  formData.append("courseId", selectedCourseId);
} else if (selectAllClicked) {
  formData.append("destination", "general");
} else {
  alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å –∫—É—Ä—Å, —Ä–æ–ª—å –∞–±–æ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å '–í–∏–¥—ñ–ª–∏—Ç–∏ –≤—Å—ñ—Ö'");
  return;
}

  try {
    await fetch("http://157.230.121.24:5050/api/library", {
      method: "POST",
      body: formData
    });
    alert("–£—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ!");
    closeModal();
  } catch (err) {
    alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ.");
    console.error(err);
  }
}

function toggleInputs(type) {
  document.getElementById("videoInput").style.display = type === "video" ? "block" : "none";
  document.getElementById("bookInput").style.display = type === "book" ? "block" : "none";
}

     function logoutUser(){
    try{
      // —á–∏—Å—Ç–∏–º–æ –ª–æ–∫–∞–ª—å–Ω–µ
      localStorage.removeItem('user');
      ['token','authToken','jwt','accessToken','bearer'].forEach(k => localStorage.removeItem(k));
    }catch(_){}

    // –ø—Ä–æ–±—É—î–º–æ –≤–∏–π—Ç–∏ —ñ –Ω–∞ –±–µ–∫–µ–Ω–¥—ñ (—ñ–≥–Ω–æ—Ä—É—î–º–æ –ø–æ–º–∏–ª–∫–∏ –º–µ—Ä–µ–∂—ñ)
    const API = ""; // —è–∫—â–æ –±–µ–∫ —ñ —Ñ—Ä–æ–Ω—Ç –Ω–∞ –æ–¥–Ω–æ–º—É –¥–æ–º–µ–Ω—ñ ‚Äî –∑–∞–ª–∏—à –ø–æ—Ä–æ–∂–Ω—ñ–º
    fetch(`${API}/api/users/logout`, { method:'POST', credentials:'include' }).catch(()=>{});

    // —Ä–µ–¥—ñ—Ä–µ–∫—Ç –Ω–∞ –ª–æ–≥—ñ–Ω –∑ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è–º
    const back = encodeURIComponent(location.pathname + location.search);
    location.href = `admin-login.html?returnUrl=${back}`;
  }

  // –ø—Ä–∏–≤‚Äô—è–∑—É—î–º–æ –¥–æ –∫–Ω–æ–ø–∫–∏
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('btnLogout');
    if (btn) btn.addEventListener('click', logoutUser);
  });

  document.addEventListener('DOMContentLoaded', () => {
  const here = location.pathname.split('/').pop();
  document.querySelectorAll('.sidebar nav a').forEach(a=>{
    if (a.getAttribute('href') === here) a.classList.add('active');
  });
});

  </script>
 <div id="addMaterialModal" class="modal" style="display:none;">
  <div class="modal-overlay" onclick="closeModal()"></div>
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal()">√ó</span>
    <h2>–î–æ–¥–∞—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª</h2>

    <div class="form-group">
      <label for="materialType">–¢–∏–ø –º–∞—Ç–µ—Ä—ñ–∞–ª—É</label>
      <select id="materialType">
        <option value="video">üé• –í—ñ–¥–µ–æ (YouTube)</option>
        <option value="book">üìò –ö–Ω–∏–≥–∞ (PDF)</option>
      </select>
    </div>

    <div class="form-group">
      <label for="materialTitle">–ù–∞–∑–≤–∞</label>
      <input type="text" id="materialTitle" placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É" />
    </div>

    <div class="form-group">
      <label for="materialDescription">–û–ø–∏—Å</label>
      <textarea id="materialDescription" placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å..."></textarea>
    </div>

    <div class="form-group" id="videoInput" style="display: none;">
      <label for="videoLink">–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ YouTube</label>
      <input type="url" id="videoLink" placeholder="https://www.youtube.com/watch?v=..." />
    </div>

    <div class="form-group" id="bookInput" style="display: none;">
      <label for="bookFile">PDF —Ñ–∞–π–ª</label>
      <input type="file" id="bookFile" accept="application/pdf" />
    </div>

    <button class="submit-btn" onclick="submitMaterial()">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
  </div>
</div>

</div>
</body>
</html>
