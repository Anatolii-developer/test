<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Тема форуму</title>
<link rel="stylesheet" href="./forum.css">
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body.with-sidebar .wrap {
        margin-left: 250px;
      }
      .wrap {
        width: 1110px;
        margin: 80px auto 40px; /* more breathing room from top */
        background: transparent;
        border-radius: 24px;
        padding: 0 0 40px;
      }
      .thread-head {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        align-items: center;
      }
      .title {
        font-size: 22px;
        font-weight: 700;
      }
      .meta {
        color: #777;
        font-size: 12px;
      }
      .btn {
        border: none;
        border-radius: 10px;
        padding: 8px 12px;
        cursor: pointer;
        font-weight: 600;
      }
      .btn-primary {
        background: #275d2b;
        color: #fff;
      }
      .btn-danger {
        background: #a31d1d;
        color: #fff;
      }
      .btn-ghost {
        background: #f3f4f6;
      }
      .badge {
        display: inline-block;
        background: #ecf5eb;
        color: #275d2b;
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 12px;
        margin-left: 6px;
      }
      .post {
        border: 1px solid #e37009;
        border-radius: 12px;
        padding: 12px 14px;
        background: #fffdf7;
      }
      .post + .post {
        margin-top: 10px;
      }
      .post .post-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .post .actions {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .composer {
        margin-top: 16px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .composer textarea {
        width: 100%;
        min-height: 110px;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 12px;
      }
      @media (max-width: 1180px) {
        body.with-sidebar .wrap {
          margin-left: 0;
        }
        .wrap {
          width: 90%;
          margin: 56px auto 30px; /* comfortable top spacing on tablets/mobiles */
          padding: 30px;
        }
      }
      .attachments-preview {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 6px;
      }
      .attachments-preview img {
        max-width: 140px;
        max-height: 140px;
        border-radius: 8px;
        border: 1px solid #eee;
      }
      .reply-context {
        display: none;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 10px;
        background: #f3f6ff;
        color: #25467a;
        font-size: 12px;
      }
      .reply-context .close {
        cursor: pointer;
        font-weight: 700;
        border: none;
        background: transparent;
      }

    /* ===== Title card (header) ===== */
    .thread-card{
      width: 100%;
      min-height: 190px;
      background: #FFFFF9;
      border-radius: 16px;
      padding: 50px 104px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
    }
    .thread-card__left{ display:flex; flex-direction:column; gap:18px; }

    .thread-title{
      max-width: 700px;
      font-family: Poppins, Inter, sans-serif;
      font-weight: 600;
      font-size: 32px;
      line-height: 38px;
      color: #414141;
    }

    .thread-author{ display:flex; align-items:center; gap:12px; }
    .thread-avatar{
      width:40px; height:40px; border-radius:50%; object-fit:cover; flex:0 0 40px;
    }
    .thread-author-col{ display:flex; flex-direction:column; }
    .thread-author-name{
      font: 500 18px Poppins, Inter, sans-serif;
      color:#275D2B;
    }
    .thread-author-meta{
      font: 400 12px Poppins, Inter, sans-serif;
      color:#97C194;
    }

    .thread-answers{
      flex:0 0 auto;
      width: 140px;
      text-align: right;
      display:flex; align-items:center; justify-content:flex-end;
      font: 400 16px Poppins, Inter, sans-serif;
      color:#6b6b6b;
      opacity:.9;
    }

    /* ===== Moderator actions row ===== */
    .mod-actions{
      display:flex;
      flex-wrap: nowrap;   /* prevent wrapping */
      justify-content:center;
      gap:24px;           /* adjust spacing between buttons */
      margin:24px 0 12px;
    }
    .mod-btn{
      width:196px;
      height:48px;
      padding:10px 53px;
      border-radius:24px;
      border:none;
      background:#275D2B;
      color:#fff;
      font:500 16px 'Poppins', sans-serif;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,.12);
      transition:transform .06s ease, filter .15s ease;
    }
    .mod-btn:hover{ filter:brightness(.95); transform:translateY(-1px); }
    .mod-btn:active{ transform:translateY(0); }

    .mod-icon {
      width: 20px;
      height: 20px;
      display: inline-block;
      object-fit: contain;
    }

    @media (max-width:1180px){
      .wrap{ width:90%; padding:0 0 30px; }
      .thread-card{ padding:32px; }
      .thread-title{ font-size:28px; line-height:34px; }
    }
    </style>
  </head>
  <body class="with-sidebar">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="wrap">
      <div class="thread-card">
    <div class="thread-card__left">
      <div class="thread-title" id="tTitle">...</div>
      <div class="thread-author">
        <img class="thread-avatar" src="/assets/profile-photo.png" alt="" />
        <div class="thread-author-col">
          <div class="thread-author-name" id="tAuthor">—</div>
          <div class="thread-author-meta" id="tMeta">—</div>
        </div>
      </div>
    </div>
    <div class="thread-answers" id="tAnswers">—</div>
  </div>

  <div id="tModActions" class="mod-actions" style="display:none">
    <button class="mod-btn" id="btnPin">
      <img src="/assets/forum/attach.svg" alt="" class="mod-icon"/>
      <span>Закріпити</span>
    </button>
    <button class="mod-btn" id="btnPrivacy">
      <img src="/assets/forum/lock.svg" alt="" class="mod-icon"/>
      <span>Приватна</span>
    </button>
    <button class="mod-btn" id="btnDelThread">
      <img src="/assets/forum/trash.svg" alt="" class="mod-icon"/>
      <span>Видалити</span>
    </button>
    <button class="mod-btn" id="btnLock">
      <img src="/assets/forum/lock.svg" alt="" class="mod-icon"/>
      <span>Закрити</span>
    </button>
    <button class="mod-btn" id="btnInvite">
      <img src="/assets/forum/add-icon.svg" alt="" class="mod-icon"/>
      <span>Запросити</span>
    </button>
  </div>

      <div id="posts" style="margin-top: 16px"></div>

      <div id="composer" class="composer">
  <div id="replyCtx" class="reply-context">
    Відповідь на:&nbsp;<span id="replyToWho"></span>
    <button id="replyCancel" class="close" title="Скасувати">×</button>
  </div>
  <textarea id="replyText" placeholder="Ваша відповідь..."></textarea>

  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
    <input id="replyFiles" type="file" multiple />
    <button class="btn btn-primary" id="btnReply">Надіслати</button>
    <span class="meta" id="lockHint" style="display:none">Тема закрита для нових відповідей</span>
  </div>

  <!-- превью выбранных файлов -->
  <div id="preview" class="attachments-preview"></div>
</div>
    </main>

    <script src="./forum.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        if (typeof renderAdminSidebar === "function")
          renderAdminSidebar("forum/index.html");
        await Forum.init();

        const id = new URLSearchParams(location.search).get("id");
        const $files = document.getElementById("replyFiles");
        const $preview = document.getElementById("preview");
        const $text = document.getElementById("replyText");

        // ---- reply-to (threaded) state ----
        let currentParentId = null;

        // Chip elements
        const $replyCtx = document.getElementById("replyCtx");
        const $replyToWho = document.getElementById("replyToWho");
        const $replyCancel = document.getElementById("replyCancel");

        function showReplyCtx({ author = "", snippet = "" } = {}) {
          $replyToWho.textContent = author ? `${author}: ${snippet}` : "";
          $replyCtx.style.display = author ? "inline-flex" : "none";
        }
        function clearReplyCtx() {
          currentParentId = null;
          $replyCtx.style.display = "none";
          $replyToWho.textContent = "";
        }
        // Allow Forum.renderPosts() to call this
        window.setReplyParent = function (postId, opts = {}) {
          currentParentId = postId;
          showReplyCtx({
            author: (opts.author || "").toString(),
            snippet: (opts.snippet || "").toString().slice(0, 80)
          });
          // Focus composer
          $text?.focus();
        };
        // Also support custom event if Forum.renderPosts dispatches it
        document.addEventListener("forum:set-reply-parent", (e) => {
          const { postId, author, snippet } = e.detail || {};
          if (!postId) return;
          window.setReplyParent(postId, { author, snippet });
        });
        // Cancel button
        $replyCancel?.addEventListener("click", clearReplyCtx);

        $files.addEventListener("change", () => {
  $preview.innerHTML = "";
  [...$files.files].forEach(f => {
    if (f.type.startsWith("image/")) {
      const url = URL.createObjectURL(f);
      const img = document.createElement("img");
      img.src = url;
      img.onload = () => URL.revokeObjectURL(url);
      $preview.appendChild(img);
    } else {
      const div = document.createElement("div");
      div.className = "meta";
      div.textContent = `Файл: ${f.name} (${Math.round(f.size/1024)} KB)`;
      $preview.appendChild(div);
    }
  });
});

document.getElementById("btnReply").addEventListener("click", async () => {
  const content = $text.value.trim();
  const hasFiles = $files.files && $files.files.length > 0;

  if (!content && !hasFiles) return;

    try {
      if (hasFiles) {
        const form = new FormData();
        form.append("content", content);
        if (currentParentId) form.append("parentId", currentParentId);
        [...$files.files].forEach(f => form.append("files", f));

        const res = await fetch(`/api/forum/threads/${id}/posts-with-files`, {
          method: "POST",
          body: form,
          credentials: "include"
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || "Помилка");
      } else {
        // JSON path — передаем parentId
        await Forum.api.addPost(id, { content, parentId: currentParentId || undefined });
      }

      // очистка и перерисовка
      $text.value = "";
      $files.value = "";
      $preview.innerHTML = "";
      clearReplyCtx();

      const data = await Forum.api.getThread(id);
      Forum.renderPosts("#posts", data.posts, { thread: data.thread });
    } catch (e) {
      alert(e.message || e);
    }
});

        if (!id) return (location.href = "./index.html");

        const { thread, posts } = await Forum.api.getThread(id);

// ==== Fill title card (header) ====
const $titleEl   = document.getElementById('tTitle');
const $authorEl  = document.getElementById('tAuthor');
const $metaEl    = document.getElementById('tMeta');
const $answersEl = document.getElementById('tAnswers');

if ($titleEl)  $titleEl.textContent  = thread.title || '';
if ($authorEl) $authorEl.textContent = (thread.author?.fullName || thread.author?.username || thread.author?.email || '—');

// Compose meta like: "Створив: NAME • DATE • (📌 Закріплено) (🔒 Закрито) (🔐 Приватна)"
const createdBy  = (thread.author?.username || thread.author?.email || '—');
const createdAt  = (()=>{ try { return new Date(thread.createdAt).toLocaleString('uk-UA'); } catch { return '';} })();
let metaParts = [ `Створив: ${createdBy}`, createdAt ];
if (thread.pinned) metaParts.push('📌 Закріплено');
if (thread.locked) metaParts.push('🔒 Закрито');
if (thread.isPrivate) metaParts.push('🔐 Приватна');
if ($metaEl) $metaEl.textContent = metaParts.filter(Boolean).join(' • ');

// Answers count (prefer posts.length, fallback to thread.postsCount)
const answers = Array.isArray(posts) ? posts.length : (thread.postsCount || 0);
if ($answersEl) $answersEl.textContent = `${answers} відповідей`;

// Render posts below
Forum.renderPosts('#posts', posts, { thread });
        
        // хто може бачити мод-кнопки: модератор або автор теми
        const me = (() => { try { return JSON.parse(localStorage.getItem('user') || 'null'); } catch { return null; } })();
        const canModThis = Forum.can("moderate:threads") || (me && thread.author && String(me._id) === String(thread.author._id));

        // mod/owner buttons
        if (canModThis) {
          const $actions = document.getElementById("tModActions");
          if ($actions) $actions.style.display = "flex";

          const $btnPin = document.getElementById("btnPin");
          const $btnLock = document.getElementById("btnLock");
          const $btnDel = document.getElementById("btnDelThread");
          const $btnPrivacy = document.getElementById("btnPrivacy");
          const $btnInvite = document.getElementById("btnInvite");

          $btnPin && ($btnPin.onclick = async () => { await Forum.api.togglePin(id); location.reload(); });
          $btnLock && ($btnLock.onclick = async () => { await Forum.api.toggleLock(id); location.reload(); });
          $btnDel && ($btnDel.onclick = async () => {
            if (!confirm("Видалити тему?")) return;
            await Forum.api.deleteThread(id);
            location.href = "./index.html";
          });

          // приватність
          $btnPrivacy && ($btnPrivacy.onclick = async () => {
            const next = !thread.isPrivate;
            await Forum.api.togglePrivate(id, next);
            location.reload();
          });

          // запрошення
          $btnInvite && ($btnInvite.onclick = async () => {
            const userId = prompt("Введіть ID користувача, якого запросити:");
            if (!userId) return;
            try {
              await Forum.api.addParticipant(id, userId.trim());
              alert("Користувача додано до приватної теми");
            } catch (e) {
              alert(e.message || e);
            }
          });
        }
    
      });

      // Update renderThreadHead to support new header placeholders while keeping backward compatibility
      function renderThreadHead(thread, selTitle, selMeta, selActions) {
        // Back-compat: still fill passed selectors
        const $t = selTitle ? document.querySelector(selTitle) : null;
        const $m = selMeta ? document.querySelector(selMeta) : null;
        if ($t) $t.textContent = thread.title || '';
        if ($m) {
          const createdBy  = (thread.author?.username || thread.author?.email || '—');
          const createdAt  = fmtDate(thread.createdAt);
          const parts = [ `Створив: ${createdBy}`, createdAt ];
          if (thread.pinned) parts.push('📌 Закріплено');
          if (thread.locked) parts.push('🔒 Закрито');
          if (thread.isPrivate) parts.push('🔐 Приватна');
          $m.textContent = parts.filter(Boolean).join(' • ');
        }
        // New header placeholders (if present on page)
        const $authorEl  = document.getElementById('tAuthor');
        const $answersEl = document.getElementById('tAnswers');
        if ($authorEl) $authorEl.textContent = (thread.author?.fullName || thread.author?.username || thread.author?.email || '—');
        if ($answersEl && Number.isFinite(thread.postsCount)) $answersEl.textContent = `${thread.postsCount} відповідей`;

        if (selActions && can('moderate:threads')) {
          const $a = document.querySelector(selActions);
          if ($a) $a.style.display = 'flex';
        }
      }
    </script>
  </body>
</html>
