<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Усі курси - Admin</title>
  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body class="with-sidebar">
  <aside class="sidebar" id="sidebar"></aside>
 <main class="admin-main">

<div class="completed-nav-buttons">
  <div class="top-buttons">
     <a href="admin-create-course.html" class="completed-nav-button create">Створити</a>
    <button class="completed-nav-button" data-status="Запланований">Заплановані</button>
    <button class="completed-nav-button" data-status="Поточний">Поточні</button>
    <button class="completed-nav-button" data-status="Пройдений">Пройдені</button>
  </div>

  <div class="bottom-center-button">
    <button class="completed-nav-button" data-status="WAITING_FOR_APPROVAL">Заявки на курси</button>
  </div>
</div>



    <!-- All Courses Table -->
    <div class="course-table-container">
      <table class="course-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Тема</th>
            <th>Користувач</th>
            <th>Роль</th>
            <th>Дата запуску</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="coursesTableBody">
        </tbody>
      </table>
    </div>
  </main>
  <script>
  window.API_BASE = "https://cabinet.mamko-prof-supervision.com";
</script>
<script src="admin-auth.js"></script>
  <script>
      document.addEventListener("DOMContentLoaded", () => {
        if (typeof renderAdminSidebar === "function") {
          renderAdminSidebar("admin-all-courses.html");
        }
        if (typeof requireAdminPage === "function") {
          requireAdminPage();
        }
        if (typeof load === "function") {
          load();
        }

        const defaultStatus = "WAITING_FOR_APPROVAL";
        fetchCourses(defaultStatus);

        // Подсветить кнопку по умолчанию
        const defaultBtn = document.querySelector(`.completed-nav-button[data-status="${defaultStatus}"]`);
        if (defaultBtn) defaultBtn.classList.add("active");

        // Назначить обработчики для кнопок (один раз)
        document.querySelectorAll('.completed-nav-button[data-status]').forEach(button => {
          button.addEventListener('click', () => {
            const status = button.getAttribute('data-status');
            fetchCourses(status);

            document.querySelectorAll('.completed-nav-button').forEach(btn => btn.classList.remove("active"));
            button.classList.add("active");
          });
        });
      });

  function creatorDisplayName(course) {
    // 1) prefer saved flat string
    if (course.creatorName && String(course.creatorName).trim()) {
      return course.creatorName;
    }
    // 2) fallback to populated creatorId object
    const c = course.creatorId || {};
    // try explicit fullName
    if (c.fullName && String(c.fullName).trim()) return c.fullName;
    // try first/last
    const full = [c.firstName, c.lastName].filter(Boolean).join(' ').trim();
    if (full) return full;
    // last fallback: email
    if (c.email && String(c.email).trim()) return c.email;
    return '-';
  }

  function creatorDisplayRole(course) {
    // 1) prefer saved flat string
    if (course.creatorRole && String(course.creatorRole).trim()) {
      return course.creatorRole;
    }
    const c = course.creatorId || {};
    // Roles may be in different shapes:
    // - c.role: string or object { name/title }
    // - c.roles: array of strings or objects
    const takeName = (r) => {
      if (!r) return null;
      if (typeof r === 'string') return r;
      if (typeof r === 'object') return r.name || r.title || r.role || null;
      return null;
    };

    // single role
    const single = takeName(c.role);
    if (single) return single;

    // multiple roles
    if (Array.isArray(c.roles) && c.roles.length) {
      const arr = c.roles
        .map(takeName)
        .filter(Boolean);
      if (arr.length) return arr.join(', ');
    }

    // sometimes API uses "role" as array at root course level (defensive)
    if (Array.isArray(course.creatorRole) && course.creatorRole.length) {
      const arr = course.creatorRole.map(takeName).filter(Boolean);
      if (arr.length) return arr.join(', ');
    }

    return '-';
  }


  async function fetchCourses(filterStatus = "WAITING_FOR_APPROVAL") {
    try {
      const res = await fetch(`${API_BASE}/api/courses`);
      const courses = await res.json();

      const tbody = document.getElementById("coursesTableBody");
      tbody.innerHTML = "";

      const filteredCourses = filterStatus
        ? courses.filter(course => course.status === filterStatus)
        : courses;

      filteredCourses.forEach((course, index) => {
        const tr = document.createElement("tr");
        const name = creatorDisplayName(course);
        const role = creatorDisplayRole(course);

        if (name === '-' || role === '-') {
          console.warn('Missing creator name/role for course', course._id, {
            creatorName: course.creatorName,
            creatorRole: course.creatorRole,
            creatorId: course.creatorId
          });
        }

        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${course.courseTitle || "-"}</td>
          <td>${name}</td>
          <td>${role}</td>
          <td>${formatDate(course.courseDates?.start)}</td>
          <td>
            <a href="admin-course-details.html?id=${course._id}" class="more-button">More</a>
            ${filterStatus === "WAITING_FOR_APPROVAL"
              ? `<button onclick="approveCourse('${course._id}')">✅ Підтвердити</button>` : ""}
          </td>
        `;
        tbody.appendChild(tr);
      });
    } catch (err) {
      console.error("Помилка при отриманні курсів:", err);
    }
  }

  async function approveCourse(courseId) {
    try {
      const res = await fetch(`${API_BASE}/api/courses/${courseId}/approve`, {
        method: "PUT",
      });

      if (res.ok) {
        alert("Курс підтверджено!");
        fetchCourses("WAITING_FOR_APPROVAL");
      } else {
        const result = await res.json();
        alert("❌ " + result.message);
      }
    } catch (err) {
      console.error("❌", err);
      alert("Серверна помилка");
    }
  }


  function formatDate(dateString) {
    if (!dateString) return "-";
    const date = new Date(dateString);
    return date.toLocaleDateString("uk-UA");
  }

  function logoutUser(){
    try{
      // чистимо локальне
      localStorage.removeItem('user');
      ['token','authToken','jwt','accessToken','bearer'].forEach(k => localStorage.removeItem(k));
    }catch(_){}

    // пробуємо вийти і на бекенді (ігноруємо помилки мережі)
    const API = ""; // якщо бек і фронт на одному домені — залиш порожнім
    fetch(`${API}/api/users/logout`, { method:'POST', credentials:'include' }).catch(()=>{});

    // редірект на логін з поверненням
    const back = encodeURIComponent(location.pathname + location.search);
    location.href = `admin-login.html?returnUrl=${back}`;
  }

  // прив’язуємо до кнопки
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('btnLogout');
    if (btn) btn.addEventListener('click', logoutUser);
  });

  document.addEventListener('DOMContentLoaded', () => {
  const here = location.pathname.split('/').pop();
  document.querySelectorAll('.sidebar nav a').forEach(a=>{
    if (a.getAttribute('href') === here) a.classList.add('active');
  });
});

</script>

</body>
</html>
