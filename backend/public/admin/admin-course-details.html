<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Створити курс</title>
  <link rel="stylesheet" href="admin-styles.css" />
  <style>
    .form-container {
      width: 890px;
      margin: 40px auto;
      padding: 60px 100px;
      border-radius: 24px;
      background: #fffef9;
      font-family: 'Poppins', sans-serif;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    .form-group label {
      font-weight: 600;
      margin-bottom: 6px;
    }
    .form-group textarea, .form-group input {
      padding: 12px;
      font-size: 16px;
      border: 2px solid #E37009;
      border-radius: 8px;
      background-color: #fffef9;
      color: #333;
      min-height: 48px;
    }
    .submit-btn {
      align-self: flex-end;
      margin-top: 20px;
      background-color: #E37009;
      color: white;
      border: none;
      padding: 14px 24px;
      font-size: 16px;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
    }
    .tag {
      background: #E37009;
      color: white;
      border-radius: 16px;
      padding: 4px 12px;
      margin: 4px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
    }
    .remove-btn {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
    }
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 12px;
      width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <aside class="sidebar" id="sidebar">
    <!-- Логотип -->
    <img class="logo" src="../assets/sidebar/IPS Logo (2).svg" alt="Logo" id="logoExpanded" />
  
    <p style="margin-left: 12px; font-weight: 600;">Admin</p>
  
    <!-- Навигация -->
    <nav>
      <a href="admin-requests.html"><img src="../assets/sidebar/profile.svg" /><span>Профайли</span></a>
      <a href="admin-certificate.html"><img src="../assets/sidebar/news.svg" /><span>Сертифікати</span></a>
      <a href="#"><img src="../assets/sidebar/3.svg" /><span>Планування кар'єри</span></a>
      <a href="#"><img src="../assets/sidebar/4.svg" /><span>Бібліотека</span></a>
      <a href="admin-all-courses.html"><img src="../assets/sidebar/5.svg" /><span>Курси</span></a>
      <a href="#"><img src="../assets/sidebar/6.svg" /><span>Облік практики</span></a>
      <a href="#"><img src="../assets/sidebar/7.svg" /><span>Здоров’я</span></a>
      <a href="#"><img src="../assets/sidebar/8.svg" /><span>Фінанси</span></a>
      <a href="#"><img src="../assets/sidebar/9.svg" /><span>Нерухомість</span></a>
    </nav>
  
    <!-- Настройки + выход -->
    <div style="margin-top: auto;">
      <a href="#"><img src="../assets/sidebar/settings.svg" /><span>Налаштування</span></a>
      <div class="logout" onclick="logoutUser()">
        <img src="../assets/sidebar/log-out.svg" alt="Logout Icon" width="20" height="20" />
        <span>Logout Account</span>
      </div>
    </div>
  </aside>

  <div class="form-container">
    <h1>Створити курс</h1>

    <div class="form-group">
      <label for="courseTitle">Назва курсу</label>
      <textarea id="courseTitle"></textarea>
    </div>

    <div class="form-group">
      <label for="eventType">Тип</label>
      <textarea id="eventType"></textarea>
    </div>

    <div class="form-group">
      <label for="courseSubtitle">Підзаголовок</label>
      <textarea id="courseSubtitle"></textarea>
    </div>

    <div class="form-group">
      <label for="courseDescription">Опис</label>
      <textarea id="courseDescription"></textarea>
    </div>

    <div class="form-group">
      <label for="accessType">Тип доступу</label>
      <textarea id="accessType"></textarea>
    </div>

    <div class="form-group">
      <label for="courseDuration">Тривалість</label>
      <textarea id="courseDuration"></textarea>
    </div>

    <div class="form-group">
      <label for="coursePrice">Ціна</label>
      <textarea id="coursePrice"></textarea>
    </div>

    <div class="form-group">
      <label for="zoomLink">Zoom</label>
      <textarea id="zoomLink"></textarea>
    </div>

    <div class="form-group">
      <label>Учасники</label>
      <div id="selectedParticipants" style="margin-bottom: 10px;"></div>
      <button type="button" onclick="openUserModal()">Додати учасників</button>
      <select id="participantsSelect" name="participants" multiple hidden></select>
    </div>

    <button class="submit-btn" onclick="createCourse()">Створити</button>
  </div>

  <div id="userModal" class="modal">
    <div class="modal-content">
      <h3>Вибрати учасників</h3>
      <input type="text" placeholder="Пошук..." oninput="filterUsers(event)" style="width: 100%; margin-bottom: 10px; padding: 8px;"/>
      <div id="userList" style="max-height: 300px; overflow-y: auto;"></div>
      <button onclick="confirmParticipants()">Підтвердити</button>
      <button onclick="closeUserModal()">Скасувати</button>
    </div>
  </div>

  <script>
    let allUsers = [];
    let selectedUserIds = new Set();

    function getFullName(user) {
      // Fallbacks: support {firstName,lastName}, {fullName}, or {name}
      const firstLast = [user.firstName, user.lastName].filter(Boolean).join(" ").trim();
      return firstLast || user.fullName || user.name || "";
    }

    async function loadParticipants() {
      try {
        const res = await fetch("http://157.230.121.24:5050/api/users");
        allUsers = await res.json();

        // Fill the hidden <select multiple> for form submission
        const select = document.getElementById("participantsSelect");
        select.innerHTML = "";
        allUsers.forEach(user => {
          const opt = document.createElement("option");
          opt.value = user._id;
          opt.textContent = getFullName(user) || user.email || "User";
          if (selectedUserIds.has(user._id)) opt.selected = true;
          select.appendChild(opt);
        });

        // Render chips/badges for currently selected users
        updateSelectedDisplay();
      } catch (err) {
        console.error("Помилка при завантаженні учасників", err);
      }
    }

    async function openUserModal() {
      try {
        const res = await fetch("http://157.230.121.24:5050/api/users");
        const users = await res.json();
        allUsers = users;
        renderUserList(allUsers);
        document.getElementById("userModal").style.display = "flex";
      } catch (err) {
        console.error("Не вдалося завантажити користувачів", err);
        alert("Помилка при відкритті модального вікна");
      }
    }

    function renderUserList(users) {
      const userList = document.getElementById("userList");
      userList.innerHTML = "";
      users.forEach(user => {
        const fullName = getFullName(user);
        const div = document.createElement("div");
        div.innerHTML = `<label><input type="checkbox" value="${user._id}" ${selectedUserIds.has(user._id) ? 'checked' : ''}/> ${fullName || user.email}</label>`;
        userList.appendChild(div);
      });
    }

    function filterUsers(e) {
      const query = e.target.value.toLowerCase();
      const filtered = allUsers.filter(u => getFullName(u).toLowerCase().includes(query));
      renderUserList(filtered);
    }

    function confirmParticipants() {
      const checkboxes = document.querySelectorAll('#userList input[type="checkbox"]');
      checkboxes.forEach(cb => {
        if (cb.checked) selectedUserIds.add(cb.value);
        else selectedUserIds.delete(cb.value);
      });
      // Refresh both chips and <select>
      updateSelectedDisplay();
      document.getElementById("userModal").style.display = "none";
    }

    function closeUserModal() {
      document.getElementById("userModal").style.display = "none";
    }

    function updateSelectedDisplay() {
      const container = document.getElementById("selectedParticipants");
      container.innerHTML = "";
      const select = document.getElementById("participantsSelect");
      select.innerHTML = "";

      allUsers.forEach(user => {
        const id = user._id;
        if (selectedUserIds.has(id)) {
          const fullName = getFullName(user);
          const badge = document.createElement("span");
          badge.className = "tag";
          badge.innerHTML = `${fullName || user.email} <button class="remove-btn" onclick="removeSelected('${id}')">✖</button>`;
          container.appendChild(badge);

          const opt = document.createElement("option");
          opt.value = id;
          opt.selected = true;
          select.appendChild(opt);
        }
      });
    }

    function removeSelected(id) {
      selectedUserIds.delete(id);
      updateSelectedDisplay();
    }

    async function createCourse() {
      const newCourse = {
        courseTitle: document.getElementById("courseTitle").value,
        eventType: document.getElementById("eventType").value,
        courseSubtitle: document.getElementById("courseSubtitle").value,
        courseDescription: document.getElementById("courseDescription").value,
        accessType: document.getElementById("accessType").value,
        courseDuration: document.getElementById("courseDuration").value,
        coursePrice: document.getElementById("coursePrice").value,
        zoomLink: document.getElementById("zoomLink").value,
        participants: Array.from(selectedUserIds),
      };

      try {
        const res = await fetch("http://157.230.121.24:5050/api/courses", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(newCourse),
        });

        if (res.ok) {
          alert("Курс створено успішно!");
          // Optionally reset form here
        } else {
          alert("Помилка при створенні курсу");
        }
      } catch (err) {
        console.error("Помилка при створенні курсу:", err);
      }
    }

    async function createNewUser() {
      const firstName = document.getElementById("newUserFirstName").value;
      const lastName = document.getElementById("newUserLastName").value;
      const email = document.getElementById("newUserEmail").value;

      try {
        const res = await fetch("http://157.230.121.24:5050/api/users", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ firstName, lastName, email }),
        });
        if (res.ok) {
          const newUser = await res.json();
          allUsers.push(newUser);
          selectedUserIds.add(newUser._id);
          updateSelectedDisplay();
          closeUserModal();
        } else {
          alert("Помилка при створенні користувача");
        }
      } catch (err) {
        console.error("Помилка при створенні користувача:", err);
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      loadParticipants();
    });
  </script>
</body>
</html>
