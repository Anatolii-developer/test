<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Деталі курсу</title>
    <link rel="stylesheet" href="admin-styles.css" />
    <style>
      .course-detail {
        width: 890px;
        margin: 40px auto;
        padding: 60px 100px;
        border-radius: 24px;
        background: #fffef9;
        font-family: "Poppins", sans-serif;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .editable-block {
        position: relative;
        display: flex;
        flex-direction: column;
      }

      .editable-block label {
        font-weight: 600;
        margin-bottom: 6px;
      }

      .editable-block textarea {
        resize: vertical;
        padding: 12px;
        font-size: 16px;
        border: 2px solid #e37009;
        border-radius: 8px;
        background-color: #fffef9;
        color: #333;
        min-height: 48px;
      }

      .editable-block textarea[disabled] {
        background-color: #f0f0f0;
        color: #888;
        border: 1px solid #ccc;
        cursor: not-allowed;
      }

      .editable-block input[type="text"],
      .editable-block input[disabled] {
        padding: 12px;
        font-size: 16px;
        border: 2px solid #e37009;
        border-radius: 8px;
        background-color: #fffef9;
        color: #333;
        min-height: 48px;
      }

      .editable-block input[disabled] {
        background-color: #f0f0f0;
        color: #888;
        border: 1px solid #ccc;
        cursor: not-allowed;
      }

      .edit-btn {
        position: absolute;
        right: 10px;
        top: 38px;
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
      }

      .edit-btn img {
        width: 20px;
        height: 20px;
      }

      .submit-btn {
        align-self: flex-end;
        margin-top: 20px;
        background-color: #e37009;
        color: white;
        border: none;
        padding: 14px 24px;
        font-size: 16px;
        font-weight: 500;
        border-radius: 8px;
        cursor: pointer;
      }
      .submit-btn.danger {
        background: #a31d1d;
      }
      /* Date range single-input UI */
      .date-range { position: relative; }
      #dateRangeInput {
        padding: 12px;
        font-size: 16px;
        border: 2px solid #e37009;
        border-radius: 8px;
        background-color: #fffef9;
        color: #333;
        min-height: 48px;
        width: 100%;
        cursor: pointer;
      }
      .date-popover {
        position: absolute;
        z-index: 20;
        top: 100%;
        left: 0;
        margin-top: 6px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,.1);
        padding: 12px;
        display: none;
        min-width: 340px;
      }
      .date-popover.open { display: block; }
      .date-popover .row { display:flex; gap:12px; align-items:flex-end; }
      .date-popover label { font-weight:600; font-size:12px; display:block; margin:0 0 4px; }
      .date-popover input[type="date"] { padding:8px 10px; border:1px solid #ddd; border-radius:8px; }
      .date-popover .actions { display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }
    </style>
  </head>
  <body class="with-sidebar">
    <aside class="sidebar" id="sidebar"></aside>

    <div class="course-detail">
      <h1>Деталі курсу</h1>
      <div style="display: flex; gap: 24px; flex-wrap: wrap">
        <div class="editable-block" style="min-width: 260px; flex: 1">
          <label>Створив</label>
          <input id="creatorName" type="text" disabled />
        </div>
        <div class="editable-block" style="min-width: 220px; flex: 1">
          <label>Роль</label>
          <input id="creatorRole" type="text" disabled />
        </div>
      </div>
      <div class="editable-block">
        <label>Назва курсу</label>
        <textarea id="title" disabled></textarea>
        <button class="edit-btn" onclick="enableEdit('title')">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>

      <div class="editable-block">
        <label>Тип (інфо)</label>
        <textarea id="eventType" disabled></textarea>
      </div>

      <div class="editable-block">
        <label>Підзаголовок</label>
        <textarea id="subtitle" disabled></textarea>
        <button class="edit-btn" onclick="enableEdit('subtitle')">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>

      <div class="editable-block">
        <label>Опис</label>
        <textarea id="description" disabled></textarea>
        <button class="edit-btn" onclick="enableEdit('description')">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>

      <div class="editable-block">
        <label>Дати проведення курсу</label>
        <div class="date-range">
          <!-- видимий інпут за дизайном -->
          <input id="dateRangeInput" type="text" readonly placeholder="ДД.ММ.РРРР – ДД.ММ.РРРР" />
          <button class="edit-btn" id="dateEditBtn" type="button" onclick="openDateEditor()" aria-label="Редагувати дати">
            <img src="../assets/edit-icon.svg" alt="Edit" />
          </button>
          <!-- приховані реальні дати -->
          <input id="startDate" type="date" hidden />
          <input id="endDate" type="date" hidden />

          <!-- popover з нативними date-пікерами -->
          <div class="date-popover" id="datePopover">
            <div class="row">
              <div style="flex:1">
                <label for="pickerStart">Початок</label>
                <input id="pickerStart" type="date" />
              </div>
              <div style="flex:1">
                <label for="pickerEnd">Кінець</label>
                <input id="pickerEnd" type="date" />
              </div>
            </div>
            <div class="actions">
              <button type="button" class="btn" id="cancelDates">Скасувати</button>
              <button type="button" class="btn primary" id="applyDates">Застосувати</button>
            </div>
          </div>
        </div>
      </div>

      <div class="editable-block">
        <label>Тип групи</label>
        <input id="groupType" type="text" disabled />
        <button class="edit-btn" onclick="enableEdit('groupType')">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>

      <div class="editable-block">
        <label>Тип доступу</label>
        <textarea id="access" disabled></textarea>
        <button class="edit-btn" onclick="enableEdit('access')">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>

      <div class="editable-block">
        <label>Учасники</label>
        <input id="participantsText" type="text" disabled />
        <button class="edit-btn" onclick="openParticipantsModal()">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>

      <div class="editable-block">
        <label>Тривалість</label>
        <textarea id="duration" disabled></textarea>
        <button class="edit-btn" onclick="enableEdit('duration')">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>

      <div class="editable-block">
        <label>Ціна</label>
        <textarea id="price" disabled></textarea>
        <button class="edit-btn" onclick="enableEdit('price')">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>

      <div class="editable-block">
        <label>Посилання на проведення курсу</label>
        <textarea id="zoom" disabled></textarea>
        <button class="edit-btn" onclick="enableEdit('zoom')">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>
      <div class="editable-block">
        <label>Посилання на сторінку курсу (на сайті)</label>
        <input id="siteLink" type="text" disabled placeholder="https://…" />
        <button class="edit-btn" onclick="enableEdit('siteLink')">
          <img src="../assets/edit-icon.svg" alt="Edit" />
        </button>
      </div>

      <div class="editable-block">
        <label>Вид курсу</label>
        <select
          id="eventTypeSel"
          style="
            padding: 12px;
            border: 2px solid #e37009;
            border-radius: 8px;
            background: #fffef9;
            min-height: 48px;
          "
        >
          <option value="Курс">Курс</option>
          <option value="Група">Група</option>
          <option value="Супервізія">Супервізія</option>
          <option value="Лекція">Лекція</option>
          <option value="Семінар">Семінар</option>
        </select>
      </div>

      <div class="editable-block" id="moderationBlock">
        <label>Модерація</label>
        <div style="display: flex; gap: 10px; flex-wrap: wrap">
          <button
            type="button"
            class="submit-btn"
            id="approveBtn"
            onclick="approveCourse()"
          >
            ✅ Підтвердити
          </button>
          <button
            type="button"
            class="submit-btn"
            id="rejectBtn"
            onclick="rejectCourse()"
            style="background: #a31d1d"
          >
            ❌ Відхилити
          </button>
          <span
            id="statusHint"
            style="align-self: center; color: #8f8f8f; font-weight: 500"
          ></span>
        </div>
      </div>

      <button class="submit-btn" onclick="saveChanges()">Зберегти</button>
      <button class="submit-btn danger" id="deleteBtn" onclick="deleteCourse()">
        🗑️ Видалити курс
      </button>
    </div>
    <script src="admin-auth.js"></script>
    <script>
  // --- Page bootstrap ---
  document.addEventListener("DOMContentLoaded", () => {
    if (typeof renderAdminSidebar === "function") {
      renderAdminSidebar("admin-career-requests.html");
    }
    if (typeof requireAdminPage === "function") {
      requireAdminPage();
    }
    loadCourseDetails();
    bindDateRangeUI();
    highlightActiveSidebar();
  });

  // --- State ---
  let courseId;
  let allUsers = [];
  let selectedParticipantIds = [];

  // --- Utils ---
  function $(id) { return document.getElementById(id); }

  function getAuthHeaders() {
    let token = null;
    try {
      const u = JSON.parse(localStorage.getItem("user") || "null");
      token = u?.token || u?.accessToken || null;
    } catch (_) {}
    const h = { "Content-Type": "application/json" };
    if (token) h.Authorization = `Bearer ${token}`;
    return h;
  }

  function enableEdit(id) {
    const el = $(id);
    if (!el) return;
    el.disabled = false;
    el.focus();
  }

  // --- Date helpers for single-input range control ---
  const pad2 = (n) => String(n).padStart(2, "0");
  function toYMD(val) {
    if (!val) return "";
    if (/^\d{4}-\d{2}-\d{2}$/.test(val)) return val;
    const d = new Date(val);
    if (isNaN(d)) return "";
    return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
  }
  function toDMY(val) {
    if (!val) return "";
    const d = /^\d{4}-\d{2}-\d{2}$/.test(val) ? new Date(val + "T12:00:00") : new Date(val);
    if (isNaN(d)) return "";
    return `${pad2(d.getDate())}.${pad2(d.getMonth() + 1)}.${d.getFullYear()}`;
  }
  function normalizeISO(val) {
    if (!val) return "";
    if (/^\d{4}-\d{2}-\d{2}$/.test(val)) return new Date(val + "T12:00:00").toISOString();
    const d = new Date(val);
    return isNaN(d) ? "" : d.toISOString();
  }
  function setDateRangeDisplay(startVal, endVal) {
    const sIso = normalizeISO(startVal);
    const eIso = normalizeISO(endVal);
    const input = $("dateRangeInput");
    if (input) input.value = (sIso || eIso) ? `${toDMY(sIso)} – ${toDMY(eIso)}` : "";
  }

  // --- Load course ---
  async function loadCourseDetails() {
    const params = new URLSearchParams(window.location.search);
    courseId = params.get("id");
    if (!courseId) {
      alert("Не вказано ID курсу");
      location.href = "admin-all-courses.html";
      return;
    }

    try {
      const res = await fetch(`http://157.230.121.24:5050/api/courses/${courseId}`, { credentials: "include" });
      if (res.status === 404) {
        alert("Курс не знайдено");
        location.href = "admin-all-courses.html";
        return;
      }
      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        throw new Error(data.message || `HTTP ${res.status}`);
      }

      const course = await res.json();

      // Basic fields
      $("title").value       = course.courseTitle || "";
      $("eventType").value   = course.eventType || "";
      $("subtitle").value    = course.courseSubtitle || "";
      $("description").value = course.courseDescription || "";
      $("access").value      = course.accessType || "";
      $("duration").value    = course.courseDuration || "";
      $("price").value       = course.coursePrice || "";
      $("zoom").value        = course.zoomLink || "";
      $("creatorName").value = course.creatorName || (course.creatorId ? ([course.creatorId.firstName, course.creatorId.lastName].filter(Boolean).join(" ") || course.creatorId.email || "") : "");
      $("creatorRole").value = course.creatorRole || (course.creatorId ? (course.creatorId.role || (Array.isArray(course.creatorId.roles) ? course.creatorId.roles.join(", ") : "")) : "");

      // Dates
      const start = course.courseDates && course.courseDates.start;
      const end   = course.courseDates && course.courseDates.end;
      $("startDate").value = toYMD(start);
      $("endDate").value   = toYMD(end);
      setDateRangeDisplay(start, end);

      // Select
      if ($("eventTypeSel") && course.eventType) $("eventTypeSel").value = course.eventType;

      // Status hint
      if ($("statusHint")) $("statusHint").textContent = course.status ? `Поточний статус: ${course.status}` : "";

      // Optional site link (може не зберігатись на бекенді)
      $("siteLink").value = course.siteLink || course.publicUrl || course.pageUrl || course.website || course.websiteUrl || "";

      // Participants
      selectedParticipantIds = (course.participants || []).map(p => typeof p === "string" ? p : (p && p._id ? p._id : p));
      try {
        const usersRes = await fetch("http://157.230.121.24:5050/api/users");
        allUsers = await usersRes.json();
        updateParticipantsUI();
      } catch (_) {}
    } catch (err) {
      console.error("Помилка при завантаженні курсу:", err);
      alert(err.message || "Помилка завантаження курсу");
    }
  }

  // --- Save ---
  async function saveChanges() {
    const startVal = $("startDate")?.value || "";
    const endVal   = $("endDate")?.value || "";
    const rawSite  = $("siteLink")?.value?.trim() || "";
    const siteLink = rawSite && !/^https?:\/\//i.test(rawSite) ? "https://" + rawSite : rawSite;

    const body = {
      eventType:        $("eventTypeSel") ? $("eventTypeSel").value : $("eventType").value,
      courseTitle:      $("title").value,
      courseSubtitle:   $("subtitle").value,
      courseDescription:$("description").value,
      accessType:       $("access").value,
      courseDuration:   $("duration").value,
      coursePrice:      $("price").value,
      zoomLink:         $("zoom").value,
      siteLink, publicUrl: siteLink, pageUrl: siteLink, website: siteLink, websiteUrl: siteLink,
      participants:     selectedParticipantIds,
      courseDates: {
        start: startVal ? new Date(startVal + (startVal.length === 10 ? "T12:00:00" : "")).toISOString() : null,
        end:   endVal   ? new Date(endVal   + (endVal.length   === 10 ? "T12:00:00" : "")).toISOString()   : null,
      },
    };

    try {
      const res = await fetch(`http://157.230.121.24:5050/api/courses/${courseId}`, {
        method: "PUT",
        credentials: "include",
        headers: getAuthHeaders(),
        body: JSON.stringify(body),
      });
      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        throw new Error(data.message || `HTTP ${res.status}`);
      }
      alert("Дані оновлено успішно");
      document.querySelectorAll("textarea, input[type='text']").forEach(el => el.disabled = true);
      loadCourseDetails();
    } catch (err) {
      console.error("Помилка при збереженні:", err);
      alert(err.message || "Помилка при збереженні");
    }
  }

  // --- Delete (простая версия) ---
  async function deleteCourse() {
    if (!courseId) { alert("Не вказано ID курсу"); return; }
    if (!confirm("Точно видалити цей курс? Дію неможливо скасувати.")) return;
    try {
      const r = await fetch(`http://157.230.121.24:5050/api/courses/${courseId}`, {
        method: "DELETE",
        credentials: "include",
        headers: getAuthHeaders(),
      });
      if (!r.ok) {
        const d = await r.json().catch(() => ({}));
        throw new Error(d.message || `HTTP ${r.status}`);
      }
      alert("Курс видалено");
      location.href = "admin-all-courses.html";
    } catch (e) {
      console.error(e);
      alert(e.message || "Помилка видалення");
    }
  }

  // --- Approve / Reject ---
  async function approveCourse() {
    if (!courseId) return;
    try {
      const r = await fetch(`http://157.230.121.24:5050/api/courses/${courseId}/approve`, { method: "PUT", credentials: "include" });
      if (!r.ok) {
        const d = await r.json().catch(() => ({}));
        throw new Error(d.message || `HTTP ${r.status}`);
      }
      alert("Курс підтверджено");
      loadCourseDetails();
    } catch (e) {
      console.error(e);
      alert(e.message || "Помилка підтвердження");
    }
  }

  async function rejectCourse() {
    if (!courseId) return;
    const reason = prompt("Причина відхилення (необовʼязково):", "");
    try {
      const r = await fetch(`http://157.230.121.24:5050/api/courses/${courseId}/reject`, {
        method: "PUT",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ reason }),
      });
      if (!r.ok) {
        const d = await r.json().catch(() => ({}));
        throw new Error(d.message || `HTTP ${r.status}`);
      }
      alert("Курс відхилено");
      loadCourseDetails();
    } catch (e) {
      console.error(e);
      alert(e.message || "Помилка відхилення");
    }
  }

  // --- Date popover (UI) ---
  function bindDateRangeUI() {
    const input   = $("dateRangeInput");
    const pop     = $("datePopover");
    const pStart  = $("pickerStart");
    const pEnd    = $("pickerEnd");
    const applyBt = $("applyDates");
    const cancelBt= $("cancelDates");
    const editBtn = $("dateEditBtn");
    if (!input || !pop) return;

    const hiddenStart = () => $("startDate");
    const hiddenEnd   = () => $("endDate");

    function open() {
      if (pStart) pStart.value = hiddenStart()?.value || "";
      if (pEnd)   pEnd.value   = hiddenEnd()?.value   || "";
      pop.classList.add("open");
      setTimeout(() => { try { pStart && pStart.focus(); } catch(_){} }, 0);
    }
    function close() { pop.classList.remove("open"); }

    input.addEventListener("click", open);
    editBtn && editBtn.addEventListener("click", (e) => { e.stopPropagation(); open(); });
    cancelBt && cancelBt.addEventListener("click", close);
    applyBt && applyBt.addEventListener("click", () => {
      if (pStart && hiddenStart()) hiddenStart().value = pStart.value || "";
      if (pEnd && hiddenEnd())     hiddenEnd().value   = pEnd.value   || "";
      setDateRangeDisplay(pStart?.value || "", pEnd?.value || "");
      close();
    });

    document.addEventListener("click", (e) => {
      const t = e.target;
      if (pop.contains(t) || t === input || t === editBtn) return;
      close();
    });
    pop.addEventListener("click", (e) => e.stopPropagation());
  }

  // --- Participants modal ---
  async function openParticipantsModal() {
    try {
      const res = await fetch("http://157.230.121.24:5050/api/users");
      allUsers = await res.json();
      renderUserList(allUsers);
      $("participantsModal").style.display = "flex";
    } catch (err) {
      console.error("Не вдалося завантажити користувачів:", err);
    }
  }

  function renderUserList(users) {
    const container = $("userList");
    container.innerHTML = "";
    users.forEach((user) => {
      const fullName = [user.firstName, user.lastName].filter(Boolean).join(" ");
      const div = document.createElement("div");
      div.innerHTML = `
        <label>
          <input type="checkbox" value="${user._id}" ${selectedParticipantIds.includes(user._id) ? "checked" : ""}/>
          ${fullName || user.email}
        </label>`;
      container.appendChild(div);
    });
  }

  function applySelectedParticipants() {
    const checkboxes = document.querySelectorAll('#userList input[type="checkbox"]');
    selectedParticipantIds = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
    updateParticipantsUI();
    closeParticipantsModal();
  }

  function closeParticipantsModal() {
    $("participantsModal").style.display = "none";
  }

  function filterParticipants(e) {
    const q = e.target.value.toLowerCase();
    const filtered = allUsers.filter(u => ([u.firstName, u.lastName].filter(Boolean).join(" ").toLowerCase()).includes(q));
    renderUserList(filtered);
  }

  function updateParticipantsUI() {
    const input = $("participantsText");
    if (!input) return;
    const names = allUsers
      .filter((u) => selectedParticipantIds.includes(u._id))
      .map((u) => [u.firstName, u.lastName].filter(Boolean).join(" ") || u.email);
    input.value = names.join(", ");
  }

  // --- Sidebar active highlight (tiny helper) ---
  function highlightActiveSidebar() {
    const here = location.pathname.split("/").pop();
    document.querySelectorAll(".sidebar nav a").forEach((a) => {
      if (a.getAttribute("href") === here) a.classList.add("active");
    });
  }
</script>

    <div id="participantsModal" class="modal" style="display: none">
      <div class="modal-content" style="max-height: 70vh; overflow-y: auto">
        <h3>Редагувати учасників</h3>
        <input
          type="text"
          placeholder="Пошук..."
          oninput="filterParticipants(event)"
        />
        <div id="userList" style="margin: 10px 0"></div>
        <button onclick="applySelectedParticipants()">Застосувати</button>
        <button onclick="closeParticipantsModal()">Скасувати</button>
      </div>
    </div>
  </body>
</html>
