<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö–µ—Ä—É–≤–∞–Ω–Ω—è —Ä–æ–ª—è–º–∏</title>
  <link rel="stylesheet" href="admin-styles.css" />
</head>
<body>
  <div class="roles-wrapper">
  <h1>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h1>

  <table class="roles-table" id="rolesTable">
    <thead>
      <tr>
        <th>–†–æ–ª—å</th>
        <th>–°—Ç–∞—Ç—É—Å</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="rolesBody"></tbody>
  </table>

  <div class="add-role-form">
    <input type="text" id="newRole" placeholder="–ù–æ–≤–∞ —Ä–æ–ª—å..." />
    <button onclick="addRole()">–î–æ–¥–∞—Ç–∏</button>
  </div>
</div>


  <script>
    let roles = [];

    async function loadRoles() {
  roles = [
    { _id: "1", name: "–ü—Å–∏—Ö–æ–ª–æ–≥", active: true },
    { _id: "2", name: "–°—É–ø–µ—Ä–≤—ñ–∑–æ—Ä II –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó", active: true },
    { _id: "3", name: "–°—É–ø–µ—Ä–≤—ñ–∑–æ—Ä I –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó", active: true }
  ];
  renderRoles();
}



    async function loadUsersForRoles() {
  try {
    const res = await fetch("http://157.230.121.24:5050/api/users/roles-with-users");
    const data = await res.json();

    roles.forEach(role => {
      const users = data[role.name] || [];

      const row = [...document.querySelectorAll("#rolesBody tr")]
        .find(tr => tr.firstChild.textContent === role.name);

      if (row) {
        const usersTd = document.createElement("td");
        usersTd.colSpan = 3;
        usersTd.style.fontSize = "14px";
        usersTd.style.color = "#555";
        usersTd.style.paddingLeft = "20px";
        usersTd.innerHTML = users.length
          ? `üî∏ <b>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ:</b> ${users.map(u => u.name + (u.status === "APPROVED" ? "" : ` (${u.status})`)).join(", ")}`
          : "<i>–ù–µ–º–∞—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</i>";

        const userRow = document.createElement("tr");
        userRow.appendChild(usersTd);
        document.getElementById("rolesBody").insertBefore(userRow, row.nextSibling);
      }
    });
  } catch (err) {
    console.error("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –ø–æ —Ä–æ–ª—è—Ö:", err);
  }
}


    function renderRoles() {
  const tbody = document.getElementById("rolesBody");
  tbody.innerHTML = "";

  roles.forEach(role => {
    const tr = document.createElement("tr");

    const nameCell = document.createElement("td");
    nameCell.textContent = role.name;
    nameCell.style.cursor = "pointer";
    nameCell.onclick = () => editRole(role._id, role.name);

    const statusCell = document.createElement("td");
    const isActive = role.active !== false; // default true
    statusCell.textContent = isActive ? "–ê–∫—Ç–∏–≤–Ω–∞" : "–ù–µ–∞–∫—Ç–∏–≤–Ω–∞";
    statusCell.className = isActive ? "active" : "inactive";

    const deleteCell = document.createElement("td");
    const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "–í–∏–¥–∞–ª–∏—Ç–∏";
    deleteBtn.className = "delete-btn";
    deleteBtn.onclick = () => deleteRole(role._id);
    deleteCell.appendChild(deleteBtn);

    tr.appendChild(nameCell);
    tr.appendChild(statusCell);
    tr.appendChild(deleteCell);

    tbody.appendChild(tr);
  });
}


    async function addRole() {
      const name = document.getElementById("newRole").value.trim();
      if (!name) return;

      try {
        const res = await fetch("http://157.230.121.24:5050/api/roles", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name })
        });

        if (res.ok) {
          document.getElementById("newRole").value = "";
          await loadRoles();
        } else {
          alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ —Ä–æ–ª—ñ");
        }
      } catch (err) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ —Ä–æ–ª—ñ:", err);
      }
    }

    async function deleteRole(id) {
      if (!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ä–æ–ª—å?")) return;

      try {
        const res = await fetch(`http://157.230.121.24:5050/api/roles/${id}`, {
          method: "DELETE"
        });

        if (res.ok) {
          await loadRoles();
        } else {
          alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ —Ä–æ–ª—å");
        }
      } catch (err) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ:", err);
      }
    }

    function editRole(id, oldName) {
      const newName = prompt("–ù–æ–≤–∞ –Ω–∞–∑–≤–∞ —Ä–æ–ª—ñ:", oldName);
      if (!newName || newName === oldName) return;

      fetch(`http://157.230.121.24:5050/api/roles/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: newName })
      }).then(res => {
        if (res.ok) loadRoles();
        else alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ —Ä–æ–ª—ñ");
      });
    }

    window.addEventListener("DOMContentLoaded", loadRoles);
  </script>

</body>
</html>
