<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Створити курс</title>
  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/uk.js"></script>
</head>
<body class="with-sidebar">
  <aside class="sidebar" id="sidebar"></aside>

  <div id="mainContentWrapper">
  <main id="admin-main">


<div class="completed-nav-buttons">
  <div class="top-buttons">
     <a href="admin-create-course.html" class="completed-nav-button create">Створити</a>
    <button class="completed-nav-button" data-status="Запланований">Заплановані</button>
    <button class="completed-nav-button" data-status="Поточний">Поточні</button>
    <button class="completed-nav-button" data-status="Пройдений">Пройдені</button>
  </div>

  <div class="bottom-center-button">
    <button class="completed-nav-button" data-status="WAITING_FOR_APPROVAL">Заявки на курси</button>
  </div>
</div>
    <section class="create-course-content">
      <form id="createCourseForm">
        <!-- ГОЛОВНИЙ ВИД -->
<div class="form-group">
  <label>Оберіть головний вид</label>
  <div class="radio-group">
    <label><input type="radio" name="mainType" value="Курс" /> Курс</label>
    <label><input type="radio" name="mainType" value="Підвищення кваліфікації" /> Підвищення кваліфікації</label>
    <label><input type="radio" name="mainType" value="Конференція" /> Конференція</label>
  </div>
</div>

<!-- ФОРМАТ (необов’язково) -->
<div class="form-group">
  <label>Оберіть формат (за потреби)</label>
  <div class="radio-group">
    <label><input type="radio" name="formatType" value="Група" /> Група</label>
    <label><input type="radio" name="formatType" value="Супервізія" /> Супервізія</label>
    <label><input type="radio" name="formatType" value="Лекція" /> Лекція</label>
    <label><input type="radio" name="formatType" value="Семінар" /> Семінар</label>
  </div>
</div>

        <div class="form-group">
          <label>Назва курсу</label>
          <input type="text" name="courseTitle" placeholder="Введіть назву" />
        </div>

        <div class="form-group">
          <label>Підзаголовок курсу</label>
          <input type="text" name="courseSubtitle" placeholder="Введіть підзаголовок" />
        </div>

        <div class="form-group">
          <label>Короткий опис курсу</label>
          <textarea name="courseDescription" placeholder="Опишіть коротко про курс..."></textarea>
        </div>

        <div class="form-group">
          <label>Оберіть дати проведення курсу</label>
          <div class="date-range">
            <input type="text" name="startDate" class="date-pick" placeholder="дд.мм.рррр" />
            <input type="text" name="endDate" class="date-pick" placeholder="дд.мм.рррр" />
          </div>
          <input type="text" id="durationHuman" placeholder="Тривалість (обчислюється)" disabled />
          <input type="hidden" name="courseDuration" id="courseDuration" />
        </div>

        <div class="form-group">
          <label>Оберіть дні проведення курсу</label>
          <div class="weekdays-checkboxes">
            <label><input type="checkbox" name="courseDays" value="Понеділок" /> Понеділок</label>
            <label><input type="checkbox" name="courseDays" value="Вівторок" /> Вівторок</label>
            <label><input type="checkbox" name="courseDays" value="Середа" /> Середа</label>
            <label><input type="checkbox" name="courseDays" value="Четвер" /> Четвер</label>
            <label><input type="checkbox" name="courseDays" value="П’ятниця" /> П’ятниця</label>
            <label><input type="checkbox" name="courseDays" value="Субота" /> Субота</label>
            <label><input type="checkbox" name="courseDays" value="Неділя" /> Неділя</label>
          </div>
        </div>

        <div class="form-group">
          <label>Оберіть години проведення</label>
          <div class="time-range">
            <input type="time" name="startTime" />
            <span>–</span>
            <input type="time" name="endTime" />
          </div>
        </div>

        <div class="form-group">
          <label>Оберіть тип курсу</label>
          <div class="radio-group">
            <label><input type="radio" name="accessType" value="Відкрита група" /> Відкрита група</label>
            <label><input type="radio" name="accessType" value="Закрита група" /> Закрита група</label>
          </div>
        </div>

       <div class="form-group">
  <label>Оберіть учасників</label>
  <select name="participants" id="participantsSelect" multiple></select>
  <button type="button" onclick="openUserModal()" class="small-button">+ Додати нового</button>
</div>
<div class="form-group">
  <label>Обрані учасники</label>
  <div id="selectedParticipants" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
</div>



        <div class="form-group">
          <label>Вартість курсу</label>
          <input type="text" name="coursePrice" placeholder="Наприклад: 1200 грн" />
        </div>

        <div class="form-group">
          <label>Посилання на Zoom</label>
          <input type="text" name="zoomLink" placeholder="Вставте Zoom-посилання" />
        </div>
        <div class="form-group">
          <label>Посилання на сторінку курсу (на сайті)</label>
          <input type="url" name="siteLink" placeholder="https://…" />
        </div>

        <div class="save-btn-wrapper">
          <button type="submit" class="save-btn">Зберегти</button>
        </div>
      </form>
    </section>
  </main>
  </div>
    <script src="admin-auth.js"></script>
 <script>
  // Define API_BASE at the top of the main script block
  const API_BASE = window.API_BASE || "https://cabinet.mamko-prof-supervision.com";
  document.addEventListener("DOMContentLoaded", () => {
    if (typeof renderAdminSidebar === "function") {
      renderAdminSidebar("admin-create-course.html");
    }
    if (typeof requireAdminPage === "function") {
      requireAdminPage();
    }
    load();
  });

let allUsers = [];
let selectedUserIds = new Set();



function renderUserList(users) {
  const userList = document.getElementById("userList");
  userList.innerHTML = "";
  users.forEach(user => {
    const fullName = getFullName(user);
    const div = document.createElement("div");
    div.innerHTML = `<label><input type="checkbox" value="${user._id}" ${selectedUserIds.has(user._id) ? 'checked' : ''}/> ${fullName || user.email}</label>`;
    userList.appendChild(div);
  });
}



async function openUserModal() {
  try {
    const res = await fetch(`${API_BASE}/api/users`, { credentials: "include" });
    const users = await res.json();
    allUsers = users;
    renderUserList(users);
    document.getElementById("userModal").style.display = "flex";
  } catch (err) {
    console.error("Не вдалося завантажити користувачів", err);
    alert("Помилка при відкритті модального вікна");
  }
}


function closeUserModal() {
  document.getElementById("userModal").style.display = "none";
}



    function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const arrow = document.getElementById('toggleArrow');

  sidebar.classList.toggle('expanded');
  sidebar.classList.toggle('collapsed');

  arrow.style.transform = sidebar.classList.contains('expanded') ? 'rotate(180deg)' : 'rotate(0deg)';
}

function logoutUser() {
  window.location.href = "login.html";
}

function daysBetweenISO(a,b){
  if(!a || !b) return null;
  const A = new Date(a), B = new Date(b);
  if (isNaN(A) || isNaN(B)) return null;
  // нормализуем к полночі UTC, щоб не з'їхало на часових поясах
  const AU = Date.UTC(A.getFullYear(),A.getMonth(),A.getDate());
  const BU = Date.UTC(B.getFullYear(),B.getMonth(),B.getDate());
  return Math.round((BU - AU) / (1000*60*60*24)) + 1; // включно з обома датами
}

function humanDurationFromRange(startISO, endISO){
  const d = daysBetweenISO(startISO, endISO);
  if (d == null || d <= 0) return '';
  const weeks = Math.floor(d / 7);
  const rest  = d % 7;
  const weeksPart = weeks ? `${weeks} тижн.` : '';
  const restPart  = rest ? `${rest} дн.` : (weeks ? '' : `${d} дн.`);
  const parts = [weeksPart, restPart].filter(Boolean).join(' ');
  return `${d} днів${weeks ? ` (${parts})` : ''}`;
}


function bindMainDateDuration(){
  const s = document.querySelector('input[name="startDate"]');
  const e = document.querySelector('input[name="endDate"]');
  const h = document.getElementById('durationHuman');
  const hidden = document.getElementById('courseDuration');

  function recalc(){
    const val = humanDurationFromRange(s && s.value, e && e.value);
    if (h) h.value = val || '';
    if (hidden) hidden.value = val || '';
  }

  if (s) s.addEventListener('change', () => {
    if (e && e.value && s.value > e.value) e.value = s.value;
    recalc();
  });
  if (e) e.addEventListener('change', () => {
    if (s && s.value && e.value < s.value) s.value = e.value;
    recalc();
  });
}

window.addEventListener('DOMContentLoaded', () => {
  bindMainDateDuration();
});

async function loadParticipants() {
  try {
    const res = await fetch(`${API_BASE}/api/users`, { credentials: "include" });
    const users = await res.json();

    const select = document.getElementById("participantsSelect");
    users.forEach(user => {
      const option = document.createElement("option");
      option.value = user._id;
      option.textContent = user.fullName || user.email || "User";
      select.appendChild(option);
    });
  } catch (err) {
    console.error("Помилка при завантаженні учасників", err);
  }
}

window.addEventListener("DOMContentLoaded", loadParticipants);


document.getElementById("createCourseForm").addEventListener("submit", async function (e) {
  e.preventDefault();

  const form = e.target;
  const storedUser = JSON.parse(localStorage.getItem("user"));

  const startDate = form.startDate.value;
  const endDate   = form.endDate.value;

  const durationHidden = document.getElementById('courseDuration');
  if (durationHidden && !durationHidden.value && form.startDate.value && form.endDate.value){
    durationHidden.value = humanDurationFromRange(form.startDate.value, form.endDate.value);
  }

  const rawSite = form.siteLink?.value?.trim() || '';
  const siteLink = rawSite && !/^https?:\/\//i.test(rawSite) ? 'https://' + rawSite : rawSite;

  const formData = {
    mainType: form.mainType.value,                   
    formatType: form.formatType?.value || null,
    courseTitle: form.courseTitle.value,
    courseSubtitle: form.courseSubtitle.value,
    courseDescription: form.courseDescription.value,
    courseDates: {
      start: startDate,
      end: endDate
    },
    courseDays: [...form.querySelectorAll('input[name="courseDays"]:checked')].map(cb => cb.value),
    courseTime: {
      start: form.startTime.value,
      end: form.endTime.value
    },
    accessType: form.accessType.value,
    courseDuration: (durationHidden ? durationHidden.value : form.courseDuration.value),
    coursePrice: form.coursePrice.value,
    zoomLink: form.zoomLink.value,
    siteLink,
    publicUrl: siteLink,
    pageUrl: siteLink,
    website: siteLink,
    websiteUrl: siteLink,
    participants: Array.from(selectedUserIds),
    creatorId: storedUser?._id || null,
    creatorName: `${storedUser?.firstName || ""} ${storedUser?.lastName || ""}`.trim(),
    creatorRole: storedUser?.role || "",
  };

  try {
    const res = await fetch(`${API_BASE}/api/courses`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(formData),
      credentials: "include"
    });

    const result = await res.json();

    if (!res.ok) {
      console.error("❌ Server returned error:", result);
      alert("Помилка при збереженні курсу: " + (result.message || "Невідома помилка"));
      return;
    }

    alert("Курс успішно збережено");
    form.reset();
  } catch (err) {
    console.error("❌ Помилка на фронтенді:", err);
    alert("Сервер тимчасово недоступний");
  }
});


function updateSelectedDisplay() {
  const container = document.getElementById("selectedParticipants");
  container.innerHTML = "";
  const select = document.getElementById("participantsSelect");
  select.innerHTML = "";

  allUsers.forEach(user => {
    if (selectedUserIds.has(user._id)) {
      const fullName = getFullName(user);
      const badge = document.createElement("span");
      badge.className = "tag";
      badge.innerHTML = `${fullName || user.email} <button class="remove-btn" onclick="removeSelected('${user._id}')">✖</button>`;
      container.appendChild(badge);

      const opt = document.createElement("option");
      opt.value = user._id;
      opt.selected = true;
      select.appendChild(opt);
    }
  });
}


function removeSelected(id) {
  selectedUserIds.delete(id);
  updateSelectedDisplay();
}


function confirmParticipants() {
  const checkboxes = document.querySelectorAll('#userList input[type="checkbox"]');
  checkboxes.forEach(cb => {
    if (cb.checked) selectedUserIds.add(cb.value);
    else selectedUserIds.delete(cb.value);
  });
  updateSelectedDisplay();
  document.getElementById("userModal").style.display = "none";
}

function getFullName(user) {
  return [user.firstName, user.lastName].filter(Boolean).join(" ");
}

function filterUsers() {
  const query = document.getElementById("userSearch").value.toLowerCase();
  const filtered = allUsers.filter(user => {
    const fullName = getFullName(user).toLowerCase();
    return fullName.includes(query);
  });
  renderUserList(filtered);
}



async function createNewUser() {
  const fullName = document.getElementById("newUserFullName").value.trim();
  const email = document.getElementById("newUserEmail").value.trim();

  if (!fullName || !email) {
    alert("Введіть імʼя та email");
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/api/users`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ fullName, email }),
      credentials: "include"
    });

    const newUser = await res.json();

    const select = document.getElementById("participantsSelect");
    const option = document.createElement("option");
    option.value = newUser._id;
    option.textContent = newUser.fullName || newUser.email;
    option.selected = true;
    select.appendChild(option);

    closeUserModal();
  } catch (err) {
    alert("Помилка при створенні користувача");
    console.error(err);
  }
}
 function logoutUser(){
    try{
      // чистимо локальне
      localStorage.removeItem('user');
      ['token','authToken','jwt','accessToken','bearer'].forEach(k => localStorage.removeItem(k));
    }catch(_){}

    // пробуємо вийти і на бекенді (ігноруємо помилки мережі)
    fetch(`${API_BASE}/api/users/logout`, { method:'POST', credentials:'include' }).catch(()=>{});

    // редірект на логін з поверненням
    const back = encodeURIComponent(location.pathname + location.search);
    location.href = `admin-login.html?returnUrl=${back}`;
  }

  // прив’язуємо до кнопки
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('btnLogout');
    if (btn) btn.addEventListener('click', logoutUser);
  });

  document.addEventListener('DOMContentLoaded', () => {
  const here = location.pathname.split('/').pop();
  document.querySelectorAll('.sidebar nav a').forEach(a=>{
    if (a.getAttribute('href') === here) a.classList.add('active');
  });
});

  </script>

  <script>
    // Initialize Flatpickr on the two date inputs
    document.addEventListener('DOMContentLoaded', function () {
      const opts = {
        locale: flatpickr.l10ns.uk,
        altInput: true,          // show pretty format to user
        altFormat: 'd.m.Y',      // DD.MM.YYYY display
        dateFormat: 'Y-m-d',     // keep ISO value for scripts/back-end
        allowInput: true
      };
      flatpickr('input[name="startDate"]', opts);
      flatpickr('input[name="endDate"]', opts);
    });
  </script>

<div id="userModal" class="modal" style="display: none;">
  <div class="modal-content">
    <h3>Обрати учасників</h3>
    <input type="text" id="userSearch" placeholder="Пошук..." oninput="filterUsers()" />
    <div id="userList" style="max-height: 200px; overflow-y: auto; margin: 10px 0;"></div>
    <button onclick="confirmParticipants()">Додати вибраних</button>
    <button onclick="closeUserModal()">Скасувати</button>
  </div>
</div>

</body>
</html>
