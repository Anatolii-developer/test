<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ –∫—É—Ä—Å—ñ–≤</title>
  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-overlay {
  position: absolute;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
}

.modal-content {
  position: relative;
  background: #fff;
  border-radius: 16px;
  max-width: 480px;
  width: 90%;
  padding: 32px;
  z-index: 10;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
  font-family: 'Poppins', sans-serif;
}

.modal-content h2 {
  margin-top: 0;
  font-size: 22px;
  margin-bottom: 20px;
  text-align: center;
}

.close-btn {
  position: absolute;
  top: 16px;
  right: 20px;
  font-size: 24px;
  cursor: pointer;
  color: #888;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-bottom: 18px;
}

    .form-group label {
  font-weight: 500;
  font-size: 14px;
}

.form-group input,
.form-group textarea,
.form-group select {
  padding: 10px 12px;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 14px;
  font-family: 'Poppins', sans-serif;
}

.form-group textarea {
  resize: vertical;
  min-height: 80px;
}

.submit-btn {
  width: 100%;
  background-color: #48a868;
  color: white;
  font-weight: 600;
  font-size: 16px;
  padding: 14px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.3s ease;
}

.submit-btn:hover {
  background-color: #3c9359;
}

.role-filter-group { display: grid; gap: 6px; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); margin: 6px 0 0; }
.role-filter-item { display: flex; align-items: center; gap: 8px; font-size: 14px; }

  /* --- Folders (Sections) UI --- */
  .folder-select,
  #sectionMode,
  #sectionName {
    padding: 10px 12px;
    border: 1px solid #e6c7a7;
    background: #FFEED9; /* requested color */
    border-radius: 10px;
    font-size: 14px;
    font-family: 'Poppins', sans-serif;
  }
  .hint {
    display: block;
    margin-top: 6px;
    font-size: 12px;
    color: #666;
  }
  .form-row-inline {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }

  </style>
</head>
<body class="with-sidebar">
  <aside class="sidebar" id="sidebar"></aside>

    <div class="main-content">
      <div class="materials-header">
        <button class="btn-green">–î–æ–¥–∞—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏ –¥–æ –∫—É—Ä—Å—ñ–≤</button>
        <button class="btn-light-green">–î–æ–¥–∞—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏ –≥—Ä—É–ø–∏</button>
      </div>

     <div class="filters">
  <input type="text" id="searchInput" placeholder="–ü–æ—à—É–∫ –∑–∞ —ñ–º'—è–º" />

<div id="roleFilterGroup" class="role-filter-group" aria-label="–§—ñ–ª—å—Ç—Ä –∑–∞ —Ä–æ–ª—è–º–∏"></div>

</select>

  <label for="listFolderFilter" style="margin-left:8px;">–ü–∞–ø–∫–∞</label>
  <select id="listFolderFilter" class="folder-select">
    <option value="">‚Äî –£—Å—ñ –ø–∞–ø–∫–∏ ‚Äî</option>
  </select>

  <button id="selectAllBtn" class="btn-light-green">–í–∏–¥—ñ–ª–∏—Ç–∏ –≤—Å—ñ—Ö</button>
</div>

      <table class="participants-table">
        <thead>
          <tr>
            <th>#</th>
            <th>–Ü–º‚Äô—è —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–µ</th>
            <th>Email</th>
            <th>–†–æ–ª—å</th>
            <th>–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è</th>
            <th>–û–±—Ä–∞—Ç–∏</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="date-time">
        <label>–û–±–µ—Ä—ñ—Ç—å –¥–∞—Ç—É —Ç–∞ —á–∞—Å –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó</label>
        <input type="date" />
        <input type="time" />
      </div>

      <div class="action-buttons">
        <button class="btn-green-add">–î–æ–¥–∞—Ç–∏ –≤—ñ–¥–µ–æ</button>
        <button class="btn-dark-green">–î–æ–¥–∞—Ç–∏ –∫–Ω–∏–≥—É</button>
      </div>

      <button class="submit-button">Submit</button>
      <hr style="margin:24px 0;">
      <h3>–Ü—Å–Ω—É—é—á—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏</h3>
      <div id="materialsList" style="display:grid; gap:12px;"></div>
    </div>
  </div>
  <script src="admin-auth.js"></script>
  
  <script>
  const API_BASE = "http://157.230.121.24:5050";
  let selectAllClicked = false;
  let allUsers = [];
const rolesById = new Map();     // _id -> name
const rolesByName = new Map();   // name -> _id

// Known folder/section names (remembered locally during the session)
const knownSections = new Set();
function refreshSectionSelect() {
  const selEl = document.getElementById("sectionSelect");
  if (!selEl) return;
  // keep the first option as "‚Äî –ë–µ–∑ –ø–∞–ø–∫–∏ ‚Äî"
  const keepFirst = selEl.querySelector("option[value='']");
  selEl.innerHTML = "";
  const first = document.createElement("option");
  first.value = "";
  first.textContent = "‚Äî –ë–µ–∑ –ø–∞–ø–∫–∏ ‚Äî";
  selEl.appendChild(first);
  // add remembered sections
  Array.from(knownSections).sort().forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    selEl.appendChild(opt);
  });
}


async function loadRoles() {
  const res = await fetch(`${API_BASE}/api/roles`);
  if (!res.ok) throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ —Ä–æ–ª—ñ');
  const roles = await res.json(); // [{ _id, name }]

  const grp = document.getElementById("roleFilterGroup");
  if (!grp) return;
  grp.innerHTML = "";

  roles.forEach(r => {
    const idStr = String(r._id);
    rolesById.set(idStr, r.name);
    rolesByName.set(r.name, idStr);

    const wrap = document.createElement("label");
    wrap.className = "role-filter-item";
    wrap.innerHTML = `
      <input type="checkbox" name="roleFilter[]" value="${idStr}" />
      <span>${r.name}</span>
    `;
    grp.appendChild(wrap);
  });
}


function getSelectedRoleIds() {
  return Array.from(document.querySelectorAll('input[name="roleFilter[]"]:checked'))
    .map(el => String(el.value));
}

function intersects(a, b) {
  if (!a || !b || a.length === 0 || b.length === 0) return false;
  const setB = new Set(b.map(String));
  return a.some(x => setB.has(String(x)));
}

  function normalizeUserRoleIds(user){
    if (Array.isArray(user.roleIds)) return user.roleIds.map(String);
    if (Array.isArray(user.roles))   return user.roles.map(r => String(rolesByName.get(r) || r));
    if (user.roleId)                 return [String(user.roleId)];
    if (user.role)                   return [String(rolesByName.get(user.role) || user.role)];
    return [];
  }

  function renderTable(users) {
    const tbody = document.querySelector(".participants-table tbody");
    tbody.innerHTML = "";

    users.forEach((user, index) => {
      const fullName = `${user.firstName || ""} ${user.lastName || ""}`.trim();
      const roleIds = normalizeUserRoleIds(user);
      const roleNames = roleIds.map(id => rolesById.get(id) || id);
      const roleText = roleNames.length ? roleNames.join(", ") : "-";

      const dob = user.dateOfBirth ? new Date(user.dateOfBirth).toLocaleDateString("uk-UA") : "-";

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${index + 1}</td>
        <td>${fullName}</td>
        <td>${user.email || ""}</td>
        <td>${roleText}</td>
        <td>${dob}</td>
        <td>
          <img 
            src="images/checkbox-empty.png" 
            alt="checkbox" 
            class="custom-checkbox" 
            data-user-id="${user._id || ''}"
            data-role-ids='${JSON.stringify(roleIds)}'
            data-checked="false"
            style="width: 24px; height: 24px; cursor: pointer;" />
        </td>
      `;
      tbody.appendChild(row);
    });
  }

  function applyFilters() {
  const searchValue = document.getElementById("searchInput").value.toLowerCase();
  const selectedRoleIds = getSelectedRoleIds(); // —Ç–µ–ø–µ—Ä—å –º–∞—Å—Å–∏–≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ä–æ–ª–µ–π (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º)

  const filtered = allUsers.filter(user => {
    const name = `${user.firstName || ""} ${user.lastName || ""}`.toLowerCase();
    const matchName = name.includes(searchValue);

    if (selectedRoleIds.length === 0) {
      return matchName; // —Ä–æ–ª—è–º–∏ –Ω–µ —Ñ–∏–ª—å—Ç—Ä—É–µ–º
    }

    const roleIds = normalizeUserRoleIds(user); // —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (ids)
    const matchRole = intersects(roleIds, selectedRoleIds);
    return matchName && matchRole;
  });

  renderTable(filtered);
}

  document.addEventListener("DOMContentLoaded", async () => {
    refreshSectionSelect();
    if (typeof renderAdminSidebar === "function") {
      renderAdminSidebar("admin-career-requests.html");
    }
    if (typeof requireAdminPage === "function") {
      requireAdminPage();
    }
    if (typeof load === "function") {
      load();
    }

    // 1) –°–Ω–∞—á–∞–ª–∞ —Ä–æ–ª–∏
    try {
      await loadRoles();
    } catch (e) {
      console.error("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ä–æ–ª—ñ:", e);
    }

    // 2) –ö—É—Ä—Å–∏
    async function loadCurrentCourses() {
      const res = await fetch(`${API_BASE}/api/courses`);
      const allCourses = await res.json();
      const currentCourses = allCourses.filter(c => c.status === "–ü–æ—Ç–æ—á–Ω–∏–π");

      const courseSelect = document.getElementById("courseSelect");
      courseSelect.innerHTML = `<option value="">-- –û–±–µ—Ä—ñ—Ç—å –∫—É—Ä—Å --</option>`;
      currentCourses.forEach(course => {
        const opt = document.createElement("option");
        opt.value = course._id;
        opt.textContent = course.courseTitle;
        courseSelect.appendChild(opt);
      });
    }
    await loadCurrentCourses();

    // 3) –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ
    try {
      const response = await fetch(`${API_BASE}/api/users/approved`);
      allUsers = await response.json();
      renderTable(allUsers);
    } catch (err) {
      console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤:", err);
    }

    // –û–±—Ä–æ–±–Ω–∏–∫–∏
    document.getElementById("courseSelect").addEventListener("change", async (e) => {
      const courseId = e.target.value;
      if (!courseId) return;
      try {
        const res = await fetch(`${API_BASE}/api/courses/${courseId}/participants`);
        const users = await res.json();
        allUsers = users; applyFilters();
        // load folders for the selected course to allow choosing existing sections
        try {
          const fr = await fetch(`${API_BASE}/api/library/folders?destination=courses&courseId=${courseId}`);
          if (fr.ok) {
            const folders = await fr.json();
            knownSections.clear();
            folders.filter(Boolean).forEach(n => knownSections.add(n));
            refreshSectionSelect();
          }
        } catch (e2) {
          console.warn('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø–∞–ø–∫–∏ –∫—É—Ä—Å—É:', e2);
        }
      } catch (err) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ —É—á–∞—Å–Ω–∏–∫—ñ–≤ –∫—É—Ä—Å—É:", err);
      }
    });

    document.getElementById("searchInput").addEventListener("input", applyFilters);
const roleFilterGroup = document.getElementById("roleFilterGroup");
if (roleFilterGroup) {
  roleFilterGroup.addEventListener("change", (e) => {
    if (e.target && e.target.name === "roleFilter[]") applyFilters();
  });
}

    document.getElementById("selectAllBtn").addEventListener("click", () => {
  selectAllClicked = true;
  const selectedRoleIds = getSelectedRoleIds(); // –º–∞—Å—Å–∏–≤

  document.querySelectorAll(".custom-checkbox").forEach(cb => {
    if (selectedRoleIds.length === 0) {
      // –µ—Å–ª–∏ —Ä–æ–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã ‚Äî –æ—Ç–º–µ—á–∞–µ–º –≤—Å–µ—Ö
      cb.src = "images/checkbox.png";
      cb.dataset.checked = "true";
      return;
    }
    const roleIds = JSON.parse(cb.dataset.roleIds || "[]");
    const match = intersects(roleIds, selectedRoleIds);
    cb.src = match ? "images/checkbox.png" : "images/checkbox-empty.png";
    cb.dataset.checked = match.toString();
  });
});

    document.addEventListener("click", (e) => {
      if (e.target.classList.contains("custom-checkbox")) {
        const checkbox = e.target;
        const isChecked = checkbox.dataset.checked === "true";
        checkbox.src = isChecked ? "images/checkbox-empty.png" : "images/checkbox.png";
        checkbox.dataset.checked = (!isChecked).toString();
      }
    });

    document.querySelector(".btn-green-add").addEventListener("click", () => {
      openModal("video");
    });
    document.querySelector(".btn-dark-green").addEventListener("click", () => {
      openModal("book");
    });
  });

function openModal(type) {
  const modal = document.getElementById("addMaterialModal");
  if (!modal) return;
  modal.style.display = "block";
  const mt = document.getElementById("materialType");
  if (mt) mt.value = type;
  toggleInputs(type);

  // reset section UI (default to "new")
  const modeEl = document.getElementById("sectionMode");
  const selEl = document.getElementById("sectionSelect");
  const nameEl = document.getElementById("sectionName");
  if (modeEl) modeEl.value = "new";
  if (selEl) {
    selEl.value = "";
    selEl.style.display = "none";
  }
  if (nameEl) {
    nameEl.value = "";
    nameEl.style.display = "block";
  }
  refreshSectionSelect();
}
function closeModal() {
  const m = document.getElementById("addMaterialModal");
  if (!m) return;
  m.style.display = "none";
  // clear edit mode flag
  delete m.dataset.editId;
  // clear fields
  document.getElementById("materialTitle").value = "";
  document.getElementById("materialDescription").value = "";
  const vl = document.getElementById("videoLink"); if (vl) vl.value = "";
  const bf = document.getElementById("bookFile"); if (bf) bf.value = "";
  const nameEl = document.getElementById("sectionName"); if (nameEl) nameEl.value = "";
  const selEl  = document.getElementById("sectionSelect"); if (selEl) selEl.value = "";
}

document.addEventListener("DOMContentLoaded", () => {
  const mt = document.getElementById("materialType");
  if (mt) {
    mt.addEventListener("change", (e) => toggleInputs(e.target.value));
  }
});

document.addEventListener("DOMContentLoaded", () => {
  const modeEl = document.getElementById("sectionMode");
  const selEl  = document.getElementById("sectionSelect");
  const nameEl = document.getElementById("sectionName");
  if (modeEl && selEl && nameEl) {
    const sync = () => {
      if (modeEl.value === "new") {
        nameEl.style.display = "block";
        selEl.style.display  = "none";
      } else {
        nameEl.style.display = "none";
        selEl.style.display  = "block";
      }
    };
    modeEl.addEventListener("change", sync);
    sync();
  }
});


async function submitMaterial() {
  const type = document.getElementById("materialType").value;
  const title = document.getElementById("materialTitle").value?.trim();
  const description = document.getElementById("materialDescription").value?.trim();
  const selectedCourseId = document.getElementById("courseSelect").value;

const selectedRoleIds = getSelectedRoleIds(); // —Ä–æ–ª–∏ –∏–∑ —á–µ–∫–±–æ–∫—Å—ñ–≤
  // –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ (–≥–∞–ª–æ—á–∫–∏ —É —Ç–∞–±–ª–∏—Ü—ñ)
  const selectedUserIds = Array
    .from(document.querySelectorAll('.custom-checkbox[data-checked="true"]'))
    .map(cb => cb.dataset.userId)
    .filter(Boolean);

  // –±–∞–∑–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
  if (!title) return alert("–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –º–∞—Ç–µ—Ä—ñ–∞–ª—É");
  if (type !== "video" && type !== "book") return alert("–û–±–µ—Ä—ñ—Ç—å —Ç–∏–ø –º–∞—Ç–µ—Ä—ñ–∞–ª—É");

  // —Ñ—É–Ω–∫—Ü–∏—è —Å–±–æ—Ä–∫–∏ –æ–±—â–∏—Ö –ø–æ–ª–µ–π
  const buildBaseForm = () => {
    const fd = new FormData();
    fd.append("type", type);
    fd.append("title", title);
    fd.append("description", description || "");

    if (type === "video") {
      const link = document.getElementById("videoLink").value?.trim();
      if (!link) { alert("–í–∫–∞–∂—ñ—Ç—å –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ YouTube"); return null; }
      fd.append("videoLink", link);
    } else {
      const file = document.getElementById("bookFile").files[0];
      if (!file) { alert("–û–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª (PDF/DOC/DOCX/PPT/PPTX)"); return null; }

      const okExt = /\.(pdf|doc|docx|ppt|pptx)$/i.test(file.name);
      const okMime = [
        "application/pdf",
        "application/msword",
        "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
        "application/vnd.ms-powerpoint",
        "application/vnd.openxmlformats-officedocument.presentationml.presentation"
      ].includes(file.type) || file.type === ""; // –¥–µ—è–∫—ñ –±—Ä–∞—É–∑–µ—Ä–∏ –Ω–µ —Å—Ç–∞–≤–ª—è—Ç—å type

      if (!okExt && !okMime) {
        alert("–ü—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å—Å—è –ª–∏—à–µ PDF/DOC/DOCX/PPT/PPTX");
        return null;
      }

      fd.append("bookFile", file);
    }

    // section/folder
    const modeEl = document.getElementById("sectionMode");
    const selEl = document.getElementById("sectionSelect");
    const nameEl = document.getElementById("sectionName");
    let section = "";
    if (modeEl) {
      section = modeEl.value === "new"
        ? (nameEl?.value || "").trim()
        : (selEl?.value || "").trim();
    }
   if (section) {
  fd.append("folder", section);
}
    // –∞–¥—Ä–µ—Å–∞—Ç–∏ (—è–∫—â–æ –æ–±—Ä–∞–Ω—ñ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ)
    selectedUserIds.forEach(id => fd.append('users[]', id));
    return fd;
  };

  // –ö–£–î–ê —Å–ª–∞—Ç—å: —Ä–æ–ª–∏ / –∫—É—Ä—Å / –≤—Å–µ–º
  const destinationByRoles = selectedRoleIds.length > 0;
  const destinationByCourse = !destinationByRoles && !!selectedCourseId;
  const destinationGeneral  = !destinationByRoles && !destinationByCourse && !!window.selectAllClicked;

  if (!destinationByRoles && !destinationByCourse && !destinationGeneral) {
    alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å –∫—É—Ä—Å, —Ä–æ–ª—ñ –∞–±–æ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å '–í–∏–¥—ñ–ª–∏—Ç–∏ –≤—Å—ñ—Ö'");
    return;
  }

  // –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ–¥–Ω–æ–≥–æ FormData
  const sendOnce = async (fd) => {
    const res = await fetch("http://157.230.121.24:5050/api/library", {
      method: "POST",
      body: fd
    });
    return res;
  };

  try {
    if (destinationByRoles) {
      // ===== 1) —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º —Å –º–∞—Å—Å–∏–≤–æ–º roleIds[] =====
      let fd = buildBaseForm();
      if (!fd) return;

      fd.append("destination", "addons");
      selectedRoleIds.forEach(id => fd.append("roleIds[]", id));
      // –∏–º–µ–Ω–∞ —Ä–æ–ª–µ–π –Ω–∞ –≤—Å—è–∫–∏–π (–µ—Å–ª–∏ –±—ç–∫—É –ø—Ä–∏–≥–æ–¥—è—Ç—Å—è)
      selectedRoleIds
        .map(id => rolesById.get(String(id)))
        .filter(Boolean)
        .forEach(name => fd.append("roles[]", name));

      let res = await sendOnce(fd);

      if (!res.ok) {
        // ===== 2) —Ñ–æ–ª–±–µ–∫ ‚Äî –ø–æ –æ–¥–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∞ –∫–∞–∂–¥—É—é —Ä–æ–ª—å =====
        // –ø–æ–ª–µ–∑–Ω–æ, –µ—Å–ª–∏ –±—ç–∫ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–æ–ª—å–∫–æ roleId (–Ω–µ –º–∞—Å—Å–∏–≤)
        for (const roleId of selectedRoleIds) {
          let fdOne = buildBaseForm();
          if (!fdOne) return;
          fdOne.append("destination", "addons");
          fdOne.append("roleId", roleId);
          const roleName = rolesById.get(String(roleId));
          if (roleName) fdOne.append("role", roleName);

          const r = await sendOnce(fdOne);
          if (!r.ok) {
            let msg = "–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ.";
            try { const j = await r.clone().json(); msg = j?.message || msg; } catch {}
            throw new Error(msg);
          }
        }
      }
    } else if (destinationByCourse) {
      // –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫—É—Ä—Å–∞
      let fd = buildBaseForm();
      if (!fd) return;
      fd.append("destination", "courses");
      fd.append("courseId", selectedCourseId);

      const res = await sendOnce(fd);
      if (!res.ok) {
        let msg = "–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ.";
        try { const j = await res.clone().json(); msg = j?.message || msg; } catch {}
        throw new Error(msg);
      }
    } else if (destinationGeneral) {
      // –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤—Å–µ–º
      let fd = buildBaseForm();
      if (!fd) return;
      fd.append("destination", "general");

      const res = await sendOnce(fd);
      if (!res.ok) {
        let msg = "–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ.";
        try { const j = await res.clone().json(); msg = j?.message || msg; } catch {}
        throw new Error(msg);
      }
    }

      // remember section if provided
      const modeEl = document.getElementById("sectionMode");
      const selEl = document.getElementById("sectionSelect");
      const nameEl = document.getElementById("sectionName");
      const sectionChosen = modeEl && modeEl.value === "new"
        ? (nameEl?.value || "").trim()
        : (selEl?.value || "").trim();
      if (sectionChosen) {
        knownSections.add(sectionChosen);
        refreshSectionSelect();
      }

      alert("–£—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ!");
      closeModal();
  } catch (err) {
    console.error(err);
    alert(err.message || "–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ.");
  }
}

function toggleInputs(type) {
  document.getElementById("videoInput").style.display = type === "video" ? "block" : "none";
  document.getElementById("bookInput").style.display = type === "book" ? "block" : "none";
}

     function logoutUser(){
    try{
      // —á–∏—Å—Ç–∏–º–æ –ª–æ–∫–∞–ª—å–Ω–µ
      localStorage.removeItem('user');
      ['token','authToken','jwt','accessToken','bearer'].forEach(k => localStorage.removeItem(k));
    }catch(_){}

    // –ø—Ä–æ–±—É—î–º–æ –≤–∏–π—Ç–∏ —ñ –Ω–∞ –±–µ–∫–µ–Ω–¥—ñ (—ñ–≥–Ω–æ—Ä—É—î–º–æ –ø–æ–º–∏–ª–∫–∏ –º–µ—Ä–µ–∂—ñ)
    const API = ""; // —è–∫—â–æ –±–µ–∫ —ñ —Ñ—Ä–æ–Ω—Ç –Ω–∞ –æ–¥–Ω–æ–º—É –¥–æ–º–µ–Ω—ñ ‚Äî –∑–∞–ª–∏—à –ø–æ—Ä–æ–∂–Ω—ñ–º
    fetch(`${API}/api/users/logout`, { method:'POST', credentials:'include' }).catch(()=>{});

    // —Ä–µ–¥—ñ—Ä–µ–∫—Ç –Ω–∞ –ª–æ–≥—ñ–Ω –∑ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è–º
    const back = encodeURIComponent(location.pathname + location.search);
    location.href = `admin-login.html?returnUrl=${back}`;
  }

  // –ø—Ä–∏–≤‚Äô—è–∑—É—î–º–æ –¥–æ –∫–Ω–æ–ø–∫–∏
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('btnLogout');
    if (btn) btn.addEventListener('click', logoutUser);
  });

  document.addEventListener('DOMContentLoaded', () => {
  const here = location.pathname.split('/').pop();
  document.querySelectorAll('.sidebar nav a').forEach(a=>{
    if (a.getAttribute('href') === here) a.classList.add('active');
  });
});

  </script>
 <div id="addMaterialModal" class="modal" style="display:none;">
  <div class="modal-overlay" onclick="closeModal()"></div>
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal()">√ó</span>
    <h2>–î–æ–¥–∞—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª</h2>

    <div class="form-group">
      <label for="materialType">–¢–∏–ø –º–∞—Ç–µ—Ä—ñ–∞–ª—É</label>
      <select id="materialType">
        <option value="video">üé• –í—ñ–¥–µ–æ (YouTube)</option>
        <option value="book">üìò –§–∞–π–ª (PDF / DOC / DOCX / PPT / PPTX)</option>
      </select>
    </div>

    <div class="form-group">
      <label for="materialTitle">–ù–∞–∑–≤–∞</label>
      <input type="text" id="materialTitle" placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É" />
    </div>

    <div class="form-group">
      <label for="materialDescription">–û–ø–∏—Å</label>
      <textarea id="materialDescription" placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å..."></textarea>
    </div>

    <!-- Section / Folder selector -->
    <div class="form-group">
      <label>–ü–∞–ø–∫–∞ / —Ä–æ–∑–¥—ñ–ª</label>
      <div class="form-row-inline">
        <select id="sectionMode">
          <option value="existing">–û–±—Ä–∞—Ç–∏ —ñ—Å–Ω—É—é—á—É</option>
          <option value="new">–°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤—É</option>
        </select>
        <select id="sectionSelect" class="folder-select">
          <option value="">‚Äî –ë–µ–∑ –ø–∞–ø–∫–∏ ‚Äî</option>
        </select>
      </div>
      <input type="text" id="sectionName" placeholder="–ù–∞–∑–≤–∞ –ø–∞–ø–∫–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –¢–∏–∂–¥–µ–Ω—å 3)" style="display:none; margin-top:8px;" />
      <small class="hint">–ü–∞–ø–∫–∞ –≥—Ä—É–ø—É—î –º–∞—Ç–µ—Ä—ñ–∞–ª–∏ –∫—É—Ä—Å—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, ¬´–¢–∏–∂–¥–µ–Ω—å 1¬ª). –ê–¥–º—ñ–Ω –º–æ–∂–µ –≤–≤–µ—Å—Ç–∏ –±—É–¥—å‚Äë—è–∫—É –Ω–∞–∑–≤—É.</small>
    </div>

    <div class="form-group" id="videoInput" style="display: none;">
      <label for="videoLink">–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ YouTube</label>
      <input type="url" id="videoLink" placeholder="https://www.youtube.com/watch?v=..." />
    </div>

    <div class="form-group" id="bookInput" style="display: none;">
  <label for="bookFile">–§–∞–π–ª (PDF / DOC / DOCX / PPT / PPTX)</label>
  <input
    type="file"
    id="bookFile"
    accept="application/pdf,
            application/msword,
            application/vnd.openxmlformats-officedocument.wordprocessingml.document,
            application/vnd.ms-powerpoint,
            application/vnd.openxmlformats-officedocument.presentationml.presentation,
            .pdf,.doc,.docx,.ppt,.pptx" />
</div>

    <button class="submit-btn" onclick="submitMaterial()">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
  </div>
</div>

</div>
</body>
</html>

  // ======== MATERIALS LIST / EDIT / DELETE ========

  function getCurrentDestination() {
    const selectedRoleIds = getSelectedRoleIds();
    const courseId = document.getElementById("courseSelect").value;
    if (selectedRoleIds.length > 0) return { destination: "addons", courseId: "", roleIds: selectedRoleIds };
    if (courseId) return { destination: "courses", courseId, roleIds: [] };
    return { destination: "general", courseId: "", roleIds: [] };
  }

  async function refreshFolderFilter() {
    const { destination, courseId } = getCurrentDestination();
    // populate folder filter based on current destination
    const sel = document.getElementById("listFolderFilter");
    if (!sel) return;
    sel.innerHTML = `<option value="">‚Äî –£—Å—ñ –ø–∞–ø–∫–∏ ‚Äî</option>`;
    const params = new URLSearchParams();
    if (destination) params.set("destination", destination);
    if (courseId && destination === "courses") params.set("courseId", courseId);
    try {
      const r = await fetch(`${API_BASE}/api/library/folders?${params.toString()}`);
      if (r.ok) {
        const folders = await r.json();
        folders.filter(Boolean).sort().forEach(f => {
          const opt = document.createElement("option");
          opt.value = f;
          opt.textContent = f;
          sel.appendChild(opt);
        });
      }
    } catch (e) {
      console.warn("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –ø–∞–ø–æ–∫:", e);
    }
  }

  async function loadExistingMaterials() {
    const listEl = document.getElementById("materialsList");
    if (!listEl) return;
    listEl.innerHTML = "<div>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>";

    const { destination, courseId } = getCurrentDestination();
    const folder = document.getElementById("listFolderFilter")?.value || "";

    const params = new URLSearchParams();
    params.set("destination", destination);
    if (courseId && destination === "courses") params.set("courseId", courseId);
    if (folder) params.set("folder", folder);

    try {
      const r = await fetch(`${API_BASE}/api/library?${params.toString()}`);
      const items = r.ok ? await r.json() : [];
      renderMaterialsList(items);
    } catch (e) {
      console.error(e);
      listEl.innerHTML = "<div>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É.</div>";
    }
  }

  function renderMaterialsList(items) {
    const listEl = document.getElementById("materialsList");
    if (!listEl) return;
    if (!Array.isArray(items) || !items.length) {
      listEl.innerHTML = "<div>–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –¥–ª—è –ø–æ—Ç–æ—á–Ω–∏—Ö —Ñ—ñ–ª—å—Ç—Ä—ñ–≤.</div>";
      return;
    }
    listEl.innerHTML = "";
    items.forEach(it => {
      const row = document.createElement("div");
      row.style.border = "1px solid #eee";
      row.style.borderRadius = "10px";
      row.style.padding = "12px";
      row.style.background = "#fff";

      const meta = [
        it.destination ? `üì¶ ${it.destination}` : "",
        it.folder ? `üìÅ ${it.folder}` : "",
        it.courseId ? `üéì ${it.courseId}` : "",
        it.role ? `üë• ${it.role}` : ""
      ].filter(Boolean).join(" ‚Ä¢ ");

      const title = it.title || (it.type === "video" ? "–í—ñ–¥–µ–æ" : "–§–∞–π–ª");
      const desc  = it.description || "";

      const openPreview = () => {
        if (it.type === "video" && it.videoLink) {
          window.open(it.videoLink, "_blank", "noopener");
        } else if (it.filePath) {
          const url = it.filePath.startsWith("http") ? it.filePath : `${API_BASE}/${it.filePath.replace(/^\/+/, "")}`;
          window.open(url, "_blank", "noopener");
        }
      };

      row.innerHTML = `
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px;">
          <div style="flex:1 1 auto;">
            <div style="font-weight:600;">${escapeHtml(title)}</div>
            ${desc ? `<div style="opacity:.8; font-size:14px;">${escapeHtml(desc)}</div>` : ""}
            ${meta ? `<div style="margin-top:6px; font-size:12px; opacity:.7;">${escapeHtml(meta)}</div>` : ""}
          </div>
          <div style="display:flex; gap:8px; flex:0 0 auto;">
            <button type="button" class="view-btn" data-id="${it._id}">–í—ñ–¥–∫—Ä–∏—Ç–∏</button>
            <button type="button" class="view-btn" data-action="edit" data-id="${it._id}">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
            <button type="button" class="view-btn" data-action="delete" data-id="${it._id}" style="border-color:#b3261e; color:#b3261e;">üóë –í–∏–¥–∞–ª–∏—Ç–∏</button>
          </div>
        </div>
      `;

      row.querySelector('[data-id]').addEventListener('click', openPreview);
      row.querySelector('[data-action="edit"]').addEventListener('click', () => openEditModal(it));
      row.querySelector('[data-action="delete"]').addEventListener('click', () => deleteMaterial(it._id));

      listEl.appendChild(row);
    });
  }

  async function deleteMaterial(id) {
    if (!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª?")) return;
    try {
      const r = await fetch(`${API_BASE}/api/library/${id}`, { method: "DELETE" });
      if (!r.ok) throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏");
      await loadExistingMaterials();
    } catch (e) {
      alert(e.message || "–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è");
    }
  }

  // ----- EDIT MODAL -----
  function openEditModal(item) {
    // –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º —ñ—Å–Ω—É—é—á–µ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–æ–¥–∞–≤–∞–Ω–Ω—è
    openModal(item.type);
    // –ø—Ä–æ—Å—Ç–∞–≤–ª—è—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è
    document.getElementById("materialTitle").value = item.title || "";
    document.getElementById("materialDescription").value = item.description || "";
    const modeEl = document.getElementById("sectionMode");
    const selEl  = document.getElementById("sectionSelect");
    const nameEl = document.getElementById("sectionName");

    // –Ø–∫—â–æ —î –ø–∞–ø–∫–∞ ‚Äî –ø–æ–∫–∞–∂–µ–º–æ —è–∫ existing, —ñ –ø–æ—Å—Ç–∞–≤–∏–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è
    if (item.folder) {
      if (modeEl) modeEl.value = "existing";
      if (selEl) {
        refreshSectionSelect();
        selEl.style.display = "block";
        selEl.value = item.folder;
      }
      if (nameEl) nameEl.style.display = "none";
    } else {
      if (modeEl) modeEl.value = "existing";
      if (selEl) { refreshSectionSelect(); selEl.value = ""; selEl.style.display = "block"; }
      if (nameEl) nameEl.style.display = "none";
    }

    // –¥–ª—è –≤—ñ–¥–µ–æ ‚Äî –≤—Å—Ç–∞–≤–∏–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
    if (item.type === "video") {
      document.getElementById("videoLink").value = item.videoLink || "";
    }

    // –ø–æ–º—ñ—Ç–∏–º–æ, —â–æ —Ü–µ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
    document.getElementById("addMaterialModal").dataset.editId = item._id;
  }

  // –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º submitMaterial –¥–ª—è —Ä–µ–∂–∏–º—É —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
  const originalSubmitMaterial = submitMaterial;
  submitMaterial = async function () {
    const editId = document.getElementById("addMaterialModal").dataset.editId;
    if (!editId) {
      // –∑–≤–∏—á–∞–π–Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è
      return originalSubmitMaterial();
    }

    // –∑–±–∏—Ä–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö —è–∫ —É —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ
    const type = document.getElementById("materialType").value;
    const title = document.getElementById("materialTitle").value?.trim();
    const description = document.getElementById("materialDescription").value?.trim();

    if (!title) return alert("–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –º–∞—Ç–µ—Ä—ñ–∞–ª—É");

    const fd = new FormData();
    fd.append("title", title);
    fd.append("description", description || "");

    // folder
    const modeEl = document.getElementById("sectionMode");
    const selEl  = document.getElementById("sectionSelect");
    const nameEl = document.getElementById("sectionName");
    let folder = "";
    if (modeEl) {
      folder = modeEl.value === "new"
        ? (nameEl?.value || "").trim()
        : (selEl?.value || "").trim();
    }
    fd.append("folder", folder);

    if (type === "video") {
      const link = document.getElementById("videoLink").value?.trim() || "";
      fd.append("videoLink", link);
    } else {
      const file = document.getElementById("bookFile").files[0];
      if (file) {
        // –æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ –º–æ–∂–Ω–∞ –∑–∞–º—ñ–Ω–∏—Ç–∏ —Ñ–∞–π–ª
        fd.append("bookFile", file);
      }
    }

    try {
      const r = await fetch(`${API_BASE}/api/library/${editId}`, {
        method: "PUT",
        body: fd
      });
      if (!r.ok) throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏");
      // –∑–∞—á–∏—Å—Ç–∫–∞ —Ä–µ–∂–∏–º—É —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
      delete document.getElementById("addMaterialModal").dataset.editId;
      closeModal();
      await loadExistingMaterials();
      alert("–ó–º—ñ–Ω–µ–Ω–æ");
    } catch (e) {
      alert(e.message || "–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è");
    }
  };

  // –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏ —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
  document.addEventListener("DOMContentLoaded", () => {
    // –ø–µ—Ä—à–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
    refreshFolderFilter().then(loadExistingMaterials);
    // –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏ –ø—Ä–∏ –∑–º—ñ–Ω—ñ –∫—É—Ä—Å—É/—Ä–æ–ª–µ–π/–ø–∞–ø–∫–∏
    const courseSel = document.getElementById("courseSelect");
    if (courseSel) {
      courseSel.addEventListener("change", async () => {
        await refreshFolderFilter();
        await loadExistingMaterials();
      });
    }
    const roleFilterGroup = document.getElementById("roleFilterGroup");
    if (roleFilterGroup) {
      roleFilterGroup.addEventListener("change", async () => {
        await refreshFolderFilter();
        await loadExistingMaterials();
      });
    }
    const folderSel = document.getElementById("listFolderFilter");
    if (folderSel) {
      folderSel.addEventListener("change", loadExistingMaterials);
    }
  });