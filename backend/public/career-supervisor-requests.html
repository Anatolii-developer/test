<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Супервізор — Заявки всіх учасників</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
    <style>
      body {
        margin: 0;
        font-family: "Poppins", sans-serif;
        background: #97c194;
        color: #414141;
        padding: 0;
      }

      main.supervisor-requests-page {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        padding: 32px 16px 72px;
        box-sizing: border-box;
      }

      .apply-header {
        width: 100%;
        max-width: 1110px;
        background: #fff;
        border-radius: 24px;
        margin: 0 auto 10px;
        padding: clamp(24px, 4vw, 40px) clamp(24px, 8vw, 100px);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 20px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.06);
        text-align: center;
      }
      .apply-title {
        font-size: clamp(28px, 4vw, 40px);
        font-weight: 600;
        color: #414141;
      }
      .apply-image {
        width: clamp(200px, 28vw, 284px);
        height: auto;
      }
      .apply-arrow {
        width: 56px;
        height: 56px;
        flex-shrink: 0;
      }
      .toolbar {
        width: 100%;
        max-width: 1110px;
        margin: 0 auto 6px;
        display: flex;
        gap: 10px;
        justify-content: space-between;
        flex-wrap: wrap;
        align-items: center;
      }
      .back-button {
        width: 196px;
        height: 48px;
        background: #275d2b;
        border-radius: 24px;
        color: #fff;
        padding: 10px 53px;
        margin: 0 auto 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        cursor: pointer;
        text-decoration: none;
      }
      .apply-form {
        width: 100%;
        max-width: 1110px;
        background: #fff;
        border-radius: 24px;
        padding: clamp(24px, 5vw, 40px) clamp(20px, 7vw, 100px);
        margin: 0 auto 32px;
        box-sizing: border-box;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.06);
      }
      h3.page-subtitle {
        margin: 0 0 8px;
        font-weight: 600;
      }

      /* List */
      #list {
        margin-top: 10px;
      }
      .req-row {
        width: 100%;
        background: #ffeed9;
        border-radius: 16px;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 16px;
        margin: 12px 0;
        justify-content: space-between;
        box-sizing: border-box;
      }
      .req-left {
        display: flex;
        align-items: center;
        gap: 16px;
        min-width: 0;
        flex: 1 1 auto;
      }
      .req-num {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        flex: 0 0 36px;
      }
      .req-name {
        font-weight: 500;
        font-size: 20px;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .req-date {
        font-weight: 500;
        font-size: 18px;
        color: #555;
        white-space: nowrap;
        flex: 0 0 auto;
      }
      .btn-more {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        height: 40px;
        padding: 0 16px;
        border-radius: 24px;
        border: none;
        cursor: pointer;
        background: #275d2b;
        color: #fff;
        font-weight: 600;
        font-size: 14px;
        white-space: nowrap;
        flex: 0 0 auto;
        text-decoration: none;
        gap: 8px;
        margin-left: auto;
      }
      .btn-more .btn-label { display: inline; }
      .btn-more .btn-arrow { display: none; width: 22px; height: 22px; }
      .empty {
        text-align: center;
        color: #6b6b6b;
        margin-top: 8px;
      }
      @media (max-width: 1024px) {
        main.supervisor-requests-page {
          padding: 20px 12px 60px;
        }
        .apply-header {
          flex-direction: column;
          align-items: center;
          text-align: center;
        }
        .apply-arrow {
          align-self: flex-end;
        }
        .toolbar {
          justify-content: center;
          gap: 12px;
        }
        .req-row {
          flex-wrap: wrap;
        }
        .req-name {
          max-width: 50vw;
        }
      }
      @media (max-width: 768px) {
        .req-row {
          align-items: flex-start;
        }
        .req-left {
          flex-wrap: wrap;
          gap: 10px;
        }
        .req-name {
          width: 100%;
          order: 3;
          white-space: normal;
          line-height: 1.4;
        }
        .req-date {
          order: 2;
          font-size: 16px;
        }
        .btn-more {
          width: 48px;
          height: 48px;
          padding: 10px;
          border-radius: 14px;
          align-self: center;
          background: transparent !important;
          box-shadow: none;
          border: none;
          color: #275d2b;
        }
        .btn-more .btn-label { display: none; }
        .btn-more .btn-arrow { display: inline-block; }
      }
    </style>
  </head>
  <body>
  <header class="site-header">
    <button class="burger" id="burgerBtn" aria-label="Відкрити меню" aria-expanded="false" aria-controls="sidebar">
      <img src="assets/sidebar/burger.svg" alt="" />
    </button>

    <a href="/" class="header-logo" aria-label="Головна">
      <img src="assets/emblem.svg" alt="IPS" />
    </a>

    <button class="lang-switch" id="langBtn" aria-haspopup="listbox" aria-expanded="false">
      UA ▼
    </button>
  </header>
    <aside class="sidebar collapsed" id="sidebar">
      <div class="toggle-button" onclick="toggleSidebar()">
        <img src="assets/sidebar/arrow.svg" alt="Toggle" id="toggleArrow" />
      </div>
      <img
        class="logo"
        src="assets/sidebar/IPS Logo (2).svg"
        alt="Logo"
        id="logoExpanded"
      />
      <img
        class="logo-collapsed"
        src="assets/sidebar/IPS Logo (1).svg"
        alt="Logo Small"
        id="logoCollapsed"
      />
      <img
        class="profile"
        src="assets/profile-photo.png"
        alt="User"
        width="40"
        height="40"
      />
      <nav>
        <a href="profile.html"
          ><img src="assets/sidebar/profile.svg" /><span>Про Мене</span></a
        >
        <a href="mycertificates.html"
          ><img src="assets/sidebar/news.svg" /><span>Мої Сертифікати</span></a
        >
        <a href="career-faq.html"
          ><img src="assets/sidebar/10.svg" /><span>Планування Кар'єри</span></a
        >
        <a href="library.html"
          ><img src="assets/sidebar/3.svg" /><span>Бібліотека</span></a
        >
        <a href="my-courses.html"
          ><img src="assets/sidebar/5.svg" /><span>Мої Курси</span></a
        >
         <a href="forum/index.html">
  <img src="assets/sidebar/forum.svg" alt="Форум"/>
  <span>Форум</span>
</a>
        <a href="practice-records.html"><img src="assets/practice-records.svg" /><span>Облік Практики</span></a>
      </nav>
      <div class="logout">
        <img
          src="assets/sidebar/log-out.svg"
          alt="Logout"
          width="20"
          height="20"
        /><span>Вийти з акаунту</span>
      </div>
    </aside>
  <div class="drawer-backdrop" id="drawerBackdrop"></div>

    <main class="supervisor-requests-page" id="mainContent">
      <div class="apply-header">
        <div class="apply-title">Супервізор — Заявки всіх учасників</div>
        <img class="apply-image" src="./assets/career-apply.png" alt="Person" />
        <img class="apply-arrow" src="./assets/library/arrow.png" alt="Arrow" />
      </div>

      <div class="toolbar">
        <a href="career-faq.html" class="back-button" style="margin: 0">
          <img src="./assets/library/arrow-main.svg" alt="Back" /> Головна
        </a>
        <a href="career-mentor-requests.html" class="back-button" style="margin: 0; background:#ecf5eb; color:#275d2b; border:1px solid #275d2b;">Менторські заявки</a>
      </div>

      <div class="apply-form">
        <h3 class="page-subtitle">Заявки всіх учасників</h3>
        <div id="list"></div>
        <div id="empty" class="empty" style="display: none">
          Поки що немає заявок учасників.
        </div>
      </div>
    </main>

    <script>
      const SUPERVISOR_REQUESTS_I18N = {
        ua: {
          title: "Супервізор — Заявки всіх учасників",
          applyTitle: "Супервізор — Заявки всіх учасників",
          backHome: "Головна",
          mentorRequests: "Менторські заявки",
          pageSubtitle: "Заявки всіх учасників",
          empty: "Поки що немає заявок учасників.",
          loginNotice: "Щоб переглянути заявки — увійдіть у систему.",
          loginBtn: "Увійти",
          learnMore: "Дізнатись більше",
          ariaOpen: "Відкрити заявку детально",
          noName: "Без імені",
          accessDenied: "Доступ лише для супервізорів.",
          loadError: "Не вдалося завантажити заявки.",
        },
        ru: {
          title: "Супервизор — Заявки всех участников",
          applyTitle: "Супервизор — Заявки всех участников",
          backHome: "На Главную",
          mentorRequests: "Менторские заявки",
          pageSubtitle: "Заявки всех участников",
          empty: "Пока что нет заявок участников.",
          loginNotice: "Чтобы просмотреть заявки — войдите в систему.",
          loginBtn: "Войти",
          learnMore: "Узнать больше",
          ariaOpen: "Просмотреть заявку",
          noName: "Без имени",
          accessDenied: "Доступ только для супервизоров.",
          loadError: "Не удалось загрузить заявки.",
        },
        en: {
          title: "All Participant Applications",
          applyTitle: "All Participant Applications",
          backHome: "Home",
          mentorRequests: "Mentorship Applications",
          pageSubtitle: "All Participant Applications",
          empty: "No participant requests yet.",
          loginNotice: "To view applications, please log in.",
          loginBtn: "Log in",
          learnMore: "Learn More",
          ariaOpen: "View Application",
          noName: "No name",
          accessDenied: "Supervisors only.",
          loadError: "Failed to load applications.",
        },
      };
      let currentLang = "ua";
      const normalizeLang = (value) => {
        const v = String(value || "").toLowerCase().trim();
        if (v.startsWith("uk") || v === "ua") return "ua";
        if (v.startsWith("ru")) return "ru";
        if (v.startsWith("en")) return "en";
        return "ua";
      };
      const getStoredLang = () => {
        try {
          const stored = localStorage.getItem("uiLang");
          if (stored) return normalizeLang(stored);
        } catch (_) {}
        return normalizeLang(document.documentElement.lang);
      };
      const t = (key) => {
        const copy =
          SUPERVISOR_REQUESTS_I18N[currentLang] || SUPERVISOR_REQUESTS_I18N.ua;
        return copy[key] || "";
      };

      function setButtonTextWithIcon(el, text) {
        if (!el) return;
        Array.from(el.childNodes)
          .filter((n) => n.nodeType === Node.TEXT_NODE)
          .forEach((n) => n.remove());
        el.appendChild(document.createTextNode(` ${text}`));
      }

      function applyLang(lang) {
        currentLang = normalizeLang(lang);
        const copy =
          SUPERVISOR_REQUESTS_I18N[currentLang] || SUPERVISOR_REQUESTS_I18N.ua;
        document.title = copy.title;
        const applyTitle = document.querySelector(".apply-title");
        if (applyTitle) applyTitle.textContent = copy.applyTitle;
        const backBtn = document.querySelector(".back-button");
        setButtonTextWithIcon(backBtn, copy.backHome);
        const mentorBtn = document.querySelector(
          '.toolbar a[href="career-mentor-requests.html"]'
        );
        if (mentorBtn) mentorBtn.textContent = copy.mentorRequests;
        const subtitle = document.querySelector(".page-subtitle");
        if (subtitle) subtitle.textContent = copy.pageSubtitle;
        const emptyEl = document.getElementById("empty");
        if (emptyEl && emptyEl.style.display !== "none") {
          emptyEl.textContent = copy.empty;
        }
        document.querySelectorAll(".btn-more .btn-label").forEach((el) => {
          el.textContent = copy.learnMore;
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        applyLang(getStoredLang());
      });

      window.addEventListener("uiLangChange", (e) => {
        applyLang(e.detail?.lang);
        if (typeof load === "function") load();
      });
      const pad = (n) => String(n).padStart(2, "0");
      function formatDate(iso) {
        const d = new Date(iso);
        if (isNaN(d)) return "";
        return `${pad(d.getDate())}-${pad(
          d.getMonth() + 1
        )}-${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }
      function fullNameFrom(item) {
        const u = item.user || {};
        const first = u.firstName || item.firstName || "";
        const last = u.lastName || item.lastName || "";
        return first || last
          ? `${first} ${last}`.trim()
          : item.fullName || item.email || t("noName");
      }
      function ensureContainers() {
        const form = document.querySelector(".apply-form") || document.body;
        let list = document.getElementById("list");
        if (!list) {
          list = document.createElement("div");
          list.id = "list";
          form.appendChild(list);
        }
        let empty = document.getElementById("empty");
        if (!empty) {
          empty = document.createElement("div");
          empty.id = "empty";
          empty.className = "empty";
          empty.style.display = "none";
          empty.textContent = t("empty");
          form.appendChild(empty);
        }
        return { listEl: list, emptyEl: empty };
      }
      function showLoginNotice(msg) {
        const { emptyEl, listEl } = ensureContainers();
        emptyEl.textContent = msg || t("loginNotice");
        emptyEl.style.display = "block";
        if (listEl) listEl.innerHTML = "";
        const btn = document.createElement("a");
        btn.href = "index.html";
        btn.textContent = t("loginBtn");
        btn.style.cssText =
          "display:inline-block;margin-top:8px;background:#275D2B;color:#fff;padding:8px 16px;border-radius:12px;text-decoration:none;";
        emptyEl.appendChild(btn);
      }
      function rowTemplate(i, item) {
        const fullName = fullNameFrom(item);
        const created = item.createdAt
          ? formatDate(item.createdAt)
          : item.created_at
          ? formatDate(item.created_at)
          : "";
        const id =
          item._id ||
          item.id ||
          (item.application && (item.application._id || item.application.id)) ||
          "";
        const row = document.createElement("div");
        row.className = "req-row";
        const left = document.createElement("div");
        left.className = "req-left";
        const num = document.createElement("div");
        num.className = "req-num";
        num.textContent = i;
        const name = document.createElement("div");
        name.className = "req-name";
        name.textContent = fullName;
        const date = document.createElement("div");
        date.className = "req-date";
        date.textContent = created;
        left.append(num, name, date);
        const more = document.createElement("a");
        more.className = "btn-more";
        more.href = `career-supervisor-request.html?id=${encodeURIComponent(
          id
        )}`;
        more.setAttribute("aria-label", t("ariaOpen"));
        more.innerHTML = `
          <span class="btn-label">${t("learnMore")}</span>
          <img src="./assets/library/arrow.png" alt="Arrow" class="btn-arrow" />
        `;
        row.append(left, more);
        return row;
      }
      function getAuthToken() {
        const keys = ["token", "authToken", "jwt", "accessToken", "bearer"];
        for (const k of keys) {
          const v = localStorage.getItem(k);
          if (v) return v;
        }
        try {
          const u = JSON.parse(localStorage.getItem("user") || "{}");
          return u.token || u.accessToken || null;
        } catch (_) {
          return null;
        }
      }
      async function ensureSupervisor() {
        try {
          const res = await fetch("/api/users/profile", {
            method: "GET",
            credentials: "include",
          });
          let body = null;
          try {
            body = await res.clone().json();
          } catch (_) {}

          // handle both shapes: { user: {...} } or direct user object
          if (!res.ok || !body) return null;
          const userObj = body.user || body;

          const roles = Array.isArray(userObj.roles) ? userObj.roles : [];
          // debug log to see current roles
          try { console.log("[supervisor] roles:", roles); } catch (_) {}

          const has = roles.some((r) => /супервізор|супервизор|supervisor/i.test(String(r)));
          return has ? userObj : null;
        } catch (e) {
          console.warn("ensureSupervisor failed:", e);
          return null;
        }
      }
      // Только заявки, назначенные текущему супервізору
      async function fetchAllApplications() {
        const token = getAuthToken();
        const headers = Object.assign(
          { Accept: "application/json" },
          token ? { Authorization: `Bearer ${token}` } : {}
        );
        try {
          const res = await fetch(
            "/api/career-applications?assigned=1&target=supervisor",
            { method: "GET", credentials: "include", headers }
          );
          const body = await res
            .clone()
            .json()
            .catch(() => null);
          if (res.ok) {
            if (Array.isArray(body)) return body;
            if (Array.isArray(body?.items)) return body.items;
            if (Array.isArray(body?.rows)) return body.rows;
            if (Array.isArray(body?.data)) return body.data;
            if (body?.ok && Array.isArray(body?.result)) return body.result;
          }
        } catch (_) {}
        return [];
      }
      async function load() {
        const { listEl, emptyEl } = ensureContainers();
        const user = await ensureSupervisor();
        if (!user) {
          showLoginNotice(t("accessDenied"));
          return;
        }
        try {
          const items = await fetchAllApplications();
          listEl.innerHTML = "";
          if (!items.length) {
            emptyEl.style.display = "block";
            emptyEl.textContent = t("empty");
            return;
          }
          emptyEl.style.display = "none";
          items
            .sort(
              (a, b) =>
                new Date(b.createdAt || b.created_at || 0) -
                new Date(a.createdAt || a.created_at || 0)
            )
            .forEach((it, idx) => listEl.appendChild(rowTemplate(idx + 1, it)));
        } catch (err) {
          console.error(err);
          emptyEl.textContent = t("loadError");
          emptyEl.style.display = "block";
        }
      }
      document.addEventListener("DOMContentLoaded", load);
    </script>
  </body>
</html>
