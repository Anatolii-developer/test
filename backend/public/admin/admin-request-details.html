<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Адмін — Заявка</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="icon"
      type="image/svg+xml"
      href="/assets/sidebar/IPS Logo (1).svg"
    />
    <style>
      :root {
        --green: #275d2b;
        --bg: #97c194;
        --orange: #e8812e;
        --light: #ecf5eb;
      }
      body {
        margin: 0;
        font-family: Poppins, system-ui, -apple-system, Segoe UI, Roboto;
        background: var(--bg);
        color: #414141;
      }
      .page {
        width: 890px;
        margin: 32px auto;
        background: #fff;
        border-radius: 24px;
        padding: 60px 100px;
        display: flex;
        flex-direction: column;
        gap: 36px;
      }
      .tabs {
        display: flex;
        gap: 16px;
      }
      .tab {
        width: 326px;
        height: 152px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        cursor: pointer;
      }
      .tab.light {
        background: var(--light);
      }
      .tab.dark {
        background: var(--green);
        color: #fff;
      }
      .card {
        display: grid;
        grid-template-columns: 248px 1fr;
        gap: 32px;
      }

      .names{
  display:flex;
  flex-direction:column;
  gap:24px;
  align-items:flex-start;
}
.info-grid{
  display:grid;
  grid-template-columns:1fr;
  gap:24px 32px;
  margin-top:24px;
}
      .photo {
        width: 248px;
        height: 250px;
        object-fit: cover;
        border-radius: 12px;
        border: 2px solid var(--orange);
        background: #eef1ee;
      }
      
      .field {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      label {
        font-size: 14px;
        color: #6b6b6b;
      }
      input[readonly],
      textarea[readonly] {
        background: #fff;
      }
      input,
      textarea {
        width: 100%;
        box-sizing: border-box;
        border: 1px solid #d9d9d9;
        border-radius: 12px;
        padding: 10px 12px;
        font: 14px/1.4 Poppins, sans-serif;
        color: #222;
      }
      textarea {
        min-height: 92px;
        resize: vertical;
      }
      .select-wrap {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 8px;
      }
      .mentor-select {
        width: 456px;
        height: 48px;
        background: #ffeed9;
        border-radius: 5px;
        padding: 12px 21px 12px 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border: 1px solid rgba(0, 0, 0, 0.05);
        cursor: pointer;
        user-select: none;
      }
      .mentor-caret {
        width: 16px;
        height: 16px;
        opacity: 0.9;
      }
      .mentor-menu {
        width: 456px;
        max-height: 240px;
        overflow: auto;
        background: #fff;
        border: 1px solid var(--orange);
        border-radius: 8px;
        margin-top: 8px;
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
        display: none;
      }
      .mentor-option {
        padding: 10px 12px;
        cursor: pointer;
      }
      .mentor-option:hover {
        background: #fff4ea;
      }
      .mentor-option.active {
        background: #ffe5cc;
      }
      .actions {
        display: flex;
        justify-content: flex-end;
      }
      .btn {
        background: var(--green);
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 12px 22px;
        font-weight: 700;
        cursor: pointer;
      }
      @media (max-width: 980px) {
        .page {
          width: 92%;
          padding: 28px;
        }
        .card {
          grid-template-columns: 1fr;
        }
        .photo {
          width: 200px;
          height: 200px;
        }
        .mentor-select,
        .mentor-menu {
          width: 100%;
        }
      
      }

      /* === Design overrides for names and sizing === */
      /* Tabs typography */
      .tab {
        font-family: Inter, Poppins, sans-serif;
        font-weight: 600;
        font-size: 24px;
        text-align: center;
      }



      /* Name fields special styling */
      #lastName,
      #firstName,
      #middleName {
        width: 251px;
        height: 36px;
        border-radius: 8px;
        border: none;
        box-shadow: 1px 1px 4px 0px #00000040;
        font-family: Poppins, sans-serif;
        font-weight: 700;
        font-size: 20px;
        color: #275D2B;
        background-color: #DDF3DC;
        padding: 6px 10px;
      }

      /* Date field styling */
      #submittedAt {
        width: 250px;
        height: 36px;
        border-radius: 8px;
        background: #fff;
        border: 1px solid #d9d9d9;
        font-family: Poppins, sans-serif;
        font-size: 16px;
        padding: 6px 10px;
      }

      /* Years and category fields */
      #experience,
      #age {
        width: 456px;
        height: 36px;
        border-radius: 8px;
        border-width: 1px;
        border-style: solid;
        border-color: #d9d9d9;
        background: #fff;
        font-family: Poppins, sans-serif;
        font-size: 16px;
        padding: 6px 10px;
      }

      /* Notes column textareas height */
      #note1,
      #note2,
      #note3,
      #note4,
      #note5,
      #note6 {
        height: 144px;
      }

      /* Full-width long text blocks */
      #requestText,
      #aboutText,
      #education,
      #topics {
        width: 514px;
        height: 144px;
        min-height: 144px;
        border-radius: 8px;
        background: #fff;
        border: 1px solid #d9d9d9;
        font-family: Poppins, sans-serif;
        font-size: 16px;
        padding: 10px 12px;
        box-sizing: border-box;
        resize: vertical;
      }
    </style>
  </head>
  
  <body class="with-sidebar">
  <aside class="sidebar" id="sidebar"></aside>
    <div class="page">
      <div class="tabs">
        <a class="tab light" href="admin-career-faq.html">Редагувати FAQ</a>
        <div class="tab dark">Налаштування ментора</div>
      </div>

      <div class="card">
        <img
          id="photo"
          class="photo"
          src="/assets/profile-photo.png"
          alt="Фото"
        />

       <div class="names">
  <div class="field">
    <label>Прізвище</label><input id="lastName" readonly />
  </div>
  <div class="field">
    <label>Імʼя</label><input id="firstName" readonly />
  </div>
  <div class="field">
    <label>По-батькові</label><input id="middleName" readonly />
  </div>
</div>
          

         <div class="info-grid">
  <div class="field">
    <label>Дата подання заявки</label><input id="submittedAt" readonly />
  </div>
  <div class="field">
    <label>Скільки років у вас практики</label><input id="experience" readonly />
  </div>
  <div class="field">
    <label>Категорія за віком</label><input id="age" readonly />
  </div>

  <div class="field" style="grid-column:1/-1">
    <label>Запит до ментора</label><textarea id="requestText" readonly></textarea>
  </div>
  <div class="field" style="grid-column:1/-1">
    <label>Про себе / ситуація</label><textarea id="aboutText" readonly></textarea>
  </div>
  <div class="field" style="grid-column:1/-1">
    <label>Психологічна освіта</label><textarea id="education" readonly></textarea>
  </div>
  <div class="field" style="grid-column:1/-1">
    <label>Тематики/теми</label><textarea id="topics" readonly></textarea>
  </div>

  <div class="field select-wrap" style="grid-column:1/-1">
    <label id="assignLabel">Призначити ментора</label>
    <div id="mentorSelectBtn" class="mentor-select" tabindex="0" aria-haspopup="listbox" aria-expanded="false">
      <span id="mentorSelectLabel">Оберіть ментора</span>
      <img class="mentor-caret" src="/admin/images/arrow-down.png" alt="">
    </div>
    <div id="mentorMenu" class="mentor-menu" role="listbox" tabindex="-1"></div>
    <input type="hidden" id="mentorSelectValue">
  </div>


      <div class="actions">
  <button id="saveBtn" class="btn" type="button">Зберегти</button>
</div>
<script src="admin-auth.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        if (typeof renderAdminSidebar === "function") {
          renderAdminSidebar("admin-career-requests.html");
        }
        if (typeof requireAdminPage === "function") {
          requireAdminPage();
        }
        load();
      });
      // --- small helpers ---
      const qs = (s) => document.querySelector(s);
      const pad = (n) => String(n).padStart(2, "0");
      const fmt = (iso) => {
        const d = new Date(iso);
        if (isNaN(d)) return "";
        return `${pad(d.getDate())}.${pad(
          d.getMonth() + 1
        )}.${d.getFullYear()}`;
      };
      const params = new URLSearchParams(location.search);
      const ID = params.get("id");

      function getToken() {
        try {
          const u = JSON.parse(localStorage.getItem("user") || "{}");
          return (
            u.token || u.accessToken || localStorage.getItem("token") || null
          );
        } catch (_) {
          return localStorage.getItem("token") || null;
        }
      }
      const authHeaders = () => {
        const t = getToken();
        return Object.assign(
          { Accept: "application/json" },
          t ? { Authorization: "Bearer " + t } : {}
        );
      };

      // role-based assignee dropdown
      let __ASSIGNEES = [];
      let CURRENT_ROLE = 'mentor'; // will be detected from application
      let APP_TARGET = 'mentor';

      async function fetchUsersByRole(role) {
        const h = authHeaders();
        // 1) try server-side filtering
        let r = await fetch(`/api/users?role=${encodeURIComponent(role)}`, {
          credentials: 'include',
          headers: h,
        });
        if (r.ok) {
          const u = await r.json();
          return Array.isArray(u) ? u : [];
        }
        // 2) fallback to client-side filtering
        r = await fetch('/api/users', { credentials: 'include', headers: h });
        if (!r.ok) return [];
        const all = await r.json();
        const roleLc = String(role).toLowerCase();
        return (Array.isArray(all) ? all : []).filter((u) => {
          const rs = (u.roles || []).map((s) => String(s).toLowerCase());
          return rs.some((x) =>
            x.includes(roleLc) ||
            (roleLc === 'mentor' && x.includes('ментор')) ||
            (roleLc === 'supervisor' && (x.includes('супервізор') || x.includes('супервизор')))
          );
        });
      }

      function renderMentorMenu(list, selectedId) {
        const menu = qs('#mentorMenu');
        menu.innerHTML = '';
        if (!list.length) {
          const d = document.createElement('div');
          d.className = 'mentor-option';
          d.textContent = 'Немає доступних користувачів';
          menu.appendChild(d);
          return;
        }
        list.forEach((m) => {
          const d = document.createElement('div');
          d.className = 'mentor-option' + (selectedId === m._id ? ' active' : '');
          d.textContent = `${m.firstName || ''} ${m.lastName || ''}`.trim() || m.username || m.email || 'Без імені';
          d.addEventListener('click', () => {
            qs('#mentorSelectLabel').textContent = d.textContent;
            qs('#mentorSelectValue').value = m._id;
            menu.style.display = 'none';
            qs('#mentorSelectBtn').setAttribute('aria-expanded', 'false');
          });
          menu.appendChild(d);
        });
      }
      function detectRequestedRole(a) {
        // default mentor
        const S = [
          a?.to,
          a?.target,
          a?.type,
          a?.category,
          a?.direction,
          a?.for,
          a?.applyFor,
          a?.requestType,
          a?.applicationType,
        ]
          .map((v) => String(v || '').toLowerCase())
          .join(' | ');

        const isSupervisor =
          S.includes('supervisor') || S.includes('супервізор') || S.includes('супервизор');
        return isSupervisor ? 'supervisor' : 'mentor';
      }
      (() => {
        const btn = qs("#mentorSelectBtn"),
          menu = qs("#mentorMenu");
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const open = menu.style.display === "block";
          menu.style.display = open ? "none" : "block";
          btn.setAttribute("aria-expanded", String(!open));
        });
        window.addEventListener("click", (e) => {
          if (!btn.contains(e.target) && !menu.contains(e.target)) {
            menu.style.display = "none";
            btn.setAttribute("aria-expanded", "false");
          }
        });
        btn.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            btn.click();
          }
          if (e.key === "Escape") {
            menu.style.display = "none";
            btn.setAttribute("aria-expanded", "false");
          }
        });
      })();

      // fetch one application
      async function loadApplication() {
        if (!ID) {
          alert("Не передано id");
          return;
        }
        const r = await fetch(`/api/career-applications/${ID}`, {
          credentials: "include",
          headers: authHeaders(),
        });
        const body = await r.json().catch(() => ({}));
        if (!r.ok || !body?.ok) {
          alert(body?.message || "Помилка завантаження");
          return;
        }
        const a = body.application;
        // Set APP_TARGET based on backend-provided application target (if any)
        APP_TARGET = (a && a.target) ? String(a.target).toLowerCase() : CURRENT_ROLE;
        const u = a.user || {};
        qs("#photo").src = u.photoUrl || "/assets/profile-photo.png";
        qs("#lastName").value = u.lastName || "";
        qs("#firstName").value = u.firstName || "";
        qs("#middleName").value = u.middleName || "";
        qs("#submittedAt").value = fmt(a.createdAt);
        qs("#experience").value = a.experience || "";
        qs("#age").value = a.ageGroup || "";
        qs("#requestText").value = a.requestText || "";
        qs("#aboutText").value = a.aboutText || "";
        qs("#education").value = a.education || "";
        qs("#topics").value = Array.isArray(a.topics)
          ? a.topics.join(", ")
          : a.topics || "";

        CURRENT_ROLE = detectRequestedRole(a);
        const assignLabel = qs('#assignLabel');
        if (assignLabel) assignLabel.textContent = CURRENT_ROLE === 'supervisor' ? 'Призначити супервізора' : 'Призначити ментора';
        // Update placeholder on closed select
        const selLabel = qs('#mentorSelectLabel');
        if (selLabel && !qs('#mentorSelectValue').value) {
          selLabel.textContent = CURRENT_ROLE === 'supervisor' ? 'Оберіть супервізора' : 'Оберіть ментора';
        }

        // assignees by role
        __ASSIGNEES = await fetchUsersByRole(CURRENT_ROLE);
        const assignedId = CURRENT_ROLE === 'supervisor'
          ? (a.assignedSupervisor?._id || a.assignedSupervisorId || '')
          : (a.assignedMentor?._id || a.assignedMentorId || '');

        if (assignedId) {
          const f = __ASSIGNEES.find((m) => m._id === assignedId);
          if (f) {
            qs('#mentorSelectLabel').textContent = `${f.firstName || ''} ${f.lastName || ''}`.trim() || f.username || f.email || 'Без імені';
            qs('#mentorSelectValue').value = assignedId;
          }
        }
        renderMentorMenu(__ASSIGNEES, assignedId);
      }

   async function save() {
    console.log('[save] start');
    const selectedId = (qs('#mentorSelectValue').value || '').trim();
    const isSupervisorFlow = (CURRENT_ROLE === 'supervisor') || (APP_TARGET === 'supervisor');

    if (!selectedId) {
      return alert(isSupervisorFlow ? 'Оберіть супервізора' : 'Оберіть ментора');
    }

    const controller = new AbortController();
    const t = setTimeout(() => controller.abort('timeout'), 30000); // 30s

    try {
      const payloadKey = isSupervisorFlow ? 'supervisorId' : 'mentorId';
      const bodyJson = { [payloadKey]: selectedId };

      const r = await fetch(`/api/career-applications/${ID}/assign`, {
        method: 'PUT',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json', ...authHeaders() },
        body: JSON.stringify(bodyJson),
        signal: controller.signal,
      });
      clearTimeout(t);
      console.log('[save] status:', r.status);

      if (!r.ok) {
        let txt = '';
        try { txt = await r.text(); } catch(_) {}
        // expose server reason to help debugging 400 Bad Request
        alert(`Помилка збереження (${r.status}): ${txt.slice(0,500) || 'Bad Request'}`);
        return;
      }

      alert(isSupervisorFlow ? 'Супервізора призначено' : 'Ментора призначено');
      history.back();
    } catch (e) {
      clearTimeout(t);
      console.error('[save] failed:', e, e?.name, e?.message);
      alert('Failed to fetch: ' + (e?.message || e));
    }
  }

      document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('saveBtn');
  if (btn) {
    btn.addEventListener('click', (e) => {
      console.log('[UI] save clicked');
      save().catch(err => {
        console.error('[save] failed:', err);
        alert('Помилка мережі або CORS: ' + (err?.message || err));
      });
    });
  } else {
    console.error('saveBtn not found in DOM');
  }
  loadApplication().catch(e=>{
    console.error('[loadApplication] failed:', e);
    alert('Помилка завантаження заявки');
  });
});

 function logoutUser(){
    try{
      // чистимо локальне
      localStorage.removeItem('user');
      ['token','authToken','jwt','accessToken','bearer'].forEach(k => localStorage.removeItem(k));
    }catch(_){}

    // пробуємо вийти і на бекенді (ігноруємо помилки мережі)
    const API = ""; // якщо бек і фронт на одному домені — залиш порожнім
    fetch(`${API}/api/users/logout`, { method:'POST', credentials:'include' }).catch(()=>{});

    // редірект на логін з поверненням
    const back = encodeURIComponent(location.pathname + location.search);
    location.href = `admin-login.html?returnUrl=${back}`;
  }

  // прив’язуємо до кнопки
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('btnLogout');
    if (btn) btn.addEventListener('click', logoutUser);
  });

  document.addEventListener('DOMContentLoaded', () => {
  const here = location.pathname.split('/').pop();
  document.querySelectorAll('.sidebar nav a').forEach(a=>{
    if (a.getAttribute('href') === here) a.classList.add('active');
  });
});


    </script>
  </body>
</html>
