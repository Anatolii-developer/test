<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Відновлення - Psychologist Platform</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <img class="logo" src="assets/logo.png" alt="Institute Logo" />
    <div class="language-select">UA ▼</div>
  </header>

  <main>
    <div class="login-card">
      <h1 class="h1" style="color: #D97A1C; text-align: center;">Відновлення</h1>

      <label for="email" class="s1">Email</label>
      <div class="input-wrapper">
        <img src="assets/icon-user.svg" class="input-icon" alt="email icon" />
        <input type="email" id="email" placeholder="Enter your email" />
      </div>

      <button id="btnSend" onclick="sendRecoveryCode()">Надіслати код</button>
      <div id="resendWrap" style="display:none; margin-top:8px;">
        <button id="btnResend" onclick="resendCode()" style="background:#6c757d;">Надіслати код ще раз</button>
        <span id="resendTimer" class="s1" style="margin-left:8px; color:#6c757d;"></span>
      </div>

      <!-- Шаг 2: код -->
      <div id="codeBlock" style="display:none; margin-top:16px;">
        <label for="code" class="s1">Код з листа</label>
        <div class="input-wrapper">
          <input type="text" id="code" placeholder="6-значний код" inputmode="numeric" maxlength="6" />
        </div>
        <button id="btnVerify" onclick="verifyCode()">Підтвердити код</button>
      </div>

      <!-- Шаг 3: новый пароль -->
      <div id="resetBlock" style="display:none; margin-top:16px;">
        <label for="newPassword" class="s1">Новий пароль</label>
        <div class="input-wrapper">
          <input type="password" id="newPassword" placeholder="Введіть новий пароль" />
        </div>
        <label for="newPassword2" class="s1" style="margin-top:8px;">Підтвердження</label>
        <div class="input-wrapper">
          <input type="password" id="newPassword2" placeholder="Повторіть пароль" />
        </div>
        <button id="btnReset" onclick="resetPassword()">Змінити пароль</button>
      </div>

      <button style="background-color: #aaa; margin-top: 12px;" onclick="history.back()">Повернутись назад</button>
    </div>
</main>
<script>
  // Primary routes live under /api/auth/recovery, but some deployments expose only /api/auth/forgot-password.
  // We'll try primary first, then fallback automatically.
  const API_PRIMARY = '/api/users/recovery';
const API_FALLBACK = '/api/users';
  const state = { email: '', code: '', codeVerified: false };
  const RESEND_COOLDOWN = 60; // seconds
  let cooldownLeft = 0;
  let cooldownTimer = null;

  function startCooldown() {
    const wrap = qs('resendWrap');
    const btn = qs('btnResend');
    const t = qs('resendTimer');
    if (!wrap || !btn || !t) return;

    wrap.style.display = '';
    cooldownLeft = RESEND_COOLDOWN;
    btn.disabled = true;
    t.textContent = `Можна надіслати повторно через ${cooldownLeft}s`;

    clearInterval(cooldownTimer);
    cooldownTimer = setInterval(() => {
      cooldownLeft -= 1;
      if (cooldownLeft <= 0) {
        clearInterval(cooldownTimer);
        t.textContent = 'Можна надіслати повторно';
        btn.disabled = false;
      } else {
        t.textContent = `Можна надіслати повторно через ${cooldownLeft}s`;
      }
    }, 1000);
  }

  function qs(id){ return document.getElementById(id); }
  function show(el, yes){ if(!el) return; el.style.display = yes ? '' : 'none'; }
  function toast(msg){ alert(msg); }
  function setLoading(btn, is){
    if(!btn) return;
    if(is){
      btn.disabled = true;
      if(!btn.dataset._txt) btn.dataset._txt = btn.textContent;
      btn.textContent = 'Зачекайте…';
    } else {
      btn.disabled = false;
      if(btn.dataset._txt) btn.textContent = btn.dataset._txt;
    }
  }

  async function postJSON(url, body, fallbackUrl) {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body || {})
    });
    // If route not found and we have a fallback — try it once
    if (res.status === 404 && fallbackUrl) {
      const res2 = await fetch(fallbackUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body || {})
      });
      return { res: res2, data: await res2.json().catch(() => ({})) };
    }
    return { res, data: await res.json().catch(() => ({})) };
  }

  // Sanitize code input to digits only and auto-verify on 6 chars
  document.addEventListener('input', (e) => {
    if (e.target && e.target.id === 'code') {
      const v = (e.target.value || '').replace(/\D+/g, '').slice(0, 6);
      e.target.value = v;
    }
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      if (qs('resetBlock') && qs('resetBlock').style.display !== 'none') {
        resetPassword();
      } else if (qs('codeBlock') && qs('codeBlock').style.display !== 'none') {
        verifyCode();
      } else {
        sendRecoveryCode();
      }
    }
  });

  // Step 1: send code to email
  async function sendRecoveryCode(){
    const email = (qs('email')?.value || '').trim().toLowerCase();
    if(!email){ toast('Вкажіть email.'); return; }
    setLoading(qs('btnSend'), true);
    try{
      const { res, data } = await postJSON(
        `${API_PRIMARY}/send`,
        { email },
        `${API_FALLBACK}/forgot-password` // fallback alias on some servers
      );
      if(!res.ok) throw new Error(data.message || 'Помилка надсилання коду');
      state.email = email;
      show(qs('codeBlock'), true);
      startCooldown();
      toast('Код відправлено на вашу електронну пошту.');
    } catch (e){
      toast(e.message || 'Помилка');
    } finally {
      setLoading(qs('btnSend'), false);
    }
  }

  async function resendCode(){
    if (cooldownLeft > 0) return;
    const email = state.email || (qs('email')?.value || '').trim().toLowerCase();
    if(!email){ toast('Вкажіть email.'); return; }
    setLoading(qs('btnResend'), true);
    try{
      const { res, data } = await postJSON(
        `${API_PRIMARY}/send`,
        { email },
        `${API_FALLBACK}/forgot-password`
      );
      if(!res.ok) throw new Error(data.message || 'Помилка надсилання коду');
      toast('Код повторно відправлено.');
      startCooldown();
    } catch(e){
      toast(e.message || 'Помилка');
    } finally {
      setLoading(qs('btnResend'), false);
    }
  }

  // Step 2: verify code
  async function verifyCode(){
    const code = (qs('code')?.value || '').trim();
    if(!code){ toast('Введіть код з листа.'); return; }
    setLoading(qs('btnVerify'), true);
    try{
      const { res, data } = await postJSON(
        `${API_PRIMARY}/verify`,
        { email: state.email || (qs('email')?.value||'').trim(), code }
      );
      if(!res.ok) throw new Error(data.message || 'Невірний або прострочений код');
      state.code = code;
      state.codeVerified = true;
      show(qs('resetBlock'), true);
      toast('Код підтверджено. Введіть новий пароль.');
    } catch(e){
      toast(e.message || 'Помилка');
    } finally {
      setLoading(qs('btnVerify'), false);
    }
  }

  // Step 3: set new password
  async function resetPassword(){
    if(!state.codeVerified){ toast('Спершу підтвердіть код.'); return; }
    const p1 = qs('newPassword')?.value || '';
    const p2 = qs('newPassword2')?.value || '';
    if(p1.length < 8){ toast('Пароль має містити щонайменше 8 символів.'); return; }
    if(p1 !== p2){ toast('Паролі не збігаються.'); return; }
    setLoading(qs('btnReset'), true);
    try{
      const { res, data } = await postJSON(
        `${API_PRIMARY}/reset`,
        { email: state.email || (qs('email')?.value||'').trim(), code: state.code, newPassword: p1 }
      );
      if(!res.ok) throw new Error(data.message || 'Не вдалося змінити пароль');
      alert('✅ Пароль успішно змінено! Тепер ви можете увійти.');
      setTimeout(() => location.href = '/login.html', 800);
    } catch(e){
      toast(e.message || 'Помилка');
    } finally {
      setLoading(qs('btnReset'), false);
    }
  }
</script>

</body>
</html>