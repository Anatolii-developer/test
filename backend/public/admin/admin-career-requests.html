<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Адмін — Заявки учасників</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="admin-styles.css" />
    <link rel="icon" type="image/svg+xml" href="/assets/sidebar/IPS Logo (1).svg" />
    <style>
      body {
        margin: 0;
        font-family: Poppins, sans-serif;
        background: #97c194;
        color: #414141;
      }
      .wrap {
        width: 890px;
        margin: 32px auto;
        background: #fff;
        border-radius: 24px;
        padding: 40px 100px;
      }
      h1 {
        margin: 0 0 10px;
        font-size: 32px;
      }
      .muted {
        color: #8f8f8f;
        margin: 0 0 24px;
      }
      /* ==== TABLE (admin requests) ==== */
      .req-table-wrap{ margin-top:16px; }
      .req-table{
        width:100%;
        border-collapse:separate;
        border-spacing:0;
        border:1.5px solid #E8812E;
        border-radius:16px;
        overflow:hidden;
        font-size:16px;
      }
      .req-table thead th{
        background:#E8812E;
        color:#fff;
        text-align:left;
        padding:16px 18px;
        font-weight:600;
        font-size:18px;
      }
      .req-table thead th:first-child{ width:60px; text-align:center; }
      .req-table tbody td{
        background:#fff;
        border-top:1px solid #E8812E;
        border-left:1px solid #E8812E;
        padding:14px 18px;
        vertical-align:middle;
      }
      .req-table tbody td:first-child{
        text-align:center;
        border-left:none;
        width:60px;
        font-weight:600;
      }
      .req-name-cell{
        font-size:18px;
        font-weight:500;
        white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
        max-width:420px;
      }
      .req-email-cell{
        white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
        max-width:360px;
      }
      .btn-view{
        background:#E8812E; color:#fff; border:none; cursor:pointer;
        border-radius:24px; padding:8px 18px; font-weight:600;
      }
      .empty{ text-align:center; color:#6b6b6b; margin-top:8px }
      .req-modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }
      .req-modal {
        width: 720px;
        max-width: 90vw;
        background: #fff;
        border-radius: 16px;
        padding: 24px 24px 20px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25);
        position: relative;
      }
      .req-modal h3 {
        margin: 0 0 12px;
        font-size: 24px;
        font-weight: 600;
      }
      .req-meta {
        color: #6b6b6b;
        font-size: 14px;
        margin-bottom: 12px;
      }
      .req-qa {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 8px;
      }
      .req-qa .row {
        background: #fff7ee;
        border-radius: 12px;
        padding: 12px 14px;
      }
      .req-qa .q {
        font-weight: 600;
        color: #275d2b;
        margin-bottom: 4px;
      }
      .req-qa .a {
        white-space: pre-wrap;
      }
      .req-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 16px;
      }
      .req-btn {
        border: none;
        border-radius: 10px;
        padding: 10px 14px;
        cursor: pointer;
        font-weight: 600;
      }
      .req-btn.close {
        background: #f3f4f6;
      }
      .req-close-x {
        position: absolute;
        right: 14px;
        top: 12px;
        font-size: 22px;
        line-height: 1;
        cursor: pointer;
        opacity: 0.6;
      }
      .req-close-x:hover {
        opacity: 1;
      }
      @media (max-width: 1200px) {
        .wrap {
          width: 90%;
          padding: 40px 30px;
        }
        .req-name {
          max-width: 50vw;
        }
      }
    </style>
  </head>
  <body>
    <aside class="sidebar" id="sidebar">
  <!-- Логотип -->
  <img class="logo" src="/assets/sidebar/IPS Logo (2).svg" alt="Logo" id="logoExpanded" />
  
  <p style="margin-left: 12px; font-weight: 600;">Admin</p>

  <!-- Навигация -->
  <nav>
    <a href="admin-requests.html"><img src="/assets/sidebar/profile.svg" /><span>Профайли</span></a>
    <a href="admin-certificate.html"><img src="/assets/sidebar/news.svg" /><span>Сертифікати</span></a>
    <a href="#"><img src="/assets/sidebar/3.svg" /><span>Планування кар'єри</span></a>
    <a href="#"><img src="/assets/sidebar/4.svg" /><span>Бібліотека</span></a>
    <a href="admin-all-courses.html"><img src="/assets/sidebar/5.svg" /><span>Курси</span></a>
    <a href="#"><img src="/assets/sidebar/6.svg" /><span>Облік практики</span></a>
    <a href="#"><img src="/assets/sidebar/7.svg" /><span>Здоров’я</span></a>
    <a href="#"><img src="/assets/sidebar/8.svg" /><span>Фінанси</span></a>
    <a href="#"><img src="/assets/sidebar/9.svg" /><span>Нерухомість</span></a>
  </nav>

  <!-- Настройки + выход -->
  <div style="margin-top: auto;">
    <a href="#"><img src="/assets/sidebar/settings.svg" /><span>Налаштування</span></a>
    <div class="logout" onclick="logoutUser()">
      <img src="/assets/sidebar/log-out.svg" alt="Logout Icon" width="20" height="20" />
      <span>Logout Account</span>
    </div>
  </div>
</aside>

    <div class="wrap">
      <h1>Заявки всіх учасників</h1>
      <div class="req-table-wrap">
        <table class="req-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Name and surname</th>
              <th>Email</th>
              <th>Review</th>
            </tr>
          </thead>
          <tbody id="tblBody"></tbody>
        </table>
        <div id="empty" class="empty" style="display:none">Поки що немає заявок.</div>
      </div>
    </div>

    <!-- MODAL -->
    <div
      id="reqModal"
      class="req-modal-backdrop"
      role="dialog"
      aria-modal="true"
      aria-labelledby="reqModalTitle"
    >
      <div class="req-modal">
        <div class="req-close-x" id="reqCloseX">×</div>
        <h3 id="reqModalTitle">Заявка</h3>
        <div class="req-meta" id="reqMeta"></div>
        <div class="req-qa" id="reqQA"></div>
        <div class="req-actions">
          <button class="req-btn close" id="reqCloseBtn">Закрити</button>
        </div>
      </div>
    </div>

    <script>
      // ===== API (админу — без mine=1) =====
      const API = "/api/career-applications";

      function getAuthToken() {
        const direct =
          localStorage.getItem("token") ||
          localStorage.getItem("authToken") ||
          localStorage.getItem("jwt") ||
          localStorage.getItem("accessToken") ||
          localStorage.getItem("bearer") ||
          null;
        if (direct) return direct;
        try {
          const u = JSON.parse(localStorage.getItem("user") || "{}");
          return u.token || u.accessToken || null;
        } catch (_) {
          return null;
        }
      }
      const pad = (n) => String(n).padStart(2, "0");
      function formatDate(iso) {
        const d = new Date(iso);
        if (isNaN(d)) return "";
        return `${pad(d.getDate())}-${pad(
          d.getMonth() + 1
        )}-${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }
      function esc(s = "") {
        return String(s).replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#039;",
            }[m])
        );
      }
      function fullNameFrom(item) {
        const u = item.user || {};
        const first = u.firstName || item.firstName || "";
        const last = u.lastName || item.lastName || "";
        return first || last
          ? `${first} ${last}`.trim()
          : item.fullName || item.email || "Без імені";
      }
      function emailFrom(item){
        return (item.user?.email || item.email || '').trim();
      }

      const $tbody = document.getElementById("tblBody");
      const $empty = document.getElementById("empty");

      function rowTemplate(i, item){
        const tr = document.createElement('tr');

        const tdNum = document.createElement('td');
        tdNum.textContent = i;

        const tdName = document.createElement('td');
        tdName.className = 'req-name-cell';
        tdName.textContent = fullNameFrom(item);

        const tdEmail = document.createElement('td');
        tdEmail.className = 'req-email-cell';
        tdEmail.textContent = emailFrom(item);

        const tdAction = document.createElement('td');
        const btn = document.createElement('button');
        btn.className = 'btn-view';
        btn.textContent = 'Переглянути';
        btn.addEventListener('click', ()=>openReqModal(item));
        tdAction.appendChild(btn);

        tr.append(tdNum, tdName, tdEmail, tdAction);
        return tr;
      }

      function getReqEls() {
        return {
          modal: document.getElementById("reqModal"),
          title: document.getElementById("reqModalTitle"),
          meta: document.getElementById("reqMeta"),
          qa: document.getElementById("reqQA"),
          closeX: document.getElementById("reqCloseX"),
          closeBtn: document.getElementById("reqCloseBtn"),
        };
      }
      function bindReqModalEvents() {
        const { modal, closeX, closeBtn } = getReqEls();
        if (!modal || window.__reqModalBound) return;
        closeX && closeX.addEventListener("click", closeReqModal);
        closeBtn && closeBtn.addEventListener("click", closeReqModal);
        modal.addEventListener("click", (e) => {
          if (e.target === modal) closeReqModal();
        });
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closeReqModal();
        });
        window.__reqModalBound = true;
      }
      function openReqModal(item) {
        bindReqModalEvents();
        const { modal, title, meta, qa } = getReqEls();
        if (!modal) return;
        const fio = fullNameFrom(item);
        const when = item.createdAt || item.created_at || item.created;
        const whenStr = when ? formatDate(when) : "";
        title.textContent = `Заявка — ${fio}`;
        meta.textContent = whenStr ? `Дата подання: ${whenStr}` : "";
        qa.innerHTML = "";
        const rows = [
          {
            q: "Імʼя",
            a: (item.user?.firstName || item.firstName || "").trim(),
          },
          {
            q: "Прізвище",
            a: (item.user?.lastName || item.lastName || "").trim(),
          },
          { q: "Дата подання заявки", a: whenStr },
          {
            q: "Скільки років у вас практики",
            a: item.experience || item.exp || "",
          },
          {
            q: "До якої вікової категорії Ви відноситесь",
            a: item.ageGroup || item.age || "",
          },
          {
            q: "Ваш запит до ментора",
            a: item.requestText || item.request || "",
          },
          {
            q: "Про себе / деталі ситуації",
            a: item.aboutText || item.about || "",
          },
        ];
        if (Array.isArray(item.answers)) {
          item.answers.forEach((x) =>
            rows.push({ q: x.question || "Питання", a: x.answer || "" })
          );
        }
        rows
          .filter((r) => String(r.a || "").trim().length)
          .forEach((r) => {
            const div = document.createElement("div");
            div.className = "row";
            div.innerHTML = `<div class="q">${esc(
              r.q
            )}</div><div class="a">${esc(String(r.a))}</div>`;
            qa.appendChild(div);
          });
        modal.style.display = "flex";
        document.body.style.overflow = "hidden";
      }
      function closeReqModal() {
        const { modal } = getReqEls();
        if (modal) {
          modal.style.display = "none";
          document.body.style.overflow = "";
        }
      }

      async function load() {
        try {
          const token = getAuthToken();
          const res = await fetch(API, {
            method: "GET",
            credentials: "include",
            headers: Object.assign(
              { Accept: "application/json" },
              token ? { Authorization: `Bearer ${token}` } : {}
            ),
          });
          let data = null;
          try {
            data = await res.clone().json();
          } catch (_) {}
          if (res.status === 401) {
            $tbody.innerHTML = "";
            $empty.textContent = "Потрібно увійти як адмін.";
            $empty.style.display = "block";
            return;
          }
          const items = Array.isArray(data)
            ? data
            : Array.isArray(data?.rows)
            ? data.rows
            : Array.isArray(data?.items)
            ? data.items
            : Array.isArray(data?.data)
            ? data.data
            : data?.ok && Array.isArray(data?.result)
            ? data.result
            : [];
          $tbody.innerHTML = "";
          if (!items.length) {
            $empty.style.display = "block";
            return;
          }
          $empty.style.display = "none";
          items
            .sort(
              (a, b) =>
                new Date(b.createdAt || b.created_at || 0) -
                new Date(a.createdAt || a.created_at || 0)
            )
            .forEach((it, idx) => $tbody.appendChild(rowTemplate(idx + 1, it)));
        } catch (e) {
          console.error(e);
          $empty.textContent = "Не вдалося завантажити заявки.";
          $empty.style.display = "block";
        }
      }
      document.addEventListener("DOMContentLoaded", () => {
        bindReqModalEvents();
        load();
      });
    </script>
  </body>
</html>
