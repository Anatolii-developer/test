<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Створити курс</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/uk.js"></script>
</head>
<body class="create-course-page">
  <header class="site-header">
    <button class="burger" id="burgerBtn" aria-label="Відкрити меню" aria-expanded="false" aria-controls="sidebar">
      <img src="assets/sidebar/burger.svg" alt="" />
    </button>

    <a href="/" class="header-logo" aria-label="Головна">
      <img src="assets/emblem.svg" alt="IPS" />
    </a>

    <button class="lang-switch" id="langBtn" aria-haspopup="listbox" aria-expanded="false">
      UA ▼
    </button>
  </header>
 <aside class="sidebar collapsed" id="sidebar">
    <div class="toggle-button" onclick="toggleSidebar()">
      <img src="assets/sidebar/arrow.svg" alt="Toggle" id="toggleArrow" />
    </div>
    <img class="logo" src="assets/sidebar/IPS Logo (2).svg" alt="Logo" id="logoExpanded" />
    <img class="logo-collapsed" src="assets/sidebar/IPS Logo (1).svg" alt="Logo Small" id="logoCollapsed" />
    <img class="profile" src="assets/profile-photo.png" alt="User" width="40" height="40" />
    <nav>
      <a href="profile.html"><img src="assets/sidebar/profile.svg" /><span>Про Мене</span></a>
      <a href="mycertificates.html"><img src="assets/sidebar/news.svg" /><span>Мої Сертифікати</span></a>
      <a href="career-faq.html"><img src="assets/sidebar/10.svg" /><span>Планування Кар'єри</span></a>
      <a href="library.html"><img src="assets/sidebar/3.svg" /><span>Бібліотека</span></a>
      <a href="my-courses.html"><img src="assets/sidebar/5.svg" /><span>Мої Курси</span></a>
       <a href="forum/index.html">
  <img src="assets/sidebar/forum.svg" alt="Форум"/>
  <span>Форум</span>
</a>
    </nav>
    <div class="logout">
      <img src="assets/sidebar/log-out.svg" alt="Logout Icon" width="20" height="20" />
      <span>Вийти з акаунту</span>
    </div>
  </aside>
  <div class="drawer-backdrop" id="drawerBackdrop"></div>

  <main id="mainContent">
    <div class="main-header">
      <h2>Створити курс</h2>
      <img src="assets/courses/create.png" alt="Create Course" />
    </div>

    <div class="completed-nav-buttons">
      <a href="my-courses.html" class="completed-nav-button secondary">Головна</a>
      <a href="completed-courses.html" class="completed-nav-button secondary">Пройдені курси</a>
      <a href="current-courses.html" class="completed-nav-button secondary">Поточні курси</a>
      <a href="planned-courses.html" class="completed-nav-button secondary">Заплановані курси</a>
      <a href="create-course.html" class="completed-nav-button create">Створити курс</a>
    </div>

    <section class="create-course-content">
      <form id="createCourseForm">
        <div class="form-group">
          <label>Оберіть головний вид</label>
          <div class="format-chip-group">
            <label class="format-chip">
              <input type="radio" name="mainType" value="Курс" />
              <span>Курс</span>
            </label>
            <label class="format-chip">
              <input type="radio" name="mainType" value="Підвищення кваліфікації" />
              <span>Підвищення кваліфікації</span>
            </label>
            <label class="format-chip">
              <input type="radio" name="mainType" value="Конференція" />
              <span>Конференція</span>
            </label>
          </div>
        </div>

        <div class="form-group">
          <div class="format-multi">
            <div class="format-multi__hint">Обирайте потрібні формати (можна кілька)</div>
            <div class="format-chip-group">
              <label class="format-chip">
                <input type="checkbox" name="formatDetails" value="Група" />
                <span>Група</span>
              </label>
              <label class="format-chip">
                <input type="checkbox" name="formatDetails" value="Супервізія" />
                <span>Супервізія</span>
              </label>
              <label class="format-chip">
                <input type="checkbox" name="formatDetails" value="Лекція" />
                <span>Лекція</span>
              </label>
              <label class="format-chip">
                <input type="checkbox" name="formatDetails" value="Семінар" />
                <span>Семінар</span>
              </label>
              <label class="format-chip">
                <input type="checkbox" name="formatDetails" value="Особистий аналіз" />
                <span>Особистий аналіз</span>
              </label>
              <label class="format-chip">
                <input type="checkbox" name="formatDetails" value="Індивідуальна супервізія" />
                <span>Індивідуальна супервізія</span>
              </label>
              <label class="format-chip">
                <input type="checkbox" name="formatDetails" value="Групова супервізія" />
                <span>Групова супервізія</span>
              </label>
              <label class="format-chip">
                <input type="checkbox" name="formatDetails" value="Менторське заняття" />
                <span>Менторське заняття</span>
              </label>
              <label class="format-chip">
                <input type="checkbox" name="formatDetails" value="Терапевтична група" />
                <span>Терапевтична група</span>
              </label>
              <label class="format-chip">
                <input type="checkbox" name="formatDetails" value="Супервізійно-семінарське заняття" />
                <span>Супервізійно-семінарське заняття</span>
              </label>
              <label class="format-chip">
                <input type="checkbox" name="formatDetails" value="Парна терапія" />
                <span>Парна терапія</span>
              </label>
              <label class="format-chip">
                <input type="checkbox" name="formatDetails" value="Лекторій" />
                <span>Лекторій</span>
              </label>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>Назва курсу</label>
          <input type="text" name="courseTitle" placeholder="Введіть назву" />
        </div>

        <div class="form-group">
          <label>Підзаголовок курсу</label>
          <input type="text" name="courseSubtitle" placeholder="Введіть підзаголовок" />
        </div>

        <div class="form-group">
          <label>Короткий опис курсу</label>
          <textarea name="courseDescription" placeholder="Опишіть коротко про курс..."></textarea>
        </div>

        <div class="form-group">
  <label>Оберіть учасників</label>
  <button type="button" onclick="openUserModal()" class="small-button">+ Додати учасників</button>
</div>

<div class="form-group">
  <label>Обрані учасники</label>
  <div id="selectedParticipants" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
</div>

        <div class="form-group">
          <label>Оберіть дати проведення курсу</label>
          <div class="date-range">
            <input type="text" name="startDate" class="datepicker" placeholder="дд.мм.рррр" />
            <input type="text" name="endDate" class="datepicker" placeholder="дд.мм.рррр" />
          </div>
        </div>

<div class="form-group">
  <label>Оберіть дні проведення курсу</label>
  <div class="weekdays-checkboxes">
    <label>
      <input type="checkbox"
             name="courseDays"
             value="Понеділок"
             onchange="handleCourseDayChange(this, 'Понеділок')" />
      Понеділок
    </label>
    <label>
      <input type="checkbox"
             name="courseDays"
             value="Вівторок"
             onchange="handleCourseDayChange(this, 'Вівторок')" />
      Вівторок
    </label>
    <label>
      <input type="checkbox"
             name="courseDays"
             value="Середа"
             onchange="handleCourseDayChange(this, 'Середа')" />
      Середа
    </label>
    <label>
      <input type="checkbox"
             name="courseDays"
             value="Четвер"
             onchange="handleCourseDayChange(this, 'Четвер')" />
      Четвер
    </label>
    <label>
      <input type="checkbox"
             name="courseDays"
             value="П’ятниця"
             onchange="handleCourseDayChange(this, 'П’ятниця')" />
      П’ятниця
    </label>
    <label>
      <input type="checkbox"
             name="courseDays"
             value="Субота"
             onchange="handleCourseDayChange(this, 'Субота')" />
      Субота
    </label>
    <label>
      <input type="checkbox"
             name="courseDays"
             value="Неділя"
             onchange="handleCourseDayChange(this, 'Неділя')" />
      Неділя
    </label>
  </div>
</div>

        <div class="form-group">
          <label>Оберіть тип курсу</label>
          <div class="radio-group access-type-group">
            <label><input type="radio" name="accessType" value="Відкрита група" /> Відкрита група</label>
            <label><input type="radio" name="accessType" value="Закрита група" /> Закрита група</label>
          </div>
        </div>




    

        <div class="form-group">
          <label>Тривалість курсу</label>
          <input type="text" name="courseDuration" placeholder="Наприклад: 4 тижні, 8 занять" />
        </div>

        <div class="form-group">
          <label>Вартість курсу</label>
          <input type="text" name="coursePrice" placeholder="Наприклад: 1200 грн" />
        </div>

        <div class="form-group">
          <label>Посилання на Zoom</label>
          <input type="text" name="zoomLink" placeholder="Вставте Zoom-посилання" />
        </div>

        <div class="save-btn-wrapper">
          <button type="submit" class="save-btn">Зберегти</button>
        </div>
      </form>
    </section>
  </main>
<div id="userModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
    <span class="close" onclick="closeUserModal()">&times;</span>
    <h3>Оберіть учасників</h3>
<input
  type="text"
  id="searchInput"
  placeholder="Пошук учасника..."
  oninput="renderUserList(this.value)"
  style="width: 100%; padding: 8px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 6px;"
/>


    <div id="userList" style="margin-top: 16px; max-height: 300px; overflow-y: auto;"></div>

    <button onclick="saveSelectedParticipants()" style="margin-top: 20px;">Зберегти вибір</button>
  </div>
</div>

        <!-- МОДАЛ ДО ДОДАВАННЯ ЮНІТА -->
        <div id="unitModal" class="modal" style="display:none;">
          <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
            <span class="close" onclick="closeUnitModal()">&times;</span>
            <h3>Додати / редагувати заняття</h3>


            <div class="form-group">
              <label>Тип юніта</label>
              <select id="unitType">
                <option value="">Оберіть тип</option>
                <option value="Особистий аналіз">Особистий аналіз</option>
                <option value="Індивідуальна супервізія">Індивідуальна супервізія</option>
                <option value="Групова супервізія">Групова супервізія</option>
                <option value="Менторське заняття">Менторське заняття</option>
                <option value="Лекція">Лекція</option>
                <option value="Семінар">Семінар</option>
                <option value="Терапевтична група">Терапевтична група</option>
                <option value="Супервізійно-семінарське заняття">Супервізійно-семінарське заняття</option>
                <option value="Парна терапія">Парна терапія</option>
                <option value="Лекторій">Лекторій</option>
              </select>
            </div>

            <div class="form-group">
              <label>Час проведення</label>
              <div class="time-range">
                <input type="time" id="unitStartTime" />
                <span>–</span>
                <input type="time" id="unitEndTime" />
              </div>
            </div>

            <div class="form-group">
              <label>Назва / тема заняття (необовʼязково)</label>
              <input type="text" id="unitTitle" placeholder="Наприклад: Заняття 1. Вступ" />
            </div>

            <div class="form-group">
              <label>Кількість годин (для обліку)</label>
              <input type="number" step="0.25" min="0" id="unitHours" placeholder="Наприклад: 2" />
            </div>

            <div class="form-group">
              <label>Учасники та роль у дні</label>
              <small style="display:block; margin-bottom:6px; color:#777;">
                Відмітьте, хто бере участь цього дня, та вкажіть роль: <b>Учасник</b> чи <b>Лектор</b>.
              </small>
              <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap;">
                <select id="unitMemberPicker" style="padding:6px 10px; border-radius:8px; min-width: 220px;">
                  <option value="">Оберіть учасника</option>
                </select>
                <button type="button" onclick="addUnitMemberFromPicker()" class="small-button" style="padding:8px 14px;">+ Додати</button>
              </div>
              <div id="unitMembersContainer" style="display:flex; flex-direction:column; gap:6px;"></div>
            </div>

            <button type="button" onclick="saveUnitFromModal()" class="small-button" style="margin-top: 16px;">
              Зберегти заняття
            </button>
          </div>
        </div>



  <script src="script.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      if (window.flatpickr) {
        flatpickr('.datepicker', {
          dateFormat: 'Y-m-d',   // value sent/stored
          altInput: true,
          altFormat: 'd.m.Y',    // what user sees
          allowInput: true,
          locale: window.flatpickr.l10ns.uk
        });
      }
    });

    // массив юнитов и текущий день, для которого настраиваем занятие
let units = [];
let currentUnitDayName = null;

function parseTimeToMinutes(value) {
  if (!value) return null;
  const [h, m] = value.split(':').map(Number);
  if (Number.isNaN(h) || Number.isNaN(m)) return null;
  return h * 60 + m;
}

function calculateHoursFromTimes(start, end) {
  const startMin = parseTimeToMinutes(start);
  const endMin = parseTimeToMinutes(end);
  if (startMin == null || endMin == null) return null;
  const diff = endMin - startMin;
  if (diff <= 0) return null;
  return Math.round((diff / 60) * 100) / 100;
}

function bindUnitTimeAutoCalc() {
  const startInput = document.getElementById('unitStartTime');
  const endInput = document.getElementById('unitEndTime');
  const hoursInput = document.getElementById('unitHours');
  if (!startInput || !endInput || !hoursInput) return;

  const recalc = () => {
    const hours = calculateHoursFromTimes(startInput.value, endInput.value);
    hoursInput.value = hours != null ? hours : '';
  };

  startInput.oninput = recalc;
  startInput.onchange = recalc;
  endInput.oninput = recalc;
  endInput.onchange = recalc;
}

function getUserLabelById(userId) {
  const userObj =
    (Array.isArray(window.users) && window.users.find((u) => u._id === userId || u.id === userId)) || null;
  if (userObj) {
    const candidate =
      userObj.fullName ||
      userObj.name ||
      `${userObj.firstName || ''} ${userObj.lastName || ''}`.trim() ||
      userObj.username ||
      userObj.email ||
      userObj.phone;
    if (candidate && candidate.trim()) return candidate.trim();
  }
  return userId;
}

function renderUnitMemberPicker() {
  const picker = document.getElementById('unitMemberPicker');
  if (!picker) return;
  picker.innerHTML = '<option value=\"\">Оберіть учасника</option>';
  if (!Array.isArray(window.users)) return;

  const set = new Set(window.selectedParticipants || []);
  window.users.forEach((u) => {
    if (!u || !u._id) return;
    if (set.has(u._id)) return;
    const opt = document.createElement('option');
    opt.value = u._id;
    opt.textContent = getUserLabelById(u._id);
    picker.appendChild(opt);
  });
}

function createUnitMemberRow(pId) {
  const label = getUserLabelById(pId);
  const row = document.createElement('div');
  row.className = 'unit-member-row';
  row.dataset.userId = pId;
  row.style.display = 'flex';
  row.style.alignItems = 'center';
  row.style.gap = '10px';

  row.innerHTML = `
    <label style="display:flex; align-items:center; gap:8px; flex:1;">
      <input type="checkbox" class="unit-member-include" checked />
      <span>${label}</span>
    </label>
    <select class="unit-member-mode" style="padding:6px 8px; border-radius:6px;">
      <option value="проходив">Учасник</option>
      <option value="проводив">Лектор</option>
    </select>
  `;
  return row;
}

function addUnitMemberFromPicker() {
  const picker = document.getElementById('unitMemberPicker');
  const membersContainer = document.getElementById('unitMembersContainer');
  if (!picker || !membersContainer) return;
  const userId = picker.value;
  if (!userId) {
    alert('Оберіть учасника');
    return;
  }
  if (!Array.isArray(window.selectedParticipants)) window.selectedParticipants = [];
  if (window.selectedParticipants.includes(userId)) {
    picker.value = '';
    return;
  }
  window.selectedParticipants.push(userId);
  if (typeof updateSelectedDisplay === 'function') updateSelectedDisplay();
  membersContainer.appendChild(createUnitMemberRow(userId));
  picker.value = '';
  renderUnitMemberPicker();
}

// вызывается при клике на чекбокс дня
function handleCourseDayChange(checkbox, dayName) {
  if (checkbox.checked) {
    // запоминаем, для какого дня сейчас настраиваем занятие
    currentUnitDayName = dayName;
    openUnitModalForDay(dayName);
  } else {
    // если ты хочешь при снятии галочки удалять юниты этого дня — можно тут дописать фильтрацию
    // units = units.filter(u => u.dayName !== dayName);
    // renderUnitsList(); // если будешь где-то показывать список
  }
}

// открываем уже существующую модалку, но дополнительно знаем dayName
function openUnitModalForDay(dayName) {
  const modal = document.getElementById('unitModal');
  if (!modal) return;

  // очистка полей
  document.getElementById('unitStartTime').value = '';
  document.getElementById('unitEndTime').value = '';
  document.getElementById('unitType').value = '';
  document.getElementById('unitTitle').value = '';
  document.getElementById('unitHours').value = '';
  bindUnitTimeAutoCalc();

  const membersContainer = document.getElementById('unitMembersContainer');
  membersContainer.innerHTML = '';
  renderUnitMemberPicker();

  // выводим участников с выбором "проходив / проводив"
  if (Array.isArray(window.selectedParticipants)) {
    window.selectedParticipants.forEach((pId) => {
      membersContainer.appendChild(createUnitMemberRow(pId));
    });
  }

  // можно где-то в модалке показать, для какого дня настраиваем
  // например, добавить span с id="unitDayLabel" и тут его обновлять:
  let label = document.getElementById('unitDayLabel');
  if (!label) {
    label = document.createElement('div');
    label.id = 'unitDayLabel';
    label.style.marginBottom = '8px';
    label.style.fontWeight = '500';
    modal.querySelector('.modal-content h3').insertAdjacentElement('afterend', label);
  }
  label.textContent = `День: ${dayName}`;

  modal.style.display = 'block';
}

function closeUnitModal() {
  const modal = document.getElementById('unitModal');
  if (modal) modal.style.display = 'none';
  currentUnitDayName = null;
}

// сохраняем юнит с привязкой к дню
function saveUnitFromModal() {
  const startTime = document.getElementById('unitStartTime').value;
  const endTime = document.getElementById('unitEndTime').value;
  const unitType = document.getElementById('unitType').value;
  const title = document.getElementById('unitTitle').value.trim();
  const hoursValue = document.getElementById('unitHours').value;
  const autoHours = calculateHoursFromTimes(startTime, endTime);
  const hours = hoursValue !== '' ? Number(hoursValue) : autoHours;

  if (!currentUnitDayName) {
    alert('Не визначено день заняття');
    return;
  }

  if (!unitType) {
    alert('Оберіть тип юніта');
    return;
  }

  // збираємо учасників
  const members = [];
  document
    .querySelectorAll('#unitMembersContainer .unit-member-row')
    .forEach((row) => {
      const userId = row.dataset.userId;
      const include = row.querySelector('.unit-member-include');
      const mode = row.querySelector('.unit-member-mode').value;
      if (include && !include.checked) return;
      if (userId && mode) {
        members.push({ user: userId, mode });
      }
    });

  const unit = {
    dayName: currentUnitDayName, // Понеділок, Вівторок і т.д.
    startTime,
    endTime,
    unitType,
    title,
    hours,
    members,
  };

  units.push(unit);
  // тут можно буде зробити preview по дням, якщо захочеш
  closeUnitModal();
}
  </script>
</body>
</html>
