<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Супервізор — Заявка</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="icon"
      type="image/svg+xml"
      href="/assets/sidebar/IPS Logo (1).svg"
    />
    <style>
      :root {
        --green: #275d2b;
        --bg: #97c194;
        --orange: #e8812e;
        --light: #ecf5eb;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial,
          sans-serif;
        background: var(--bg);
        color: #414141;
        padding: 0;
      }

      main.supervisor-request-page {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 24px 16px 72px;
        box-sizing: border-box;
        gap: 16px;
      }
      .page {
        width: 100%;
        max-width: 920px;
        background: #fff;
        border-radius: 24px;
        padding: clamp(28px, 5vw, 60px);
        display: flex;
        flex-direction: column;
        gap: 28px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
      }
      .tabs {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        width: 100%;
        justify-content: center;
      }
      .tab {
        flex: 1 1 240px;
        width: 100%;
        max-width: 100%;
        min-height: 120px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        text-decoration: none;
        text-align: center;
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial,
          sans-serif;
        font-weight: 600;
        font-size: 24px;
        line-height: 1.2;
      }

      .lang-fab {
        position: fixed;
        top: 16px;
        right: 24px;
        width: 52px;
        height: 52px;
        padding: 0;
        background: transparent;
        border: 0;
        border-radius: 0;
        box-shadow: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 2000;
      }
      .lang-fab img {
        width: 52px;
        height: 52px;
        display: block;
      }
      .lang-menu {
        position: fixed;
        z-index: 2200;
        display: none;
        min-width: 180px;
        background: #1f4f27;
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-radius: 12px;
        padding: 6px;
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.25);
        backdrop-filter: blur(6px);
      }
      .lang-menu.open {
        display: block;
      }
      .lang-option {
        width: 100%;
        background: transparent;
        border: 0;
        color: #fff;
        font: inherit;
        padding: 10px 12px;
        text-align: left;
        border-radius: 8px;
        cursor: pointer;
      }
      .lang-option:hover,
      .lang-option:focus {
        background: rgba(255, 255, 255, 0.12);
        outline: none;
      }
      .lang-option.active {
        background: rgba(255, 255, 255, 0.22);
      }
      @media (max-width: 480px) {
        .lang-fab {
          top: 10px;
          right: 18px;
          width: 52px;
          height: 52px;
        }
        .lang-fab img {
          width: 52px;
          height: 52px;
        }
      }
      .tab.light {
        background: var(--light);
        color: inherit;
        border: none;
      }
      .tab.dark {
        background: var(--green);
        color: #fff;
      }
      .title {
        font-size: 28px;
        font-weight: 700;
      }
      .card {
        display: grid;
        grid-template-columns: 248px 1fr;
        gap: 32px;
      }
      .photo-wrap {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 248px;
      }
      .photo {
        width: 100%;
        height: 250px;           /* фиксируем высоту самого фото */
        object-fit: cover;
        border-radius: 12px;
        border: 2px solid var(--orange);
        background: #eef1ee;
        display: block;
      }
      .grid.grid-names {
        display: grid;
        grid-template-columns: 1fr;
        gap: 24px 32px;
      }
      .info-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 24px 32px;
        margin-top: 16px;
      }
      .field {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      label {
        font-size: 14px;
        color: #6b6b6b;
      }
      input,
      textarea {
        width: 100%;
        border: 1px solid #d9d9d9;
        border-radius: 12px;
        padding: 10px 12px;
        font: 14px/1.4 Poppins, sans-serif;
        color: #222;
      }
      textarea {
        min-height: 92px;
        resize: vertical;
        white-space: pre-wrap;
      }
      input[readonly],
      textarea[readonly] {
        background: #ffffff;
      }

      /* Кнопка "Зв’язатися" під фото */
.contact-btn-wrap {
  display: flex;
  justify-content: center;   /* центрируем кнопку */
  margin-top: 12px;          /* отступ от фото */
  margin-bottom: 72px;       /* отодвигаем следующий контент вниз */
}

.contact-btn {
  width: auto;
  height: 40px;
  line-height: 40px;       /* вертикальное центрирование текста */
  border-radius: 24px;
  padding: 0 48px;         /* горизонтальные отступы по ТЗ */
  background: #275D2B;
  color: #fff;
  border: none;
  font-size: 16px;
  font-weight: 600;
  font-family: "Poppins", sans-serif;
  cursor: pointer;
  transition: background 0.2s ease;
}

.contact-btn:hover {
  background: #1e4722;
}
      #lastName,
      #firstName,
      #middleName {
        width: 100%;
        max-width: 100%;
        height: 44px;
        border-radius: 8px;
        box-shadow: 1px 1px 4px 0px #00000040;
        font-family: "Poppins", sans-serif;
        font-weight: 700;
        font-size: 20px;
        color: #275d2b;
        background-color: #ddf3dc;
      }
      #submittedAt {
        width: 100%;
        max-width: 100%;
        height: 44px;
        border-radius: 8px;
      }
      #experience,
      #age {
        width: 100%;
        max-width: 100%;
        height: 44px;
        border-radius: 8px;
        border-width: 1px;
      }
      #requestText,
      #aboutText,
      #education,
      #topics {
        width: 100%;
        max-width: 100%;
        min-height: 144px;
        border-radius: 8px;
      }
      .back-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }
      .back-btn {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 10px 16px;
        background: var(--green);
        color: #fff;
        border-radius: 12px;
        text-decoration: none;
        font-weight: 600;
      }
      .meta {
        font-size: 14px;
        color: #6b6b6b;
      }
      .empty,
      .guard {
        text-align: center;
        color: #2a2a2a;
        padding: clamp(18px, 4vw, 24px);
        background: #fff;
        border-radius: 16px;
        width: min(920px, 92vw);
        margin: 24px auto;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
      }
      .guard a {
        display: inline-block;
        margin-top: 10px;
        background: var(--green);
        color: #fff;
        padding: 8px 16px;
        border-radius: 12px;
        text-decoration: none;
      }
      @media (max-width: 1024px) {
        main.supervisor-request-page {
          padding: 16px 12px 60px;
        }
        .page {
          width: 100%;
          padding: 24px;
          margin: 0 auto;
        }
        .card {
          grid-template-columns: 1fr;
        }
        .photo-wrap {
          width: 200px;
          height: 200px;
        }
        .grid.grid-names {
          grid-template-columns: 1fr;
        }
        .info-grid {
          grid-template-columns: 1fr;
        }
        .back-row {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }
        .contact-btn {
          width: 100%;
          max-width: 360px;
          padding: 12px 16px;
          height: auto;
          line-height: 1.4;
          margin-bottom: 12px;
        }
      }
      @media (max-width: 600px) {
        .tabs {
          flex-direction: column;
          width: 100%;
        }
        .tab {
          width: 100%;
          min-height: 100px;
        }
        .page {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <button class="lang-fab" id="langBtn" aria-haspopup="listbox" aria-expanded="false">
      <img src="assets/language.png" alt="Language" />
    </button>
    <main class="supervisor-request-page" id="mainContent">
      <div id="guard" class="guard" style="display: none">
        Доступ лише для супервізорів.
        <div><a href="career-supervisor-requests.html">Повернутися</a></div>
      </div>

      <div id="page" class="page" style="display: none">
        <div class="tabs">
          <a class="tab light" href="career-supervisor-requests.html"
            >Повернутися</a
          >
          <div class="tab dark">
            Налаштування <br />
            супервізора
          </div>
        </div>

      <div class="card">
        <div class="photo-wrap">
          <img
            id="photo"
            class="photo"
            src="/assets/profile-photo.png"
            alt="Фото"
          />
         <div class="contact-btn-wrap">
    <button class="contact-btn">Звʼязатися</button>
  </div>
        </div>

        <div class="grid grid-names">
          <div class="field">
            <label>Прізвище</label><input id="lastName" readonly />
          </div>
          <div class="field">
            <label>Імʼя</label><input id="firstName" readonly />
          </div>
          <div class="field">
            <label>По-батькові</label><input id="middleName" readonly />
          </div>
        </div>
      </div>

      <div class="info-grid">
        <div class="field">
          <label>Дата подання заявки</label><input id="submittedAt" readonly />
        </div>
        <div class="field">
          <label>Скільки років у вас практики</label
          ><input id="experience" readonly />
        </div>
        <div class="field">
          <label>Категорія за віком</label><input id="age" readonly />
        </div>
        <div class="field" style="grid-column: 1/-1">
          <label>Запит до супервізора</label
          ><textarea id="requestText" readonly></textarea>
        </div>
        <div class="field" style="grid-column: 1/-1">
          <label>Про себе / ситуація</label
          ><textarea id="aboutText" readonly></textarea>
        </div>
        <div class="field" style="grid-column: 1/-1">
          <label>Психологічна освіта</label
          ><textarea id="education" readonly></textarea>
        </div>
        <div class="field" style="grid-column: 1/-1">
          <label>Напрямок роботи</label><textarea id="directions" readonly></textarea>
        </div>
      </div>
      </div>
    </main>

    <script src="script.js"></script>
    <script>
      const SUPERVISOR_REQUEST_I18N = {
        ua: {
          title: "Супервізор — Заявка",
          guardAccess: "Доступ лише для супервізорів.",
          guardBack: "Повернутися",
          tabBack: "Повернутися",
          tabSettingsHtml: "Налаштування <br /> супервізора",
          contact: "Звʼязатися",
          labels: {
            lastName: "Прізвище",
            firstName: "Імʼя",
            middleName: "По-батькові",
            submittedAt: "Дата подання заявки",
            experience: "Скільки років у вас практики",
            age: "Категорія за віком",
            request: "Запит до супервізора",
            about: "Про себе / ситуація",
            education: "Психологічна освіта",
            directions: "Напрямок роботи",
          },
          errorNoId: "Не передано id заявки.",
          errorLoad: "Помилка завантаження заявки.",
          errorNotFound: "Заявку не знайдено.",
        },
        ru: {
          title: "Супервизор — Заявка",
          guardAccess: "Доступ только для супервизоров.",
          guardBack: "Вернуться",
          tabBack: "Вернуться",
          tabSettingsHtml: "Настройки <br /> супервизора",
          contact: "Связаться",
          labels: {
            lastName: "Фамилия",
            firstName: "Имя",
            middleName: "Отчество",
            submittedAt: "Дата подачи заявки",
            experience: "Сколько лет у вас практики",
            age: "Возрастная категория",
            request: "Запрос к супервизору",
            about: "О себе / ситуация",
            education: "Психологическое образование",
            directions: "Направление работы",
          },
          errorNoId: "Не передано id заявки.",
          errorLoad: "Ошибка загрузки заявки.",
          errorNotFound: "Заявка не найдена.",
        },
        en: {
          title: "Supervisor — Application",
          guardAccess: "Supervisors only.",
          guardBack: "Back",
          tabBack: "Back",
          tabSettingsHtml: "Supervisor <br /> settings",
          contact: "Contact",
          labels: {
            lastName: "Last name",
            firstName: "First name",
            middleName: "Middle name",
            submittedAt: "Application date",
            experience: "Years of practice",
            age: "Age group",
            request: "Request to the supervisor",
            about: "About you / situation",
            education: "Psychological education",
            directions: "Areas of work",
          },
          errorNoId: "Application id is missing.",
          errorLoad: "Failed to load application.",
          errorNotFound: "Application not found.",
        },
      };

      let currentLang = "ua";
      const normalizeLang = (value) => {
        const v = String(value || "").toLowerCase().trim();
        if (v.startsWith("uk") || v === "ua") return "ua";
        if (v.startsWith("ru")) return "ru";
        if (v.startsWith("en")) return "en";
        return "ua";
      };
      const getStoredLang = () => {
        try {
          const stored = localStorage.getItem("uiLang");
          if (stored) return normalizeLang(stored);
        } catch (_) {}
        return normalizeLang(document.documentElement.lang);
      };
      const t = (key) => {
        const copy =
          SUPERVISOR_REQUEST_I18N[currentLang] || SUPERVISOR_REQUEST_I18N.ua;
        return copy[key] || "";
      };

      function applyLang(lang) {
        currentLang = normalizeLang(lang);
        const copy =
          SUPERVISOR_REQUEST_I18N[currentLang] || SUPERVISOR_REQUEST_I18N.ua;
        document.title = copy.title;
        const guard = document.getElementById("guard");
        if (guard) {
          const textNode = Array.from(guard.childNodes).find(
            (n) => n.nodeType === Node.TEXT_NODE
          );
          if (textNode) textNode.textContent = ` ${copy.guardAccess} `;
          const link = guard.querySelector("a");
          if (link) link.textContent = copy.guardBack;
        }
        const tabBack = document.querySelector(".tab.light");
        if (tabBack) tabBack.textContent = copy.tabBack;
        const tabSettings = document.querySelector(".tab.dark");
        if (tabSettings) tabSettings.innerHTML = copy.tabSettingsHtml;
        const contactBtn = document.querySelector(".contact-btn");
        if (contactBtn) contactBtn.textContent = copy.contact;

        const nameLabels = document.querySelectorAll(".grid-names .field label");
        if (nameLabels[0]) nameLabels[0].textContent = copy.labels.lastName;
        if (nameLabels[1]) nameLabels[1].textContent = copy.labels.firstName;
        if (nameLabels[2]) nameLabels[2].textContent = copy.labels.middleName;

        const infoLabels = document.querySelectorAll(".info-grid .field label");
        if (infoLabels[0]) infoLabels[0].textContent = copy.labels.submittedAt;
        if (infoLabels[1]) infoLabels[1].textContent = copy.labels.experience;
        if (infoLabels[2]) infoLabels[2].textContent = copy.labels.age;
        if (infoLabels[3]) infoLabels[3].textContent = copy.labels.request;
        if (infoLabels[4]) infoLabels[4].textContent = copy.labels.about;
        if (infoLabels[5]) infoLabels[5].textContent = copy.labels.education;
        if (infoLabels[6]) infoLabels[6].textContent = copy.labels.directions;
      }

      document.addEventListener("DOMContentLoaded", () => {
        applyLang(getStoredLang());
      });

      window.addEventListener("uiLangChange", (e) => {
        applyLang(e.detail?.lang);
      });

      const qs = (s) => document.querySelector(s);
      const pad = (n) => String(n).padStart(2, "0");
      const fmtDate = (iso) => {
        const d = new Date(iso);
        if (isNaN(d)) return "";
        return `${pad(d.getDate())}.${pad(
          d.getMonth() + 1
        )}.${d.getFullYear()}`;
      };
      const setVal = (id, val) => {
        const el = document.getElementById(id);
        if (el) el.value = val || "";
      };
      const params = new URLSearchParams(location.search);
      const ID = params.get("id");

      async function fetchUserDetails(userId) {
        if (!userId) return null;
        try {
          const r = await fetch(`/api/users/${userId}`, {
            credentials: "include",
            headers: authHeaders(),
          });
          if (!r.ok) return null;
          return await r.json().catch(() => null);
        } catch {
          return null;
        }
      }

      function getToken() {
        try {
          const u = JSON.parse(localStorage.getItem("user") || "{}");
          return (
            u.token || u.accessToken || localStorage.getItem("token") || null
          );
        } catch (_) {
          return localStorage.getItem("token") || null;
        }
      }
      const authHeaders = () => {
        const t = getToken();
        return Object.assign(
          { Accept: "application/json" },
          t ? { Authorization: "Bearer " + t } : {}
        );
      };

      async function ensureSupervisor() {
        try {
          const r = await fetch("/api/users/profile", {
            credentials: "include",
            headers: authHeaders(),
          });
          const body = await r.json().catch(() => ({}));
          if (!r.ok) return null;

          // Accept both shapes: { user: {...} } or the user object directly
          const current = body && (body.user || body);
          if (!current) return null;

          const roles = current.roles || [];
          const ok =
            Array.isArray(roles) &&
            roles.some((s) => {
              const v = String(s).toLowerCase();
              return (
                v.includes("супервізор") ||
                v.includes("супервизор") ||
                v.includes("supervisor")
              );
            });
          return ok ? current : null;
        } catch {
          return null;
        }
      }

      async function loadApplication() {
        if (!ID) {
          qs("#guard").style.display = "block";
          qs("#guard").textContent = t("errorNoId");
          return;
        }
        const r = await fetch(`/api/career-applications/${ID}`, {
          credentials: "include",
          headers: authHeaders(),
        });
        const body = await r.json().catch(() => ({}));

        if (!r.ok) {
          qs("#guard").style.display = "block";
          qs("#guard").textContent =
            (body && body.message) || t("errorLoad");
          return;
        }

        // Accept both shapes: { ok, application } or a flat application object
        const a = (body && (body.application || body)) || {};
        if (!a || (!a._id && !a.id)) {
          qs("#guard").style.display = "block";
          qs("#guard").textContent = t("errorNotFound");
          return;
        }

        // user can be nested under 'user' or 'owner'
        const baseUser = a.user || a.owner || {};
        const freshUser = await fetchUserDetails(baseUser._id || baseUser.id);
        const u = freshUser || baseUser || {};

        const photoEl = document.getElementById("photo");
        if (photoEl) photoEl.src = u.photoUrl || "/assets/profile-photo.png";
        setVal("lastName", u.lastName);
        setVal("firstName", u.firstName);
        setVal("middleName", u.middleName);
        setVal("submittedAt", fmtDate(a.createdAt || a.created_at || ""));
        setVal("experience", a.experience || a.exp || "");
        setVal("age", a.ageGroup || a.age || "");
        setVal("requestText", a.requestText || a.request || "");
        setVal("aboutText", a.aboutText || a.about || "");
        setVal("education", u.education || a.education || "");

        const directions = Array.isArray(u.directions)
          ? u.directions
          : Array.isArray(a.directions)
          ? a.directions
          : [];
        setVal("directions",
          Array.isArray(directions) && directions.length
            ? directions.filter(Boolean).join(", ")
            : (u.direction || a.direction || "")
        );

        const topics = Array.isArray(a.topics) ? a.topics.filter(Boolean) : a.topics || "";
        setVal("topics", Array.isArray(topics) ? topics.join(", ") : topics);

        qs("#page").style.display = "flex";
        qs("#guard").style.display = "none";
      }

      (async () => {
        const me = await ensureSupervisor();
        if (!me) {
          qs("#guard").style.display = "block";
          return;
        }
        qs("#guard").style.display = "none";
        await loadApplication();
      })();
    </script>
  </body>
</html>
