<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–ê–¥–º—ñ–Ω ‚Äî –ó–∞—è–≤–∫–∏ —É—á–∞—Å–Ω–∏–∫—ñ–≤</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="admin-styles.css" />
    <link
      rel="icon"
      type="image/svg+xml"
      href="/assets/sidebar/IPS Logo (1).svg"
    />
    <style>
      body {
        margin: 0;
        font-family: Poppins, sans-serif;
        background: #97c194;
        color: #414141;
      }
      .wrap {
        width: 890px;
        margin: 32px auto;
        background: #fff;
        border-radius: 24px;
        padding: 40px 100px;
      }
      h1 {
        margin: 0 0 10px;
        font-size: 32px;
      }
      .muted {
        color: #8f8f8f;
        margin: 0 0 24px;
      }
      /* ==== TABLE (admin requests) ==== */
      .req-table-wrap {
        margin-top: 16px;
      }
      .req-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        border: 1.5px solid #e8812e;
        border-radius: 16px;
        overflow: hidden;
        font-size: 16px;
      }
      .req-table thead th {
        background: #e8812e;
        color: #fff;
        text-align: left;
        padding: 16px 18px;
        font-weight: 600;
        font-size: 18px;
      }
      .req-table thead th:first-child {
        width: 60px;
        text-align: center;
      }
      .req-table tbody td {
        background: #fff;
        border-top: 1px solid #e8812e;
        border-left: 1px solid #e8812e;
        padding: 14px 18px;
        vertical-align: middle;
      }
      .req-table tbody td:first-child {
        text-align: center;
        border-left: none;
        width: 60px;
        font-weight: 600;
      }
      .req-name-cell {
        font-size: 18px;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 420px;
      }
      .req-email-cell {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 360px;
      }
      .btn-view {
        background: #e8812e;
        color: #fff;
        border: none;
        cursor: pointer;
        border-radius: 24px;
        padding: 8px 18px;
        font-weight: 600;
      }
      .empty {
        text-align: center;
        color: #6b6b6b;
        margin-top: 8px;
      }
      .req-modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }
      .req-modal {
        width: 720px;
        max-width: 90vw;
        background: #fff;
        border-radius: 16px;
        padding: 24px 24px 20px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25);
        position: relative;
        max-height: 90vh; /* allow the modal to fit viewport height */
        overflow: auto; /* enable scrolling inside the modal */
        -webkit-overflow-scrolling: touch; /* smooth scroll on iOS */
        overscroll-behavior: contain; /* prevent background scroll bounce */
      }
      .req-modal h3 {
        margin: 0 0 12px;
        font-size: 24px;
        font-weight: 600;
      }
      .req-meta {
        color: #6b6b6b;
        font-size: 14px;
        margin-bottom: 12px;
      }
      .req-qa {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 8px;
      }
      .req-qa .row {
        background: #fff7ee;
        border-radius: 12px;
        padding: 12px 14px;
      }
      .req-qa .q {
        font-weight: 600;
        color: #275d2b;
        margin-bottom: 4px;
      }
      .req-qa .a {
        white-space: pre-wrap;
      }
      .req-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 16px;
      }
      .req-btn {
        border: none;
        border-radius: 10px;
        padding: 10px 14px;
        cursor: pointer;
        font-weight: 600;
      }
      .req-btn.close {
        background: #f3f4f6;
      }
      .req-close-x {
        position: absolute;
        right: 14px;
        top: 12px;
        font-size: 22px;
        line-height: 1;
        cursor: pointer;
        opacity: 0.6;
      }
      .req-close-x:hover {
        opacity: 1;
      }
      /* === Mentors/Admin modal redesign === */
      .mentor-modal {
        display: grid;
        grid-template-columns: 1fr 360px;
        gap: 20px;
      }
      .mentor-left {
        display: flex;
        flex-direction: column;
        gap: 14px;
      }
      .mentor-right {
        display: flex;
        flex-direction: column;
        gap: 14px;
      }
      .mentor-photo {
        width: 160px;
        height: 200px;
        border-radius: 12px;
        object-fit: cover;
        background: #eef1ee;
        border: 1px dashed #7aa978;
      }
      .field {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .field label {
        font-size: 14px;
        color: #6b6b6b;
      }
      .field input,
      .field textarea,
      .note textarea {
        width: 100%;
        box-sizing: border-box;
        border: 1px solid #d9d9d9;
        border-radius: 12px;
        padding: 10px 12px;
        font-family: Poppins, sans-serif;
        font-size: 14px;
        color: #222;
        background: #ffffff;
      }
      .field textarea {
        min-height: 90px;
        resize: vertical;
      }
      .note {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .note label {
        font-size: 14px;
        font-weight: 600;
        color: #275d2b;
      }
      .note textarea {
        min-height: 54px;
        background: #f5f6f7;
      }
      .modal-actions-bar {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 8px;
      }
      .btn-primary {
        background: #275d2b;
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 10px 16px;
        font-weight: 600;
        cursor: pointer;
      }

      /* –ö–Ω–æ–ø–∫–∞-–¥—Ä–æ–ø–¥–∞—É–Ω –ø–æ –¢–ó */
      .mentor-select {
        width: 456px;
        height: 48px;
        background: #ffeed9;
        border-radius: 5px;
        padding: 12px 21px 12px 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        user-select: none;
        border: 1px solid rgba(0, 0, 0, 0.05);
      }
      .mentor-select:focus {
        outline: 2px solid #e8812e33;
      }
      .mentor-select .mentor-caret {
        width: 16px;
        height: 16px;
        opacity: 0.9;
      }

      .mentor-menu {
        width: 456px;
        max-height: 240px;
        overflow: auto;
        background: #fff;
        border: 1px solid #e8812e;
        border-radius: 8px;
        margin-top: 8px;
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
      }
      .mentor-option {
        padding: 10px 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .mentor-option:hover {
        background: #fff4ea;
      }
      .mentor-option.active {
        background: #ffe5cc;
      }
      @media (max-width: 1200px) {
        .wrap {
          width: 90%;
          padding: 40px 30px;
        }
        .req-name {
          max-width: 50vw;
        }
      }
    </style>
  </head>
  <body>
    <aside class="sidebar" id="sidebar">
      <!-- –õ–æ–≥–æ—Ç–∏–ø -->
      <img
        class="logo"
        src="/assets/sidebar/IPS Logo (2).svg"
        alt="Logo"
        id="logoExpanded"
      />

      <p style="margin-left: 12px; font-weight: 600">Admin</p>

      <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
      <nav>
        <a href="admin-requests.html"
          ><img src="/assets/sidebar/profile.svg" /><span>–ü—Ä–æ—Ñ–∞–π–ª–∏</span></a
        >
        <a href="admin-certificate.html"
          ><img src="/assets/sidebar/news.svg" /><span>–°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏</span></a
        >
        <a href="admin-career-faq.html"
          ><img src="/assets/sidebar/3.svg" /><span>–ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è –∫–∞—Ä'—î—Ä–∏</span></a
        >
        <a href="admin-library.html"
          ><img src="/assets/sidebar/4.svg" /><span>–ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞</span></a
        >
        <a href="admin-all-courses.html"
          ><img src="/assets/sidebar/5.svg" /><span>–ö—É—Ä—Å–∏</span></a
        >
        <a href="#"
          ><img src="/assets/sidebar/6.svg" /><span>–û–±–ª—ñ–∫ –ø—Ä–∞–∫—Ç–∏–∫–∏</span></a
        >
        <a href="#"><img src="/assets/sidebar/7.svg" /><span>–ó–¥–æ—Ä–æ–≤‚Äô—è</span></a>
        <a href="#"><img src="/assets/sidebar/8.svg" /><span>–§—ñ–Ω–∞–Ω—Å–∏</span></a>
        <a href="#"
          ><img src="/assets/sidebar/9.svg" /><span>–ù–µ—Ä—É—Ö–æ–º—ñ—Å—Ç—å</span></a
        >
      </nav>

      <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ + –≤—ã—Ö–æ–¥ -->
      <div style="margin-top: auto">
        <a href="#"
          ><img src="/assets/sidebar/settings.svg" /><span
            >–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</span
          ></a
        >
        <div class="logout" onclick="logoutUser()">
          <img
            src="/assets/sidebar/log-out.svg"
            alt="Logout Icon"
            width="20"
            height="20"
          />
          <span>Logout Account</span>
        </div>
      </div>
    </aside>

    <div class="wrap">
      <h1>–ó–∞—è–≤–∫–∏ –≤—Å—ñ—Ö —É—á–∞—Å–Ω–∏–∫—ñ–≤</h1>
      <div class="req-table-wrap">
        <table class="req-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Name and surname</th>
              <th>Email</th>
              <th>Review</th>
            </tr>
          </thead>
          <tbody id="tblBody"></tbody>
        </table>
        <div id="empty" class="empty" style="display: none">
          –ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –∑–∞—è–≤–æ–∫.
        </div>
      </div>
    </div>

    <!-- MODAL -->
    <div
      id="reqModal"
      class="req-modal-backdrop"
      role="dialog"
      aria-modal="true"
      aria-labelledby="reqModalTitle"
    >
      <div class="req-modal">
        <div class="req-close-x" id="reqCloseX">√ó</div>
        <h3 id="reqModalTitle">–ó–∞—è–≤–∫–∞</h3>
        <div class="req-meta" id="reqMeta"></div>

        <div class="mentor-modal">
          <div class="mentor-left">
            <img
              id="reqPhoto"
              class="mentor-photo"
              src="/assets/profile-photo.png"
              alt="–§–æ—Ç–æ"
            />

            <div class="field">
              <label>–ü—Ä—ñ–∑–≤–∏—â–µ</label>
              <input id="fLastName" readonly />
            </div>
            <div class="field">
              <label>–Ü–º º—è</label>
              <input id="fFirstName" readonly />
            </div>
            <div class="field">
              <label>–ü–æ-–±–∞—Ç—å–∫–æ–≤—ñ</label>
              <input id="fMiddleName" readonly />
            </div>
            <div class="field">
              <label>–î–∞—Ç–∞ –ø–æ–¥–∞–Ω–Ω—è –∑–∞—è–≤–∫–∏</label>
              <input id="fSubmittedAt" readonly />
            </div>
            <div class="field">
              <label>–°–∫—ñ–ª—å–∫–∏ —Ä–æ–∫—ñ–≤ —É –≤–∞—Å –ø—Ä–∞–∫—Ç–∏–∫–∏</label>
              <input id="fExperience" readonly />
            </div>
            <div class="field">
              <label>–î–æ —è–∫–æ—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –ª—é–¥–µ–π –∑–∞ –≤—ñ–∫–æ–º –í–∏ –≤—ñ–¥–Ω–æ—Å–∏—Ç–µ—Å—å</label>
              <input id="fAge" readonly />
            </div>
            <div class="field">
              <label>–ù–∞–ø–∏—à—ñ—Ç—å –∑–∞–ø–∏—Ç –¥–æ –º–µ–Ω—Ç–æ—Ä–∞</label>
              <textarea id="fRequest" readonly></textarea>
            </div>
            <div class="field">
              <label>–ü—Ä–æ —Å–µ–±–µ / —Å–∏—Ç—É–∞—Ü—ñ—è</label>
              <textarea id="fAbout" readonly></textarea>
            </div>
            <div class="field">
              <label>–ü—Å–∏—Ö–æ–ª–æ–≥—ñ—á–Ω–∞ –æ—Å–≤—ñ—Ç–∞</label>
              <textarea id="fEducation" readonly></textarea>
            </div>
            <div class="field">
              <label>–¢–µ–º–∞—Ç–∏–∫–∏/—Ç–µ–º–∏</label>
              <textarea id="fTopics" readonly></textarea>
            </div>
          </div>

          <!-- mentor-right section for notes removed -->
        </div>

        <div class="modal-actions-bar">
          <button class="req-btn close" id="reqCloseBtn">–ó–∞–∫—Ä–∏—Ç–∏</button>
          <button class="btn-primary" id="reqSaveNotes">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
        </div>

        <div class="field">
          <label>–ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ –º–µ–Ω—Ç–æ—Ä–∞</label>

          <!-- –ö–Ω–æ–ø–∫–∞-¬´—Å–µ–ª–µ–∫—Ç¬ª -->
          <div
            id="mentorSelectBtn"
            class="mentor-select"
            aria-haspopup="listbox"
            aria-expanded="false"
            tabindex="0"
          >
            <span id="mentorSelectLabel">–û–±–µ—Ä—ñ—Ç—å –º–µ–Ω—Ç–æ—Ä–∞</span>
            <img
              class="mentor-caret"
              src="./images/arrow-down.png"
              alt=""
            />
          </div>

          <!-- –î—Ä–æ–ø–¥–∞—É–Ω-–º–µ–Ω—é -->
          <div
            id="mentorMenu"
            class="mentor-menu"
            role="listbox"
            tabindex="-1"
            style="display: none"
          ></div>

          <!-- –°—é–¥–∞ –∫–ª–∞–¥–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π id -->
          <input type="hidden" id="mentorSelectValue" />
        </div>
      </div>
    </div>

    <script>
      // ===== API (–∞–¥–º–∏–Ω—É ‚Äî –±–µ–∑ mine=1) =====
      const API = "/api/career-applications?all=1";

      function getAuthToken() {
        const direct =
          localStorage.getItem("token") ||
          localStorage.getItem("authToken") ||
          localStorage.getItem("jwt") ||
          localStorage.getItem("accessToken") ||
          localStorage.getItem("bearer") ||
          null;
        if (direct) return direct;
        try {
          const u = JSON.parse(localStorage.getItem("user") || "{}");
          return u.token || u.accessToken || null;
        } catch (_) {
          return null;
        }
      }
      // Fetch ALL career applications with robust pagination
     async function fetchAllAdminApplications() {
  const token = getAuthToken();
  const headers = Object.assign(
    { Accept: "application/json" },
    token ? { Authorization: `Bearer ${token}` } : {}
  );

  const all = [];
  let page = 1, pageSize = 200;

  for (let guard = 0; guard < 25; guard++) {
    const url = `/api/career-applications?all=1&limit=${pageSize}&page=${page}`;

    let res;
    try {
      res = await fetch(url, { method: "GET", credentials: "include", headers });
    } catch (e) {
      // –ó–¥–µ—Å—å –ø–æ–ø–∞–¥—ë–º –ø—Ä–∏ CORS/mixed content/—Å–µ—Ç–µ–≤–æ–π –æ—à–∏–±–∫–µ
      console.error("FETCH FAILED:", e);
      throw new Error("Failed to fetch (CORS / network / mixed content?)");
    }

    const raw = await res.clone().text();
    console.log("[ADMIN/APPS]", res.status, raw);

    if (res.status === 401) throw new Error("401 Unauthorized ‚Äî –Ω–µ –∑–∞—à–ª–∞ –∫—É–∫–∞/—Ç–æ–∫–µ–Ω");
    if (res.status === 403) throw new Error("403 Forbidden ‚Äî –Ω—É–∂–µ–Ω admin login");
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    let body = {};
    try { body = JSON.parse(raw); } catch {}

    const chunk = Array.isArray(body) ? body
      : Array.isArray(body?.rows) ? body.rows
      : Array.isArray(body?.items) ? body.items
      : Array.isArray(body?.data) ? body.data
      : (body?.ok && Array.isArray(body?.result)) ? body.result
      : [];

    all.push(...chunk);

    const hasMore = !!(body?.hasMore || body?.has_next || body?.next || body?.nextPage || body?.next_page || body?.next_page_token);
    const total = body?.total || body?.count || null;
    const nextPage =
      body?.nextPage ||
      (body?.page && body?.pages && body.page < body.pages ? body.page + 1 : null);

    const tokenCandidate = body?.next_page_token || body?.nextPageToken || body?.pageToken || null;

    if (tokenCandidate) { page += 1; continue; }
    if (nextPage)       { page = nextPage; continue; }
    if (hasMore && chunk.length > 0) { page += 1; continue; }
    if (total && all.length < total) { page += 1; continue; }
    break;
  }

  return all;
}

      const pad = (n) => String(n).padStart(2, "0");
      function formatDate(iso) {
        const d = new Date(iso);
        if (isNaN(d)) return "";
        return `${pad(d.getDate())}-${pad(
          d.getMonth() + 1
        )}-${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }
      function esc(s = "") {
        return String(s).replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#039;",
            }[m])
        );
      }
      function fullNameFrom(item) {
        const u = item.user || {};
        const first = u.firstName || item.firstName || "";
        const last = u.lastName || item.lastName || "";
        return first || last
          ? `${first} ${last}`.trim()
          : item.fullName || item.email || "–ë–µ–∑ —ñ–º–µ–Ω—ñ";
      }
      function emailFrom(item) {
        return (item.user?.email || item.email || "").trim();
      }

      const $tbody = document.getElementById("tblBody");
      const $empty = document.getElementById("empty");

      function rowTemplate(i, item) {
        const tr = document.createElement("tr");

        const tdNum = document.createElement("td");
        tdNum.textContent = i;

        const tdName = document.createElement("td");
        tdName.className = "req-name-cell";
        tdName.textContent = fullNameFrom(item);

        const tdEmail = document.createElement("td");
        tdEmail.className = "req-email-cell";
        tdEmail.textContent = emailFrom(item);

        const tdAction = document.createElement("td");
        const btn = document.createElement("button");
        btn.className = "btn-view";
        btn.textContent = "–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏";
       btn.addEventListener("click", () => {
  window.location.href = `admin-request-details.html?id=${item._id}`;
});
        tdAction.appendChild(btn);

        tr.append(tdNum, tdName, tdEmail, tdAction);
        return tr;
      }


      let __MENTORS = []; // –∫—ç—à —Å–ø–∏—Å–∫–∞ –º–µ–Ω—Ç–æ—Ä–æ–≤

function getAuthTokenAdmin(){
  try{
    const u = JSON.parse(localStorage.getItem('user')||'{}');
    return u.token || u.accessToken || localStorage.getItem('token') || null;
  }catch(_){ return null; }
}

async function fetchMentors(){
  // –æ—Å–Ω–æ–≤–Ω–æ–π –ø—É—Ç—å
  const token = getAuthTokenAdmin();
  const headers = Object.assign({ 'Accept':'application/json' }, token ? { 'Authorization': `Bearer ${token}` } : {});
  try{
    let res = await fetch('/api/users?role=mentor', { credentials:'include', headers });
    if (res.ok){
      const users = await res.json();
      return (Array.isArray(users) ? users : []).filter(Boolean);
    }
  }catch(_){}
  // —Ñ–æ–ª–±—ç–∫ ‚Äî —Ç—è–Ω–µ–º –≤—Å–µ—Ö –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Ä–æ–ª–∏
  try{
    let res = await fetch('/api/users', { credentials:'include', headers });
    if (!res.ok) return [];
    const all = await res.json();
    return (Array.isArray(all) ? all : []).filter(u=>{
      const roles = (u.roles||[]).map(s=>String(s).toLowerCase());
      return roles.some(r=> r.includes('–º–µ–Ω—Ç–æ—Ä') || r.includes('mentor'));
    });
  }catch(_){ return []; }
}

function renderMentorMenu(list, preselectedId){
  const menu = document.getElementById('mentorMenu');
  if (!menu) return;
  menu.innerHTML = '';
  if (!Array.isArray(list) || !list.length){
    const empty = document.createElement('div');
    empty.className = 'mentor-option';
    empty.textContent = '–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –º–µ–Ω—Ç–æ—Ä—ñ–≤';
    menu.appendChild(empty);
    return;
  }
  list.forEach(m=>{
    const opt = document.createElement('div');
    opt.className = 'mentor-option' + (preselectedId && preselectedId === m._id ? ' active':'');
    opt.setAttribute('role','option');
    opt.dataset.id = m._id;
    const name = `${m.firstName||''} ${m.lastName||''}`.trim() || (m.username || m.email || '–ë–µ–∑ —ñ–º–µ–Ω—ñ');
    opt.textContent = name;
    opt.addEventListener('click', ()=>{
      const label = document.getElementById('mentorSelectLabel');
      const hidden = document.getElementById('mentorSelectValue');
      if (label) label.textContent = name;
      if (hidden) hidden.value = m._id;
      closeMentorMenu();
    });
    menu.appendChild(opt);
  });
}

function openMentorMenu(){
  const menu = document.getElementById('mentorMenu');
  const btn  = document.getElementById('mentorSelectBtn');
  if (!menu || !btn) return;
  btn.setAttribute('aria-expanded','true');
  menu.style.display = 'block';
  // –∫–ª–∏–∫ –≤–Ω–µ ‚Äî –∑–∞–∫—Ä—ã—Ç—å
  window.addEventListener('click', closeOnOutsideOnce, { once:true });
}
function closeMentorMenu(){
  const menu = document.getElementById('mentorMenu');
  const btn  = document.getElementById('mentorSelectBtn');
  if (!menu || !btn) return;
  btn.setAttribute('aria-expanded','false');
  menu.style.display = 'none';
}
function closeOnOutsideOnce(e){
  const btn = document.getElementById('mentorSelectBtn');
  const menu= document.getElementById('mentorMenu');
  if (!btn || !menu) return;
  if (!btn.contains(e.target) && !menu.contains(e.target)) closeMentorMenu();
}
      function getReqEls() {
        return {
          modal: document.getElementById("reqModal"),
          title: document.getElementById("reqModalTitle"),
          meta: document.getElementById("reqMeta"),
          closeX: document.getElementById("reqCloseX"),
          closeBtn: document.getElementById("reqCloseBtn"),
          saveBtn: document.getElementById("reqSaveNotes"),
          photo: document.getElementById("reqPhoto"),
          fLast: document.getElementById("fLastName"),
          fFirst: document.getElementById("fFirstName"),
          fMiddle: document.getElementById("fMiddleName"),
          fSubmitted: document.getElementById("fSubmittedAt"),
          fExp: document.getElementById("fExperience"),
          fAge: document.getElementById("fAge"),
          fReq: document.getElementById("fRequest"),
          fAbout: document.getElementById("fAbout"),
          fEdu: document.getElementById("fEducation"),
          fTopics: document.getElementById("fTopics"),
        };
      }
      function bindReqModalEvents() {
        const { modal, closeX, closeBtn } = getReqEls();
        if (!modal || window.__reqModalBound) return;
        closeX && closeX.addEventListener("click", closeReqModal);
        closeBtn && closeBtn.addEventListener("click", closeReqModal);
        modal.addEventListener("click", (e) => {
          if (e.target === modal) closeReqModal();
        });
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closeReqModal();
        });
        window.__reqModalBound = true;
      }

      function fillModalFields(item) {
        const {
          photo,
          fLast,
          fFirst,
          fMiddle,
          fSubmitted,
          fExp,
          fAge,
          fReq,
          fAbout,
          fEdu,
          fTopics,
        } = getReqEls();
        const u = item.user || {};
        const photoUrl =
          u.photoUrl || item.photoUrl || "/assets/profile-photo.png";
        if (photo) photo.src = photoUrl;
        if (fLast) fLast.value = (u.lastName || item.lastName || "").trim();
        if (fFirst) fFirst.value = (u.firstName || item.firstName || "").trim();
        if (fMiddle)
          fMiddle.value = (u.middleName || item.middleName || "").trim();
        const when = item.createdAt || item.created_at || item.created || null;
        if (fSubmitted) fSubmitted.value = when ? formatDate(when) : "";
        if (fExp) fExp.value = item.experience || item.exp || "";
        if (fAge) fAge.value = item.ageGroup || item.age || "";
        if (fReq) fReq.value = item.requestText || item.request || "";
        if (fAbout) fAbout.value = item.aboutText || item.about || "";
        if (fEdu) fEdu.value = item.education || "";
        if (fTopics)
          fTopics.value = Array.isArray(item.topics)
            ? item.topics.join(", ")
            : item.topics || "";
      }

      async function assignMentorIfChanged(item) {
  const mentorId = (document.getElementById('mentorSelectValue')?.value || '').trim();
  const current  = item.assignedMentorId || item.assignedMentor?._id || '';
  if (!mentorId || mentorId === current) return;

  const token = getAuthToken && getAuthToken();
  const headersBase = Object.assign(
    { 'Content-Type':'application/json', 'Accept':'application/json' },
    token ? { 'Authorization': `Bearer ${token}` } : {}
  );

  const id = item._id;
  const res = await fetch(`/api/career-applications/${id}/assign`, {
    method: 'PUT',
    credentials: 'include',
    headers: headersBase,
    body: JSON.stringify({ mentorId })
  });

  if (!res.ok) {
    const txt = await res.text();
    throw new Error(`HTTP ${res.status} ‚Äì ${txt}`);
  }
}

      // saveAdminNotes function removed

      function openReqModal(item) {
        bindReqModalEvents();
        const { modal, title, meta, saveBtn } = getReqEls();
        if (!modal) return;
        const fio = fullNameFrom(item);
        const when = item.createdAt || item.created_at || item.created;
        const whenStr = when ? formatDate(when) : "";
        if (title) title.textContent = `–ó–∞—è–≤–∫–∞ ‚Äî ${fio}`;
        if (meta) meta.textContent = whenStr ? `–î–∞—Ç–∞ –ø–æ–¥–∞–Ω–Ω—è: ${whenStr}` : "";

        fillModalFields(item);
        // ==== –ú–µ–Ω—Ç–æ—Ä–∏: –∑–∞–≥—Ä—É–∑–∫–∞ –∏ –ø—Ä–µ—Å–µlect ====
        (async ()=>{
          try{
            // –ª–µ–Ω–∏–≤–æ –∫—ç—à–∏—Ä—É–µ–º
            if (!__MENTORS.length) __MENTORS = await fetchMentors();
            const hidden = document.getElementById('mentorSelectValue');
            const label  = document.getElementById('mentorSelectLabel');

            // –ø—Ä–µ—Å–µlect –∏–∑ –∑–∞—è–≤–∫–∏, –µ—Å–ª–∏ —É–∂–µ –Ω–∞–∑–Ω–∞—á–µ–Ω
            const assignedId = item.assignedMentorId || item.assignedMentor?._id || null;
            if (hidden) hidden.value = assignedId || '';
            if (label){
              const found = __MENTORS.find(m=> m._id === assignedId);
              label.textContent = found ? `${found.firstName||''} ${found.lastName||''}`.trim() || (found.username || found.email || '–ë–µ–∑ —ñ–º–µ–Ω—ñ') : '–û–±–µ—Ä—ñ—Ç—å –º–µ–Ω—Ç–æ—Ä–∞';
            }
            renderMentorMenu(__MENTORS, assignedId);

            // –±–∏–Ω–¥–∏–º –∫–Ω–æ–ø–∫—É
            const btn = document.getElementById('mentorSelectBtn');
            if (btn && !btn.__bound){
              btn.__bound = true;
              btn.addEventListener('click', (ev)=>{ ev.stopPropagation(); 
                const menu = document.getElementById('mentorMenu');
                if (!menu) return;
                const isOpen = menu.style.display !== 'none';
                if (isOpen) closeMentorMenu(); else openMentorMenu();
              });
              btn.addEventListener('keydown', (e)=>{
                if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openMentorMenu(); }
                if (e.key === 'Escape') { e.preventDefault(); closeMentorMenu(); }
              });
            }
          }catch(e){ console.warn('Mentors init failed', e); }
        })();

        if (saveBtn) {
          saveBtn.onclick = () =>
            assignMentorIfChanged(item)
              .then(() => {
                alert("–ú–µ–Ω—Ç–æ—Ä –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∏–π");
                closeReqModal();
              })
              .catch((e) => {
                alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –º–µ–Ω—Ç–æ—Ä–∞");
                console.error(e);
              });
        }

        modal.style.display = "flex";
        document.body.style.overflow = "hidden";
      }
      function closeReqModal() {
        const { modal } = getReqEls();
        if (modal) {
          modal.style.display = "none";
          document.body.style.overflow = "";
        }
      }

      async function load() {
  try {
    const items = await fetchAllAdminApplications();
    $tbody.innerHTML = "";
    if (!items.length) {
      $empty.style.display = "block";
      $empty.textContent = "–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –∑–∞—è–≤–æ–∫.";
      return;
    }
    $empty.style.display = "none";
    items.sort((a,b)=> new Date(b.createdAt||0) - new Date(a.createdAt||0))
         .forEach((it, idx)=> $tbody.appendChild(rowTemplate(idx+1, it)));
  } catch (e) {
    console.error(e);
    $tbody.innerHTML = "";
    $empty.style.display = "block";
    $empty.textContent = String(e.message || e)  // üëà –ø–æ–∫–∞–∂–µ–º 401/403 –∏ —Ç.–¥.
  }
}
      document.addEventListener("DOMContentLoaded", () => {
        bindReqModalEvents();
        load();
      });
    </script>
  </body>
</html>
