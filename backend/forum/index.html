<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Форум</title>
    <link rel="stylesheet" href="/forum.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body class="with-sidebar">
    <aside class="sidebar collapsed" id="sidebar">
      <div class="toggle-button" onclick="toggleSidebar()">
        <img src="/assets/sidebar/arrow.svg" alt="Toggle" id="toggleArrow" />
      </div>
      <img
        class="logo"
        src="/assets/sidebar/IPS Logo (2).svg"
        alt="Logo"
        id="logoExpanded"
      />
      <img
        class="logo-collapsed"
        src="/assets/sidebar/IPS Logo (1).svg"
        alt="Logo Small"
        id="logoCollapsed"
      />
      <img
        class="profile"
        src="/assets/profile-photo.png"
        alt="User"
        width="40"
        height="40"
      />
      <nav>
        <a href="/profile.html"
          ><img src="/assets/sidebar/profile.svg" /><span>Про Мене</span></a
        >
        <a href="/mycertificates.html"
          ><img src="/assets/sidebar/news.svg" /><span>Мої Сертифікати</span></a
        >
        <a href="/career-faq.html"
          ><img src="/assets/sidebar/10.svg" /><span
            >Планування Кар'єри</span
          ></a
        >
        <a href="/library.html"
          ><img src="/assets/sidebar/3.svg" /><span>Бібліотека</span></a
        >
        <a href="/my-courses.html"
          ><img src="/assets/sidebar/5.svg" /><span>Мої Курси</span></a
        >
        <a href="/forum/index.html">
          <img src="/assets/sidebar/forum.svg" alt="Форум" /><span>Форум</span>
        </a>
      </nav>
      <div class="logout">
        <img
          src="/assets/sidebar/log-out.svg"
          alt="Logout Icon"
          width="20"
          height="20"
        />
        <span>Вийти з акаунту</span>
      </div>
    </aside>

    <main class="wrap">
      <div class="forum-hero">
        <img src="/assets/forum/main-img.jpg" alt="Forum hero" />
      </div>

      <div class="action-bar">
        <img class="avatar" src="/assets/profile-photo.png" alt="User" />
        <input
          id="q"
          class="search-bar"
          type="text"
          placeholder="Пошук тем..."
        />
        <button class="publish-btn" id="btnNewThread">Публікувати</button>
      </div>

      <div class="forum-header">
        <div>
          <div class="forum-title">Форум</div>
          <div id="roleHint" class="thread-meta"></div>
        </div>
      </div>

      <div
        id="empty"
        class="thread-meta"
        style="display: none; margin-top: 12px"
      >
        Поки що немає тем.
      </div>
      <div id="list" class="thread-list"></div>
    </main>

    <script src="./forum.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        if (typeof renderAdminSidebar === "function")
          renderAdminSidebar("forum/index.html");

        await Forum.init();
        Forum.renderRoleHint("#roleHint");

        const btnNew = document.getElementById("btnNewThread");

        if (!Forum.can("post:create")) btnNew.style.display = "none";

        const load = async () => {
          try {
            const q = document.getElementById("q").value.trim();
            const data = await Forum.api.listThreads({ q });
            Forum.renderThreadList("#list", data, "#empty");
          } catch (e) {
            console.warn(e);
            alert("Не вдалося завантажити список тем.");
          }
        };
        document.getElementById("q").addEventListener("keydown", (e) => {
          if (e.key === "Enter") load();
        });

        btnNew.addEventListener("click", async () => {
          const title = prompt("Заголовок теми:");
          if (!title) return;
          const content = prompt("Перший пост:") || "";
          try {
            const t = await Forum.api.createThread({ title, content });
            if (t && t._id) location.href = `./thread.html?id=${t._id}`;
          } catch (err) {
            const msg = String(err.message || err);
            if (/unauthorized/i.test(msg) || /401/.test(msg)) {
              alert("Потрібно увійти в акаунт, щоб створити тему.");
            } else if (/forbidden/i.test(msg) || /403/.test(msg)) {
              alert("У вас немає прав створювати теми (403).");
            } else {
              alert("Не вдалося створити тему: " + msg);
            }
          }
        });

        await load();

        let t;
        document.getElementById("q").addEventListener("input", () => {
          clearTimeout(t);
          t = setTimeout(load, 350);
        });
      });
    </script>
  </body>
</html>
