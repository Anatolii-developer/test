<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–¢–µ–º–∞ —Ñ–æ—Ä—É–º—É</title>
<link rel="stylesheet" href="./forum.css">
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body class="with-sidebar">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="wrap">
      <div class="thread-card">
    <div class="thread-card__left">
      <div class="thread-title" id="tTitle">...</div>
      <div class="thread-author">
        <img class="thread-avatar" src="/assets/profile-photo.png" alt="" />
        <div class="thread-author-col">
          <div class="thread-author-name" id="tAuthor">‚Äî</div>
          <div class="thread-author-meta" id="tMeta">‚Äî</div>
        </div>
      </div>
    </div>
    <div class="thread-answers" id="tAnswers">‚Äî</div>
  </div>

  <div id="tModActions" class="mod-actions" style="display:none">
    <button class="mod-btn" id="btnPin">
      <img src="/assets/forum/attach.svg" alt="" class="mod-icon"/>
      <span>–ó–∞–∫—Ä—ñ–ø–∏—Ç–∏</span>
    </button>
    <button class="mod-btn" id="btnPrivacy">
      <img src="/assets/forum/lock.svg" alt="" class="mod-icon"/>
      <span>–ü—Ä–∏–≤–∞—Ç–Ω–∞</span>
    </button>
    <button class="mod-btn" id="btnDelThread">
      <img src="/assets/forum/trash.svg" alt="" class="mod-icon"/>
      <span>–í–∏–¥–∞–ª–∏—Ç–∏</span>
    </button>
    <button class="mod-btn" id="btnLock">
      <img src="/assets/forum/lock.svg" alt="" class="mod-icon"/>
      <span>–ó–∞–∫—Ä–∏—Ç–∏</span>
    </button>
    <button class="mod-btn" id="btnInvite">
      <img src="/assets/forum/add-icon.svg" alt="" class="mod-icon"/>
      <span>–ó–∞–ø—Ä–æ—Å–∏—Ç–∏</span>
    </button>
  </div>

      <div id="posts" style="margin-top: 16px"></div>

      <div id="composer" class="composer">
  <div id="replyCtx" class="reply-context">
    –í—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞:&nbsp;<span id="replyToWho"></span>
    <button id="replyCancel" class="close" title="–°–∫–∞—Å—É–≤–∞—Ç–∏">√ó</button>
  </div>
  <textarea id="replyText" placeholder="–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å..."></textarea>

  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
    <input id="replyFiles" type="file" multiple />
    <button class="btn btn-primary" id="btnReply">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
    <span class="meta" id="lockHint" style="display:none">–¢–µ–º–∞ –∑–∞–∫—Ä–∏—Ç–∞ –¥–ª—è –Ω–æ–≤–∏—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π</span>
  </div>

  <!-- –ø—Ä–µ–≤—å—é –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ -->
  <div id="preview" class="attachments-preview"></div>
</div>
    </main>

    <script src="./forum.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        if (typeof renderAdminSidebar === "function")
          renderAdminSidebar("forum/index.html");
        await Forum.init();

        const id = new URLSearchParams(location.search).get("id");
        const $files = document.getElementById("replyFiles");
        const $preview = document.getElementById("preview");
        const $text = document.getElementById("replyText");

        // ---- reply-to (threaded) state ----
        let currentParentId = null;

        // Chip elements
        const $replyCtx = document.getElementById("replyCtx");
        const $replyToWho = document.getElementById("replyToWho");
        const $replyCancel = document.getElementById("replyCancel");

        function showReplyCtx({ author = "", snippet = "" } = {}) {
          $replyToWho.textContent = author ? `${author}: ${snippet}` : "";
          $replyCtx.style.display = author ? "inline-flex" : "none";
        }
        function clearReplyCtx() {
          currentParentId = null;
          $replyCtx.style.display = "none";
          $replyToWho.textContent = "";
        }
        // Allow Forum.renderPosts() to call this
        window.setReplyParent = function (postId, opts = {}) {
          currentParentId = postId;
          showReplyCtx({
            author: (opts.author || "").toString(),
            snippet: (opts.snippet || "").toString().slice(0, 80)
          });
          // Focus composer
          $text?.focus();
        };
        // Also support custom event if Forum.renderPosts dispatches it
        document.addEventListener("forum:set-reply-parent", (e) => {
          const { postId, author, snippet } = e.detail || {};
          if (!postId) return;
          window.setReplyParent(postId, { author, snippet });
        });
        // Cancel button
        $replyCancel?.addEventListener("click", clearReplyCtx);

        $files.addEventListener("change", () => {
  $preview.innerHTML = "";
  [...$files.files].forEach(f => {
    if (f.type.startsWith("image/")) {
      const url = URL.createObjectURL(f);
      const img = document.createElement("img");
      img.src = url;
      img.onload = () => URL.revokeObjectURL(url);
      $preview.appendChild(img);
    } else {
      const div = document.createElement("div");
      div.className = "meta";
      div.textContent = `–§–∞–π–ª: ${f.name} (${Math.round(f.size/1024)} KB)`;
      $preview.appendChild(div);
    }
  });
});

document.getElementById("btnReply").addEventListener("click", async () => {
  const content = $text.value.trim();
  const hasFiles = $files.files && $files.files.length > 0;

  if (!content && !hasFiles) return;

    try {
      if (hasFiles) {
        const form = new FormData();
        form.append("content", content);
        if (currentParentId) form.append("parentId", currentParentId);
        [...$files.files].forEach(f => form.append("files", f));

        const res = await fetch(`/api/forum/threads/${id}/posts-with-files`, {
          method: "POST",
          body: form,
          credentials: "include"
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || "–ü–æ–º–∏–ª–∫–∞");
      } else {
        // JSON path ‚Äî –ø–µ—Ä–µ–¥–∞–µ–º parentId
        await Forum.api.addPost(id, { content, parentId: currentParentId || undefined });
      }

      // –æ—á–∏—Å—Ç–∫–∞ –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞
      $text.value = "";
      $files.value = "";
      $preview.innerHTML = "";
      clearReplyCtx();

      const data = await Forum.api.getThread(id);
      Forum.renderPosts("#posts", data.posts, { thread: data.thread });
    } catch (e) {
      alert(e.message || e);
    }
});

        if (!id) return (location.href = "./index.html");

        const { thread, posts } = await Forum.api.getThread(id);

// ==== Fill title card (header) ====
const $titleEl   = document.getElementById('tTitle');
const $authorEl  = document.getElementById('tAuthor');
const $metaEl    = document.getElementById('tMeta');
const $answersEl = document.getElementById('tAnswers');

if ($titleEl)  $titleEl.textContent  = thread.title || '';
if ($authorEl) $authorEl.textContent = (thread.author?.fullName || thread.author?.username || thread.author?.email || '‚Äî');

// Compose meta like: "–°—Ç–≤–æ—Ä–∏–≤: NAME ‚Ä¢ DATE ‚Ä¢ (üìå –ó–∞–∫—Ä—ñ–ø–ª–µ–Ω–æ) (üîí –ó–∞–∫—Ä–∏—Ç–æ) (üîê –ü—Ä–∏–≤–∞—Ç–Ω–∞)"
const createdBy  = (thread.author?.username || thread.author?.email || '‚Äî');
const createdAt  = (()=>{ try { return new Date(thread.createdAt).toLocaleString('uk-UA'); } catch { return '';} })();
let metaParts = [ `–°—Ç–≤–æ—Ä–∏–≤: ${createdBy}`, createdAt ];
if (thread.pinned) metaParts.push('üìå –ó–∞–∫—Ä—ñ–ø–ª–µ–Ω–æ');
if (thread.locked) metaParts.push('üîí –ó–∞–∫—Ä–∏—Ç–æ');
if (thread.isPrivate) metaParts.push('üîê –ü—Ä–∏–≤–∞—Ç–Ω–∞');
if ($metaEl) $metaEl.textContent = metaParts.filter(Boolean).join(' ‚Ä¢ ');

// Answers count (prefer posts.length, fallback to thread.postsCount)
const answers = Array.isArray(posts) ? posts.length : (thread.postsCount || 0);
if ($answersEl) $answersEl.textContent = `${answers} –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π`;

// Render posts below
Forum.renderPosts('#posts', posts, { thread });

// –µ–¥–∏–Ω—ã–π –±–ª–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–∫–∞–∑–æ–º –æ—Ç–≤–µ—Ç–æ–≤
(function initRepliesToggle(){
  const root = document.querySelector('#posts');
  if (!root) return;

  // —Å–æ–±—Ä–∞—Ç—å –æ—Ç–≤–µ—Ç—ã, –Ω–∞—á–∏–Ω–∞—è —Å–æ 2-–≥–æ –ø–æ—Å—Ç–∞, –∏ —Å–ø—Ä—è—Ç–∞—Ç—å
  const replies = [...root.querySelectorAll('.post')].slice(1);
  if (!replies.length) return;

  let store = root.querySelector('#hiddenReplies');
  if (!store){
    store = document.createElement('div');
    store.id = 'hiddenReplies';
    store.style.display = 'none';
    root.appendChild(store);
  }
  replies.forEach(n => store.appendChild(n));

  // —Ñ—É—Ç–µ—Ä —Å –∫–Ω–æ–ø–∫–æ–π –∏ —Å—á—ë—Ç—á–∏–∫–æ–º –≤ –ø–µ—Ä–≤–æ–º –ø–æ—Å—Ç–µ
  const first = root.querySelector('.post:first-child');
  if (!first) return;

  let footer = first.querySelector('.post-footer');
  if (!footer){
    footer = document.createElement('div');
    footer.className = 'post-footer';
    footer.innerHTML = `
      <button class="show-more" type="button">–ü–æ–∫–∞–∑–∞—Ç–∏ –±—ñ–ª—å—à–µ</button>
      <span class="answers-count" id="postAnswersCount"></span>
    `;
    first.appendChild(footer);
  }

  const total = Math.max((Array.isArray(posts) ? posts.length : (thread.postsCount || 0)) - 1, 0);
  const cntEl = footer.querySelector('#postAnswersCount');
  if (cntEl) cntEl.textContent = `${total} –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π`;

  // –±–ª–æ–∫, –≤ –∫–æ—Ç–æ—Ä–æ–º –±—É–¥–µ—Ç –û–î–ù–ê –ª–∏–Ω–∏—è –∏ —Å–ø–∏—Å–æ–∫ –æ—Ç–≤–µ—Ç–æ–≤ ‚Äî –≤–Ω—É—Ç—Ä–∏ –ø–µ—Ä–≤–æ–≥–æ –ø–æ—Å—Ç–∞
  let repliesBlock = first.querySelector('.replies-block');
  if (!repliesBlock){
    repliesBlock = document.createElement('div');
    repliesBlock.className = 'replies-block';
    repliesBlock.style.display = 'none';
    first.appendChild(repliesBlock);
  }

  const btn = footer.querySelector('.show-more');
  let open = false;

  // –∑–∞—Ä–∞–Ω–µ–µ —Å–æ–∑–¥–∞—ë–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–ø–∏—Å–∫–∞, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å
  const sep = document.createElement('div');
  sep.className = 'replies-separator';
  const list = document.createElement('div');
  list.className = 'replies-list';

  btn?.addEventListener('click', () => {
    open = !open;
    if (open){
      // –ø–æ—Ä—è–¥–æ–∫: –∫–Ω–æ–ø–∫–∞ ‚Üí –ª–∏–Ω–∏—è ‚Üí –æ—Ç–≤–µ—Ç—ã
      repliesBlock.innerHTML = '';
      repliesBlock.appendChild(sep);
      repliesBlock.appendChild(list);

      while (store.firstChild) list.appendChild(store.firstChild);

      repliesBlock.style.display = 'block';
      btn.textContent = '–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏';
    } else {
      while (list.firstChild) store.appendChild(list.firstChild);
      repliesBlock.style.display = 'none';
      btn.textContent = '–ü–æ–∫–∞–∑–∞—Ç–∏ –±—ñ–ª—å—à–µ';
    }
  });
})();
       document.querySelectorAll('#posts .js-reply').forEach(btn => { btn.textContent = 'Reply'; });
        // —Ö—Ç–æ –º–æ–∂–µ –±–∞—á–∏—Ç–∏ –º–æ–¥-–∫–Ω–æ–ø–∫–∏: –º–æ–¥–µ—Ä–∞—Ç–æ—Ä –∞–±–æ –∞–≤—Ç–æ—Ä —Ç–µ–º–∏
        const me = (() => { try { return JSON.parse(localStorage.getItem('user') || 'null'); } catch { return null; } })();
        const canModThis = Forum.can("moderate:threads") || (me && thread.author && String(me._id) === String(thread.author._id));

        // mod/owner buttons
        if (canModThis) {
          const $actions = document.getElementById("tModActions");
          if ($actions) $actions.style.display = "flex";

          const $btnPin = document.getElementById("btnPin");
          const $btnLock = document.getElementById("btnLock");
          const $btnDel = document.getElementById("btnDelThread");
          const $btnPrivacy = document.getElementById("btnPrivacy");
          const $btnInvite = document.getElementById("btnInvite");

          $btnPin && ($btnPin.onclick = async () => { await Forum.api.togglePin(id); location.reload(); });
          $btnLock && ($btnLock.onclick = async () => { await Forum.api.toggleLock(id); location.reload(); });
          $btnDel && ($btnDel.onclick = async () => {
            if (!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–µ–º—É?")) return;
            await Forum.api.deleteThread(id);
            location.href = "./index.html";
          });

          // –ø—Ä–∏–≤–∞—Ç–Ω—ñ—Å—Ç—å
          $btnPrivacy && ($btnPrivacy.onclick = async () => {
            const next = !thread.isPrivate;
            await Forum.api.togglePrivate(id, next);
            location.reload();
          });

          // –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è
          $btnInvite && ($btnInvite.onclick = async () => {
            const userId = prompt("–í–≤–µ–¥—ñ—Ç—å ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —è–∫–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∏—Ç–∏:");
            if (!userId) return;
            try {
              await Forum.api.addParticipant(id, userId.trim());
              alert("–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–æ–¥–∞–Ω–æ –¥–æ –ø—Ä–∏–≤–∞—Ç–Ω–æ—ó —Ç–µ–º–∏");
            } catch (e) {
              alert(e.message || e);
            }
          });
        }
    
      });

      // Update renderThreadHead to support new header placeholders while keeping backward compatibility
      function renderThreadHead(thread, selTitle, selMeta, selActions) {
        // Back-compat: still fill passed selectors
        const $t = selTitle ? document.querySelector(selTitle) : null;
        const $m = selMeta ? document.querySelector(selMeta) : null;
        if ($t) $t.textContent = thread.title || '';
        if ($m) {
          const createdBy  = (thread.author?.username || thread.author?.email || '‚Äî');
          const createdAt  = fmtDate(thread.createdAt);
          const parts = [ `–°—Ç–≤–æ—Ä–∏–≤: ${createdBy}`, createdAt ];
          if (thread.pinned) parts.push('üìå –ó–∞–∫—Ä—ñ–ø–ª–µ–Ω–æ');
          if (thread.locked) parts.push('üîí –ó–∞–∫—Ä–∏—Ç–æ');
          if (thread.isPrivate) parts.push('üîê –ü—Ä–∏–≤–∞—Ç–Ω–∞');
          $m.textContent = parts.filter(Boolean).join(' ‚Ä¢ ');
        }
        // New header placeholders (if present on page)
        const $authorEl  = document.getElementById('tAuthor');
        const $answersEl = document.getElementById('tAnswers');
        if ($authorEl) $authorEl.textContent = (thread.author?.fullName || thread.author?.username || thread.author?.email || '‚Äî');
        if ($answersEl && Number.isFinite(thread.postsCount)) $answersEl.textContent = `${thread.postsCount} –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π`;

        if (selActions && can('moderate:threads')) {
          const $a = document.querySelector(selActions);
          if ($a) $a.style.display = 'flex';
        }
      }
    </script>
  </body>
</html>
