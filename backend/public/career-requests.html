<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Подати заявку</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
    <style>
      body {
        margin: 0;
        font-family: "Poppins", sans-serif;
        background: #97c194;
        color: #414141;
      }

      .apply-header {
        width: 1110px;
        height: 212px;
        background: #fff;
        border-radius: 24px;
        margin: 40px auto 20px;
        padding: 40px 100px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .apply-title {
        font-size: 40px;
        font-weight: 600;
        color: #414141;
      }
      .apply-image {
        width: 284px;
        height: 164px;
      }
      .apply-arrow {
        width: 64px;
        height: 64px;
      }

      .back-button {
        width: 196px;
        height: 48px;
        background: #275d2b;
        border-radius: 24px;
        color: #fff;
        padding: 10px 53px;
        margin: 0 auto 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        cursor: pointer;
        text-decoration: none;
      }

      .apply-form {
        width: 1110px;
        background: #fff;
        border-radius: 24px;
        padding: 60px 100px;
        margin: 0 auto;
      }

      /* Список заявок */
      #list {
        margin-top: 10px;
      }

.req-row {
  width: 910px;
  height: 52px;
  background: #ffeed9;
  border-radius: 16px;
  padding: 10px 16px;
  box-sizing: border-box;
  display: flex;
  align-items: center;
  gap: 16px;
  margin: 14px auto;
  justify-content: space-between; 
}

      /* Левая часть растягивается, внутри можно сжиматься */
      .req-left {
        display: flex;
        align-items: center;
        gap: 16px;
        min-width: 0; /* ВАЖНО: даёт право детям сжиматься */
        flex: 1 1 auto;
      }

      .req-num {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        flex: 0 0 36px;
      }

      /* Имя обрезаем многоточием */
      .req-name {
        font-weight: 500;
        font-size: 20px;
        min-width: 0; /* ВАЖНО: иначе ellipsis не сработает */
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .req-date {
        font-weight: 500;
        font-size: 18px;
        color: #555;
        white-space: nowrap;
        flex: 0 0 auto;
      }

      .btn-more {
  height: 32px;
  padding: 0 16px;
  border-radius: 24px;
  border: none;
  cursor: pointer;
  background: #275d2b;
  color: #fff;
  font-weight: 600;
  font-size: 14px;
  white-space: nowrap;
  flex: 0 0 auto; /* кнопка не растягивается */
}

      .empty {
        text-align: center;
        color: #6b6b6b;
        margin-top: 8px;
      }

      @media (max-width: 1200px) {
        .apply-header,
        .apply-form {
          width: 90%;
          padding: 40px 30px;
        }
        .req-row {
          width: 100%;
        }
        .req-name {
          max-width: 50vw;
        } /* можно подрегулировать */
      }

      /* ==== MODAL (деталі заявки) ==== */
      .req-modal-backdrop{
        position:fixed; inset:0; background:rgba(0,0,0,.45); display:none;
        align-items:center; justify-content:center; z-index:2000;
      }
      .req-modal{
        width:720px; max-width:90vw; background:#fff; border-radius:16px;
        padding:24px 24px 20px; box-shadow:0 12px 40px rgba(0,0,0,.25);
        position:relative;
      }
      .req-modal h3{
        margin:0 0 12px 0; font-size:24px; font-weight:600; color:#414141;
      }
      .req-meta{ color:#6b6b6b; font-size:14px; margin-bottom:12px }
      .req-qa{ display:flex; flex-direction:column; gap:12px; margin-top:8px }
      .req-qa .row{
        background:#FFF7EE; border-radius:12px; padding:12px 14px;
      }
      .req-qa .q{ font-weight:600; color:#275D2B; margin-bottom:4px }
      .req-qa .a{ white-space:pre-wrap; color:#414141 }
      .req-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:16px }
      .req-btn{ border:none; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:600 }
      .req-btn.close{ background:#f3f4f6 }
      .req-btn.primary{ background:#275D2B; color:#fff }
      .req-close-x{
        position:absolute; right:14px; top:12px; font-size:22px; line-height:1; cursor:pointer; opacity:.6;
      }
      .req-close-x:hover{ opacity:1 }
    </style>
  </head>
  <body>
    <aside class="sidebar collapsed" id="sidebar">
      <div class="toggle-button" onclick="toggleSidebar()">
        <img src="assets/sidebar/arrow.svg" alt="Toggle" id="toggleArrow" />
      </div>
      <img
        class="logo"
        src="assets/sidebar/IPS Logo (2).svg"
        alt="Logo"
        id="logoExpanded"
      />
      <img
        class="logo-collapsed"
        src="assets/sidebar/IPS Logo (1).svg"
        alt="Logo Small"
        id="logoCollapsed"
      />
      <img
        class="profile"
        src="assets/profile-photo.png"
        alt="User"
        width="40"
        height="40"
      />
      <nav>
        <a href="profile.html"
          ><img src="assets/sidebar/profile.svg" /><span>Про Мене</span></a
        >
        <a href="#"
          ><img src="assets/sidebar/news.svg" /><span>Мої Сертифікати</span></a
        >
        <a href="career-faq.html"
          ><img src="assets/sidebar/10.svg" /><span>Планування Кар'єри</span></a
        >
        <a href="library.html"
          ><img src="assets/sidebar/3.svg" /><span>Бібліотека</span></a
        >
        <a href="my-courses.html"
          ><img src="assets/sidebar/5.svg" /><span>Мої Курси</span></a
        >
        <a href="#"><img src="assets/sidebar/8.svg" /><span>Облік</span></a>
        <a href="#"><img src="assets/sidebar/4.svg" /><span>Здоров’я</span></a>
        <a href="#"><img src="assets/sidebar/9.svg" /><span>Фінанси</span></a>
        <a href="#"
          ><img src="assets/sidebar/6.svg" /><span>Нерухомість</span></a
        >
      </nav>
      <div class="logout">
        <img
          src="assets/sidebar/log-out.svg"
          alt="Logout Icon"
          width="20"
          height="20"
        />
        <span>Вийти з акаунту</span>
      </div>
    </aside>

    <div class="apply-header">
      <div class="apply-title">Подати заявку</div>
      <!-- текст оставил таким же -->
      <img class="apply-image" src="./assets/career-apply.png" alt="Person" />
      <img class="apply-arrow" src="./assets/library/arrow.png" alt="Arrow" />
    </div>

    <a href="career-faq.html" class="back-button">
      <img src="./assets/library/arrow-main.svg" alt="Back" /> Головна
    </a>

    <div class="apply-form">
      <div id="list"></div>
      <div id="empty" class="empty" style="display: none">
        Поки що немає заявок.
      </div>
    </div>

    <script>
      const API = "/api/career-applications?mine=1";

      // Get token from various possible keys
      function getAuthToken() {
        const direct =
          localStorage.getItem("token") ||
          localStorage.getItem("authToken") ||
          localStorage.getItem("jwt") ||
          localStorage.getItem("accessToken") ||
          localStorage.getItem("bearer") ||
          null;

        if (direct) return direct;

        try {
          const u = JSON.parse(localStorage.getItem("user") || "{}");
          return u.token || u.accessToken || null;
        } catch (_) {
          return null;
        }
      }

      function debugLog(prefix, res, body) {
        try {
          console.log(prefix, {
            status: res && res.status,
            ok: res && res.ok,
            url: res && res.url,
            body,
          });
        } catch (e) {}
      }

      // Ensure containers exist even if markup changes
      function ensureContainers() {
        let form = document.querySelector(".apply-form") || document.body;

        let list = document.getElementById("list");
        if (!list) {
          list = document.createElement("div");
          list.id = "list";
          form.appendChild(list);
        }

        let empty = document.getElementById("empty");
        if (!empty) {
          empty = document.createElement("div");
          empty.id = "empty";
          empty.className = "empty";
          empty.style.display = "none";
          empty.textContent = "Поки що немає заявок.";
          form.appendChild(empty);
        }
        return { listEl: list, emptyEl: empty };
      }

      // Friendly notice instead of redirect loop
      function showLoginNotice(msg) {
        const { emptyEl, listEl } = ensureContainers();
        emptyEl.textContent =
          msg || "Щоб переглянути заявки — увійдіть у систему.";
        emptyEl.style.display = "block";
        if (listEl) listEl.innerHTML = "";
        const btn = document.createElement("a");
        btn.href = "index.html";
        btn.textContent = "Увійти";
        btn.style.cssText =
          "display:inline-block;margin-top:8px;background:#275D2B;color:#fff;padding:8px 16px;border-radius:12px;text-decoration:none;";
        emptyEl.appendChild(btn);
      }

      async function ensureAuth() {
        const token = getAuthToken();
        try {
          const res = await fetch("/api/users/profile", {
            method: "GET",
            credentials: "include",
            headers: token ? { Authorization: `Bearer ${token}` } : {},
          });
          let payload = null;
          try {
            payload = await res.clone().json();
          } catch (_) {}
          debugLog("Profile check →", res, payload);
          if (res.ok) return payload;
          return null;
        } catch (e) {
          console.warn("ensureAuth failed:", e);
          return null;
        }
      }

      const pad = (n) => String(n).padStart(2, "0");
      function formatDate(iso) {
        const d = new Date(iso);
        if (isNaN(d)) return "";
        return `${pad(d.getDate())}-${pad(
          d.getMonth() + 1
        )}-${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }

      function rowTemplate(i, item) {
        const fullName =
          (item.user &&
            `${item.user.firstName || ""} ${
              item.user.lastName || ""
            }`.trim()) ||
          (item.fullName && item.fullName.trim()) ||
          (item.email || "").trim() ||
          "Без імені";

        const created = item.createdAt
          ? formatDate(item.createdAt)
          : item.created_at
          ? formatDate(item.created_at)
          : "";

        const row = document.createElement("div");
        row.className = "req-row";

        const left = document.createElement("div");
        left.className = "req-left";

        const num = document.createElement("div");
        num.className = "req-num";
        num.textContent = i;

        const name = document.createElement("div");
        name.className = "req-name";
        name.textContent = fullName;

        const date = document.createElement("div");
        date.className = "req-date";
        date.textContent = created;

        left.append(num, name, date);

        const more = document.createElement("button");
        more.className = "btn-more";
        more.textContent = "Дізнатись більше";
        more.addEventListener("click", () => {
          openReqModal(item);
        });

        row.append(left, more);
        return row;
      }

      async function load() {
        const { listEl, emptyEl } = ensureContainers();

        try {
          const user = await ensureAuth();
          if (!user) {
            showLoginNotice(
              "Щоб переглянути власні заявки — увійдіть у систему."
            );
            return;
          }

          const token = getAuthToken();
          const res = await fetch(API, {
            method: "GET",
            headers: Object.assign(
              { Accept: "application/json" },
              token ? { Authorization: `Bearer ${token}` } : {}
            ),
            credentials: "include",
          });

          let data = null;
          try {
            data = await res.clone().json();
          } catch (_) {}
          debugLog("Career apps →", res, data);

          if (
            res.status === 401 ||
            (data &&
              data.ok === false &&
              /unauthorized/i.test(data.message || ""))
          ) {
            showLoginNotice("Сеанс закінчився. Будь ласка, увійдіть ще раз.");
            return;
          }

          const items = Array.isArray(data)
            ? data
            : Array.isArray(data?.rows)
            ? data.rows
            : Array.isArray(data?.items)
            ? data.items
            : Array.isArray(data?.data)
            ? data.data
            : data?.ok && Array.isArray(data?.result)
            ? data.result
            : [];

          listEl.innerHTML = "";

          if (!items.length) {
            emptyEl.style.display = "block";
            emptyEl.textContent = "Поки що немає заявок.";
            return;
          }

          emptyEl.style.display = "none";

          items
            .sort(
              (a, b) =>
                new Date(b.createdAt || b.created_at || 0) -
                new Date(a.createdAt || a.created_at || 0)
            )
            .forEach((it, idx) => listEl.appendChild(rowTemplate(idx + 1, it)));
        } catch (err) {
          console.error("Career applications load failed:", err);
          const { emptyEl } = ensureContainers();
          emptyEl.textContent = "Не вдалося завантажити заявки.";
          emptyEl.style.display = "block";
        }
      }

      // Run after DOM is ready
      document.addEventListener("DOMContentLoaded", load);


      function esc(s=''){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}
function fullNameFrom(item){
  // имя/фамилия
  const u = item.user || {};
  const first = u.firstName || item.firstName || '';
  const last  = u.lastName  || item.lastName  || '';
  return (first || last) ? `${first} ${last}`.trim() :
         (item.fullName || item.email || 'Без імені');
}


function getReqEls(){
  return {
    modal:    document.getElementById('reqModal'),
    title:    document.getElementById('reqModalTitle'),
    meta:     document.getElementById('reqMeta'),
    qa:       document.getElementById('reqQA'),
    closeX:   document.getElementById('reqCloseX'),
    closeBtn: document.getElementById('reqCloseBtn'),
  };
}

function bindReqModalEvents(){
  const { modal, closeX, closeBtn } = getReqEls();
  if (!modal || window.__reqModalBound) return;
  if (closeX)   closeX.addEventListener('click', closeReqModal);
  if (closeBtn) closeBtn.addEventListener('click', closeReqModal);
  modal.addEventListener('click', (e)=>{ if (e.target === modal) closeReqModal(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeReqModal(); });
  window.__reqModalBound = true;
}

function openReqModal(item){
  bindReqModalEvents();
  const { modal, title, meta, qa } = getReqEls();
  if (!modal || !title || !meta || !qa) return;

  // Заголовок + мета
  const fio = fullNameFrom(item);
  const when = item.createdAt || item.created_at || item.created || null;
  const whenStr = when ? formatDate(when) : '';
  title.textContent = `Заявка — ${fio}`;
  meta.textContent = whenStr ? `Дата подання: ${whenStr}` : '';

  // Q&A блок
  qa.innerHTML = '';

  const rows = [
    { q: 'Імʼя',                  a: (item.user?.firstName || item.firstName || '').trim() },
    { q: 'Прізвище',              a: (item.user?.lastName  || item.lastName  || '').trim() },
    { q: 'Дата подання заявки',   a: whenStr },
    { q: 'Скільки років у вас практики', a: item.experience || item.exp || '' },
    { q: 'До якої вікової категорії Ви відноситесь', a: item.ageGroup || item.age || '' },
    { q: 'Ваш запит до ментора',  a: item.requestText || item.request || '' },
    { q: 'Про себе / деталі ситуації', a: item.aboutText || item.about || '' },
  ];

  if (Array.isArray(item.answers)) {
    item.answers.forEach(x=>{
      rows.push({ q: x.question || 'Питання', a: x.answer || '' });
    });
  }

  rows
    .filter(r => (r.a && String(r.a).trim().length))
    .forEach(r => {
      const row = document.createElement('div');
      row.className = 'row';
      row.innerHTML = `
        &lt;div class="q"&gt;${esc(r.q)}&lt;/div&gt;
        &lt;div class="a"&gt;${esc(String(r.a))}&lt;/div&gt;
      `;
      qa.appendChild(row);
    });

  // показати
  modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function closeReqModal(){
  const { modal } = getReqEls();
  if (modal){
    modal.style.display = 'none';
    document.body.style.overflow = '';
  }
}

// убедимся, что события свяжутся после загрузки DOM (на случай, если клик произойдет очень рано)
document.addEventListener('DOMContentLoaded', bindReqModalEvents);
    </script>

    <script src="script.js"></script>

    <!-- MODAL: детали заявки -->
<div id="reqModal" class="req-modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="reqModalTitle">
  <div class="req-modal">
    <div class="req-close-x" id="reqCloseX">×</div>
    <h3 id="reqModalTitle">Заявка</h3>
    <div class="req-meta" id="reqMeta"></div>
    <div class="req-qa" id="reqQA"></div>
    <div class="req-actions">
      <button class="req-btn close" id="reqCloseBtn">Закрити</button>
      <!-- при необходимости добавь сюда primary-кнопку -->
    </div>
  </div>
</div>
  </body>
</html>
