<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Профіль</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>

    /* ===== Photo Cropper (FB-like) ===== */
.cropper-modal{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
}
.cropper-modal.show{ display:flex; }

.cropper-dialog{
  width: 420px;
  max-width: calc(100vw - 32px);
  background: #fff;
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,.35);
}
.cropper-dialog h3{
  margin: 0 0 12px;
  font-family: 'Poppins', sans-serif;
  font-weight: 600;
  font-size: 18px;
  color: #222;
  text-align: center;
}

#cropperCanvas{
  width: 100%;
  height: auto;
  display:block;
  background:#111;
  border-radius:12px;
}
.cropper-zoom{
  margin-top: 12px;
  display:flex;
  align-items:center;
  gap: 12px;
}
.cropper-zoom input[type="range"]{
  width: 100%;
}
.cropper-actions{
  margin-top: 14px;
  display:flex;
  justify-content: flex-end;
  gap: 8px;
}
.cropper-actions .btn{
  border:1px solid #D9D9D9;
  background:#fff;
  padding:8px 14px;
  border-radius:10px;
  font-family: 'Poppins', sans-serif;
  font-size:14px;
  cursor:pointer;
}
.cropper-actions .btn.primary{
  border-color:#275D2B;
  background:#275D2B;
  color:#fff;
}
    /* Make all profile textareas comfortably tall and readable by default */
    .textarea-wrapper { width: 100%; }
    .edit-textarea{
      width:100%;
      min-height:56px;             /* base height so text isn't squished */
      line-height:1.5;
      padding:12px 16px;
      border:1px solid #D9D9D9;
      border-radius:12px;
      box-sizing:border-box;
      background:#FFFFFF;
      white-space:pre-wrap;         /* keep line breaks */
      overflow:hidden;              /* allow JS autoResize to expand height */
      resize:none;                  /* user doesn't drag; it grows automatically */
      font-family: 'Poppins', sans-serif;
      font-size:14px;
      color:#222;
    }
    .edit-textarea.locked{
      background:#F5F6F7;           /* read-only look */
      color:#333;
    }
    /* Larger default for the courses block we already auto-fill */
    #profileCoursesTextarea{
      min-height:120px;
    }
    /* ===== Header (общий) ===== */
    .site-header {
      background-color: #275D2B;
      height: 80px;
      padding: 16px 20px;
      display: grid;
      grid-template-columns: 48px 1fr 64px; /* левый бургер / центр логотип / правый язык */
      align-items: center;
      column-gap: 12px;
    }
    .site-header .header-logo img {
      height: 40px;
      display: block;
      margin: 0 auto; /* центрируем логотип */
    }
    .burger,
    .lang-switch {
      background: transparent;
      border: 0;
      color: #fff;
      font: inherit;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 40px;
      padding: 0 8px;
      cursor: pointer;
    }
    .burger img { width: 24px; height: 24px; }
    .language-select { display: none !important; }

    /* ===== Базовое поведение сайдбара на десктопе (без изменений) ===== */
    @media (min-width: 481px) {
      .drawer-backdrop { display: none !important; }
    }

    /* ===== Мобайл: 376×812 спецификация ===== */
    @media (max-width: 480px) {
      /* высота навбара 64px */
      .site-header { height: 64px; padding: 8px 12px; }

      /* основной контент не сдвигаем влево на мобиле */
      #mainContent { padding-left: 0 !important; }

      /* off-canvas для существующего .sidebar */
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 376px;           /* по ТЗ */
        max-width: 100vw;       /* подстраховка */
        height: 100vh;
        transform: translateX(-100%);
        transition: transform .3s ease;
        z-index: 1001;          /* над всем */
        padding-top: 64px;      /* чтобы не попасть под header */
        background: #fff;       /* гарантируем фон */
      }

      /* убираем десктопные кнопки сайдбара */
      .sidebar .toggle-button { display: none !important; }

      /* когда меню открыто */
      .sidebar.open { transform: translateX(0); }

      /* затемнение фона */
      .drawer-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.45);
        opacity: 0;
        pointer-events: none;
        transition: opacity .2s ease;
        z-index: 1000; /* ниже сайдбара, но выше контента */
      }
      .drawer-backdrop.active {
        opacity: 1;
        pointer-events: auto;
      }

      /* Внутренние элементы сайдбара на мобиле на всю ширину */
      .sidebar nav a {
        padding: 12px 8px;
        gap: 12px;
        border-radius: 12px;
      }
      .sidebar.expanded,
      .sidebar.collapsed {
        width: 376px; /* на мобиле не коллапсим, всегда фулл */
        align-items: flex-start;
      }
      .sidebar.collapsed nav a span { display: inline-block; opacity: 1; max-width: none; }

      /* фиксируем лого сайдбара нормально */
      .sidebar .logo { margin-left: 8px; width: 160px; }
      .sidebar .logo-collapsed { display: none !important; }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="background-top"></div>
  <header class="site-header">
    <button class="burger" id="burgerBtn" aria-label="Open menu" aria-expanded="false" aria-controls="sidebar">
      <img src="assets/sidebar/burger.svg" alt="" />
    </button>

    <a href="/" class="header-logo" aria-label="Homepage">
      <img src="assets/emblem.svg" alt="Company" />
    </a>

    <button class="lang-switch" id="langBtn" aria-haspopup="listbox" aria-expanded="false">
      UA ▼
    </button>
  </header>
  <!-- Photo Cropper Modal -->
  <div id="photoCropperModal" class="cropper-modal" aria-hidden="true" role="dialog" aria-label="Редактор фото">
    <div class="cropper-dialog">
      <h3>Пересуньте та масштабуйте</h3>
      <canvas id="cropperCanvas" width="360" height="360"></canvas>
      <div class="cropper-zoom">
        <span>−</span>
        <input id="cropperZoom" type="range" min="0.5" max="3" step="0.01" value="1" />
        <span>+</span>
      </div>
      <div class="cropper-actions">
        <button class="btn" id="cropperCancel">Скасувати</button>
        <button class="btn primary" id="cropperSave">Зберегти</button>
      </div>
    </div>
  </div>
  <div class="drawer-backdrop" id="drawerBackdrop"></div>
  <aside class="sidebar collapsed" id="sidebar">
    <div class="toggle-button" onclick="toggleSidebar()">
      <img src="assets/sidebar/arrow.svg" alt="Toggle" id="toggleArrow" />
    </div>
    <img class="logo" src="assets/sidebar/IPS Logo (2).svg" alt="Logo" id="logoExpanded" />
    <img class="logo-collapsed" src="assets/sidebar/IPS Logo (1).svg" alt="Logo Small" id="logoCollapsed" />
    <img class="profile" src="assets/profile-photo.png" alt="User" width="40" height="40" />
    <nav>
      <a href="profile.html"><img src="assets/sidebar/profile.svg" /><span>Про Мене</span></a>
      <a href="mycertificates.html"><img src="assets/sidebar/news.svg" /><span>Мої Сертифікати</span></a>
      <a href="career-faq.html"><img src="assets/sidebar/10.svg" /><span>Планування Кар'єри</span></a>
      <a href="library.html"><img src="assets/sidebar/3.svg" /><span>Бібліотека</span></a>
      <a href="my-courses.html"><img src="assets/sidebar/5.svg" /><span>Мої Курси</span></a>
      <a href="practice-records.html"><img src="assets/practice-records.svg" /><span>Облік Практики</span></a>
      <a href="forum/index.html">
  <img src="assets/sidebar/forum.svg" alt="Форум"/>
  <span>Форум</span>
</a>
    </nav>
    <div class="logout">
      <img src="assets/sidebar/log-out.svg" alt="Logout Icon" width="20" height="20" />
      <span>Вийти з акаунту</span>
    </div>
  </aside>



  <main class="profile-background" id="mainContent">
    <section class="profile-hero">
      <h1 class="about-me-title">ABOUT ME</h1>
      <div class="progress-indicator">
        <span class="step active" onclick="showStep(1)">1</span>
        <div class="step-line"></div>
        <span class="step" onclick="showStep(2)">2</span>
        <div class="step-line"></div>
        <span class="step" onclick="showStep(3)">3</span>
      </div>
    </section>
    <!-- STEP 1 -->
  <section id="step1" class="profile-card-wrapper profile-step">
  <div class="profile-card">
    <div class="profile-info">
     <div class="field-block">

<div class="profile-row">
  <span class="profile-label">Username:</span>
  <div class="profile-value-wrapper">
    <span id="profileUsername" class="profile-value">test</span>
  </div>
</div>


<div class="profile-row">
  <span class="profile-label">Ім’я:</span>
  <div class="profile-value-wrapper">
    <span id="profileFirstName" class="profile-value">test</span>
    <img src="assets/edit-icon.svg" class="edit-icon" onclick="editField('profileFirstName')" />
  </div>
</div>


<div class="profile-row">
  <span class="profile-label">Прізвище:</span>
  <div class="profile-value-wrapper">
    <span id="profileLastName" class="profile-value">test</span>
    <img src="assets/edit-icon.svg" class="edit-icon" onclick="editField('profileLastName')" />
  </div>
</div>

<div class="profile-row">
  <span class="profile-label">По-батькові:</span>
  <div class="profile-value-wrapper">
    <span id="profileMiddleName" class="profile-value">test</span>
    <img src="assets/edit-icon.svg" class="edit-icon" onclick="editField('profileMiddleName')" />
  </div>
</div>

<div class="profile-row">
  <span class="profile-label">Email Address:</span>
  <div class="profile-value-wrapper">
    <span id="profileEmail" class="profile-value">test@example.com</span>
    <img src="assets/edit-icon.svg" class="edit-icon" onclick="editField('profileEmail')" />
  </div>
</div>

<div class="profile-row">
  <span class="profile-label">Номер телефону:</span>
  <div class="profile-value-wrapper">
    <span id="profilePhone" class="profile-value">+380123456789</span>
    <img src="assets/edit-icon.svg" class="edit-icon" onclick="editField('profilePhone')" />
  </div>
</div>

<div class="profile-row">
  <span class="profile-label">Стать:</span>
  <div class="profile-value-wrapper">
    <span id="profileGender" class="profile-value">test</span>
    <img src="assets/edit-icon.svg" class="edit-icon" onclick="editField('profileGender')" />
  </div>
</div>

      <p style="margin-top: 20px; opacity: 0.6;">
        Сукупний досвід клінічної роботи з клієнтами, пацієнтами, постраждалими (вкажіть кількість років, числом):
        <img src="assets/edit-icon.svg" class="edit-icon" onclick="enableEdit('profileExperience', 'experience')" />
      </p>
      <p><span id="profileExperience"></span></p>

      <p style="margin-top: 20px; opacity: 0.6;">
        Психологічна освіта. Психологічна освіта без підтвердження державною ліцензією. Назва закладу, місце розташування:
        <img src="assets/edit-icon.svg" class="edit-icon" onclick="enableEdit('profileEducation', 'education')" />
      </p>
      <p><span id="profileEducation"></span></p>

      <p style="margin-top: 20px; opacity: 0.6;">
  Ваш напрямок роботи:
  <img src="assets/edit-icon.svg" class="edit-icon" onclick="enableCheckboxEdit('profileDirections', 'directions', directionsOptions)" />
</p>
<p><span id="profileDirections"></span></p>

<div class="checkbox-group directions-group">
<p style="margin-top: 20px; opacity: 0.6;">
  З чим працюєте:
  <img src="assets/edit-icon.svg" class="edit-icon" onclick="enableCheckboxEdit('profileTopics', 'topics', topicsOptions)" />
</p>
</div>
<div class="checkbox-group topics-group">
<p><span id="profileTopics"></span></p>
</div>
    </div>
  </div>
</section>

<section id="step2" class="profile-card-wrapper profile-step" style="display: none;">
  <div class="profile-card">
    <div class="profile-step-two">

      <!-- Profile Image -->
      <div class="profile-photo-wrapper">
        <label for="upload-photo">
          <img id="profilePhoto" src="assets/profile-photo.png" alt="Profile" class="profile-photo" />
          <div class="photo-upload-icon">+</div>
        </label>
      <input type="file" id="upload-photo" accept="image/*" style="display: none" onchange="previewPhoto(event)" />
      </div>

      <!-- Editable Fields -->
     <p class="label-with-textarea">Про мене:</p>
<div class="textarea-wrapper">
  <textarea id="profileAboutTextarea" class="edit-textarea" placeholder="Введіть інформацію..."></textarea>
  <img src="assets/check-icon.svg" class="check-icon" id="aboutCheckIcon" style="display: none;" />
</div>


   <p class="label-with-textarea">Курси, які були пройдені в IPS:</p>
<div class="textarea-wrapper">
  <textarea id="profileCoursesTextarea"
            class="edit-textarea locked"
            placeholder="Введіть інформацію..."
            readonly
            aria-readonly="true"
            style="height:auto; min-height:120px; overflow:hidden; resize:none; line-height:1.5; white-space:pre-wrap; box-sizing:border-box; padding:12px 16px;"></textarea>
</div>

<!-- Роль (незмінне) -->
<p class="label-with-textarea">Роль в компанії:</p>
<div class="textarea-wrapper">
  <textarea id="profileRoleTextarea"
            class="edit-textarea locked"
            placeholder="Введіть інформацію..."
            readonly
            aria-readonly="true"></textarea>
</div>


     <p class="label-with-textarea">Вартість роботи:</p>
<div class="textarea-wrapper">
  <textarea id="profileCostTextarea" class="edit-textarea" placeholder="Введіть інформацію..."></textarea>
  <img src="assets/check-icon.svg" class="check-icon" id="costCheckIcon" style="display: none;" />
</div>

     <p class="label-with-textarea">Відеозвернення:</p>
<div class="textarea-wrapper">
  <textarea id="profileVideoTextarea" class="edit-textarea" placeholder="Введіть інформацію..."></textarea>
  <img src="assets/check-icon.svg" class="check-icon" id="videoCheckIcon" style="display: none;" />
</div>
 
     <p class="label-with-textarea">Кваліфікаційні курси:</p>
<div class="textarea-wrapper">
  <textarea id="profileQualificationsTextarea" class="edit-textarea" placeholder="Введіть інформацію..."></textarea>
  <img src="assets/check-icon.svg" class="check-icon" id="qualificationsCheckIcon" style="display: none;" />
</div>
      
     <p class="label-with-textarea">Інший релевантний досвід:</p>
<div class="textarea-wrapper">
  <textarea id="profileExperienceExtraTextarea" class="edit-textarea" placeholder="Введіть інформацію..."></textarea>
  <img src="assets/check-icon.svg" class="check-icon" id="experienceExtraCheckIcon" style="display: none;" />
</div>
      
     <p class="label-with-textarea">Мова надання сесії:</p>
<div class="textarea-wrapper">
  <textarea id="profileLanguageTextarea" class="edit-textarea" placeholder="Введіть інформацію..."></textarea>
  <img src="assets/check-icon.svg" class="check-icon" id="languageCheckIcon" style="display: none;" />
</div>

      
    <p class="label-with-textarea">Формат проведення:</p>
<div class="textarea-wrapper">
  <label>
    <input type="checkbox" id="formatOnline" /> Онлайн
  </label>
  <label>
    <input type="checkbox" id="formatOffline" onchange="toggleCityField()" /> Офлайн
  </label>
  <input type="text" id="offlineCity" placeholder="Місто проведення" style="display:none; margin-top:8px;" />
  <button type="button" id="saveFormatBtn" class="small-button" style="margin-top:8px;">Зберегти формат</button>
</div>

    </div>
  </div>
</section>


<!-- STEP 3 -->
<section id="step3" class="profile-card-wrapper profile-step" style="display: none;">
  <div class="profile-card">
    <div class="profile-step-three">

      <div class="profile-table-block">
        <div class="profile-table-header">
          <p class="profile-table-title">Ваша освіта і навчання з психології (в годинах):</p>
        </div>
        <table class="profile-table">
          <tr><td class="profile-table-label">Лекції</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileLectures" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileLectures', 'lectures')" /></div></td></tr>
          <tr><td class="profile-table-label">Семінари</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileSeminars" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileSeminars', 'seminars')" /></div></td></tr>
          <tr><td class="profile-table-label">Колоквіуми</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileColloquiums" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileColloquiums', 'colloquiums')" /></div></td></tr>
        </table>
      </div>

      <div class="profile-table-block">
        <div class="profile-table-header">
          <p class="profile-table-title">Ваша освіта і навчання з психології, яку ви мали переважно (в годинах):</p>
        </div>
        <table class="profile-table">
          <tr><td class="profile-table-label">Особистий досвід в групі</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileGroupExperience" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileGroupExperience', 'groupExperience')" /></div></td></tr>
          <tr><td class="profile-table-label">Особиста терапія</td><td class="profile-table-value"><div class="profile-value-box"><span id="profilePersonalTherapy" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profilePersonalTherapy', 'personalTherapy')" /></div></td></tr>
          <tr><td class="profile-table-label">Особистий психоаналіз</td><td class="profile-table-value"><div class="profile-value-box"><span id="profilePersonalAnalysis" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profilePersonalAnalysis', 'personalAnalysis')" /></div></td></tr>
          <tr><td class="profile-table-label">Індивідуальні супервізії</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileIndividualSupervision" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileIndividualSupervision', 'individualSupervision')" /></div></td></tr>
          <tr><td class="profile-table-label">Менторський супровід</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileMentoring" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileMentoring', 'mentoring')" /></div></td></tr>
          <tr><td class="profile-table-label">Групові супервізії</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileGroupSupervision" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileGroupSupervision', 'groupSupervision')" /></div></td></tr>
          <tr><td class="profile-table-label">Психоаналітична психодрама</td><td class="profile-table-value"><div class="profile-value-box"><span id="profilePsychoanalyticPsychodrama" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profilePsychoanalyticPsychodrama', 'psychoanalyticPsychodrama')" /></div></td></tr>
        </table>
      </div>

      <div class="profile-table-block">
        <div class="profile-table-header">
          <p class="profile-table-title">Чи маєте ви досвід викладання, проведення тренінгів, надання супервізій. Скільки годин:</p>
        </div>
        <table class="profile-table">
          <tr><td class="profile-table-label">Викладання в школі</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileTeachingSchool" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileTeachingSchool', 'teachingSchool')" /></div></td></tr>
          <tr><td class="profile-table-label">Викладання у виші</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileTeachingUniversity" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileTeachingUniversity', 'teachingUniversity')" /></div></td></tr>
          <tr><td class="profile-table-label">Інститути професійних асоціацій</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileProfessionalInstitutes" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileProfessionalInstitutes', 'professionalInstitutes')" /></div></td></tr>
          <tr><td class="profile-table-label">Суспільні об'єднання</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileCommunityOrganizations" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileCommunityOrganizations', 'communityOrganizations')" /></div></td></tr>
          <tr><td class="profile-table-label">Ведення терапевтичних груп</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileTherapyGroups" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileTherapyGroups', 'therapyGroups')" /></div></td></tr>
          <tr><td class="profile-table-label">Кризові групи</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileCrisisGroups" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileCrisisGroups', 'crisisGroups')" /></div></td></tr>
          <tr><td class="profile-table-label">Групи психоаналітичної психодрами</td><td class="profile-table-value"><div class="profile-value-box"><span id="profilePsychoanalyticDramaGroups" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profilePsychoanalyticDramaGroups', 'psychoanalyticDramaGroups')" /></div></td></tr>
        </table>
      </div>

      <div class="profile-table-block">
        <div class="profile-table-header">
          <p class="profile-table-title">Які терапевтичні підходи ви застосовуєте в своїй клінічній практиці наразі. Як довго?</p>
        </div>
        <table class="profile-table">
          <tr><td class="profile-table-label">Психоаналіз</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileCurrentPsychoanalysis" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileCurrentPsychoanalysis','currentPsychoanalysis')" /></div></td></tr>
          <tr><td class="profile-table-label">Групаналіз</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileCurrentGroupAnalysis" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileCurrentGroupAnalysis','currentGroupAnalysis')" /></div></td></tr>
          <tr><td class="profile-table-label">Індивідуальна психологія (Адлер)</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileCurrentAdler" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileCurrentAdler','currentAdler')" /></div></td></tr>
          <tr><td class="profile-table-label">Аналітична психологія (Юнг)</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileCurrentJung" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileCurrentJung','currentJung')" /></div></td></tr>
          <tr><td class="profile-table-label">Клієнт-центрованa терапія (К. Роджерс)</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileCurrentClientCentered" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileCurrentClientCentered','currentClientCentered')" /></div></td></tr>
          <tr><td class="profile-table-label">Логотерапія (В. Франкл)</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileCurrentLogotherapy" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileCurrentLogotherapy','currentLogotherapy')" /></div></td></tr>
          <tr><td class="profile-table-label">Психотерапія реципрокного гальмування</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileCurrentReciprocalInhibition" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileCurrentReciprocalInhibition','currentReciprocalInhibition')" /></div></td></tr>
          <tr><td class="profile-table-label">Групова психотерапія і психодрама</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileCurrentGroupPsychotherapy" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileCurrentGroupPsychotherapy','currentGroupPsychotherapy')" /></div></td></tr>
          <tr><td class="profile-table-label">Гештальт-терапія</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileCurrentGestalt" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileCurrentGestalt','currentGestalt')" /></div></td></tr>
          <tr><td class="profile-table-label">Когнітивно-поведінкова терапія</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileCurrentCBT" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileCurrentCBT','currentCBT')" /></div></td></tr>
          <tr><td class="profile-table-label">Інше</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileCurrentOther" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileCurrentOther','currentOther')" /></div></td></tr>
        </table>
      </div>

      <div class="profile-table-block">
        <div class="profile-table-header">
          <p class="profile-table-title">Які терапевтичні підходи ви застосовували раніше – в минулому. Як довго?</p>
        </div>
        <table class="profile-table">
          <tr><td class="profile-table-label">Психоаналіз</td><td class="profile-table-value"><div class="profile-value-box"><span id="profilePastPsychoanalysis" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profilePastPsychoanalysis','pastPsychoanalysis')" /></div></td></tr>
          <tr><td class="profile-table-label">Групаналіз</td><td class="profile-table-value"><div class="profile-value-box"><span id="profilePastGroupAnalysis" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profilePastGroupAnalysis','pastGroupAnalysis')" /></div></td></tr>
          <tr><td class="profile-table-label">Індивідуальна психологія (Адлер)</td><td class="profile-table-value"><div class="profile-value-box"><span id="profilePastAdler" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profilePastAdler','pastAdler')" /></div></td></tr>
          <tr><td class="profile-table-label">Аналітична психологія (Юнг)</td><td class="profile-table-value"><div class="profile-value-box"><span id="profilePastJung" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profilePastJung','pastJung')" /></div></td></tr>
          <tr><td class="profile-table-label">Клієнт-центрованa терапія (К. Роджерс)</td><td class="profile-table-value"><div class="profile-value-box"><span id="profilePastClientCentered" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profilePastClientCentered','pastClientCentered')" /></div></td></tr>
          <tr><td class="profile-table-label">Логотерапія (В. Франкл)</td><td class="profile-table-value"><div class="profile-value-box"><span id="profilePastLogotherapy" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profilePastLogotherapy','pastLogotherapy')" /></div></td></tr>
          <tr><td class="profile-table-label">Психотерапія реципрокного гальмування</td><td class="profile-table-value"><div class="profile-value-box"><span id="profilePastReciprocalInhibition" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profilePastReciprocalInhibition','pastReciprocalInhibition')" /></div></td></tr>
          <tr><td class="profile-table-label">Групова психотерапія і психодрама</td><td class="profile-table-value"><div class="profile-value-box"><span id="profilePastGroupPsychotherapy" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profilePastGroupPsychotherapy','pastGroupPsychotherapy')" /></div></td></tr>
          <tr><td class="profile-table-label">Гештальт-терапія</td><td class="profile-table-value"><div class="profile-value-box"><span id="profilePastGestalt" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profilePastGestalt','pastGestalt')" /></div></td></tr>
          <tr><td class="profile-table-label">Когнітивно-поведінкова терапія</td><td class="profile-table-value"><div class="profile-value-box"><span id="profilePastCBT" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profilePastCBT','pastCBT')" /></div></td></tr>
          <tr><td class="profile-table-label">Інше</td><td class="profile-table-value"><div class="profile-value-box"><span id="profilePastOther" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profilePastOther','pastOther')" /></div></td></tr>
        </table>
      </div>

      <div class="profile-table-block">
        <div class="profile-table-header">
          <p class="profile-table-title">Ваш досвід клінічної роботи в кризовому консультуванні. Скільки годин:</p>
        </div>
        <table class="profile-table">
          <tr><td class="profile-table-label">Індивідуальні консультації</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileCrisisIndividualConsultations" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileCrisisIndividualConsultations','crisisIndividualConsultations')" /></div></td></tr>
          <tr><td class="profile-table-label">Групова робота</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileCrisisGroupWork" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileCrisisGroupWork','crisisGroupWork')" /></div></td></tr>
          <tr><td class="profile-table-label">Кризова супервізія</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileCrisisSupervision" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileCrisisSupervision','crisisSupervision')" /></div></td></tr>
        </table>
      </div>

      <div class="profile-table-block">
        <div class="profile-table-header">
          <p class="profile-table-title">Ваша освіта і навчання з психології (в годинах):</p>
        </div>
        <table class="profile-table">
          <tr><td class="profile-table-label">Індивідуальні консультації</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileEducationIndividualConsultations" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileEducationIndividualConsultations','educationIndividualConsultations')" /></div></td></tr>
          <tr><td class="profile-table-label">Групова робота</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileEducationGroupWork" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileEducationGroupWork','educationGroupWork')" /></div></td></tr>
          <tr><td class="profile-table-label">Кризова супервізія</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileEducationCrisisSupervision" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileEducationCrisisSupervision','educationCrisisSupervision')" /></div></td></tr>
        </table>
      </div>

      <div class="profile-table-block">
        <div class="profile-table-header">
          <p class="profile-table-title">Ваш досвід клінічної роботи в кризовому консультуванні.</p>
        </div>
        <table class="profile-table">
          <tr><td class="profile-table-label">В державних чи армійських установах</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileCrisisWorkStateInstitutions" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileCrisisWorkStateInstitutions','crisisWorkStateInstitutions')" /></div></td></tr>
          <tr><td class="profile-table-label">В волонтерських проєктах</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileCrisisWorkVolunteering" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileCrisisWorkVolunteering','crisisWorkVolunteering')" /></div></td></tr>
          <tr><td class="profile-table-label">Приватно</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileCrisisWorkPrivate" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileCrisisWorkPrivate','crisisWorkPrivate')" /></div></td></tr>
        </table>
      </div>

      <div class="profile-table-block">
        <div class="profile-table-header">
          <p class="profile-table-title">Ваш досвід проведення супервізій. Скільки годин:</p>
        </div>
        <table class="profile-table">
          <tr><td class="profile-table-label">Індивідуальна супервізія ( психоаналіз)</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileSupervisionPsychoanalysis" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileSupervisionPsychoanalysis','supervisionPsychoanalysis')" /></div></td></tr>
          <tr><td class="profile-table-label">Індивідуальна супервізія (психотерапія)</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileSupervisionPsychotherapy" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileSupervisionPsychotherapy','supervisionPsychotherapy')" /></div></td></tr>
          <tr><td class="profile-table-label">Індивідуальна супервізія (клінічна психологія)</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileSupervisionClinicalPsychology" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileSupervisionClinicalPsychology','supervisionClinicalPsychology')" /></div></td></tr>
          <tr><td class="profile-table-label">Індивідуальна супервізія (кризова психологія)</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileSupervisionCrisisPsychology" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileSupervisionCrisisPsychology','supervisionCrisisPsychology')" /></div></td></tr>
          <tr><td class="profile-table-label">Індивідуальна супервізія (педагогіка)</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileSupervisionPedagogy" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileSupervisionPedagogy','supervisionPedagogy')" /></div></td></tr>
          <tr><td class="profile-table-label">Індивідуальна супервізія (коуч)</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileSupervisionCoach" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileSupervisionCoach','supervisionCoach')" /></div></td></tr>
          <tr><td class="profile-table-label">Індивідуальна супервізія (управленческая)</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileSupervisionManagement" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileSupervisionManagement','supervisionManagement')" /></div></td></tr>
          <tr><td class="profile-table-label">Індивідуальна супервізія (супервізії)</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileSupervisionSupervision" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileSupervisionSupervision','supervisionSupervision')" /></div></td></tr>
          <tr><td class="profile-table-label">Індивідуальна супервізія (пацієнтів, клієнтів, аналізантів)</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileSupervisionPatientsClientsAnalysands" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileSupervisionPatientsClientsAnalysands','supervisionPatientsClientsAnalysands')" /></div></td></tr>
          <tr><td class="profile-table-label">Групова супервізія</td><td class="profile-table-value"><div class="profile-value-box"><span id="profileSupervisionGroup" class="profile-table-text"></span><img src="assets/edit-icon.svg" class="edit-icon table-edit-icon" onclick="enableEdit('profileSupervisionGroup','supervisionGroup')" /></div></td></tr>
        </table>
      </div>

      <div class="profile-table-block">
        <div class="profile-table-header">
          <p class="profile-table-title">Як ви оцінюєте якість своєї роботи і її результатів в кризовому консультуванні (шкала від 1 до 5):</p>
        </div>
        <div class="rating-block">
          <div class="rating-row">
            <span class="rating-label">Оцінка з боку постраждалого або його близьких:</span>
            <div class="rating-circles" data-key="crisisRatingVictim" id="ratingVictim">
              <button type="button" class="rating-circle" data-value="1">1</button>
              <button type="button" class="rating-circle" data-value="2">2</button>
              <button type="button" class="rating-circle" data-value="3">3</button>
              <button type="button" class="rating-circle" data-value="4">4</button>
              <button type="button" class="rating-circle" data-value="5">5</button>
            </div>
          </div>
          <div class="rating-row">
            <span class="rating-label">Оцінка з боку супервізора:</span>
            <div class="rating-circles" data-key="crisisRatingSupervisor" id="ratingSupervisor">
              <button type="button" class="rating-circle" data-value="1">1</button>
              <button type="button" class="rating-circle" data-value="2">2</button>
              <button type="button" class="rating-circle" data-value="3">3</button>
              <button type="button" class="rating-circle" data-value="4">4</button>
              <button type="button" class="rating-circle" data-value="5">5</button>
            </div>
          </div>
          <div class="rating-row">
            <span class="rating-label">Ваша власна оцінка:</span>
            <div class="rating-circles" data-key="crisisRatingSelf" id="ratingSelf">
              <button type="button" class="rating-circle" data-value="1">1</button>
              <button type="button" class="rating-circle" data-value="2">2</button>
              <button type="button" class="rating-circle" data-value="3">3</button>
              <button type="button" class="rating-circle" data-value="4">4</button>
              <button type="button" class="rating-circle" data-value="5">5</button>
            </div>
          </div>
        </div>
      </div>

      <div class="profile-table-block">
        <div class="profile-table-header">
          <p class="profile-table-title">Чого потребує кризова допомога як вид професійного втручання і специфічний вид психологічної діяльності? Чим ви задоволені більше чи менше? Вільна відповідь.</p>
        </div>
        <div class="textarea-wrapper">
          <textarea id="profileCrisisHelpTextarea" class="edit-textarea" placeholder="Ваша відповідь..."></textarea>
        </div>
        <div class="save-btn-wrapper">
          <button type="button" id="saveCrisisHelpBtn" class="save-btn">Зберегти</button>
        </div>
      </div>

    </div>
  </div>
</section>
  </main>

  <script src="script.js"></script>
  <script>

  function resolvePhotoUrl(url) {
  if (!url) return '';
  try {
    if (/^https?:\/\//i.test(url)) return url;           // вже абсолютний
    if (/^\/\//.test(url)) return window.location.protocol + url; // //host/...
    const base = (typeof API_BASE !== 'undefined' ? API_BASE : '').replace(/\/+$/, '');
    const path = url.startsWith('/') ? url : '/' + url;
    return base + path;
  } catch { return url; }
}


function toggleCityField() {
  const offline = document.getElementById('formatOffline').checked;
  document.getElementById('offlineCity').style.display = offline ? 'block' : 'none';
}

function populateFormat(freshUser) {
  // витягуємо формат у вигляді масиву
  const raw = freshUser?.format;
  const arr = Array.isArray(raw)
    ? raw
    : (typeof raw === 'string' ? raw.split(',') : []);

  // нормалізуємо: обрізати пробіли, до нижнього регістру
  const norm = arr.map(s => String(s).trim().toLowerCase());

  // підтримуємо UA/EN варіанти
  const isOnline  = norm.includes('онлайн') || norm.includes('online');
  const isOffline = norm.includes('офлайн') || norm.includes('offline') || norm.includes('in-person');

  const onlineEl  = document.getElementById('formatOnline');
  const offlineEl = document.getElementById('formatOffline');
  const cityEl    = document.getElementById('offlineCity');

  if (onlineEl)  onlineEl.checked  = !!isOnline;
  if (offlineEl) offlineEl.checked = !!isOffline;

  if (cityEl) {
    if (isOffline) {
      cityEl.style.display = 'block';
      cityEl.value = freshUser.city || '';
    } else {
      cityEl.style.display = 'none';
      // cityEl.value = ''; // якщо треба ховати й чистити
    }
  }
}
    // Make autoResize available globally
    function autoResize(el) {
      if (!el) return;
      el.style.height = 'auto';
      el.style.height = el.scrollHeight + 'px';
    }

    // --- Inserted helpers for Step 2 population ---
    async function fetchFreshUser() {
      const rawUser = localStorage.getItem('user');
      if (!rawUser) return null;
      const user = JSON.parse(rawUser);
      try {
        const res = await fetch(`${API_BASE}/api/users/${user._id}`);
        if (!res.ok) throw new Error('Failed to load user');
        return await res.json();
      } catch (e) {
        console.error('fetchFreshUser error:', e);
        return null;
      }
    }

    function setIfExists(el, val) {
      if (!el) return;
      const value = (val === undefined || val === null) ? '' : (Array.isArray(val) ? val.join(', ') : String(val));
      el.value = value;
      autoResize(el);
    }

    // Step 2: helper for saving textareas and wiring up check icons
    function setupTextareaSave(textareaId, mongoKey, checkIconId){
      const textarea = document.getElementById(textareaId);
      const checkIcon = document.getElementById(checkIconId);
      if (!textarea || !checkIcon) return;

      // show the check icon when the user types
      textarea.addEventListener('input', () => {
        checkIcon.style.display = 'inline';
      });

      checkIcon.addEventListener('click', async () => {
        const rawUser = localStorage.getItem('user');
        if (!rawUser) { alert('Увійдіть у систему'); return; }
        const user = JSON.parse(rawUser);
        const payload = { [mongoKey]: (textarea.value || '').trim() };

        try {
          const res = await fetch(`${API_BASE}/api/users/${user._id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(payload)
          });
          const result = await res.json().catch(()=>({}));
          if (!res.ok) throw new Error(result.message || 'Помилка збереження');
          checkIcon.style.display = 'none';
          // optionally refresh local snapshot
          localStorage.setItem('user', JSON.stringify(result));
          alert('Збережено!');
        } catch(e){
          console.error(e);
          alert(e.message || 'Сталася помилка під час збереження');
        }
      });
    }

    async function populateStep2FromUser() {
      // Pull fresh user from API
      const freshUser = await fetchFreshUser();
      if (!freshUser) return;

      // Photo (if exists) — fixed ReferenceError (use freshUser)
      try {
        const photoEl = document.getElementById("profilePhoto");
        if (photoEl) {
          if (freshUser && freshUser.photoUrl) {
            const finalUrl = resolvePhotoUrl(freshUser.photoUrl) + `?v=${Date.now()}`; // cache-busting
            photoEl.src = finalUrl;
            photoEl.onerror = () => { photoEl.src = 'assets/profile-photo.png'; };
          } else {
            photoEl.src = 'assets/profile-photo.png';
          }
        }
      } catch (e) {
        console.error('Photo render error:', e);
      }

      // Step 2 textareas
      setIfExists(document.getElementById('profileAboutTextarea'), freshUser.about);
      // Courses textarea is filled by populateCompletedCoursesTextarea(), skip direct set
      setIfExists(document.getElementById('profileRoleTextarea'), (freshUser.roles && freshUser.roles.length ? freshUser.roles.join(', ') : freshUser.role));
      setIfExists(document.getElementById('profileCostTextarea'), freshUser.cost);
      setIfExists(document.getElementById('profileVideoTextarea'), freshUser.videoLink);
      setIfExists(document.getElementById('profileQualificationsTextarea'), freshUser.qualifications);
      setIfExists(document.getElementById('profileExperienceExtraTextarea'), freshUser.experienceExtra);
      setIfExists(document.getElementById('profileLanguageTextarea'), freshUser.language);
      // Removed setIfExists for profileFormatTextarea (no such element)

      // Apply format (checkboxes + city) from user
      populateFormat(freshUser);

      // Optional: fill step 1 spans if they are empty (defensive)
      const fillSpan = (id, val) => {
        const el = document.getElementById(id);
        if (el && (!el.textContent || el.textContent === 'test' || el.textContent === '')) {
          el.textContent = (val === undefined || val === null) ? '' : String(val);
        }
      };
      fillSpan('profileUsername', freshUser.username);
      fillSpan('profileFirstName', freshUser.firstName);
      fillSpan('profileLastName', freshUser.lastName);
      fillSpan('profileMiddleName', freshUser.middleName);
      fillSpan('profileEmail', freshUser.email);
      fillSpan('profilePhone', freshUser.phone);
      fillSpan('profileGender', freshUser.gender);
      fillSpan('profileExperience', freshUser.experience);
      fillSpan('profileEducation', freshUser.education);

      // Directions & topics (arrays) to spans if present
      const dirSpan = document.getElementById('profileDirections');
      if (dirSpan && Array.isArray(freshUser.directions)) dirSpan.textContent = freshUser.directions.join(', ');
      const topicsSpan = document.getElementById('profileTopics');
      if (topicsSpan && Array.isArray(freshUser.topics)) topicsSpan.textContent = freshUser.topics.join(', ');
    }

    async function populateCompletedCoursesTextarea() {
      const coursesField = document.getElementById('profileCoursesTextarea');
      if (!coursesField) return;
      // lock field
      coursesField.readOnly = true;
      coursesField.setAttribute('aria-readonly', 'true');
      coursesField.classList.add('locked');

      const rawUser = localStorage.getItem('user');
      if (!rawUser) {
        coursesField.value = 'Будь ласка, увійдіть до акаунту.';
        autoResize(coursesField);
        return;
      }
      const user = JSON.parse(rawUser);
      // ensure initial sizing
      setTimeout(() => autoResize(coursesField), 0);

      try {
        const [resUser, resCourses] = await Promise.all([
          fetch(`${API_BASE}/api/users/${user._id}`),
          fetch(`${API_BASE}/api/courses`)
        ]);
        const freshUser = await resUser.json();
        const allCourses = await resCourses.json();

        const completedCourses = allCourses.filter(c => {
          if (c.status !== 'Пройдений') return false;
          const isOpen = c.accessType === 'Відкрита група';
          const isParticipant = Array.isArray(c.participants) && c.participants.includes(user._id);
          return isOpen || isParticipant;
        });

        const titles = completedCourses.map(c => c.courseTitle).filter(Boolean);
        coursesField.value = titles.length ? titles.join('\n') : 'Наразі немає пройдених курсів';
        autoResize(coursesField);
      } catch (e) {
        console.error('Помилка завантаження списку пройдених курсів:', e);
        coursesField.value = 'Не вдалося завантажити список пройдених курсів.';
        autoResize(coursesField);
      }
    }

    // Initial load
    document.addEventListener('DOMContentLoaded', populateCompletedCoursesTextarea);
    document.addEventListener('DOMContentLoaded', populateStep2FromUser);
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.edit-textarea').forEach(t => {
        // initial sizing (in case some values are pre-rendered)
        setTimeout(() => autoResize(t), 0);
        // keep growing while user types
        t.addEventListener('input', () => autoResize(t));
      });
    });
    // When coming back via browser back/forward cache
    window.addEventListener('pageshow', (ev) => {
      // run on normal navigation and on bfcache restore
      if (ev.persisted || document.visibilityState === 'visible') {
        populateCompletedCoursesTextarea();
        populateStep2FromUser();
      }
    });
    // Keep height in sync on viewport changes
    window.addEventListener('resize', () => autoResize(document.getElementById('profileCoursesTextarea')));


    // Save format (Онлайн/Офлайн) + city to backend
    async function saveFormatSection() {
      try {
        const rawUser = localStorage.getItem('user');
        if (!rawUser) return alert('Увійдіть у систему');
        const user = JSON.parse(rawUser);

        const payload = { format: [], city: '' };

        const online = document.getElementById('formatOnline')?.checked;
        const offline = document.getElementById('formatOffline')?.checked;
        const city = (document.getElementById('offlineCity')?.value || '').trim();

        if (online)  payload.format.push('Онлайн');
        if (offline) payload.format.push('Офлайн');
        if (offline) payload.city = city; // only save city when offline selected

        const res = await fetch(`${typeof API_BASE !== 'undefined' ? API_BASE : ''}/api/users/${user._id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.message || 'Помилка збереження');
        }

        const updated = await res.json();
        // Update localStorage snapshot to keep UI consistent
        localStorage.setItem('user', JSON.stringify(updated));
        populateFormat(updated);
        alert('Збережено');
      } catch(e) {
        console.error(e);
        alert(e.message || 'Сталася помилка під час збереження');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const onlineCb  = document.getElementById('formatOnline');
      const offlineCb = document.getElementById('formatOffline');
      const cityInput = document.getElementById('offlineCity');
      const saveBtn   = document.getElementById('saveFormatBtn');

      if (onlineCb)  onlineCb.addEventListener('change', () => { toggleCityField(); });
      if (offlineCb) offlineCb.addEventListener('change', () => { toggleCityField(); });
      // no auto-save on input/change
      if (saveBtn)   saveBtn.addEventListener('click', saveFormatSection);
    });

    // Step 2: wire up textarea saves after DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      setupTextareaSave('profileAboutTextarea', 'about', 'aboutCheckIcon');
      setupTextareaSave('profileCostTextarea', 'cost', 'costCheckIcon');
      setupTextareaSave('profileVideoTextarea', 'videoLink', 'videoCheckIcon');
      setupTextareaSave('profileQualificationsTextarea', 'qualifications', 'qualificationsCheckIcon');
      setupTextareaSave('profileExperienceExtraTextarea', 'experienceExtra', 'experienceExtraCheckIcon');
      setupTextareaSave('profileLanguageTextarea', 'language', 'languageCheckIcon');
    });
    // Override previewPhoto to guarantee preview + upload + final URL from backend
window.previewPhoto = function (event) {
  const file = event?.target?.files?.[0];
  if (!file) return;
  openPhotoCropper(file);
};
</script>

</div>
<script>
(function(){
  const modal = document.getElementById('photoCropperModal');
  const canvas = document.getElementById('cropperCanvas');
  const zoom = document.getElementById('cropperZoom');
  const btnSave = document.getElementById('cropperSave');
  const btnCancel = document.getElementById('cropperCancel');
  if (!modal || !canvas || !zoom || !btnSave || !btnCancel) {
    console.warn('[cropper] Required DOM elements not found. Modal markup missing?');
    return;
  }
  const ctx = canvas.getContext('2d');

  const PREVIEW_W = canvas.width;
  const PREVIEW_H = canvas.height;
  const CIRCLE_R = Math.floor(Math.min(PREVIEW_W, PREVIEW_H) * 0.45);
  const CIRCLE_CX = Math.floor(PREVIEW_W / 2);
  const CIRCLE_CY = Math.floor(PREVIEW_H / 2);

  let img = null;
  let imgW = 0, imgH = 0;
  let scale = 1;
  let offsetX = 0, offsetY = 0;
  let dragging = false;
  let dragStartX = 0, dragStartY = 0;
  let originalFile = null;

  function showModal(){ modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); }
  function hideModal(){ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }

  function draw(){
    ctx.clearRect(0,0,PREVIEW_W,PREVIEW_H);
    ctx.fillStyle = '#111';
    ctx.fillRect(0,0,PREVIEW_W,PREVIEW_H);

    if (img) {
      ctx.save();
      ctx.setTransform(scale, 0, 0, scale, offsetX, offsetY);
      ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(img, 0, 0);
      ctx.restore();
    }

    ctx.fillStyle = 'rgba(0,0,0,.55)';
    ctx.fillRect(0,0,PREVIEW_W,PREVIEW_H);

    ctx.save();
    ctx.globalCompositeOperation = 'destination-out';
    ctx.beginPath();
    ctx.arc(CIRCLE_CX, CIRCLE_CY, CIRCLE_R, 0, Math.PI*2);
    ctx.closePath();
    ctx.fill();
    ctx.restore();

    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(CIRCLE_CX, CIRCLE_CY, CIRCLE_R, 0, Math.PI*2);
    ctx.closePath();
    ctx.stroke();
  }

  function fitImageInitially(){
    const scaleX = (CIRCLE_R*2) / imgW;
    const scaleY = (CIRCLE_R*2) / imgH;
    scale = Math.max(scaleX, scaleY);
    zoom.value = String(scale.toFixed(2));
    const imgCanvasW = imgW * scale;
    const imgCanvasH = imgH * scale;
    offsetX = CIRCLE_CX - imgCanvasW / 2;
    offsetY = CIRCLE_CY - imgCanvasH / 2;
  }

  function clampOffset(){
    const minX = CIRCLE_CX - (imgW*scale - (CIRCLE_R));
    const maxX = CIRCLE_CX - (CIRCLE_R);
    const minY = CIRCLE_CY - (imgH*scale - (CIRCLE_R));
    const maxY = CIRCLE_CY - (CIRCLE_R);

    if (imgW*scale <= CIRCLE_R*2){
      offsetX = CIRCLE_CX - (imgW*scale)/2;
    } else {
      if (offsetX < minX) offsetX = minX;
      if (offsetX > maxX) offsetX = maxX;
    }
    if (imgH*scale <= CIRCLE_R*2){
      offsetY = CIRCLE_CY - (imgH*scale)/2;
    } else {
      if (offsetY < minY) offsetY = minY;
      if (offsetY > maxY) offsetY = maxY;
    }
  }

  function onPointerDown(e){
    dragging = true;
    const rect = canvas.getBoundingClientRect();
    const pt = e.touches ? e.touches[0] : e;
    dragStartX = pt.clientX - rect.left;
    dragStartY = pt.clientY - rect.top;
  }
  function onPointerMove(e){
    if (!dragging) return;
    const rect = canvas.getBoundingClientRect();
    const pt = e.touches ? e.touches[0] : e;
    const x = pt.clientX - rect.left;
    const y = pt.clientY - rect.top;
    const dx = x - dragStartX;
    const dy = y - dragStartY;
    dragStartX = x;
    dragStartY = y;
    offsetX += dx;
    offsetY += dy;
    clampOffset();
    draw();
  }
  function onPointerUp(){ dragging = false; }

  function onWheel(e){
    e.preventDefault();
    const delta = -e.deltaY;
    const factor = delta > 0 ? 1.05 : 0.95;

    const imgXBefore = (CIRCLE_CX - offsetX)/scale;
    const imgYBefore = (CIRCLE_CY - offsetY)/scale;

    scale = Math.min(3, Math.max(0.5, scale * factor));
    zoom.value = String(scale.toFixed(2));

    const imgXAfter = (CIRCLE_CX - offsetX)/scale;
    const imgYAfter = (CIRCLE_CY - offsetY)/scale;
    offsetX += (imgXAfter - imgXBefore)*scale;
    offsetY += (imgYAfter - imgYBefore)*scale;

    clampOffset();
    draw();
  }

  zoom.addEventListener('input', () => {
    const newScale = parseFloat(zoom.value);
    if (!isFinite(newScale)) return;
    const imgXBefore = (CIRCLE_CX - offsetX)/scale;
    const imgYBefore = (CIRCLE_CY - offsetY)/scale;
    scale = Math.min(3, Math.max(0.5, newScale));
    const imgXAfter = (CIRCLE_CX - offsetX)/scale;
    const imgYAfter = (CIRCLE_CY - offsetY)/scale;
    offsetX += (imgXAfter - imgXBefore)*scale;
    offsetY += (imgYAfter - imgYBefore)*scale;
    clampOffset();
    draw();
  });

  canvas.addEventListener('mousedown', onPointerDown);
  canvas.addEventListener('mousemove', onPointerMove);
  window.addEventListener('mouseup', onPointerUp);
  canvas.addEventListener('touchstart', onPointerDown, {passive:false});
  canvas.addEventListener('touchmove', onPointerMove, {passive:false});
  window.addEventListener('touchend', onPointerUp);
  canvas.addEventListener('wheel', onWheel, { passive:false });

  async function exportCroppedAndUpload(){
    if (!img) return;
    const OUT = 512;
    const out = document.createElement('canvas');
    out.width = OUT; out.height = OUT;
    const octx = out.getContext('2d');

    const Rp = CIRCLE_R;
    const Ro = OUT/2;

    const imgCx = (CIRCLE_CX - offsetX)/scale;
    const imgCy = (CIRCLE_CY - offsetY)/scale;

    const scaleOut = scale * (Ro / Rp);

    octx.clearRect(0,0,OUT,OUT);
    octx.save();
    octx.beginPath();
    octx.arc(Ro, Ro, Ro, 0, Math.PI*2);
    octx.closePath();
    octx.clip();

    octx.setTransform(scaleOut, 0, 0, scaleOut, Ro - imgCx*scaleOut, Ro - imgCy*scaleOut);
    octx.imageSmoothingQuality = 'high';
    octx.drawImage(img, 0, 0);
    octx.restore();

    const blob = await new Promise(res => out.toBlob(res, 'image/png', 0.92));
    const file = new File([blob], (originalFile?.name || 'avatar') + '.png', { type: 'image/png' });

    try{
      const url = URL.createObjectURL(blob);
      const imgEl = document.getElementById('profilePhoto');
      if (imgEl) imgEl.src = url;
      if (typeof uploadProfilePhoto === 'function'){
        await uploadProfilePhoto(file);
      }
    } finally {
      hideModal();
    }
  }

  // Public entry
  window.openPhotoCropper = function(file){
    originalFile = file;
    const reader = new FileReader();
    reader.onload = function(){
      img = new Image();
      img.onload = function(){
        imgW = img.width; imgH = img.height;
        fitImageInitially();
        clampOffset();
        draw();
        showModal();
      };
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  };

  btnCancel.addEventListener('click', hideModal);
  btnSave.addEventListener('click', exportCroppedAndUpload);
})();
</script>
</body>
</html>
