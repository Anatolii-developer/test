<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏ –º–æ—ó—Ö –∫—É—Ä—Å—ñ–≤</title>
    <link rel="stylesheet" href="styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Section (folder) dropdowns */
      .section {
        margin: 12px 0 16px;
        border-radius: 12px;
        background: #ffeed9;
        padding: 0;
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.06);
      }
      .section summary {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        list-style: none;
        padding: 14px 16px;
        font-weight: 600;
        user-select: none;
      }
      .section[open] summary {
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      }
      .section summary::-webkit-details-marker {
        display: none;
      }
      .materials {
        padding: 12px 16px;
        display: grid;
        gap: 12px;
      }
      .material-row {
        display: grid;
        gap: 8px;
        background: #fff;
        border-radius: 10px;
        padding: 12px;
        border: 1px solid #eee;
      }
      .row-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .material-title {
        font-weight: 600;
      }
      .material-desc {
        opacity: 0.8;
        font-size: 14px;
        line-height: 1.45;
      }
      .view-btn {
        padding: 8px 14px;
        border-radius: 8px;
        border: 1px solid #d97a1c;
        background: transparent;
        color: #d97a1c;
        cursor: pointer;
      }
      .preview {
        margin-top: 10px;
        display: none;
      }
      .preview.active {
        display: block;
      }
      .preview iframe,
      .preview embed {
        width: 100%;
        height: 420px;
        border: 0;
        border-radius: 10px;
        background: #fff;
      }
      .empty-note {
        opacity: 0.7;
        padding: 8px 0;
      }

      /* Buckets (–ü–æ—Ç–æ—á–Ω—ñ / –ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω—ñ / –ü—Ä–æ–π–¥–µ–Ω—ñ) */
      .bucket { margin: 28px 0; }
      .bucket-title { font-weight: 700; font-size: 20px; margin: 8px 0 14px; }

      /* ===== Header (global) ===== */
      .site-header {
        background-color: #275D2B;
        height: 80px;
        padding: 16px 20px;
        display: grid;
        grid-template-columns: 48px 1fr 64px; /* burger / center logo / language */
        align-items: center;
        column-gap: 12px;
      }
      .site-header .header-logo img {
        height: 40px;
        display: block;
        margin: 0 auto;
      }
      .burger,
      .lang-switch {
        background: transparent;
        border: 0;
        color: #fff;
        font: inherit;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        height: 40px;
        padding: 0 8px;
        cursor: pointer;
      }
      .burger img { width: 24px; height: 24px; }
      .language-select { display: none !important; }

      /* Desktop: keep backdrop hidden */
      @media (min-width: 481px) {
        .drawer-backdrop { display: none !important; }
      }

      /* ===== Mobile 376√ó812 behavior ===== */
      @media (max-width: 480px) {
        .site-header { height: 64px; padding: 8px 12px; }
        /* content should not be shifted left on mobile */
        #mainContent { padding-left: 0 !important; }

        /* Off-canvas sidebar */
        .sidebar {
          position: fixed;
          top: 0;
          left: 0;
          width: 376px;
          max-width: 100vw;
          height: 100vh;
          transform: translateX(-100%);
          transition: transform .3s ease;
          z-index: 1001;
          padding-top: 64px; /* keep clear under header */
          background: #fff;
        }
        /* hide desktop toggle button in sidebar */
        .sidebar .toggle-button { display: none !important; }
        /* when menu is open */
        .sidebar.open { transform: translateX(0); }

        /* Backdrop */
        .drawer-backdrop {
          position: fixed;
          inset: 0;
          background: rgba(0,0,0,.45);
          opacity: 0;
          pointer-events: none;
          transition: opacity .2s ease;
          z-index: 1000;
        }
        .drawer-backdrop.active {
          opacity: 1;
          pointer-events: auto;
        }

        /* Full-width sidebar internals */
        .sidebar nav a {
          padding: 12px 8px;
          gap: 12px;
          border-radius: 12px;
        }
        .sidebar.expanded,
        .sidebar.collapsed {
          width: 376px; /* always full on mobile */
          align-items: flex-start;
        }
        .sidebar.collapsed nav a span { display: inline-block; opacity: 1; max-width: none; }
        .sidebar .logo { margin-left: 8px; width: 160px; }
        .sidebar .logo-collapsed { display: none !important; }
      }
    </style>
  </head>
  <body>
  <header class="site-header">
    <button class="burger" id="burgerBtn" aria-label="Open menu" aria-expanded="false" aria-controls="sidebar">
      <img src="assets/sidebar/burger.svg" alt="" />
    </button>

    <a href="/" class="header-logo" aria-label="Homepage">
      <img src="assets/emblem.svg" alt="Company" />
    </a>

    <button class="lang-switch" id="langBtn" aria-haspopup="listbox" aria-expanded="false">
      UA ‚ñº
    </button>
  </header>
  <div class="drawer-backdrop" id="drawerBackdrop"></div>
    <aside class="sidebar collapsed" id="sidebar">
      <div class="toggle-button" onclick="toggleSidebar()">
        <img src="assets/sidebar/arrow.svg" alt="Toggle" id="toggleArrow" />
      </div>
      <img
        class="logo"
        src="assets/sidebar/IPS Logo (2).svg"
        alt="Logo"
        id="logoExpanded"
      />
      <img
        class="logo-collapsed"
        src="assets/sidebar/IPS Logo (1).svg"
        alt="Logo Small"
        id="logoCollapsed"
      />
      <img
        class="profile"
        src="assets/profile-photo.png"
        alt="User"
        width="40"
        height="40"
      />
      <nav>
        <a href="profile.html"
          ><img src="assets/sidebar/profile.svg" /><span>–ü—Ä–æ –ú–µ–Ω–µ</span></a
        >
        <a href="mycertificates.html"
          ><img src="assets/sidebar/news.svg" /><span>–ú–æ—ó –°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏</span></a
        >
        <a href="career-faq.html"
          ><img src="assets/sidebar/10.svg" /><span>–ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è –ö–∞—Ä'—î—Ä–∏</span></a
        >
        <a href="library.html"
          ><img src="assets/sidebar/3.svg" /><span>–ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞</span></a
        >
        <a href="my-courses.html"
          ><img src="assets/sidebar/5.svg" /><span>–ú–æ—ó –ö—É—Ä—Å–∏</span></a
        >
         <a href="forum/index.html">
  <img src="assets/sidebar/forum.svg" alt="–§–æ—Ä—É–º"/>
  <span>–§–æ—Ä—É–º</span>
</a>
      </nav>
      <div class="logout">
        <img
          src="assets/sidebar/log-out.svg"
          alt="Logout Icon"
          width="20"
          height="20"
        />
        <span>–í–∏–π—Ç–∏ –∑ –∞–∫–∞—É–Ω—Ç—É</span>
      </div>
    </aside>

    <main id="mainContent">
      <div class="main-header">
        <h2>–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏ –º–æ—ó—Ö –∫—É—Ä—Å—ñ–≤</h2>
        <img src="assets/library/courses.png" alt="Courses Image" />
      </div>

      <div class="nav-buttons">
        <a href="library.html"
          ><button class="nav-button">
            <img src="assets/library/arrow-main.svg" alt="Back" />–ì–æ–ª–æ–≤–Ω–∞
          </button></a
        >
        <a href="main-library.html"
          ><button class="nav-button secondary">–ó–∞–≥–∞–ª—å–Ω—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏</button></a
        >
        <a href="addons-library.html"
          ><button class="nav-button secondary">–î–æ–¥–∞—Ç–∫–æ–≤—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏</button></a
        >
      </div>

      <section class="materials-library-content">
        <div class="date-section">
          <label class="date-label">Publishing Date (DD/MM/YYYY)</label>
          <div class="date-inputs">
            <input type="date" class="date-input" id="dateFrom" />
            <input type="date" class="date-input" id="dateTo" />
          </div>
          <div class="filter-btn-wrapper">
            <button class="filter-btn" id="btnFilter">–§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏</button>
          </div>
        </div>

        <div class="course-list" id="courseList">
          <div class="empty-note">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>
        </div>
      </section>
    </main>
  <script>
  window.API_BASE = "https://cabinet.mamko-prof-supervision.com";
</script>
    <script src="script.js"></script>
    <script>

function getYouTubeEmbedUrl(link){
  const m = String(link||"").match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/))([\w-]{11})/);
  return m ? `https://www.youtube.com/embed/${m[1]}` : "";
}
const esc = s => String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
const cssSafe = s => String(s||"").replace(/[^a-z0-9_-]+/gi,"-");
const parseISO = v => { const d = v?new Date(v):null; return isNaN(d?.getTime?.())?null:d; };

function getMe(){
  // –æ—á—ñ–∫—É—î–º–æ –∑ localStorage (—è–∫ —É –∞–¥–º—ñ–Ω—Ü—ñ)
  try { return JSON.parse(localStorage.getItem("user")||"null"); } catch(_){ return null; }
}

async function loadCourseMaterials(){
  const list = document.getElementById("courseList");
  list.innerHTML = '<div class="empty-note">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>';

  // Read date filters
  const dFromVal = document.getElementById('dateFrom').value;
  const dToVal   = document.getElementById('dateTo').value;
  const dateFrom = dFromVal ? new Date(dFromVal + "T00:00:00") : null;
  const dateTo   = dToVal ? new Date(dToVal + "T23:59:59") : null;

  // Current user (for filtering by my courses)
  const me = getMe();
  const myId = me?._id || me?.id || null;

  // Helper: normalize bucket name from course.status
  const statusToBucket = (status) => {
    const s = String(status || '').toLowerCase();
    if (s.includes('–∑–∞–ø–ª–∞–Ω')) return '–ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω—ñ';
    if (s.includes('–ø—Ä–æ–π–¥–µ–Ω')) return '–ü—Ä–æ–π–¥–µ–Ω—ñ';
    return '–ü–æ—Ç–æ—á–Ω—ñ';
  };

  try {
    // Fetch library items and all courses in parallel
    const [libRes, coursesRes] = await Promise.all([
      fetch(`${API_BASE}/api/library?destination=courses`),
      fetch(`${API_BASE}/api/courses`)
    ]);

    const libAll = (await libRes.json()) || [];
    const courses = (await coursesRes.json()) || [];

    // Map courses by id + compute the set of "my" courses
    const courseMap = new Map();
    let myCourseIds = new Set();
    for (const c of courses){
      const id = String(c._id || c.id || '');
      if (!id) continue;
      courseMap.set(id, c);
      const participants = Array.isArray(c.participants) ? c.participants.map(String) : [];
      if (!myId || participants.includes(String(myId))) {
        myCourseIds.add(id);
      }
    }
    // If we couldn't resolve any course as "mine" (e.g., no user), don't restrict
    if (!myId) myCourseIds = null;

    // Filter by date and (optionally) by my courses
    const filtered = libAll.filter(it => {
      const dt = parseISO(it.date || it.createdAt);
      if (dateFrom && dt && dt < dateFrom) return false;
      if (dateTo && dt && dt > dateTo) return false;
      if (myCourseIds && it.courseId && !myCourseIds.has(String(it.courseId))) return false;
      return true;
    });

    if (!filtered.length){
      list.innerHTML = '<p>–ù–∞—Ä–∞–∑—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ.</p>';
      return;
    }

    // Group materials by courseId
    const byCourse = new Map();
    for (const it of filtered){
      const key = String(it.courseId || '_no_course_');
      if (!byCourse.has(key)) byCourse.set(key, []);
      byCourse.get(key).push(it);
    }

    // Build buckets: –ü–æ—Ç–æ—á–Ω—ñ / –ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω—ñ / –ü—Ä–æ–π–¥–µ–Ω—ñ
    const buckets = { '–ü–æ—Ç–æ—á–Ω—ñ': [], '–ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω—ñ': [], '–ü—Ä–æ–π–¥–µ–Ω—ñ': [] };

    // For each course, collect meta + latest material date, then push to bucket
    for (const [cid, items] of byCourse.entries()){
      const meta = courseMap.get(String(cid)) || {};
      // Latest material date for sorting recency
      const latest = items.reduce((acc, it) => {
        const d = parseISO(it.date || it.createdAt) || 0;
        return d && (!acc || d > acc) ? d : acc;
      }, null) || 0;

      const payload = { courseId: cid, meta, items, latest };
      const b = statusToBucket(meta.status);
      (buckets[b] ||= []).push(payload);
    }

    // Sort each bucket by recency (latest first)
    for (const k of Object.keys(buckets)){
      buckets[k].sort((a,b) => (b.latest || 0) - (a.latest || 0));
    }

    // Render
    list.innerHTML = '';

    const renderCourseBlock = (co) => {
      const m = co.meta || {};
      const title = m.courseTitle || '–ö—É—Ä—Å';
      const descr = m.courseSubtitle || m.courseDescription || '–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏ –∫—É—Ä—Å—É';

      const wrap = document.createElement('div');
      wrap.className = 'course-item';
      wrap.innerHTML = `
        <h4 class="course-title">${esc(title)}</h4>
        <p class="course-description">${esc(descr)}</p>
      `;

      // Group by folder
      const byFolder = new Map();
      for (const it of co.items){
        const folder = (it.folder && String(it.folder).trim()) || '–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏';
        if (!byFolder.has(folder)) byFolder.set(folder, []);
        byFolder.get(folder).push(it);
      }

      for (const [folderName, sItems] of byFolder.entries()){
        const details = document.createElement('details');
        details.className = 'section';
        details.innerHTML = `
          <summary class="section-summary">üìÅ ${esc(folderName)}</summary>
          <div class="materials"></div>
        `;
        const matWrap = details.querySelector('.materials');

        sItems.forEach((mat, idx) => {
          const row = document.createElement('div');
          row.className = 'material-row';
          const t = mat.itemTitle || mat.title || (mat.type === 'video' ? '–í—ñ–¥–µ–æ' : '–§–∞–π–ª');
          const d = mat.description || '';
          const prevId = `prev-${co.courseId}-${cssSafe(folderName)}-${idx}`;

          row.innerHTML = `
            <div class="row-head">
              <div>
                <div class="material-title">${esc(t)}</div>
                ${d ? `<div class="material-desc">${esc(d)}</div>` : ''}
              </div>
              <button class="view-btn" type="button" data-target="${prevId}">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏</button>
            </div>
            <div class="preview" id="${prevId}"></div>
          `;

          row.querySelector('.view-btn').addEventListener('click', () => {
            renderPreview(document.getElementById(prevId), mat);
          });

          matWrap.appendChild(row);
        });

        wrap.appendChild(details);
      }

      return wrap;
    };

    const order = ['–ü–æ—Ç–æ—á–Ω—ñ', '–ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω—ñ', '–ü—Ä–æ–π–¥–µ–Ω—ñ'];
    let renderedAny = false;
    for (const bucketName of order){
      const arr = buckets[bucketName] || [];
      if (!arr.length) continue;
      renderedAny = true;

      const bucketEl = document.createElement('div');
      bucketEl.className = 'bucket';
      const h = document.createElement('h3');
      h.className = 'bucket-title';
      h.textContent = bucketName;
      bucketEl.appendChild(h);

      arr.forEach(co => bucketEl.appendChild(renderCourseBlock(co)));
      list.appendChild(bucketEl);
    }

    if (!renderedAny){
      list.innerHTML = '<p>–ù–∞—Ä–∞–∑—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ.</p>';
    }
  } catch (err) {
    console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤:', err);
    list.innerHTML = '<p>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤.</p>';
  }
}
function renderPreview(container, mat){
  if (!container) return;
  const wasActive = container.classList.contains("active");
  document.querySelectorAll(".preview.active").forEach(el=>{ el.classList.remove("active"); el.innerHTML=""; });
  if (wasActive){ container.classList.remove("active"); return; }
  container.classList.add("active");

  if (mat.type==="video"){
    const src = getYouTubeEmbedUrl(mat.videoLink);
    container.innerHTML = src
      ? `<iframe src="${src}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen title="–í—ñ–¥–µ–æ"></iframe>`
      : `<div class="material-desc">–ù–µ–≤—ñ—Ä–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –≤—ñ–¥–µ–æ.</div>`;
    return;
  }

  const raw = mat.filePath || "";
  const url = raw.startsWith("http") ? raw : `${API_BASE}/${raw.replace(/^\/+/, "")}`;
  const ext = (raw.split(".").pop()||"").toLowerCase();
  if (ext==="pdf"){
    container.innerHTML = `<embed src="${url}" type="application/pdf" />`;
  } else if (["doc","docx","ppt","pptx"].includes(ext)){
    container.innerHTML = `<div class="material-desc">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π –±–µ–∑ HTTPS. <a href="${url}" target="_blank" rel="noopener">–í—ñ–¥–∫—Ä–∏—Ç–∏ / –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</a></div>`;
  } else {
    container.innerHTML = `<div class="material-desc">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π. <a href="${url}" target="_blank" rel="noopener">–í—ñ–¥–∫—Ä–∏—Ç–∏ —Ñ–∞–π–ª</a></div>`;
  }
}

window.addEventListener("load", ()=>{
  document.getElementById("btnFilter").addEventListener("click", loadCourseMaterials);
  loadCourseMaterials().catch(console.error);
});
</script>
  </body>
</html>
