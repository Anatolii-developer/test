<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è - Psychologist Platform</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Make page stretch full height and center card */
    html, body { height: 100%; }
    body { min-height: 100vh; display: flex; flex-direction: column; }
    main { flex: 1 0 auto; display: grid; place-items: center; padding: 16px; }
    header { flex: 0 0 auto; }

    /* Password peek button */
    .input-wrapper { position: relative; }
    .peek {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      padding: 4px;
    }

    /* Cooldown progress bar */
    #resendWrap { display: none; }
    .cooldown {
      height: 4px;
      background: #e9ecef;
      border-radius: 3px;
      overflow: hidden;
      margin-left: 8px;
      flex: 1 1 auto;
      align-self: center;
    }
    .cooldown .fill {
      height: 100%;
      width: 0%;
      background: #6c757d;
      transition: width 1s linear;
    }

    /* Make resend row tidy */
    .resend-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <header>
    <img class="logo" src="assets/logo.png" alt="Institute Logo" />
    <div class="language-select">UA ‚ñº</div>
  </header>

  <main>
    <div class="login-card">
      <h1 class="h1" style="color: #D97A1C; text-align: center;">–í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è</h1>

      <label for="email" class="s1">Email</label>
      <div class="input-wrapper">
        <img src="assets/icon-user.svg" class="input-icon" alt="email icon" />
        <input type="email" id="email" placeholder="Enter your email" />
      </div>

      <button id="btnSend" onclick="sendRecoveryCode()">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –∫–æ–¥</button>
      <div id="resendWrap">
        <div class="resend-row">
          <button id="btnResend" onclick="resendCode()" style="background:#6c757d;">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –∫–æ–¥ —â–µ —Ä–∞–∑</button>
          <span id="resendTimer" class="s1" style="color:#6c757d;" aria-live="polite"></span>
          <div id="resendBar" class="cooldown"><div class="fill"></div></div>
        </div>
      </div>

      <!-- –®–∞–≥ 2: –∫–æ–¥ -->
      <div id="codeBlock" style="display:none; margin-top:16px;">
        <label for="code" class="s1">–ö–æ–¥ –∑ –ª–∏—Å—Ç–∞</label>
        <div class="input-wrapper">
          <input type="text" id="code" placeholder="6-–∑–Ω–∞—á–Ω–∏–π –∫–æ–¥" inputmode="numeric" maxlength="6" />
        </div>
        <button id="btnVerify" onclick="verifyCode()">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∫–æ–¥</button>
      </div>

      <!-- –®–∞–≥ 3: –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å -->
      <div id="resetBlock" style="display:none; margin-top:16px;">
        <label for="newPassword" class="s1">–ù–æ–≤–∏–π –ø–∞—Ä–æ–ª—å</label>
        <div class="input-wrapper">
          <input type="password" id="newPassword" placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤–∏–π –ø–∞—Ä–æ–ª—å" />
          <button type="button" class="peek" data-target="newPassword" aria-label="–ü–æ–∫–∞–∑–∞—Ç–∏ –ø–∞—Ä–æ–ª—å">üëÅ</button>
        </div>
        <label for="newPassword2" class="s1" style="margin-top:8px;">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</label>
        <div class="input-wrapper">
          <input type="password" id="newPassword2" placeholder="–ü–æ–≤—Ç–æ—Ä—ñ—Ç—å –ø–∞—Ä–æ–ª—å" />
          <button type="button" class="peek" data-target="newPassword2" aria-label="–ü–æ–∫–∞–∑–∞—Ç–∏ –ø–∞—Ä–æ–ª—å">üëÅ</button>
        </div>
        <button id="btnReset" onclick="resetPassword()">–ó–º—ñ–Ω–∏—Ç–∏ –ø–∞—Ä–æ–ª—å</button>
      </div>

      <button style="background-color: #aaa; margin-top: 12px;" onclick="history.back()">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—å –Ω–∞–∑–∞–¥</button>
    </div>
</main>
<script>
  // Primary routes live under /api/auth/recovery, but some deployments expose only /api/auth/forgot-password.
  // We'll try primary first, then fallback automatically.
  const API_PRIMARY = '/api/users/recovery';
const API_FALLBACK = '/api/users';

  const state = { email: '', code: '', codeVerified: false };
  const RESEND_COOLDOWN = 60; // seconds
  let cooldownLeft = 0;
  let cooldownTimer = null;

  function startCooldown() {
    const wrap = qs('resendWrap');
    const btn = qs('btnResend');
    const t = qs('resendTimer');
    if (!wrap || !btn || !t) return;

    wrap.style.display = '';
    const barFill = document.querySelector('#resendBar .fill');
    if (barFill) barFill.style.width = '100%';
    cooldownLeft = RESEND_COOLDOWN;
    btn.disabled = true;
    t.textContent = `–ú–æ–∂–Ω–∞ –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ —á–µ—Ä–µ–∑ ${cooldownLeft}s`;

    clearInterval(cooldownTimer);
    cooldownTimer = setInterval(() => {
      cooldownLeft -= 1;
      if (cooldownLeft <= 0) {
        clearInterval(cooldownTimer);
        t.textContent = '–ú–æ–∂–Ω–∞ –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ';
        btn.disabled = false;
        if (barFill) barFill.style.width = '0%';
      } else {
        t.textContent = `–ú–æ–∂–Ω–∞ –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ —á–µ—Ä–µ–∑ ${cooldownLeft}s`;
        if (barFill) {
          const pct = Math.max(0, Math.round((cooldownLeft / RESEND_COOLDOWN) * 100));
          barFill.style.width = pct + '%';
        }
      }
    }, 1000);
  }

  function qs(id){ return document.getElementById(id); }
  function show(el, yes){ if(!el) return; el.style.display = yes ? '' : 'none'; }
  function toast(msg){ alert(msg); }
  function setLoading(btn, is){
    if(!btn) return;
    if(is){
      btn.disabled = true;
      if(!btn.dataset._txt) btn.dataset._txt = btn.textContent;
      btn.textContent = '–ó–∞—á–µ–∫–∞–π—Ç–µ‚Ä¶';
    } else {
      btn.disabled = false;
      if(btn.dataset._txt) btn.textContent = btn.dataset._txt;
    }
  }

  async function postJSON(url, body, fallbackUrl) {
    const controller = new AbortController();
    const timer = setTimeout(() => controller.abort(), 12000); // 12s timeout
    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body || {}),
        signal: controller.signal,
      });
      if (res.status === 404 && fallbackUrl) {
        const res2 = await fetch(fallbackUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body || {}),
          signal: controller.signal,
        });
        return { res: res2, data: await res2.json().catch(() => ({})) };
      }
      return { res, data: await res.json().catch(() => ({})) };
    } finally {
      clearTimeout(timer);
    }
  }

  // Sanitize code input to digits only and auto-verify on 6 chars
  document.addEventListener('input', (e) => {
    if (e.target && e.target.id === 'code') {
      const v = (e.target.value || '').replace(/\D+/g, '').slice(0, 6);
      e.target.value = v;
    }
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      if (qs('resetBlock') && qs('resetBlock').style.display !== 'none') {
        resetPassword();
      } else if (qs('codeBlock') && qs('codeBlock').style.display !== 'none') {
        verifyCode();
      } else {
        sendRecoveryCode();
      }
    }
  });

  // Step 1: send code to email
  async function sendRecoveryCode(){
    const email = (qs('email')?.value || '').trim().toLowerCase();
    if(!email){ toast('–í–∫–∞–∂—ñ—Ç—å email.'); return; }
    setLoading(qs('btnSend'), true);
    try{
      const { res, data } = await postJSON(
        `${API_PRIMARY}/send`,
        { email },
        `${API_FALLBACK}/forgot-password` // fallback alias on some servers
      );
      if(!res.ok) throw new Error(data.message || '–ü–æ–º–∏–ª–∫–∞ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∫–æ–¥—É');
      state.email = email;
      show(qs('codeBlock'), true);
      startCooldown();
      toast('–ö–æ–¥ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –≤–∞—à—É –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω—É –ø–æ—à—Ç—É.');
    } catch (e){
      toast(e.message || '–ü–æ–º–∏–ª–∫–∞');
    } finally {
      setLoading(qs('btnSend'), false);
    }
  }

  async function resendCode(){
    if (cooldownLeft > 0) return;
    const email = state.email || (qs('email')?.value || '').trim().toLowerCase();
    if(!email){ toast('–í–∫–∞–∂—ñ—Ç—å email.'); return; }
    setLoading(qs('btnResend'), true);
    try{
      const { res, data } = await postJSON(
        `${API_PRIMARY}/send`,
        { email },
        `${API_FALLBACK}/forgot-password`
      );
      if(!res.ok) throw new Error(data.message || '–ü–æ–º–∏–ª–∫–∞ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∫–æ–¥—É');
      toast('–ö–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ.');
      startCooldown();
    } catch(e){
      toast(e.message || '–ü–æ–º–∏–ª–∫–∞');
    } finally {
      setLoading(qs('btnResend'), false);
    }
  }

  // Step 2: verify code
  async function verifyCode(){
    const code = (qs('code')?.value || '').trim();
    if(!code){ toast('–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –∑ –ª–∏—Å—Ç–∞.'); return; }
    setLoading(qs('btnVerify'), true);
    try{
      const { res, data } = await postJSON(
        `${API_PRIMARY}/verify`,
        { email: state.email || (qs('email')?.value||'').trim(), code }
      );
      if(!res.ok) throw new Error(data.message || '–ù–µ–≤—ñ—Ä–Ω–∏–π –∞–±–æ –ø—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–∏–π –∫–æ–¥');
      state.code = code;
      state.codeVerified = true;
      show(qs('resetBlock'), true);
      toast('–ö–æ–¥ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ. –í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤–∏–π –ø–∞—Ä–æ–ª—å.');
    } catch(e){
      toast(e.message || '–ü–æ–º–∏–ª–∫–∞');
    } finally {
      setLoading(qs('btnVerify'), false);
    }
  }

  // Step 3: set new password (client-side)
  async function resetPassword(){
    if(!state.codeVerified){ toast('–°–ø–µ—Ä—à—É –ø—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å –∫–æ–¥.'); return; }
    const p1 = qs('newPassword')?.value || '';
    const p2 = qs('newPassword2')?.value || '';
    if(p1.length < 8){ toast('–ü–∞—Ä–æ–ª—å –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏ —â–æ–Ω–∞–π–º–µ–Ω—à–µ 8 —Å–∏–º–≤–æ–ª—ñ–≤.'); return; }
    if(p1 !== p2){ toast('–ü–∞—Ä–æ–ª—ñ –Ω–µ –∑–±—ñ–≥–∞—é—Ç—å—Å—è.'); return; }
    setLoading(qs('btnReset'), true);
    try{
      const { res, data } = await postJSON(
        `${API_PRIMARY}/reset`,
        { email: state.email || (qs('email')?.value||'').trim(), code: state.code, newPassword: p1 }
      );
      if(!res.ok) throw new Error(data.message || '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–º—ñ–Ω–∏—Ç–∏ –ø–∞—Ä–æ–ª—å');
      alert('‚úÖ –ü–∞—Ä–æ–ª—å —É—Å–ø—ñ—à–Ω–æ –∑–º—ñ–Ω–µ–Ω–æ! –¢–µ–ø–µ—Ä –≤–∏ –º–æ–∂–µ—Ç–µ —É–≤—ñ–π—Ç–∏.');
      setTimeout(() => location.href = '/index.html', 800);
    } catch(e){
      toast(e.message || '–ü–æ–º–∏–ª–∫–∞');
    } finally {
      setLoading(qs('btnReset'), false);
    }
  }

  // Toggle password visibility
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.peek');
    if (!btn) return;
    const id = btn.getAttribute('data-target');
    const input = document.getElementById(id);
    if (!input) return;
    input.type = input.type === 'password' ? 'text' : 'password';
    btn.textContent = input.type === 'password' ? 'üëÅ' : 'üôà';
    btn.setAttribute('aria-label', input.type === 'password' ? '–ü–æ–∫–∞–∑–∞—Ç–∏ –ø–∞—Ä–æ–ª—å' : '–°—Ö–æ–≤–∞—Ç–∏ –ø–∞—Ä–æ–ª—å');
  });
</script>

</body>
</html>