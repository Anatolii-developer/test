<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Бібліотека курсів</title>
  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-overlay {
  position: absolute;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
}

.modal-content {
  position: relative;
  background: #fff;
  border-radius: 16px;
  max-width: 480px;
  width: 90%;
  padding: 32px;
  z-index: 10;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
  font-family: 'Poppins', sans-serif;
}

.modal-content h2 {
  margin-top: 0;
  font-size: 22px;
  margin-bottom: 20px;
  text-align: center;
}

.close-btn {
  position: absolute;
  top: 16px;
  right: 20px;
  font-size: 24px;
  cursor: pointer;
  color: #888;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-bottom: 18px;
}

.form-group label {
  font-weight: 500;
  font-size: 14px;
}

.form-group input,
.form-group textarea,
.form-group select {
  padding: 10px 12px;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 14px;
  font-family: 'Poppins', sans-serif;
}

.form-group textarea {
  resize: vertical;
  min-height: 80px;
}

.submit-btn {
  width: 100%;
  background-color: #48a868;
  color: white;
  font-weight: 600;
  font-size: 16px;
  padding: 14px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.3s ease;
}

.submit-btn:hover {
  background-color: #3c9359;
}

.role-filter-group { display: grid; gap: 6px; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); margin: 6px 0 0; }
.role-filter-item { display: flex; align-items: center; gap: 8px; font-size: 14px; }

  </style>
</head>
<body class="with-sidebar">
  <aside class="sidebar" id="sidebar"></aside>

    <div class="main-content">
      <div class="materials-header">
        <button class="btn-green">Додати матеріали до курсів</button>
        <button class="btn-light-green">Додати матеріали групи</button>
      </div>

     <div class="filters">
  <input type="text" id="searchInput" placeholder="Пошук за ім'ям" />

<div id="roleFilterGroup" class="role-filter-group" aria-label="Фільтр за ролями"></div>

  <label for="courseSelect">Оберіть курс</label>
<select id="courseSelect">
  <option value="">-- Оберіть курс --</option>
</select>


  <button id="selectAllBtn" class="btn-light-green">Виділити всіх</button>
</div>

      <table class="participants-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Ім’я та прізвище</th>
            <th>Email</th>
            <th>Роль</th>
            <th>Дата народження</th>
            <th>Обрати</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="date-time">
        <label>Оберіть дату та час публікації</label>
        <input type="date" />
        <input type="time" />
      </div>

      <div class="action-buttons">
        <button class="btn-green-add">Додати відео</button>
        <button class="btn-dark-green">Додати книгу</button>
      </div>

      <button class="submit-button">Submit</button>
    </div>
  </div>
  <script src="admin-auth.js"></script>
  
  <script>
  const API_BASE = "http://157.230.121.24:5050";
  let selectAllClicked = false;
  let allUsers = [];
  const rolesById = new Map();     // _id -> name
  const rolesByName = new Map();   // name -> _id

async function loadRoles() {
  const res = await fetch(`${API_BASE}/api/roles`);
  if (!res.ok) throw new Error('Не вдалося отримати ролі');
  const roles = await res.json(); // [{ _id, name }]

  const grp = document.getElementById("roleFilterGroup");
  if (!grp) return;
  grp.innerHTML = "";

  roles.forEach(r => {
    const idStr = String(r._id);
    rolesById.set(idStr, r.name);
    rolesByName.set(r.name, idStr);

    const wrap = document.createElement("label");
    wrap.className = "role-filter-item";
    wrap.innerHTML = `
      <input type="checkbox" name="roleFilter[]" value="${idStr}" />
      <span>${r.name}</span>
    `;
    grp.appendChild(wrap);
  });
}


function getSelectedRoleIds() {
  return Array.from(document.querySelectorAll('input[name="roleFilter[]"]:checked'))
    .map(el => String(el.value));
}

function intersects(a, b) {
  if (!a || !b || a.length === 0 || b.length === 0) return false;
  const setB = new Set(b.map(String));
  return a.some(x => setB.has(String(x)));
}

  function normalizeUserRoleIds(user){
    if (Array.isArray(user.roleIds)) return user.roleIds.map(String);
    if (Array.isArray(user.roles))   return user.roles.map(r => String(rolesByName.get(r) || r));
    if (user.roleId)                 return [String(user.roleId)];
    if (user.role)                   return [String(rolesByName.get(user.role) || user.role)];
    return [];
  }

  function renderTable(users) {
    const tbody = document.querySelector(".participants-table tbody");
    tbody.innerHTML = "";

    users.forEach((user, index) => {
      const fullName = `${user.firstName || ""} ${user.lastName || ""}`.trim();
      const roleIds = normalizeUserRoleIds(user);
      const roleNames = roleIds.map(id => rolesById.get(id) || id);
      const roleText = roleNames.length ? roleNames.join(", ") : "-";

      const dob = user.dateOfBirth ? new Date(user.dateOfBirth).toLocaleDateString("uk-UA") : "-";

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${index + 1}</td>
        <td>${fullName}</td>
        <td>${user.email || ""}</td>
        <td>${roleText}</td>
        <td>${dob}</td>
        <td>
          <img 
            src="images/checkbox-empty.png" 
            alt="checkbox" 
            class="custom-checkbox" 
            data-role-ids='${JSON.stringify(roleIds)}'
            data-checked="false"
            style="width: 24px; height: 24px; cursor: pointer;" />
        </td>
      `;
      tbody.appendChild(row);
    });
  }

  function applyFilters() {
  const searchValue = document.getElementById("searchInput").value.toLowerCase();
  const selectedRoleIds = getSelectedRoleIds(); // теперь массив выбранных ролей (может быть пустым)

  const filtered = allUsers.filter(user => {
    const name = `${user.firstName || ""} ${user.lastName || ""}`.toLowerCase();
    const matchName = name.includes(searchValue);

    if (selectedRoleIds.length === 0) {
      return matchName; // ролями не фильтруем
    }

    const roleIds = normalizeUserRoleIds(user); // роли пользователя (ids)
    const matchRole = intersects(roleIds, selectedRoleIds);
    return matchName && matchRole;
  });

  renderTable(filtered);
}

  document.addEventListener("DOMContentLoaded", async () => {
    if (typeof renderAdminSidebar === "function") {
      renderAdminSidebar("admin-career-requests.html");
    }
    if (typeof requireAdminPage === "function") {
      requireAdminPage();
    }
    if (typeof load === "function") {
      load();
    }

    // 1) Сначала роли
    try {
      await loadRoles();
    } catch (e) {
      console.error("Не вдалося завантажити ролі:", e);
    }

    // 2) Курси
    async function loadCurrentCourses() {
      const res = await fetch(`${API_BASE}/api/courses`);
      const allCourses = await res.json();
      const currentCourses = allCourses.filter(c => c.status === "Поточний");

      const courseSelect = document.getElementById("courseSelect");
      courseSelect.innerHTML = `<option value="">-- Оберіть курс --</option>`;
      currentCourses.forEach(course => {
        const opt = document.createElement("option");
        opt.value = course._id;
        opt.textContent = course.courseTitle;
        courseSelect.appendChild(opt);
      });
    }
    await loadCurrentCourses();

    // 3) Користувачі
    try {
      const response = await fetch(`${API_BASE}/api/users/approved`);
      allUsers = await response.json();
      renderTable(allUsers);
    } catch (err) {
      console.error("Помилка при отриманні користувачів:", err);
    }

    // Обробники
    document.getElementById("courseSelect").addEventListener("change", async (e) => {
      const courseId = e.target.value;
      if (!courseId) return;
      try {
        const res = await fetch(`${API_BASE}/api/courses/${courseId}/participants`);
        const users = await res.json();
        allUsers = users;
        applyFilters();
      } catch (err) {
        console.error("Помилка при отриманні учасників курсу:", err);
      }
    });

    document.getElementById("searchInput").addEventListener("input", applyFilters);
const roleFilterGroup = document.getElementById("roleFilterGroup");
if (roleFilterGroup) {
  roleFilterGroup.addEventListener("change", (e) => {
    if (e.target && e.target.name === "roleFilter[]") applyFilters();
  });
}

    document.getElementById("selectAllBtn").addEventListener("click", () => {
  selectAllClicked = true;
  const selectedRoleIds = getSelectedRoleIds(); // массив

  document.querySelectorAll(".custom-checkbox").forEach(cb => {
    if (selectedRoleIds.length === 0) {
      // если роли не выбраны — отмечаем всех
      cb.src = "images/checkbox.png";
      cb.dataset.checked = "true";
      return;
    }
    const roleIds = JSON.parse(cb.dataset.roleIds || "[]");
    const match = intersects(roleIds, selectedRoleIds);
    cb.src = match ? "images/checkbox.png" : "images/checkbox-empty.png";
    cb.dataset.checked = match.toString();
  });
});

    document.addEventListener("click", (e) => {
      if (e.target.classList.contains("custom-checkbox")) {
        const checkbox = e.target;
        const isChecked = checkbox.dataset.checked === "true";
        checkbox.src = isChecked ? "images/checkbox-empty.png" : "images/checkbox.png";
        checkbox.dataset.checked = (!isChecked).toString();
      }
    });

    document.querySelector(".btn-green-add").addEventListener("click", () => {
      openModal("video");
    });
    document.querySelector(".btn-dark-green").addEventListener("click", () => {
      openModal("book");
    });
  });

function openModal(type) {
  document.getElementById("addMaterialModal").style.display = "block";
  document.getElementById("materialType").value = type;
  toggleInputs(type);
}
function closeModal() {
  document.getElementById("addMaterialModal").style.display = "none";
}

document.addEventListener("DOMContentLoaded", () => {
  const mt = document.getElementById("materialType");
  if (mt) {
    mt.addEventListener("change", (e) => toggleInputs(e.target.value));
  }
});


async function submitMaterial() {
  const type = document.getElementById("materialType").value;
  const title = document.getElementById("materialTitle").value?.trim();
  const description = document.getElementById("materialDescription").value?.trim();
  const selectedCourseId = document.getElementById("courseSelect").value;

const selectedRoleIds = getSelectedRoleIds(); // роли из чекбоксів

  // базовая валидация
  if (!title) return alert("Введіть назву матеріалу");
  if (type !== "video" && type !== "book") return alert("Оберіть тип матеріалу");

  // функция сборки общих полей
  const buildBaseForm = () => {
    const fd = new FormData();
    fd.append("type", type);
    fd.append("title", title);
    fd.append("description", description || "");

    if (type === "video") {
      const link = document.getElementById("videoLink").value?.trim();
      if (!link) { alert("Вкажіть посилання на YouTube"); return null; }
      fd.append("videoLink", link);
    } else {
     const file = document.getElementById("bookFile").files[0];
if (!file) { alert("Оберіть файл (PDF/DOC/DOCX/PPT/PPTX)"); return null; }

const okExt = /\.(pdf|doc|docx|ppt|pptx)$/i.test(file.name);
const okMime = [
  "application/pdf",
  "application/msword",
  "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
  "application/vnd.ms-powerpoint",
  "application/vnd.openxmlformats-officedocument.presentationml.presentation"
].includes(file.type) || file.type === ""; // інколи браузери не ставлять type

if (!okExt && !okMime) {
  alert("Підтримуються лише PDF/DOC/DOCX/PPT/PPTX");
  return null;
}

fd.append("bookFile", file);
    }
    return fd;
  };

  // КУДА слать: роли / курс / всем
  const destinationByRoles = selectedRoleIds.length > 0;
  const destinationByCourse = !destinationByRoles && !!selectedCourseId;
  const destinationGeneral  = !destinationByRoles && !destinationByCourse && !!window.selectAllClicked;

  if (!destinationByRoles && !destinationByCourse && !destinationGeneral) {
    alert("Будь ласка, виберіть курс, ролі або натисніть 'Виділити всіх'");
    return;
  }

  // отправка одного FormData
  const sendOnce = async (fd) => {
    const res = await fetch("http://157.230.121.24:5050/api/library", {
      method: "POST",
      body: fd
    });
    return res;
  };

  try {
    if (destinationByRoles) {
      // ===== 1) сначала пробуем одним запросом с массивом roleIds[] =====
      let fd = buildBaseForm();
      if (!fd) return;

      fd.append("destination", "addons");
      selectedRoleIds.forEach(id => fd.append("roleIds[]", id));
      // имена ролей на всякий (если бэку пригодятся)
      selectedRoleIds
        .map(id => rolesById.get(String(id)))
        .filter(Boolean)
        .forEach(name => fd.append("roles[]", name));

      let res = await sendOnce(fd);

      if (!res.ok) {
        // ===== 2) фолбек — по одному запросу на каждую роль =====
        // полезно, если бэк принимает только roleId (не массив)
        for (const roleId of selectedRoleIds) {
          let fdOne = buildBaseForm();
          if (!fdOne) return;
          fdOne.append("destination", "addons");
          fdOne.append("roleId", roleId);
          const roleName = rolesById.get(String(roleId));
          if (roleName) fdOne.append("role", roleName);

          const r = await sendOnce(fdOne);
          if (!r.ok) {
            let msg = "Помилка при завантаженні.";
            try { const j = await r.clone().json(); msg = j?.message || msg; } catch {}
            throw new Error(msg);
          }
        }
      }
    } else if (destinationByCourse) {
      // отправка для выбранного курса
      let fd = buildBaseForm();
      if (!fd) return;
      fd.append("destination", "courses");
      fd.append("courseId", selectedCourseId);

      const res = await sendOnce(fd);
      if (!res.ok) {
        let msg = "Помилка при завантаженні.";
        try { const j = await res.clone().json(); msg = j?.message || msg; } catch {}
        throw new Error(msg);
      }
    } else if (destinationGeneral) {
      // отправка всем
      let fd = buildBaseForm();
      if (!fd) return;
      fd.append("destination", "general");

      const res = await sendOnce(fd);
      if (!res.ok) {
        let msg = "Помилка при завантаженні.";
        try { const j = await res.clone().json(); msg = j?.message || msg; } catch {}
        throw new Error(msg);
      }
    }

    alert("Успішно додано!");
    closeModal();
  } catch (err) {
    console.error(err);
    alert(err.message || "Помилка при завантаженні.");
  }
}

function toggleInputs(type) {
  document.getElementById("videoInput").style.display = type === "video" ? "block" : "none";
  document.getElementById("bookInput").style.display = type === "book" ? "block" : "none";
}

     function logoutUser(){
    try{
      // чистимо локальне
      localStorage.removeItem('user');
      ['token','authToken','jwt','accessToken','bearer'].forEach(k => localStorage.removeItem(k));
    }catch(_){}

    // пробуємо вийти і на бекенді (ігноруємо помилки мережі)
    const API = ""; // якщо бек і фронт на одному домені — залиш порожнім
    fetch(`${API}/api/users/logout`, { method:'POST', credentials:'include' }).catch(()=>{});

    // редірект на логін з поверненням
    const back = encodeURIComponent(location.pathname + location.search);
    location.href = `admin-login.html?returnUrl=${back}`;
  }

  // прив’язуємо до кнопки
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('btnLogout');
    if (btn) btn.addEventListener('click', logoutUser);
  });

  document.addEventListener('DOMContentLoaded', () => {
  const here = location.pathname.split('/').pop();
  document.querySelectorAll('.sidebar nav a').forEach(a=>{
    if (a.getAttribute('href') === here) a.classList.add('active');
  });
});

  </script>
 <div id="addMaterialModal" class="modal" style="display:none;">
  <div class="modal-overlay" onclick="closeModal()"></div>
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal()">×</span>
    <h2>Додати матеріал</h2>

    <div class="form-group">
      <label for="materialType">Тип матеріалу</label>
      <select id="materialType">
        <option value="video">🎥 Відео (YouTube)</option>
        <option value="book">📘 Файл (PDF / DOC / DOCX / PPT / PPTX)</option>
      </select>
    </div>

    <div class="form-group">
      <label for="materialTitle">Назва</label>
      <input type="text" id="materialTitle" placeholder="Введіть назву" />
    </div>

    <div class="form-group">
      <label for="materialDescription">Опис</label>
      <textarea id="materialDescription" placeholder="Короткий опис..."></textarea>
    </div>

    <div class="form-group" id="videoInput" style="display: none;">
      <label for="videoLink">Посилання на YouTube</label>
      <input type="url" id="videoLink" placeholder="https://www.youtube.com/watch?v=..." />
    </div>

    <div class="form-group" id="bookInput" style="display: none;">
  <label for="bookFile">Файл (PDF / DOC / DOCX / PPT / PPTX)</label>
  <input
    type="file"
    id="bookFile"
    accept="application/pdf,
            application/msword,
            application/vnd.openxmlformats-officedocument.wordprocessingml.document,
            application/vnd.ms-powerpoint,
            application/vnd.openxmlformats-officedocument.presentationml.presentation,
            .pdf,.doc,.docx,.ppt,.pptx" />
</div>

    <button class="submit-btn" onclick="submitMaterial()">Завантажити</button>
  </div>
</div>

</div>
</body>
</html>
