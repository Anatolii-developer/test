<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–¢–µ–º–∞ —Ñ–æ—Ä—É–º—É</title>
<link rel="stylesheet" href="./forum.css">
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body class="with-sidebar">
    <header class="site-header">
      <button class="burger" id="burgerBtn" aria-label="Open menu" aria-expanded="false" aria-controls="sidebar">
        <img src="/assets/sidebar/burger.svg" alt="" />
      </button>
      <a href="/" class="header-logo" aria-label="Homepage">
        <img src="/assets/emblem.svg" alt="Company" />
      </a>
    </header>
    <button class="lang-fab" id="langBtn" aria-label="Language" aria-haspopup="listbox" aria-expanded="false">
      <img src="/assets/language.png" alt="Language" />
    </button>
    <div class="drawer-backdrop" id="drawerBackdrop"></div>

    <aside class="sidebar collapsed" id="sidebar">
    <div class="toggle-button" onclick="toggleSidebar()">
      <img src="/assets/sidebar/arrow.svg" alt="Toggle" id="toggleArrow" />
    </div>
    <img class="logo" src="/assets/sidebar/IPS Logo (2).svg" alt="Logo" id="logoExpanded" />
    <img class="logo-collapsed" src="/assets/sidebar/IPS Logo (1).svg" alt="Logo Small" id="logoCollapsed" />
    <img class="profile" src="/assets/profile-photo.png" alt="User" width="40" height="40" />
    <nav>
      <a href="/profile.html"><img src="/assets/sidebar/profile.svg" /><span>–ü—Ä–æ –ú–µ–Ω–µ</span></a>
      <a href="/mycertificates.html"><img src="/assets/sidebar/news.svg" /><span>–ú–æ—ó –°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏</span></a>
      <a href="/career-faq.html"><img src="/assets/sidebar/10.svg" /><span>–ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è –ö–∞—Ä'—î—Ä–∏</span></a>
      <a href="/library.html"><img src="/assets/sidebar/3.svg" /><span>–ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞</span></a>
      <a href="/my-courses.html"><img src="/assets/sidebar/5.svg" /><span>–ú–æ—ó –ö—É—Ä—Å–∏</span></a>
       <a href="/forum/index.html">
  <img src="/assets/sidebar/forum.svg" alt="–§–æ—Ä—É–º"/>
  <span>–§–æ—Ä—É–º</span>
</a>
    </nav>
    <div class="logout">
      <img src="/assets/sidebar/log-out.svg" alt="Logout Icon" width="20" height="20" />
      <span>–í–∏–π—Ç–∏ –∑ –∞–∫–∞—É–Ω—Ç—É</span>
    </div>
  </aside>

    <main class="wrap">
      <div class="thread-card">
    <div class="thread-card__left">
      <div class="thread-title" id="tTitle">...</div>
      <div class="thread-author">
        <img class="thread-avatar" src="/assets/profile-photo.png" alt="" />
        <div class="thread-author-col">
          <div class="thread-author-name" id="tAuthor">‚Äî</div>
          <div class="thread-author-meta" id="tMeta">‚Äî</div>
        </div>
      </div>
    </div>
    <div class="thread-answers" id="tAnswers">‚Äî</div>
  </div>

  <div id="tModActions" class="mod-actions" style="display:none">
    <button class="mod-btn" id="btnPin">
      <img src="/assets/forum/attach.svg" alt="" class="mod-icon"/>
      <span id="btnPinText">–ó–∞–∫—Ä—ñ–ø–∏—Ç–∏</span>
    </button>
    <button class="mod-btn" id="btnPrivacy">
      <img src="/assets/forum/lock.svg" alt="" class="mod-icon"/>
      <span id="btnPrivacyText">–û—Å–æ–±–∏—Å—Ç—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</span>
    </button>
    <button class="mod-btn" id="btnDelThread">
      <img src="/assets/forum/trash.svg" alt="" class="mod-icon"/>
      <span id="btnDelThreadText">–í–∏–¥–∞–ª–∏—Ç–∏</span>
    </button>
    <button class="mod-btn" id="btnLock">
      <img src="/assets/forum/lock.svg" alt="" class="mod-icon"/>
      <span id="btnLockText">–ó–∞–∫—Ä–∏—Ç–∏</span>
    </button>
    <button class="mod-btn" id="btnInvite">
      <img src="/assets/forum/add-icon.svg" alt="" class="mod-icon"/>
      <span id="btnInviteText">–ó–∞–ø—Ä–æ—Å–∏—Ç–∏</span>
    </button>
  </div>

      <div id="posts" style="margin-top: 16px"></div>

    <div id="composer" class="composer">
  <!-- –ï–î–ò–ù–ê–Ø –ö–ê–†–¢–û–ß–ö–ê: –≤–µ—Ä—Ö ‚Äî —á–∏–ø, –Ω–∏–∑ ‚Äî textarea -->
  <div class="composer-card">
    <div id="replyCtx" class="reply-context" style="display:none">
      <span class="label" id="replyCtxLabel">–í—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞:</span>
      <span class="quote" id="replyToWho"></span>
      <button id="replyCancel" class="close" title="–°–∫–∞—Å—É–≤–∞—Ç–∏">√ó</button>
    </div>

    <textarea id="replyText" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –í–∞—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..."></textarea>
  </div>

  <!-- –Ω–∏–∑: —Ñ–∞–π–ª—ã + –æ—Ç–ø—Ä–∞–≤–∫–∞ -->
  <div class="composer-actions">
    <!-- –∫–Ω–æ–ø–∫–∞-–ª–µ–π–±–ª –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–∫—Ä—ã—Ç—ã–π input -->
    <input id="replyFiles" type="file" multiple hidden />
    <label for="replyFiles" class="attach-btn">
      <img src="/assets/forum/attach.svg" alt="" />
      <span id="attachBtnText">–ü—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏ —Ñ–∞–π–ª</span>
    </label>

    <button class="btn btn-send" id="btnReply"><span id="btnReplyText">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</span></button>
    <span class="meta" id="lockHint" style="display:none">–¢–µ–º–∞ –∑–∞–∫—Ä–∏—Ç–∞ –¥–ª—è –Ω–æ–≤–∏—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π</span>
  </div>

  <!-- –ø—Ä–µ–≤—å—é –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ -->
  <div id="preview" class="attachments-preview"></div>
</div>
    </main>

    <script src="./forum.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        if (typeof renderAdminSidebar === "function")
          renderAdminSidebar("forum/index.html");
        await Forum.init();
        if (Forum.applyAvatars) {
          await Forum.applyAvatars();
        }

        const id = new URLSearchParams(location.search).get("id");
        if (!id) return (location.href = "./index.html");

        const $files = document.getElementById("replyFiles");
        const $preview = document.getElementById("preview");
        const $text = document.getElementById("replyText");
        const $btnReply = document.getElementById("btnReply");
        let currentParentId = null;
        let threadData = null;
        let postsData = [];

        function getLang() {
          if (typeof window.getForumLang === "function") return window.getForumLang();
          return "ua";
        }

        function getCopy() {
          const fallback = {
            pin: "–ó–∞–∫—Ä—ñ–ø–∏—Ç–∏",
            directMessages: "–û—Å–æ–±–∏—Å—Ç—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è",
            delete: "–í–∏–¥–∞–ª–∏—Ç–∏",
            close: "–ó–∞–∫—Ä–∏—Ç–∏",
            invite: "–ó–∞–ø—Ä–æ—Å–∏—Ç–∏",
            reply: "–í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏",
            showMore: "–ü–æ–∫–∞–∑–∞—Ç–∏ –±—ñ–ª—å—à–µ",
            showLess: "–ó–≥–æ—Ä–Ω—É—Ç–∏",
            replyTo: "–í—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞:",
            typeMessage: "–ù–∞–ø–∏—à—ñ—Ç—å –í–∞—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è...",
            attachFile: "–ü—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏ —Ñ–∞–π–ª",
            send: "–ù–∞–¥—ñ—Å–ª–∞—Ç–∏",
            lockHint: "–¢–µ–º–∞ –∑–∞–∫—Ä–∏—Ç–∞ –¥–ª—è –Ω–æ–≤–∏—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π",
            createdBy: "–°—Ç–≤–æ—Ä–∏–≤",
            pinnedState: "–ó–∞–∫—Ä—ñ–ø–ª–µ–Ω–æ",
            lockedState: "–ó–∞–∫—Ä–∏—Ç–æ",
            privateState: "–ü—Ä–∏–≤–∞—Ç–Ω–∞",
            cancel: "–°–∫–∞—Å—É–≤–∞—Ç–∏",
            fileLabel: "–§–∞–π–ª",
            errorGeneric: "–ü–æ–º–∏–ª–∫–∞",
            deleteThreadConfirm: "–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–µ–º—É?",
            invitePrompt: "–í–≤–µ–¥—ñ—Ç—å ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —è–∫–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∏—Ç–∏:",
            inviteSuccess: "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–æ–¥–∞–Ω–æ –¥–æ –ø—Ä–∏–≤–∞—Ç–Ω–æ—ó —Ç–µ–º–∏",
          };
          if (typeof window.getForumMainCopy !== "function") return fallback;
          return window.getForumMainCopy(getLang()).thread || fallback;
        }

        function localeForLang(lang) {
          if (lang === "ru") return "ru-RU";
          if (lang === "en") return "en-US";
          return "uk-UA";
        }

        function formatReplies(count) {
          if (typeof window.formatForumReplies === "function") {
            return window.formatForumReplies(count, getLang());
          }
          return `${count} replies`;
        }

        function formatThreadDate(value) {
          try {
            return new Date(value).toLocaleString(localeForLang(getLang()));
          } catch (_) {
            return "";
          }
        }

        function applyThreadText() {
          const t = getCopy();
          const setText = (id, value) => {
            const node = document.getElementById(id);
            if (node) node.textContent = value;
          };

          setText("btnPinText", t.pin);
          setText("btnPrivacyText", t.directMessages);
          setText("btnDelThreadText", t.delete);
          setText("btnLockText", t.close);
          setText("btnInviteText", t.invite);
          setText("replyCtxLabel", t.replyTo);
          setText("attachBtnText", t.attachFile);
          setText("btnReplyText", t.send);
          setText("lockHint", t.lockHint);

          const $cancel = document.getElementById("replyCancel");
          if ($cancel) $cancel.title = t.cancel;
          if ($text) $text.placeholder = t.typeMessage;
        }

        function renderThreadHeader(thread, posts) {
          const t = getCopy();
          const $titleEl = document.getElementById("tTitle");
          const $authorEl = document.getElementById("tAuthor");
          const $metaEl = document.getElementById("tMeta");
          const $answersEl = document.getElementById("tAnswers");

          if ($titleEl) $titleEl.textContent = thread.title || "";
          if ($authorEl) {
            $authorEl.textContent =
              thread.author?.fullName ||
              thread.author?.username ||
              thread.author?.email ||
              "‚Äî";
          }

          const createdBy = thread.author?.username || thread.author?.email || "‚Äî";
          const createdAt = formatThreadDate(thread.createdAt);
          const metaParts = [`${t.createdBy}: ${createdBy}`, createdAt];
          if (thread.pinned) metaParts.push(`üìå ${t.pinnedState}`);
          if (thread.locked) metaParts.push(`üîí ${t.lockedState}`);
          if (thread.isPrivate) metaParts.push(`üîê ${t.privateState}`);
          if ($metaEl) $metaEl.textContent = metaParts.filter(Boolean).join(" ‚Ä¢ ");

          const answers = Array.isArray(posts) ? posts.length : Number(thread.postsCount || 0);
          if ($answersEl) $answersEl.textContent = formatReplies(answers);
        }

        function showReplyCtx({ snippet = "" } = {}) {
          const $ctx = document.getElementById("replyCtx");
          const $quote = document.getElementById("replyToWho");
          if (!$ctx || !$quote) return;
          const text = String(snippet || "").trim();
          $quote.textContent = text ? `‚Äú${text}‚Äù` : "";
          $ctx.style.display = text ? "inline-flex" : "none";
        }

        function clearReplyCtx() {
          const $ctx = document.getElementById("replyCtx");
          const $quote = document.getElementById("replyToWho");
          if ($quote) $quote.textContent = "";
          if ($ctx) $ctx.style.display = "none";
          currentParentId = null;
        }

        function renderThreadPage() {
          if (!threadData) return;
          applyThreadText();
          renderThreadHeader(threadData, postsData);
          Forum.renderPosts("#posts", postsData, { thread: threadData });
          initRepliesToggle(postsData, threadData);

          const lockHint = document.getElementById("lockHint");
          const locked = !!threadData.locked;
          if (lockHint) lockHint.style.display = locked ? "inline" : "none";
          if ($text) $text.disabled = locked;
          if ($btnReply) $btnReply.disabled = locked;
        }

        window.setReplyParent = function (postId, opts = {}) {
          currentParentId = postId;
          showReplyCtx({
            snippet: (opts.snippet || "").toString().slice(0, 80)
          });
          $text?.focus();
        };

        document.addEventListener("forum:set-reply-parent", (e) => {
          const { postId, author, snippet } = e.detail || {};
          if (!postId) return;
          window.setReplyParent(postId, { author, snippet });
        });
        document.getElementById("replyCancel")?.addEventListener("click", clearReplyCtx);

        $files.addEventListener("change", () => {
          const t = getCopy();
          $preview.innerHTML = "";
          const list = [...$files.files];

          list.forEach((f, idx) => {
            if (f.type.startsWith("image/")) {
              const url = URL.createObjectURL(f);
              const box = document.createElement("div");
              box.className = "thumb";

              const img = document.createElement("img");
              img.src = url;
              img.onload = () => URL.revokeObjectURL(url);

              const rm = document.createElement("button");
              rm.className = "rm";
              rm.textContent = "√ó";
              rm.title = t.delete;
              rm.onclick = (e) => {
                e.preventDefault();
                const dt = new DataTransfer();
                [...$files.files].forEach((file, i) => { if (i !== idx) dt.items.add(file); });
                $files.files = dt.files;
                box.remove();
              };

              box.appendChild(img);
              box.appendChild(rm);
              $preview.appendChild(box);
            } else {
              const div = document.createElement("div");
              div.className = "meta";
              div.textContent = `${t.fileLabel}: ${f.name} (${Math.round(f.size / 1024)} KB)`;
              $preview.appendChild(div);
            }
          });
        });

        $btnReply.addEventListener("click", async () => {
          const content = $text.value.trim();
          const hasFiles = $files.files && $files.files.length > 0;
          const t = getCopy();

          if (!content && !hasFiles) return;

          try {
            if (hasFiles) {
              const form = new FormData();
              form.append("content", content);
              if (currentParentId) form.append("parentId", currentParentId);
              [...$files.files].forEach((f) => form.append("files", f));

              const res = await fetch(`/api/forum/threads/${id}/posts-with-files`, {
                method: "POST",
                body: form,
                credentials: "include"
              });
              const data = await res.json();
              if (!res.ok) throw new Error(data.message || t.errorGeneric);
            } else {
              await Forum.api.addPost(id, { content, parentId: currentParentId || undefined });
            }

            $text.value = "";
            $files.value = "";
            $preview.innerHTML = "";
            clearReplyCtx();

            const data = await Forum.api.getThread(id);
            threadData = data.thread;
            postsData = data.posts || [];
            renderThreadPage();
          } catch (e) {
            alert(e.message || e);
          }
        });

        const data = await Forum.api.getThread(id);
        threadData = data.thread;
        postsData = data.posts || [];

        (function () {
          try {
            const $headerAvatar = document.querySelector(".thread-card .thread-avatar");
            if ($headerAvatar) {
              const authorName = (
                threadData.author?.fullName ||
                threadData.author?.username ||
                threadData.author?.email ||
                "‚Äî"
              );
              const src = threadData.author?.photoUrl || "/assets/profile-photo.png";
              $headerAvatar.src = src;
              $headerAvatar.alt = authorName;
              $headerAvatar.onerror = () => { $headerAvatar.src = "/assets/profile-photo.png"; };
            }
          } catch (_) {}
        })();

        function initRepliesToggle(posts, thread) {
          const root = document.querySelector("#posts");
          if (!root) return;
          const replies = [...root.querySelectorAll(".post")].slice(1);
          if (!replies.length) return;

          let store = root.querySelector("#hiddenReplies");
          if (!store) {
            store = document.createElement("div");
            store.id = "hiddenReplies";
            store.style.display = "none";
            root.appendChild(store);
          }
          replies.forEach((n) => store.appendChild(n));

          const first = root.querySelector(".post:first-child");
          if (!first) return;

          const t = getCopy();
          let footer = first.querySelector(".post-footer");
          if (!footer) {
            footer = document.createElement("div");
            footer.className = "post-footer";
            footer.innerHTML = `
              <button class="show-more" type="button"></button>
              <span class="answers-count" id="postAnswersCount"></span>
            `;
            first.appendChild(footer);
          }

          const total = Math.max((Array.isArray(posts) ? posts.length : (thread?.postsCount || 0)) - 1, 0);
          const cntEl = footer.querySelector("#postAnswersCount");
          if (cntEl) cntEl.textContent = formatReplies(total);

          let repliesBlock = first.querySelector(".replies-block");
          if (!repliesBlock) {
            repliesBlock = document.createElement("div");
            repliesBlock.className = "replies-block";
            repliesBlock.style.display = "none";
            first.appendChild(repliesBlock);
          }

          const btn = footer.querySelector(".show-more");
          if (btn) btn.textContent = t.showMore;
          let open = false;

          const sep = document.createElement("div");
          sep.className = "replies-separator";
          const list = document.createElement("div");
          list.className = "replies-list";

          btn?.addEventListener("click", () => {
            open = !open;
            if (open) {
              repliesBlock.innerHTML = "";
              repliesBlock.appendChild(sep);
              repliesBlock.appendChild(list);
              while (store.firstChild) list.appendChild(store.firstChild);
              repliesBlock.style.display = "block";
              btn.textContent = t.showLess;
            } else {
              while (list.firstChild) store.appendChild(list.firstChild);
              repliesBlock.style.display = "none";
              btn.textContent = t.showMore;
            }
          });
        }

        renderThreadPage();

        const me = (() => { try { return JSON.parse(localStorage.getItem("user") || "null"); } catch { return null; } })();
        const canModThis = Forum.can("moderate:threads") || (me && threadData.author && String(me._id) === String(threadData.author._id));

        if (canModThis) {
          const $actions = document.getElementById("tModActions");
          if ($actions) $actions.style.display = "flex";

          const $btnPin = document.getElementById("btnPin");
          const $btnLock = document.getElementById("btnLock");
          const $btnDel = document.getElementById("btnDelThread");
          const $btnPrivacy = document.getElementById("btnPrivacy");
          const $btnInvite = document.getElementById("btnInvite");

          $btnPin && ($btnPin.onclick = async () => { await Forum.api.togglePin(id); location.reload(); });
          $btnLock && ($btnLock.onclick = async () => { await Forum.api.toggleLock(id); location.reload(); });
          $btnDel && ($btnDel.onclick = async () => {
            const t = getCopy();
            if (!confirm(t.deleteThreadConfirm)) return;
            await Forum.api.deleteThread(id);
            location.href = "./index.html";
          });

          $btnPrivacy && ($btnPrivacy.onclick = async () => {
            const next = !threadData.isPrivate;
            await Forum.api.togglePrivate(id, next);
            location.reload();
          });

          $btnInvite && ($btnInvite.onclick = async () => {
            const t = getCopy();
            const userId = prompt(t.invitePrompt);
            if (!userId) return;
            try {
              await Forum.api.addParticipant(id, userId.trim());
              alert(t.inviteSuccess);
            } catch (e) {
              alert(e.message || e);
            }
          });
        }

        window.addEventListener("uiLangChange", () => {
          renderThreadPage();
        });
      });
    </script>
  </body>
</html>
