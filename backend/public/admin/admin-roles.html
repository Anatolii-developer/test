<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Керування ролями</title>
  <link rel="stylesheet" href="admin-styles.css" />
</head>
<body>
  <aside class="sidebar" id="sidebar">
    <!-- Логотип -->
    <img class="logo" src="../assets/sidebar/IPS Logo (2).svg" alt="Logo" id="logoExpanded" />
  
    
    <p style="margin-left: 12px; font-weight: 600;">Admin</p>
  
    <!-- Навигация -->
    <nav>
      <a href="admin-requests.html"><img src="../assets/sidebar/profile.svg" /><span>Профайли</span></a>
      <a href="admin-certificate.html"><img src="../assets/sidebar/news.svg" /><span>Сертифікати</span></a>
      <a href="#"><img src="../assets/sidebar/3.svg" /><span>Планування кар'єри</span></a>
      <a href="admin-library.html"><img src="../assets/sidebar/4.svg" /><span>Бібліотека</span></a>
      <a href="admin-all-courses.html"><img src="../assets/sidebar/5.svg" /><span>Курси</span></a>
      <a href="#"><img src="../assets/sidebar/6.svg" /><span>Облік практики</span></a>
      <a href="#"><img src="../assets/sidebar/7.svg" /><span>Здоров’я</span></a>
      <a href="#"><img src="../assets/sidebar/8.svg" /><span>Фінанси</span></a>
      <a href="#"><img src="../assets/sidebar/9.svg" /><span>Нерухомість</span></a>
    </nav>
  
    <!-- Настройки + выход -->
    <div style="margin-top: auto;">
      <a href="admin-roles.html"><img src="../assets/sidebar/settings.png" /><span>Налаштування</span></a>
      <div class="logout" onclick="logoutUser()">
        <img src="../assets/sidebar/log-out.svg" alt="Logout Icon" width="20" height="20" />
        <span>Logout Account</span>
      </div>
    </div>
  </aside>
  
  <div class="roles-wrapper">
  <h1>Налаштування</h1>

  <table class="roles-table" id="rolesTable">
    <thead>
      <tr>
        <th>Роль</th>
        <th>Статус</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="rolesBody"></tbody>
  </table>

  <div class="add-role-form">
    <input type="text" id="newRole" placeholder="Нова роль..." />
    <button onclick="addRole()">Додати</button>
  </div>
</div>


  <script>
    let roles = [];

async function loadRoles() {
  try {
    const res = await fetch("http://157.230.121.24:5050/api/roles");
    roles = await res.json();
    await renderRoles(); // теперь тоже async
  } catch (err) {
    console.error("❌ Помилка при завантаженні ролей:", err);
  }
}


   async function renderRoles() {
  const tbody = document.getElementById("rolesBody");
  tbody.innerHTML = "";

  let usersByRole = {};
  try {
    const res = await fetch("http://157.230.121.24:5050/api/users/roles-with-users");
    usersByRole = await res.json();
  } catch (err) {
    console.error("❌ Не вдалося завантажити користувачів по ролях:", err);
  }

  for (const role of roles) {
    const tr = document.createElement("tr");

    const nameCell = document.createElement("td");
    nameCell.textContent = role.name;
    nameCell.style.cursor = "pointer";
    nameCell.onclick = () => editRole(role._id, role.name);

    const statusCell = document.createElement("td");
    const isActive = role.active !== false;
    statusCell.textContent = isActive ? "Активна" : "Неактивна";
    statusCell.className = isActive ? "active" : "inactive";

    const deleteCell = document.createElement("td");
    const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "Видалити";
    deleteBtn.className = "delete-btn";
    deleteBtn.onclick = () => deleteRole(role._id);
    deleteCell.appendChild(deleteBtn);

    tr.appendChild(nameCell);
    tr.appendChild(statusCell);
    tr.appendChild(deleteCell);

    tbody.appendChild(tr);

    // Users row
    const users = usersByRole[role.name] || [];
    const usersTr = document.createElement("tr");
    const usersTd = document.createElement("td");
    usersTd.colSpan = 3;
    usersTd.style.fontSize = "14px";
    usersTd.style.color = "#555";
    usersTd.style.paddingLeft = "20px";
    usersTr.appendChild(usersTd);
    tbody.appendChild(usersTr);
  }
}



    async function addRole() {
      const name = document.getElementById("newRole").value.trim();
      if (!name) return;

      try {
        const res = await fetch("http://157.230.121.24:5050/api/roles", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name })
        });

        if (res.ok) {
          document.getElementById("newRole").value = "";
          await loadRoles();
        } else {
          alert("Помилка при додаванні ролі");
        }
      } catch (err) {
        console.error("Помилка при створенні ролі:", err);
      }
    }

    async function deleteRole(id) {
      if (!confirm("Видалити роль?")) return;

      try {
        const res = await fetch(`http://157.230.121.24:5050/api/roles/${id}`, {
          method: "DELETE"
        });

        if (res.ok) {
          await loadRoles();
        } else {
          alert("Не вдалося видалити роль");
        }
      } catch (err) {
        console.error("Помилка при видаленні:", err);
      }
    }

    function editRole(id, oldName) {
      const newName = prompt("Нова назва ролі:", oldName);
      if (!newName || newName === oldName) return;

      fetch(`http://157.230.121.24:5050/api/roles/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: newName })
      }).then(res => {
        if (res.ok) loadRoles();
        else alert("Помилка при оновленні ролі");
      });
    }

    window.addEventListener("DOMContentLoaded", loadRoles);
  </script>

</body>
</html>
