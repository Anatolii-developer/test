<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏ –º–æ—ó—Ö –∫—É—Ä—Å—ñ–≤</title>
    <link rel="stylesheet" href="styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Section (folder) dropdowns */
      .section {
        margin: 12px 0 16px;
        border-radius: 12px;
        background: #ffeed9;
        padding: 0;
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.06);
      }
      .section summary {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        list-style: none;
        padding: 14px 16px;
        font-weight: 600;
        user-select: none;
      }
      .section[open] summary {
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      }
      .section summary::-webkit-details-marker {
        display: none;
      }
      .materials {
        padding: 12px 16px;
        display: grid;
        gap: 12px;
      }
      .material-row {
        display: grid;
        gap: 8px;
        background: #fff;
        border-radius: 10px;
        padding: 12px;
        border: 1px solid #eee;
      }
      .row-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .material-title {
        font-weight: 600;
      }
      .material-desc {
        opacity: 0.8;
        font-size: 14px;
        line-height: 1.45;
      }
      .view-btn {
        padding: 8px 14px;
        border-radius: 8px;
        border: 1px solid #d97a1c;
        background: transparent;
        color: #d97a1c;
        cursor: pointer;
      }
      .preview {
        margin-top: 10px;
        display: none;
      }
      .preview.active {
        display: block;
      }
      .preview iframe,
      .preview embed {
        width: 100%;
        height: 420px;
        border: 0;
        border-radius: 10px;
        background: #fff;
      }
      .empty-note {
        opacity: 0.7;
        padding: 8px 0;
      }
    </style>
  </head>
  <body>
    <aside class="sidebar collapsed" id="sidebar">
      <div class="toggle-button" onclick="toggleSidebar()">
        <img src="assets/sidebar/arrow.svg" alt="Toggle" id="toggleArrow" />
      </div>
      <img
        class="logo"
        src="assets/sidebar/IPS Logo (2).svg"
        alt="Logo"
        id="logoExpanded"
      />
      <img
        class="logo-collapsed"
        src="assets/sidebar/IPS Logo (1).svg"
        alt="Logo Small"
        id="logoCollapsed"
      />
      <img
        class="profile"
        src="assets/profile-photo.png"
        alt="User"
        width="40"
        height="40"
      />
      <nav>
        <a href="profile.html"
          ><img src="assets/sidebar/profile.svg" /><span>–ü—Ä–æ –ú–µ–Ω–µ</span></a
        >
        <a href="mycertificates.html"
          ><img src="assets/sidebar/news.svg" /><span>–ú–æ—ó –°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏</span></a
        >
        <a href="career-faq.html"
          ><img src="assets/sidebar/10.svg" /><span>–ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è –ö–∞—Ä'—î—Ä–∏</span></a
        >
        <a href="library.html"
          ><img src="assets/sidebar/3.svg" /><span>–ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞</span></a
        >
        <a href="my-courses.html"
          ><img src="assets/sidebar/5.svg" /><span>–ú–æ—ó –ö—É—Ä—Å–∏</span></a
        >
         <a href="forum/index.html">
  <img src="assets/sidebar/forum.svg" alt="–§–æ—Ä—É–º"/>
  <span>–§–æ—Ä—É–º</span>
</a>
      </nav>
      <div class="logout">
        <img
          src="assets/sidebar/log-out.svg"
          alt="Logout Icon"
          width="20"
          height="20"
        />
        <span>–í–∏–π—Ç–∏ –∑ –∞–∫–∞—É–Ω—Ç—É</span>
      </div>
    </aside>

    <main id="mainContent">
      <div class="main-header">
        <h2>–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏ –º–æ—ó—Ö –∫—É—Ä—Å—ñ–≤</h2>
        <img src="assets/library/courses.png" alt="Courses Image" />
      </div>

      <div class="nav-buttons">
        <a href="library.html"
          ><button class="nav-button">
            <img src="assets/library/arrow-main.svg" alt="Back" />–ì–æ–ª–æ–≤–Ω–∞
          </button></a
        >
        <a href="main-library.html"
          ><button class="nav-button secondary">–ó–∞–≥–∞–ª—å–Ω—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏</button></a
        >
        <a href="addons-library.html"
          ><button class="nav-button secondary">–î–æ–¥–∞—Ç–∫–æ–≤—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏</button></a
        >
      </div>

      <section class="materials-library-content">
        <div class="date-section">
          <label class="date-label">Publishing Date (DD/MM/YYYY)</label>
          <div class="date-inputs">
            <input type="date" class="date-input" id="dateFrom" />
            <input type="date" class="date-input" id="dateTo" />
          </div>
          <div class="filter-btn-wrapper">
            <button class="filter-btn" id="btnFilter">–§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏</button>
          </div>
        </div>

        <div class="course-list" id="courseList">
          <div class="empty-note">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>
        </div>
      </section>
    </main>

    <script src="script.js"></script>
    <script>
const API_BASE = "http://157.230.121.24:5050";

function getYouTubeEmbedUrl(link){
  const m = String(link||"").match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/))([\w-]{11})/);
  return m ? `https://www.youtube.com/embed/${m[1]}` : "";
}
const esc = s => String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
const cssSafe = s => String(s||"").replace(/[^a-z0-9_-]+/gi,"-");
const parseISO = v => { const d = v?new Date(v):null; return isNaN(d?.getTime?.())?null:d; };

function getMe(){
  // –æ—á—ñ–∫—É—î–º–æ –∑ localStorage (—è–∫ —É –∞–¥–º—ñ–Ω—Ü—ñ)
  try { return JSON.parse(localStorage.getItem("user")||"null"); } catch(_){ return null; }
}

async function loadCourseMaterials(){
  const list = document.getElementById("courseList");
  list.innerHTML = '<div class="empty-note">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>';

  const dFromVal = document.getElementById('dateFrom').value;
  const dToVal   = document.getElementById('dateTo').value;
  const dateFrom = dFromVal ? new Date(dFromVal + "T00:00:00") : null;
  const dateTo   = dToVal ? new Date(dToVal + "T23:59:59") : null;

  const me = getMe();
  const myId = me?._id || me?.id || null;

  // 1) –í—Å—ñ material-entries –ø–æ destination=courses
  const libRes = await fetch(`${API_BASE}/api/library?destination=courses`);
  const libAll = (await libRes.json()) || [];

  // 2) –î—ñ—Å—Ç–∞—î–º–æ —Å–ø–∏—Å–æ–∫ –∫—É—Ä—Å—ñ–≤ —ñ —Ñ—ñ–ª—å—Ç—Ä—É—î–º–æ ¬´–º–æ—ó¬ª
  let myCourseIds = new Set();
  try{
    const cr = await fetch(`${API_BASE}/api/courses`);
    const courses = (await cr.json()) || [];
    for (const c of courses){
      const parts = Array.isArray(c.participants) ? c.participants.map(String) : [];
      if (!myId || parts.includes(String(myId))){
        myCourseIds.add(String(c._id));
      }
    }
  } catch(_){
    // —è–∫—â–æ –Ω–µ –≤–¥–∞–ª–æ—Å—å –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –º–æ—ó –∫—É—Ä—Å–∏ ‚Äî –±—É–¥–µ–º–æ –≤–≤–∞–∂–∞—Ç–∏, —â–æ –¥–æ–∑–≤–æ–ª–µ–Ω–æ –≤—Å–µ
    myCourseIds = null; // ¬´–Ω–µ–º–∞ –æ–±–º–µ–∂–µ–Ω–Ω—è¬ª
  }

  // 3) –§—ñ–ª—å—Ç—Ä—É—î–º–æ materials: –¥–∞—Ç–∏ + –º–æ—ó –∫—É—Ä—Å–∏
  const filtered = libAll.filter(it=>{
    const dt = parseISO(it.date || it.createdAt);
    if (dateFrom && dt && dt<dateFrom) return false;
    if (dateTo && dt && dt>dateTo) return false;
    if (myCourseIds && it.courseId && !myCourseIds.has(String(it.courseId))) return false;
    return true;
  });

  if (!filtered.length){
    list.innerHTML = "<p>–ù–∞—Ä–∞–∑—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ.</p>";
    return;
  }

  // 4) –ì—Ä—É–ø—É—î–º–æ –∑–∞ –∫—É—Ä—Å–æ–º ‚Üí –∑–∞ –ø–∞–ø–∫–æ—é
  const byCourse = new Map();
  const courseIds = new Set();
  for (const it of filtered){
    const key = it.courseId || "_no_course_";
    if (!byCourse.has(key)) byCourse.set(key, []);
    byCourse.get(key).push(it);
    if (it.courseId) courseIds.add(String(it.courseId));
  }

  // 5) –ú–µ—Ç–∞–¥–∞–Ω—ñ –∫—É—Ä—Å—ñ–≤
  const meta = new Map();
  for (const cid of courseIds){
    try{
      const r = await fetch(`${API_BASE}/api/courses/${cid}`);
      if (r.ok){
        const c = await r.json();
        meta.set(cid, {
          title: c.courseTitle || "–ö—É—Ä—Å",
          description: c.courseSubtitle || c.courseDescription || ""
        });
      }
    }catch(_){}
  }

  list.innerHTML = "";

  for (const [courseKey, items] of byCourse.entries()){
    const m = meta.get(String(courseKey)) || {title:"–ö—É—Ä—Å", description:"–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏ –∫—É—Ä—Å—É"};
    const courseItem = document.createElement("div");
    courseItem.className = "course-item";
    courseItem.innerHTML = `
      <h4 class="course-title">${esc(m.title)}</h4>
      <p class="course-description">${esc(m.description)}</p>
    `;

    const byFolder = new Map();
    for (const it of items){
      const folder = (it.folder && String(it.folder).trim()) || "–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏";
      if (!byFolder.has(folder)) byFolder.set(folder, []);
      byFolder.get(folder).push(it);
    }

    for (const [folderName, sItems] of byFolder.entries()){
      const details = document.createElement("details");
      details.className = "section";
      details.innerHTML = `
        <summary class="section-summary">üìÅ ${esc(folderName)}</summary>
        <div class="materials"></div>`;
      const wrap = details.querySelector(".materials");

      sItems.forEach((mat, idx)=>{
        const row = document.createElement("div");
        row.className = "material-row";
        const title = mat.itemTitle || mat.title || (mat.type==="video" ? "–í—ñ–¥–µ–æ" : "–§–∞–π–ª");
        const desc  = mat.description || "";
        const prevId = `prev-${courseKey}-${cssSafe(folderName)}-${idx}`;

        row.innerHTML = `
          <div class="row-head">
            <div>
              <div class="material-title">${esc(title)}</div>
              ${desc?`<div class="material-desc">${esc(desc)}</div>`:""}
            </div>
            <button class="view-btn" type="button" data-target="${prevId}">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏</button>
          </div>
          <div class="preview" id="${prevId}"></div>`;

        row.querySelector(".view-btn").addEventListener("click", ()=>{
          renderPreview(document.getElementById(prevId), mat);
        });

        wrap.appendChild(row);
      });

      courseItem.appendChild(details);
    }

    list.appendChild(courseItem);
  }
}

function renderPreview(container, mat){
  if (!container) return;
  const wasActive = container.classList.contains("active");
  document.querySelectorAll(".preview.active").forEach(el=>{ el.classList.remove("active"); el.innerHTML=""; });
  if (wasActive){ container.classList.remove("active"); return; }
  container.classList.add("active");

  if (mat.type==="video"){
    const src = getYouTubeEmbedUrl(mat.videoLink);
    container.innerHTML = src
      ? `<iframe src="${src}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen title="–í—ñ–¥–µ–æ"></iframe>`
      : `<div class="material-desc">–ù–µ–≤—ñ—Ä–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –≤—ñ–¥–µ–æ.</div>`;
    return;
  }

  const raw = mat.filePath || "";
  const url = raw.startsWith("http") ? raw : `${API_BASE}/${raw.replace(/^\/+/, "")}`;
  const ext = (raw.split(".").pop()||"").toLowerCase();
  if (ext==="pdf"){
    container.innerHTML = `<embed src="${url}" type="application/pdf" />`;
  } else if (["doc","docx","ppt","pptx"].includes(ext)){
    container.innerHTML = `<div class="material-desc">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π –±–µ–∑ HTTPS. <a href="${url}" target="_blank" rel="noopener">–í—ñ–¥–∫—Ä–∏—Ç–∏ / –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</a></div>`;
  } else {
    container.innerHTML = `<div class="material-desc">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π. <a href="${url}" target="_blank" rel="noopener">–í—ñ–¥–∫—Ä–∏—Ç–∏ —Ñ–∞–π–ª</a></div>`;
  }
}

window.addEventListener("load", ()=>{
  document.getElementById("btnFilter").addEventListener("click", loadCourseMaterials);
  loadCourseMaterials().catch(console.error);
});
</script>
  </body>
</html>
