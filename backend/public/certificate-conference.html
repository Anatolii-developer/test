<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Проходження конференцій</title>
    <link rel="stylesheet" href="styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <header class="site-header">
      <button class="burger" id="burgerBtn" aria-label="Відкрити меню" aria-expanded="false" aria-controls="sidebar">
        <img src="assets/sidebar/burger.svg" alt="" />
      </button>

      <a href="/" class="header-logo" aria-label="Головна">
        <img src="assets/emblem.svg" alt="IPS" />
      </a>

      <button class="lang-switch" id="langBtn" aria-haspopup="listbox" aria-expanded="false">
        UA ▼
      </button>
    </header>
    <aside class="sidebar collapsed" id="sidebar">
      <div class="toggle-button" onclick="toggleSidebar()">
        <img src="assets/sidebar/arrow.svg" alt="Toggle" id="toggleArrow" />
      </div>
      <img
        class="logo"
        src="assets/sidebar/IPS Logo (2).svg"
        alt="Logo"
        id="logoExpanded"
      />
      <img
        class="logo-collapsed"
        src="assets/sidebar/IPS Logo (1).svg"
        alt="Logo Small"
        id="logoCollapsed"
      />
      <img
        class="profile"
        src="assets/profile-photo.png"
        alt="User"
        width="40"
        height="40"
      />
      <nav>
        <a href="profile.html"
          ><img src="assets/sidebar/profile.svg" /><span>Про Мене</span></a
        >
        <a href="mycertificates.html"
          ><img src="assets/sidebar/news.svg" /><span>Мої Сертифікати</span></a
        >
        <a href="career-faq.html"
          ><img src="assets/sidebar/10.svg" /><span>Планування Кар'єри</span></a
        >
        <a href="library.html"
          ><img src="assets/sidebar/3.svg" /><span>Бібліотека</span></a
        >
        <a href="my-courses.html"
          ><img src="assets/sidebar/5.svg" /><span>Мої Курси</span></a
        >
        <a href="forum/index.html">
  <img src="assets/sidebar/forum.svg" alt="Форум"/>
  <span>Форум</span>
</a>
        <a href="practice-records.html"><img src="assets/practice-records.svg" /><span>Облік Практики</span></a>
      </nav>
      <div class="logout">
        <img
          src="assets/sidebar/log-out.svg"
          alt="Logout Icon"
          width="20"
          height="20"
        />
        <span>Вийти з акаунту</span>
      </div>
    </aside>
    <div class="drawer-backdrop" id="drawerBackdrop"></div>

    <main class="cert-page">
      <div class="main-header">
        <h2 id="certPageTitle">Проходження конференцій</h2>
        <img src="assets/certificates/certificate1.png" alt="Main Image" />
      </div>

      <div class="cert-nav">
        <a href="./mycertificates.html" class="cert-btn back" id="certNavHome"
          ><span>&larr;</span> На головну</a
        >
        <a href="./certificate-upgrade.html" class="cert-btn" id="certNavUpgrade"
          >Підвищення кваліфікації</a
        >
        <a href="./certificate-completing.html" class="cert-btn" id="certNavCourses"
          >Проходження курсів</a
        >
        <a href="./certificate-conference.html" class="cert-btn active" id="certNavConferences"
          >Проходження конференцій</a
        >
      </div>

      <div class="cert-grid" id="certGrid"></div>
    </main>

    <script src="script.js"></script>
    <script>
      const MAIN_TYPE = "Конференція";
      const CERT_PAGE_I18N = {
        ua: {
          pageTitle: "Проходження конференцій",
          home: "На головну",
          upgrade: "Підвищення кваліфікації",
          courses: "Проходження курсів",
          conferences: "Проходження конференцій",
          view: "Переглянути",
          noCertificate: "Немає сертифікату",
          noCertificateYet: "Сертифікат ще не додано",
          untitled: "Без назви",
          loginRequired: "Щоб переглянути сертифікати, увійдіть у систему.",
          empty: "Поки що немає доданих сертифікатів за цією категорією.",
          loadError: "Сталася помилка під час завантаження сертифікатів.",
          loadErrorLog: "Помилка завантаження сертифікатів:",
        },
        ru: {
          pageTitle: "Прохождение конференций",
          home: "На главную",
          upgrade: "Повышение квалификации",
          courses: "Прохождение курсов",
          conferences: "Прохождение конференций",
          view: "Просмотреть",
          noCertificate: "Нет сертификата",
          noCertificateYet: "Сертификат еще не добавлен",
          untitled: "Без названия",
          loginRequired: "Чтобы просмотреть сертификаты, войдите в систему.",
          empty: "Пока нет добавленных сертификатов по этой категории.",
          loadError: "Произошла ошибка при загрузке сертификатов.",
          loadErrorLog: "Ошибка загрузки сертификатов:",
        },
        en: {
          pageTitle: "Conferences attended",
          home: "Home",
          upgrade: "Professional development",
          courses: "Completed courses",
          conferences: "Conferences attended",
          view: "View",
          noCertificate: "No certificate",
          noCertificateYet: "Certificate is not added yet",
          untitled: "Untitled",
          loginRequired: "Log in to view certificates.",
          empty: "No certificates added in this category yet.",
          loadError: "An error occurred while loading certificates.",
          loadErrorLog: "Certificate loading error:",
        },
      };
      const API_BASE = "https://cabinet.mamko-prof-supervision.com";

      function normalizeLang(value) {
        const v = String(value || "").toLowerCase().trim();
        if (v.startsWith("en")) return "en";
        if (v.startsWith("ru")) return "ru";
        return "ua";
      }

      function getUiLang() {
        try {
          return normalizeLang(localStorage.getItem("uiLang") || document.documentElement.lang);
        } catch (_) {
          return normalizeLang(document.documentElement.lang);
        }
      }

      function getCopy() {
        return CERT_PAGE_I18N[getUiLang()] || CERT_PAGE_I18N.ua;
      }

      function getDateLocale() {
        const lang = getUiLang();
        if (lang === "ru") return "ru-RU";
        if (lang === "en") return "en-US";
        return "uk-UA";
      }

      function refreshUiTexts() {
        const t = getCopy();
        document.title = t.pageTitle;
        const setText = (id, text) => {
          const el = document.getElementById(id);
          if (el) el.textContent = text;
        };
        setText("certPageTitle", t.pageTitle);
        setText("certNavUpgrade", t.upgrade);
        setText("certNavCourses", t.courses);
        setText("certNavConferences", t.conferences);
        const home = document.getElementById("certNavHome");
        if (home) home.innerHTML = `<span>&larr;</span> ${t.home}`;
      }

      document.addEventListener("DOMContentLoaded", () => {
        refreshUiTexts();
        loadUserCertificatesByMainType(MAIN_TYPE);
      });

      window.addEventListener("uiLangChange", () => {
        refreshUiTexts();
        loadUserCertificatesByMainType(MAIN_TYPE);
      });

      function renderPreview(url, id) {
        const t = getCopy();
        if (!url)
          return `<div class="cert-placeholder" id="cert-preview-${id}" style="display:flex;align-items:center;justify-content:center;min-height:220px;border:1px dashed #ccc;border-radius:12px;">${t.noCertificateYet}</div>`;
        const isPdf = /\.pdf(\?|$)/i.test(url);
        return isPdf
          ? `<embed src="${url}" type="application/pdf" class="cert-embed" id="cert-preview-${id}" style="width:100%;height:260px;border-radius:12px;" />`
          : `<img src="${url}" alt="Certificate" class="cert-image" id="cert-preview-${id}" style="width:100%;height:auto;border-radius:12px;object-fit:cover;max-height:260px;" />`;
      }

      function renderCertCard({ course, uaUrl, engUrl }) {
        const t = getCopy();
        const dateLocale = getDateLocale();
        const hasUA = !!uaUrl,
          hasEN = !!engUrl;
        const initialUrl = uaUrl || engUrl || null;
        return `
        <div class="cert-card" data-course="${course._id}">
          <div class="cert-preview" id="cert-preview-wrap-${course._id}">
            ${renderPreview(initialUrl, course._id)}
          </div>
          <h3 class="cert-title">${course.courseTitle || t.untitled}</h3>
          <p class="cert-dates">
            ${
              course.courseDates?.start
                ? new Date(course.courseDates.start).toLocaleDateString(dateLocale)
                : ""
            }
            ${
              course.courseDates?.end
                ? " – " +
                  new Date(course.courseDates.end).toLocaleDateString(dateLocale)
                : ""
            }
          </p>
          <div class="cert-footer">
            <div class="lang-switch">
              <span>UA</span>
              <label class="switch">
                <input type="checkbox" ${
                  hasUA ? "" : hasEN ? "checked" : "disabled"
                } onchange="switchUserCert(this, '${course._id}', '${
          uaUrl || ""
        }', '${engUrl || ""}')"/>
                <span class="slider round"></span>
              </label>
              <span>EN</span>
            </div>
            ${
              initialUrl
                ? `<a href="${initialUrl}" target="_blank" class="view-btn" id="view-btn-${course._id}">${t.view}</a>`
                : `<span class="view-btn" style="pointer-events:none;opacity:.6">${t.noCertificate}</span>`
            }
          </div>
        </div>`;
      }

      function switchUserCert(toggle, courseId, uaUrl, enUrl) {
        const btn = document.getElementById("view-btn-" + courseId);
        const wrap = document.getElementById("cert-preview-wrap-" + courseId);
        const url = toggle.checked ? enUrl || uaUrl : uaUrl || enUrl;
        if (btn) {
          if (url) {
            btn.href = url;
            btn.style.pointerEvents = "auto";
            btn.style.opacity = "1";
          } else {
            btn.removeAttribute("href");
            btn.style.pointerEvents = "none";
            btn.style.opacity = ".6";
          }
        }
        if (wrap) wrap.innerHTML = renderPreview(url, courseId);
      }

      async function loadUserCertificatesByMainType(MAIN_TYPE) {
        const t = getCopy();
        const grid =
          document.getElementById("certGrid") ||
          document.querySelector(".cert-grid");
        if (!grid) return;
        const rawUser = localStorage.getItem("user");
        if (!rawUser) {
          grid.innerHTML = `<p>${t.loginRequired}</p>`;
          return;
        }
        const user = JSON.parse(rawUser);
        try {
          const resUser = await fetch(`${API_BASE}/api/users/${user._id}`);
          const freshUser = await resUser.json();
          const resCourses = await fetch(
            `${API_BASE}/api/courses?mainType=${encodeURIComponent(
              MAIN_TYPE
            )}&status=${encodeURIComponent("Пройдений")}`
          );
          const courses = await resCourses.json();
          const cards = [];
          courses.forEach((course) => {
            const cert = freshUser.certificates?.[course._id];
            const uaUrl = cert?.ua?.url || "";
            const engUrl = cert?.eng?.url || "";
            if (uaUrl || engUrl)
              cards.push(renderCertCard({ course, uaUrl, engUrl }));
          });
          grid.innerHTML = cards.length
            ? cards.join("")
            : `<p>${t.empty}</p>`;
        } catch (e) {
          console.error(t.loadErrorLog, e);
          grid.innerHTML = `<p>${t.loadError}</p>`;
        }
      }
    </script>
  </body>
</html>
