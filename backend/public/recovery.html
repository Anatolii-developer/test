<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Відновлення - Psychologist Platform</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <img class="logo" src="assets/logo.png" alt="Institute Logo" />
    <div class="language-select">UA ▼</div>
  </header>

  <main>
    <div class="login-card">
      <h1 class="h1" style="color: #D97A1C; text-align: center;">Відновлення</h1>

      <label for="email" class="s1">Email</label>
      <div class="input-wrapper">
        <img src="assets/icon-user.png" class="input-icon" alt="email icon" />
        <input type="email" id="email" placeholder="Enter your email" />
      </div>

      <button id="btnSend" onclick="sendRecoveryCode()">Надіслати код</button>

      <!-- Шаг 2: код -->
      <div id="codeBlock" style="display:none; margin-top:16px;">
        <label for="code" class="s1">Код з листа</label>
        <div class="input-wrapper">
          <input type="text" id="code" placeholder="6-значний код" />
        </div>
        <button id="btnVerify" onclick="verifyCode()">Підтвердити код</button>
      </div>

      <!-- Шаг 3: новый пароль -->
      <div id="resetBlock" style="display:none; margin-top:16px;">
        <label for="newPassword" class="s1">Новий пароль</label>
        <div class="input-wrapper">
          <input type="password" id="newPassword" placeholder="Введіть новий пароль" />
        </div>
        <label for="newPassword2" class="s1" style="margin-top:8px;">Підтвердження</label>
        <div class="input-wrapper">
          <input type="password" id="newPassword2" placeholder="Повторіть пароль" />
        </div>
        <button id="btnReset" onclick="resetPassword()">Змінити пароль</button>
      </div>

      <button style="background-color: #aaa; margin-top: 12px;" onclick="history.back()">Повернутись назад</button>
    </div>
</main>
<script>
  // ===== Password recovery flow (frontend) =====
  const API_BASE = '/api/auth/recovery';
  const state = { email: '', code: '', codeVerified: false };

  function qs(id){ return document.getElementById(id); }
  function show(el, yes){ if(!el) return; el.style.display = yes ? '' : 'none'; }
  function toast(msg){ alert(msg); }
  function setLoading(btn, is){
    if(!btn) return;
    if(is){
      btn.disabled = true;
      if(!btn.dataset._txt) btn.dataset._txt = btn.textContent;
      btn.textContent = 'Зачекайте…';
    } else {
      btn.disabled = false;
      if(btn.dataset._txt) btn.textContent = btn.dataset._txt;
    }
  }

  // Step 1: send code to email
  async function sendRecoveryCode(){
    const email = (qs('email')?.value || '').trim().toLowerCase();
    if(!email){ toast('Вкажіть email.'); return; }
    setLoading(qs('btnSend'), true);
    try{
      const res = await fetch(`${API_BASE}/send`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });
      const data = await res.json().catch(()=>({}));
      if(!res.ok) throw new Error(data.message || 'Помилка надсилання коду');
      state.email = email;
      show(qs('codeBlock'), true);
      toast('Код відправлено на вашу електронну пошту.');
    } catch (e){
      toast(e.message || 'Помилка');
    } finally {
      setLoading(qs('btnSend'), false);
    }
  }

  // Step 2: verify code
  async function verifyCode(){
    const code = (qs('code')?.value || '').trim();
    if(!code){ toast('Введіть код з листа.'); return; }
    setLoading(qs('btnVerify'), true);
    try{
      const res = await fetch(`${API_BASE}/verify`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: state.email || (qs('email')?.value||'').trim(), code })
      });
      const data = await res.json().catch(()=>({}));
      if(!res.ok) throw new Error(data.message || 'Невірний або прострочений код');
      state.code = code;
      state.codeVerified = true;
      show(qs('resetBlock'), true);
      toast('Код підтверджено. Введіть новий пароль.');
    } catch(e){
      toast(e.message || 'Помилка');
    } finally {
      setLoading(qs('btnVerify'), false);
    }
  }

  // Step 3: set new password
  async function resetPassword(){
    if(!state.codeVerified){ toast('Спершу підтвердіть код.'); return; }
    const p1 = qs('newPassword')?.value || '';
    const p2 = qs('newPassword2')?.value || '';
    if(p1.length < 8){ toast('Пароль має містити щонайменше 8 символів.'); return; }
    if(p1 !== p2){ toast('Паролі не збігаються.'); return; }
    setLoading(qs('btnReset'), true);
    try{
      const res = await fetch(`${API_BASE}/reset`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: state.email || (qs('email')?.value||'').trim(), code: state.code, newPassword: p1 })
      });
      const data = await res.json().catch(()=>({}));
      if(!res.ok) throw new Error(data.message || 'Не вдалося змінити пароль');
      alert('✅ Пароль успішно змінено! Тепер ви можете увійти.');
setTimeout(() => location.href = '/index.html', 1000);
    } catch(e){
      toast(e.message || 'Помилка');
    } finally {
      setLoading(qs('btnReset'), false);
    }
  }
</script>

</body>
</html>